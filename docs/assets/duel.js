var vs=Object.defineProperty;var ps=(n,e,t)=>e in n?vs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var o=(n,e,t)=>ps(n,typeof e!="symbol"?e+"":e,t);import{e as cr,d as gs,a as xn,g as qn,b as vi,l as ms,c as ys,s as _s,f as Ss,h as ws,i as ks,j as Cs,k as ur,m as bs,n as dr,o as fr,p as hr,q as vr,r as pr,t as gr,u as Es}from"./card.js";import{j as Ts}from"./json.js";const tn=!1;var gn=Array.isArray,As=Array.prototype.indexOf,mn=Array.from,Ps=Object.defineProperty,jt=Object.getOwnPropertyDescriptor,mr=Object.getOwnPropertyDescriptors,Ds=Object.prototype,Fs=Array.prototype,yn=Object.getPrototypeOf;function xs(n){return typeof n=="function"}const wt=()=>{};function qs(n){return typeof(n==null?void 0:n.then)=="function"}function Ms(n){return n()}function nn(n){for(var e=0;e<n.length;e++)n[e]()}const Xe=2,yr=4,Bi=8,Oi=16,gt=32,ui=64,Si=128,We=256,wi=512,Re=1024,mt=2048,Wt=4096,vt=8192,Ni=16384,_r=32768,Li=65536,Sr=1<<17,Bs=1<<19,wr=1<<20,pt=Symbol("$state"),Os=Symbol("legacy props"),Ns=Symbol("");function kr(n){return n===this.v}function Cr(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function _n(n){return!Cr(n,this.v)}function Ls(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Is(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Rs(n){throw new Error("https://svelte.dev/e/effect_orphan")}function $s(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Us(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function Hs(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function js(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Zs(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function Vs(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let di=!1,zs=!1;function Gs(){di=!0}const Sn=1,wn=2,br=4,Ks=8,Ws=16,Xs=1,Qs=2,Ys=4,Js=8,ea=16,ta=1,ia=2,na=4,ra=1,sa=2,Oe=Symbol();let Fe=null;function ki(n){Fe=n}function Je(n,e=!1,t){Fe={p:Fe,c:null,e:null,m:!1,s:n,x:null,l:null},di&&!e&&(Fe.l={s:null,u:null,r1:[],r2:Le(!1)})}function et(n){const e=Fe;if(e!==null){const l=e.e;if(l!==null){var t=fe,i=ve;e.e=null;try{for(var r=0;r<l.length;r++){var s=l[r];Ye(s.effect),Qe(s.reaction),Yt(s.fn)}}finally{Ye(t),Qe(i)}}Fe=e.p,e.m=!0}return{}}function Xt(){return!di||Fe!==null&&Fe.l===null}function Le(n,e){var t={f:0,v:n,reactions:null,equals:kr,rv:0,wv:0};return t}function aa(n){return Er(Le(n))}function ri(n,e=!1){var i;const t=Le(n);return e||(t.equals=_n),di&&Fe!==null&&Fe.l!==null&&((i=Fe.l).s??(i.s=[])).push(t),t}function Te(n,e=!1){return Er(ri(n,e))}function Er(n){return ve!==null&&!rt&&ve.f&Xe&&(st===null?ma([n]):st.push(n)),n}function ti(n,e){return x(n,at(()=>h(n))),e}function x(n,e){return ve!==null&&!rt&&Xt()&&ve.f&(Xe|Oi)&&(st===null||!st.includes(n))&&Vs(),Et(n,e)}function Et(n,e){return n.equals(e)||(n.v,n.v=e,n.wv=Zr(),Tr(n,mt),Xt()&&fe!==null&&fe.f&Re&&!(fe.f&(gt|ui))&&(ut===null?ya([n]):ut.push(n))),e}function Tr(n,e){var t=n.reactions;if(t!==null)for(var i=Xt(),r=t.length,s=0;s<r;s++){var l=t[s],a=l.f;a&mt||!i&&l===fe||(ot(l,e),a&(Re|We)&&(a&Xe?Tr(l,Wt):Hi(l)))}}let Ar=!1;function kt(n,e=null,t){if(typeof n!="object"||n===null||pt in n)return n;const i=yn(n);if(i!==Ds&&i!==Fs)return n;var r=new Map,s=gn(n),l=Le(0);s&&r.set("length",Le(n.length));var a;return new Proxy(n,{defineProperty(c,u,d){(!("value"in d)||d.configurable===!1||d.enumerable===!1||d.writable===!1)&&Hs();var f=r.get(u);return f===void 0?(f=Le(d.value),r.set(u,f)):x(f,kt(d.value,a)),!0},deleteProperty(c,u){var d=r.get(u);if(d===void 0)u in c&&r.set(u,Le(Oe));else{if(s&&typeof u=="string"){var f=r.get("length"),v=Number(u);Number.isInteger(v)&&v<f.v&&x(f,v)}x(d,Oe),Mn(l)}return!0},get(c,u,d){var m;if(u===pt)return n;var f=r.get(u),v=u in c;if(f===void 0&&(!v||(m=jt(c,u))!=null&&m.writable)&&(f=Le(kt(v?c[u]:Oe,a)),r.set(u,f)),f!==void 0){var g=h(f);return g===Oe?void 0:g}return Reflect.get(c,u,d)},getOwnPropertyDescriptor(c,u){var d=Reflect.getOwnPropertyDescriptor(c,u);if(d&&"value"in d){var f=r.get(u);f&&(d.value=h(f))}else if(d===void 0){var v=r.get(u),g=v==null?void 0:v.v;if(v!==void 0&&g!==Oe)return{enumerable:!0,configurable:!0,value:g,writable:!0}}return d},has(c,u){var g;if(u===pt)return!0;var d=r.get(u),f=d!==void 0&&d.v!==Oe||Reflect.has(c,u);if(d!==void 0||fe!==null&&(!f||(g=jt(c,u))!=null&&g.writable)){d===void 0&&(d=Le(f?kt(c[u],a):Oe),r.set(u,d));var v=h(d);if(v===Oe)return!1}return f},set(c,u,d,f){var b;var v=r.get(u),g=u in c;if(s&&u==="length")for(var m=d;m<v.v;m+=1){var S=r.get(m+"");S!==void 0?x(S,Oe):m in c&&(S=Le(Oe),r.set(m+"",S))}v===void 0?(!g||(b=jt(c,u))!=null&&b.writable)&&(v=Le(void 0),x(v,kt(d,a)),r.set(u,v)):(g=v.v!==Oe,x(v,kt(d,a)));var p=Reflect.getOwnPropertyDescriptor(c,u);if(p!=null&&p.set&&p.set.call(f,d),!g){if(s&&typeof u=="string"){var C=r.get("length"),w=Number(u);Number.isInteger(w)&&w>=C.v&&x(C,w+1)}Mn(l)}return!0},ownKeys(c){h(l);var u=Reflect.ownKeys(c).filter(v=>{var g=r.get(v);return g===void 0||g.v!==Oe});for(var[d,f]of r)f.v!==Oe&&!(d in c)&&u.push(d);return u},setPrototypeOf(){js()}})}function Mn(n,e=1){x(n,n.v+e)}function Bn(n){return n!==null&&typeof n=="object"&&pt in n?n[pt]:n}function Pr(n,e){return Object.is(Bn(n),Bn(e))}var On,Dr,Fr,xr;function oa(){if(On===void 0){On=window,Dr=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype;Fr=jt(e,"firstChild").get,xr=jt(e,"nextSibling").get,n.__click=void 0,n.__className="",n.__attributes=null,n.__styles=null,n.__e=void 0,Text.prototype.__t=void 0}}function Ii(n=""){return document.createTextNode(n)}function Ci(n){return Fr.call(n)}function Ri(n){return xr.call(n)}function y(n,e){return Ci(n)}function G(n,e){{var t=Ci(n);return t instanceof Comment&&t.data===""?Ri(t):t}}function k(n,e=1,t=!1){let i=n;for(;e--;)i=Ri(i);return i}function la(n){n.textContent=""}function si(n){var e=Xe|mt,t=ve!==null&&ve.f&Xe?ve:null;return fe===null||t!==null&&t.f&We?e|=We:fe.f|=wr,{ctx:Fe,deps:null,effects:null,equals:kr,f:e,fn:n,reactions:null,rv:0,v:null,wv:0,parent:t??fe}}function ue(n){const e=si(n);return e.equals=_n,e}function qr(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)Pt(e[t])}}function ca(n){for(var e=n.parent;e!==null;){if(!(e.f&Xe))return e;e=e.parent}return null}function ua(n){var e,t=fe;Ye(ca(n));try{qr(n),e=zr(n)}finally{Ye(t)}return e}function Mr(n){var e=ua(n),t=(bt||n.f&We)&&n.deps!==null?Wt:Re;ot(n,t),n.equals(e)||(n.v=e,n.wv=Zr())}function Br(n){fe===null&&ve===null&&Rs(),ve!==null&&ve.f&We&&fe===null&&Is(),Cn&&Ls()}function da(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function Qt(n,e,t,i=!0){var r=(n&ui)!==0,s=fe,l={ctx:Fe,deps:null,nodes_start:null,nodes_end:null,f:n|mt,first:null,fn:e,last:null,next:null,parent:r?null:s,prev:null,teardown:null,transitions:null,wv:0};if(t){var a=Zt;try{Ln(!0),bn(l),l.f|=_r}catch(d){throw Pt(l),d}finally{Ln(a)}}else e!==null&&Hi(l);var c=t&&l.deps===null&&l.first===null&&l.nodes_start===null&&l.teardown===null&&(l.f&(wr|Si))===0;if(!c&&!r&&i&&(s!==null&&da(l,s),ve!==null&&ve.f&Xe)){var u=ve;(u.effects??(u.effects=[])).push(l)}return l}function Or(n){const e=Qt(Bi,null,!1);return ot(e,Re),e.teardown=n,e}function Nn(n){Br();var e=fe!==null&&(fe.f&gt)!==0&&Fe!==null&&!Fe.m;if(e){var t=Fe;(t.e??(t.e=[])).push({fn:n,effect:fe,reaction:ve})}else{var i=Yt(n);return i}}function fa(n){return Br(),fi(n)}function ha(n){const e=Qt(ui,n,!0);return(t={})=>new Promise(i=>{t.outro?Mt(e,()=>{Pt(e),i(void 0)}):(Pt(e),i(void 0))})}function Yt(n){return Qt(yr,n,!1)}function fi(n){return Qt(Bi,n,!0)}function M(n,e=[],t=si){const i=e.map(t);return $i(()=>n(...i.map(h)))}function $i(n,e=0){return Qt(Bi|Oi|e,n,!0)}function Bt(n,e=!0){return Qt(Bi|gt,n,!0,e)}function Nr(n){var e=n.teardown;if(e!==null){const t=Cn,i=ve;In(!0),Qe(null);try{e.call(null)}finally{In(t),Qe(i)}}}function Lr(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){var i=t.next;Pt(t,e),t=i}}function va(n){for(var e=n.first;e!==null;){var t=e.next;e.f&gt||Pt(e),e=t}}function Pt(n,e=!0){var t=!1;if((e||n.f&Bs)&&n.nodes_start!==null){for(var i=n.nodes_start,r=n.nodes_end;i!==null;){var s=i===r?null:Ri(i);i.remove(),i=s}t=!0}Lr(n,e&&!t),Ti(n,0),ot(n,Ni);var l=n.transitions;if(l!==null)for(const c of l)c.stop();Nr(n);var a=n.parent;a!==null&&a.first!==null&&Ir(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes_start=n.nodes_end=null}function Ir(n){var e=n.parent,t=n.prev,i=n.next;t!==null&&(t.next=i),i!==null&&(i.prev=t),e!==null&&(e.first===n&&(e.first=i),e.last===n&&(e.last=t))}function Mt(n,e){var t=[];kn(n,t,!0),Rr(t,()=>{Pt(n),e&&e()})}function Rr(n,e){var t=n.length;if(t>0){var i=()=>--t||e();for(var r of n)r.out(i)}else e()}function kn(n,e,t){if(!(n.f&vt)){if(n.f^=vt,n.transitions!==null)for(const l of n.transitions)(l.is_global||t)&&e.push(l);for(var i=n.first;i!==null;){var r=i.next,s=(i.f&Li)!==0||(i.f&gt)!==0;kn(i,e,s?t:!1),i=r}}}function Gt(n){$r(n,!0)}function $r(n,e){if(n.f&vt){n.f^=vt,n.f&Re||(n.f^=Re),hi(n)&&(ot(n,mt),Hi(n));for(var t=n.first;t!==null;){var i=t.next,r=(t.f&Li)!==0||(t.f&gt)!==0;$r(t,r?e:!1),t=i}if(n.transitions!==null)for(const s of n.transitions)(s.is_global||e)&&s.in()}}let bi=!1,rn=[];function Ur(){bi=!1;const n=rn.slice();rn=[],nn(n)}function Ot(n){bi||(bi=!0,queueMicrotask(Ur)),rn.push(n)}function pa(){bi&&Ur()}const Hr=0,ga=1;let yi=!1,_i=Hr,ai=!1,oi=null,Zt=!1,Cn=!1;function Ln(n){Zt=n}function In(n){Cn=n}let qt=[],Vt=0;let ve=null,rt=!1;function Qe(n){ve=n}let fe=null;function Ye(n){fe=n}let st=null;function ma(n){st=n}let Ie=null,ze=0,ut=null;function ya(n){ut=n}let jr=1,Ei=0,bt=!1,Ct=null;function Zr(){return++jr}function hi(n){var f;var e=n.f;if(e&mt)return!0;if(e&Wt){var t=n.deps,i=(e&We)!==0;if(t!==null){var r,s,l=(e&wi)!==0,a=i&&fe!==null&&!bt,c=t.length;if(l||a){var u=n,d=u.parent;for(r=0;r<c;r++)s=t[r],(l||!((f=s==null?void 0:s.reactions)!=null&&f.includes(u)))&&(s.reactions??(s.reactions=[])).push(u);l&&(u.f^=wi),a&&d!==null&&!(d.f&We)&&(u.f^=We)}for(r=0;r<c;r++)if(s=t[r],hi(s)&&Mr(s),s.wv>n.wv)return!0}(!i||fe!==null&&!bt)&&ot(n,Re)}return!1}function _a(n,e){for(var t=e;t!==null;){if(t.f&Si)try{t.fn(n);return}catch{t.f^=Si}t=t.parent}throw yi=!1,n}function Sa(n){return(n.f&Ni)===0&&(n.parent===null||(n.parent.f&Si)===0)}function Ui(n,e,t,i){if(yi){if(t===null&&(yi=!1),Sa(e))throw n;return}t!==null&&(yi=!0);{_a(n,e);return}}function Vr(n,e,t=!0){var i=n.reactions;if(i!==null)for(var r=0;r<i.length;r++){var s=i[r];s.f&Xe?Vr(s,e,!1):e===s&&(t?ot(s,mt):s.f&Re&&ot(s,Wt),Hi(s))}}function zr(n){var g;var e=Ie,t=ze,i=ut,r=ve,s=bt,l=st,a=Fe,c=rt,u=n.f;Ie=null,ze=0,ut=null,ve=u&(gt|ui)?null:n,bt=(u&We)!==0&&(!Zt||r===null||c),st=null,ki(n.ctx),rt=!1,Ei++;try{var d=(0,n.fn)(),f=n.deps;if(Ie!==null){var v;if(Ti(n,ze),f!==null&&ze>0)for(f.length=ze+Ie.length,v=0;v<Ie.length;v++)f[ze+v]=Ie[v];else n.deps=f=Ie;if(!bt)for(v=ze;v<f.length;v++)((g=f[v]).reactions??(g.reactions=[])).push(n)}else f!==null&&ze<f.length&&(Ti(n,ze),f.length=ze);if(Xt()&&ut!==null&&!rt&&f!==null&&!(n.f&(Xe|Wt|mt)))for(v=0;v<ut.length;v++)Vr(ut[v],n);return r!==null&&Ei++,d}finally{Ie=e,ze=t,ut=i,ve=r,bt=s,st=l,ki(a),rt=c}}function wa(n,e){let t=e.reactions;if(t!==null){var i=As.call(t,n);if(i!==-1){var r=t.length-1;r===0?t=e.reactions=null:(t[i]=t[r],t.pop())}}t===null&&e.f&Xe&&(Ie===null||!Ie.includes(e))&&(ot(e,Wt),e.f&(We|wi)||(e.f^=wi),qr(e),Ti(e,0))}function Ti(n,e){var t=n.deps;if(t!==null)for(var i=e;i<t.length;i++)wa(n,t[i])}function bn(n){var e=n.f;if(!(e&Ni)){ot(n,Re);var t=fe,i=Fe;fe=n;try{e&Oi?va(n):Lr(n),Nr(n);var r=zr(n);n.teardown=typeof r=="function"?r:null,n.wv=jr;var s=n.deps,l;tn&&zs&&n.f&mt}catch(a){Ui(a,n,t,i||n.ctx)}finally{fe=t}}}function Gr(){if(Vt>1e3){Vt=0;try{$s()}catch(n){if(oi!==null)Ui(n,oi,null);else throw n}}Vt++}function Kr(n){var e=n.length;if(e!==0){Gr();var t=Zt;Zt=!0;try{for(var i=0;i<e;i++){var r=n[i];r.f&Re||(r.f^=Re);var s=ba(r);ka(s)}}finally{Zt=t}}}function ka(n){var e=n.length;if(e!==0)for(var t=0;t<e;t++){var i=n[t];if(!(i.f&(Ni|vt)))try{hi(i)&&(bn(i),i.deps===null&&i.first===null&&i.nodes_start===null&&(i.teardown===null?Ir(i):i.fn=null))}catch(r){Ui(r,i,null,i.ctx)}}}function Ca(){if(ai=!1,Vt>1001)return;const n=qt;qt=[],Kr(n),ai||(Vt=0,oi=null)}function Hi(n){_i===Hr&&(ai||(ai=!0,queueMicrotask(Ca))),oi=n;for(var e=n;e.parent!==null;){e=e.parent;var t=e.f;if(t&(ui|gt)){if(!(t&Re))return;e.f^=Re}}qt.push(e)}function ba(n){var e=[],t=n.first;e:for(;t!==null;){var i=t.f,r=(i&gt)!==0,s=r&&(i&Re)!==0,l=t.next;if(!s&&!(i&vt)){if(i&yr)e.push(t);else if(r)t.f^=Re;else{var a=ve;try{ve=t,hi(t)&&bn(t)}catch(d){Ui(d,t,null,t.ctx)}finally{ve=a}}var c=t.first;if(c!==null){t=c;continue}}if(l===null){let d=t.parent;for(;d!==null;){if(n===d)break e;var u=d.next;if(u!==null){t=u;continue e}d=d.parent}}t=l}return e}function En(n){var e=_i,t=qt;try{Gr();const r=[];_i=ga,qt=r,ai=!1,Kr(t);var i=n==null?void 0:n();return pa(),(qt.length>0||r.length>0)&&En(),Vt=0,oi=null,i}finally{_i=e,qt=t}}async function Ea(){await Promise.resolve(),En()}function h(n){var e=n.f,t=(e&Xe)!==0;if(Ct!==null&&Ct.add(n),ve!==null&&!rt){st!==null&&st.includes(n)&&Zs();var i=ve.deps;n.rv<Ei&&(n.rv=Ei,Ie===null&&i!==null&&i[ze]===n?ze++:Ie===null?Ie=[n]:(!bt||!Ie.includes(n))&&Ie.push(n))}else if(t&&n.deps===null&&n.effects===null){var r=n,s=r.parent;s!==null&&!(s.f&We)&&(r.f^=We)}return t&&(r=n,hi(r)&&Mr(r)),n.v}function Ta(n){var e=Ct;Ct=new Set;var t=Ct,i;try{if(at(n),e!==null)for(i of Ct)e.add(i)}finally{Ct=e}return t}function Gc(n){var e=Ta(()=>at(n));for(var t of e)if(t.f&Sr)for(const i of t.deps||[])i.f&Xe||Et(i,i.v);else Et(t,t.v)}function at(n){var e=rt;try{return rt=!0,n()}finally{rt=e}}const Aa=-7169;function ot(n,e){n.f=n.f&Aa|e}function Pa(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(pt in n)sn(n);else if(!Array.isArray(n))for(let e in n){const t=n[e];typeof t=="object"&&t&&pt in t&&sn(t)}}}function sn(n,e=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!e.has(n)){e.add(n),n instanceof Date&&n.getTime();for(let i in n)try{sn(n[i],e)}catch{}const t=yn(n);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const i=mr(t);for(let r in i){const s=i[r].get;if(s)try{s.call(n)}catch{}}}}}const Da=["touchstart","touchmove"];function Fa(n){return Da.includes(n)}let Rn=!1;function xa(){Rn||(Rn=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Tn(n){var e=ve,t=fe;Qe(null),Ye(null);try{return n()}finally{Qe(e),Ye(t)}}function ji(n,e,t,i=t){n.addEventListener(e,()=>Tn(t));const r=n.__on_r;r?n.__on_r=()=>{r(),i(!0)}:n.__on_r=()=>i(!0),xa()}const Wr=new Set,an=new Set;function qa(n,e,t,i={}){function r(s){if(i.capture||ei.call(e,s),!s.cancelBubble)return Tn(()=>t==null?void 0:t.call(this,s))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Ot(()=>{e.addEventListener(n,r,i)}):e.addEventListener(n,r,i),r}function je(n,e,t,i,r){var s={capture:i,passive:r},l=qa(n,e,t,s);(e===document.body||e===window||e===document)&&Or(()=>{e.removeEventListener(n,l,s)})}function Jt(n){for(var e=0;e<n.length;e++)Wr.add(n[e]);for(var t of an)t(n)}function ei(n){var w;var e=this,t=e.ownerDocument,i=n.type,r=((w=n.composedPath)==null?void 0:w.call(n))||[],s=r[0]||n.target,l=0,a=n.__root;if(a){var c=r.indexOf(a);if(c!==-1&&(e===document||e===window)){n.__root=e;return}var u=r.indexOf(e);if(u===-1)return;c<=u&&(l=c)}if(s=r[l]||n.target,s!==e){Ps(n,"currentTarget",{configurable:!0,get(){return s||t}});var d=ve,f=fe;Qe(null),Ye(null);try{for(var v,g=[];s!==null;){var m=s.assignedSlot||s.parentNode||s.host||null;try{var S=s["__"+i];if(S!==void 0&&!s.disabled)if(gn(S)){var[p,...C]=S;p.apply(s,[n,...C])}else S.call(s,n)}catch(b){v?g.push(b):v=b}if(n.cancelBubble||m===e||m===null)break;s=m}if(v){for(let b of g)queueMicrotask(()=>{throw b});throw v}}finally{n.__root=e,delete n.currentTarget,Qe(d),Ye(f)}}}function Ma(n){var e=document.createElement("template");return e.innerHTML=n,e.content}function Ai(n,e){var t=fe;t.nodes_start===null&&(t.nodes_start=n,t.nodes_end=e)}function A(n,e){var t=(e&ra)!==0,i=(e&sa)!==0,r,s=!n.startsWith("<!>");return()=>{r===void 0&&(r=Ma(s?n:"<!>"+n),t||(r=Ci(r)));var l=i||Dr?document.importNode(r,!0):r.cloneNode(!0);if(t){var a=Ci(l),c=l.lastChild;Ai(a,c)}else Ai(l,l);return l}}function Ba(n=""){{var e=Ii(n+"");return Ai(e,e),e}}function _e(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Ii();return n.append(e,t),Ai(e,t),n}function _(n,e){n!==null&&n.before(e)}let on=!0;function F(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Kc(n,e){return Oa(n,e)}const Lt=new Map;function Oa(n,{target:e,anchor:t,props:i={},events:r,context:s,intro:l=!0}){oa();var a=new Set,c=f=>{for(var v=0;v<f.length;v++){var g=f[v];if(!a.has(g)){a.add(g);var m=Fa(g);e.addEventListener(g,ei,{passive:m});var S=Lt.get(g);S===void 0?(document.addEventListener(g,ei,{passive:m}),Lt.set(g,1)):Lt.set(g,S+1)}}};c(mn(Wr)),an.add(c);var u=void 0,d=ha(()=>{var f=t??e.appendChild(Ii());return Bt(()=>{if(s){Je({});var v=Fe;v.c=s}r&&(i.$$events=r),on=l,u=n(f,i)||{},on=!0,s&&et()}),()=>{var m;for(var v of a){e.removeEventListener(v,ei);var g=Lt.get(v);--g===0?(document.removeEventListener(v,ei),Lt.delete(v)):Lt.set(v,g)}an.delete(c),f!==t&&((m=f.parentNode)==null||m.removeChild(f))}});return Na.set(u,d),u}let Na=new WeakMap;const zi=0,pi=1,Gi=2;function Wc(n,e,t,i,r){var s=n,l=Xt(),a=Fe,c=Oe,u,d,f,v=(l?Le:ri)(void 0),g=(l?Le:ri)(void 0),m=!1;function S(C,w){m=!0,w&&(Ye(p),Qe(p),ki(a));try{C===zi&&t&&(u?Gt(u):u=Bt(()=>t(s))),C===pi&&i&&(d?Gt(d):d=Bt(()=>i(s,v))),C!==zi&&u&&Mt(u,()=>u=null),C!==pi&&d&&Mt(d,()=>d=null),C!==Gi&&f&&Mt(f,()=>f=null)}finally{w&&(ki(null),Qe(null),Ye(null),En())}}var p=$i(()=>{if(c!==(c=e())){if(qs(c)){var C=c;m=!1,C.then(w=>{C===c&&(Et(v,w),S(pi,!0))},w=>{if(C===c)throw Et(g,w),S(Gi,!0),g.v}),Ot(()=>{m||S(zi,!0)})}else Et(v,c),S(pi,!1);return()=>c=Oe}})}function B(n,e,t=!1){var i=n,r=null,s=null,l=Oe,a=t?Li:0,c=!1;const u=(f,v=!0)=>{c=!0,d(v,f)},d=(f,v)=>{l!==(l=f)&&(l?(r?Gt(r):v&&(r=Bt(()=>v(i))),s&&Mt(s,()=>{s=null})):(s?Gt(s):v&&(s=Bt(()=>v(i))),r&&Mt(r,()=>{r=null})))};$i(()=>{c=!1,e(u),c||d(null,null)},a)}function le(n,e){return e}function La(n,e,t,i){for(var r=[],s=e.length,l=0;l<s;l++)kn(e[l].e,r,!0);var a=s>0&&r.length===0&&t!==null;if(a){var c=t.parentNode;la(c),c.append(t),i.clear(),St(n,e[0].prev,e[s-1].next)}Rr(r,()=>{for(var u=0;u<s;u++){var d=e[u];a||(i.delete(d.k),St(n,d.prev,d.next)),Pt(d.e,!a)}})}function ce(n,e,t,i,r,s=null){var l=n,a={flags:e,items:new Map,first:null},c=(e&br)!==0;if(c){var u=n;l=u.appendChild(Ii())}var d=null,f=!1,v=ue(()=>{var g=t();return gn(g)?g:g==null?[]:mn(g)});$i(()=>{var g=h(v),m=g.length;f&&m===0||(f=m===0,Ia(g,a,l,r,e,i,t),s!==null&&(m===0?d?Gt(d):d=Bt(()=>s(l)):d!==null&&Mt(d,()=>{d=null})),h(v))})}function Ia(n,e,t,i,r,s,l){var K,V,ie,he;var a=(r&Ks)!==0,c=(r&(Sn|wn))!==0,u=n.length,d=e.items,f=e.first,v=f,g,m=null,S,p=[],C=[],w,b,P,q;if(a)for(q=0;q<u;q+=1)w=n[q],b=s(w,q),P=d.get(b),P!==void 0&&((K=P.a)==null||K.measure(),(S??(S=new Set)).add(P));for(q=0;q<u;q+=1){if(w=n[q],b=s(w,q),P=d.get(b),P===void 0){var Z=v?v.e.nodes_start:t;m=$a(Z,e,m,m===null?e.first:m.next,w,b,q,i,r,l),d.set(b,m),p=[],C=[],v=m.next;continue}if(c&&Ra(P,w,q,r),P.e.f&vt&&(Gt(P.e),a&&((V=P.a)==null||V.unfix(),(S??(S=new Set)).delete(P))),P!==v){if(g!==void 0&&g.has(P)){if(p.length<C.length){var ee=C[0],N;m=ee.prev;var H=p[0],$=p[p.length-1];for(N=0;N<p.length;N+=1)$n(p[N],ee,t);for(N=0;N<C.length;N+=1)g.delete(C[N]);St(e,H.prev,$.next),St(e,m,H),St(e,$,ee),v=ee,m=$,q-=1,p=[],C=[]}else g.delete(P),$n(P,v,t),St(e,P.prev,P.next),St(e,P,m===null?e.first:m.next),St(e,m,P),m=P;continue}for(p=[],C=[];v!==null&&v.k!==b;)v.e.f&vt||(g??(g=new Set)).add(v),C.push(v),v=v.next;if(v===null)continue;P=v}p.push(P),m=P,v=P.next}if(v!==null||g!==void 0){for(var O=g===void 0?[]:mn(g);v!==null;)v.e.f&vt||O.push(v),v=v.next;var Pe=O.length;if(Pe>0){var Be=r&br&&u===0?t:null;if(a){for(q=0;q<Pe;q+=1)(ie=O[q].a)==null||ie.measure();for(q=0;q<Pe;q+=1)(he=O[q].a)==null||he.fix()}La(e,O,Be,d)}}a&&Ot(()=>{var ke;if(S!==void 0)for(P of S)(ke=P.a)==null||ke.apply()}),fe.first=e.first&&e.first.e,fe.last=m&&m.e}function Ra(n,e,t,i){i&Sn&&Et(n.v,e),i&wn?Et(n.i,t):n.i=t}function $a(n,e,t,i,r,s,l,a,c,u){var d=(c&Sn)!==0,f=(c&Ws)===0,v=d?f?ri(r):Le(r):r,g=c&wn?Le(l):l,m={i:g,v,k:s,a:null,e:null,prev:t,next:i};try{return m.e=Bt(()=>a(n,v,g,u),Ar),m.e.prev=t&&t.e,m.e.next=i&&i.e,t===null?e.first=m:(t.next=m,t.e.next=m.e),i!==null&&(i.prev=m,i.e.prev=m.e),m}finally{}}function $n(n,e,t){for(var i=n.next?n.next.e.nodes_start:t,r=e?e.e.nodes_start:t,s=n.e.nodes_start;s!==i;){var l=Ri(s);r.before(s),s=l}}function St(n,e,t){e===null?n.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function Xr(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=Xr(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function Ua(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=Xr(n))&&(i&&(i+=" "),i+=e);return i}function It(n){return typeof n=="object"?Ua(n):n??""}function li(n,e,t,i){var r=n.__attributes??(n.__attributes={});r[e]!==(r[e]=t)&&(e==="style"&&"__styles"in n&&(n.__styles={}),e==="loading"&&(n[Ns]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Ha(n).includes(e)?n[e]=t:n.setAttribute(e,t))}var Un=new Map;function Ha(n){var e=Un.get(n.nodeName);if(e)return e;Un.set(n.nodeName,e=[]);for(var t,i=n,r=Element.prototype;r!==i;){t=mr(i);for(var s in t)t[s].set&&e.push(s);i=yn(i)}return e}function ge(n,e,t){var i=n.__className,r=ja(e,t);(i!==r||Ar)&&(e==null&&!t?n.removeAttribute("class"):n.className=r,n.__className=r)}function ja(n,e){return(n??"")+(e?" "+e:"")}const Za=()=>performance.now(),ht={tick:n=>requestAnimationFrame(n),now:()=>Za(),tasks:new Set};function Qr(){const n=ht.now();ht.tasks.forEach(e=>{e.c(n)||(ht.tasks.delete(e),e.f())}),ht.tasks.size!==0&&ht.tick(Qr)}function Va(n){let e;return ht.tasks.size===0&&ht.tick(Qr),{promise:new Promise(t=>{ht.tasks.add(e={c:n,f:t})}),abort(){ht.tasks.delete(e)}}}function gi(n,e){Tn(()=>{n.dispatchEvent(new CustomEvent(e))})}function za(n){if(n==="float")return"cssFloat";if(n==="offset")return"cssOffset";if(n.startsWith("--"))return n;const e=n.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function Hn(n){const e={},t=n.split(";");for(const i of t){const[r,s]=i.split(":");if(!r||s===void 0)break;const l=za(r.trim());e[l]=s.trim()}return e}const Ga=n=>n;function Rt(n,e,t,i){var r=(n&ta)!==0,s=(n&ia)!==0,l=r&&s,a=(n&na)!==0,c=l?"both":r?"in":"out",u,d=e.inert,f=e.style.overflow,v,g;function m(){var b=ve,P=fe;Qe(null),Ye(null);try{return u??(u=t()(e,(i==null?void 0:i())??{},{direction:c}))}finally{Qe(b),Ye(P)}}var S={is_global:a,in(){var b;if(e.inert=d,!r){g==null||g.abort(),(b=g==null?void 0:g.reset)==null||b.call(g);return}s||v==null||v.abort(),gi(e,"introstart"),v=ln(e,m(),g,1,()=>{gi(e,"introend"),v==null||v.abort(),v=u=void 0,e.style.overflow=f})},out(b){if(!s){b==null||b(),u=void 0;return}e.inert=!0,gi(e,"outrostart"),g=ln(e,m(),v,0,()=>{gi(e,"outroend"),b==null||b()})},stop:()=>{v==null||v.abort(),g==null||g.abort()}},p=fe;if((p.transitions??(p.transitions=[])).push(S),r&&on){var C=a;if(!C){for(var w=p.parent;w&&w.f&Li;)for(;(w=w.parent)&&!(w.f&Oi););C=!w||(w.f&_r)!==0}C&&Yt(()=>{at(()=>S.in())})}}function ln(n,e,t,i,r){var s=i===1;if(xs(e)){var l,a=!1;return Ot(()=>{if(!a){var p=e({direction:s?"in":"out"});l=ln(n,p,t,i,r)}}),{abort:()=>{a=!0,l==null||l.abort()},deactivate:()=>l.deactivate(),reset:()=>l.reset(),t:()=>l.t()}}if(t==null||t.deactivate(),!(e!=null&&e.duration))return r(),{abort:wt,deactivate:wt,reset:wt,t:()=>i};const{delay:c=0,css:u,tick:d,easing:f=Ga}=e;var v=[];if(s&&t===void 0&&(d&&d(0,1),u)){var g=Hn(u(0,1));v.push(g,g)}var m=()=>1-i,S=n.animate(v,{duration:c});return S.onfinish=()=>{var p=(t==null?void 0:t.t())??1-i;t==null||t.abort();var C=i-p,w=e.duration*Math.abs(C),b=[];if(w>0){var P=!1;if(u)for(var q=Math.ceil(w/16.666666666666668),Z=0;Z<=q;Z+=1){var ee=p+C*f(Z/q),N=Hn(u(ee,1-ee));b.push(N),P||(P=N.overflow==="hidden")}P&&(n.style.overflow="hidden"),m=()=>{var H=S.currentTime;return p+C*f(H/w)},d&&Va(()=>{if(S.playState!=="running")return!1;var H=m();return d(H,1-H),!0})}S=n.animate(b,{duration:w,fill:"forwards"}),S.onfinish=()=>{m=()=>i,d==null||d(i,1-i),r()}},{abort:()=>{S&&(S.cancel(),S.effect=null,S.onfinish=wt)},deactivate:()=>{r=wt},reset:()=>{i===0&&(d==null||d(1,0))},t:()=>m()}}function Xc(n,e,t=e){var i=Xt();ji(n,"input",r=>{var s=r?n.defaultValue:n.value;if(s=Wi(n)?Xi(s):s,t(s),i&&s!==(s=e())){var l=n.selectionStart,a=n.selectionEnd;n.value=s??"",a!==null&&(n.selectionStart=l,n.selectionEnd=Math.min(a,n.value.length))}}),at(e)==null&&n.value&&t(Wi(n)?Xi(n.value):n.value),fi(()=>{var r=e();Wi(n)&&r===Xi(n.value)||n.type==="date"&&!r&&!n.value||r!==n.value&&(n.value=r??"")})}const Ki=new Set;function Qc(n,e,t,i,r=i){var s=t.getAttribute("type")==="checkbox",l=n;if(e!==null)for(var a of e)l=l[a]??(l[a]=[]);l.push(t),ji(t,"change",()=>{var c=t.__value;s&&(c=Ka(l,c,t.checked)),r(c)},()=>r(s?[]:null)),fi(()=>{var c=i();s?(c=c||[],t.checked=c.includes(t.__value)):t.checked=Pr(t.__value,c)}),Or(()=>{var c=l.indexOf(t);c!==-1&&l.splice(c,1)}),Ki.has(l)||(Ki.add(l),Ot(()=>{l.sort((c,u)=>c.compareDocumentPosition(u)===4?-1:1),Ki.delete(l)})),Ot(()=>{})}function Yc(n,e,t=e){ji(n,"change",i=>{var r=i?n.defaultChecked:n.checked;t(r)}),at(e)==null&&t(n.checked),fi(()=>{var i=e();n.checked=!!i})}function Ka(n,e,t){for(var i=new Set,r=0;r<n.length;r+=1)n[r].checked&&i.add(n[r].__value);return t||i.delete(e),Array.from(i)}function Wi(n){var e=n.type;return e==="number"||e==="range"}function Xi(n){return n===""?null:+n}function Yr(n,e,t){if(n.multiple)return Xa(n,e);for(var i of n.options){var r=ii(i);if(Pr(r,e)){i.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Wa(n,e){Yt(()=>{var t=new MutationObserver(()=>{var i=n.__value;Yr(n,i)});return t.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{t.disconnect()}})}function Jc(n,e,t=e){var i=!0;ji(n,"change",r=>{var s=r?"[selected]":":checked",l;if(n.multiple)l=[].map.call(n.querySelectorAll(s),ii);else{var a=n.querySelector(s)??n.querySelector("option:not([disabled])");l=a&&ii(a)}t(l)}),Yt(()=>{var r=e();if(Yr(n,r,i),i&&r===void 0){var s=n.querySelector(":checked");s!==null&&(r=ii(s),t(r))}n.__value=r,i=!1}),Wa(n)}function Xa(n,e){for(var t of n.options)t.selected=~e.indexOf(ii(t))}function ii(n){return"__value"in n?n.__value:n.value}function jn(n,e){return n===e||(n==null?void 0:n[pt])===e}function Qa(n={},e,t,i){return Yt(()=>{var r,s;return fi(()=>{r=s,s=[],at(()=>{n!==t(...s)&&(e(n,...s),r&&jn(t(...r),n)&&e(null,...r))})}),()=>{Ot(()=>{s&&jn(t(...s),n)&&e(null,...s)})}}),n}function lt(n=!1){const e=Fe,t=e.l.u;if(!t)return;let i=()=>Pa(e.s);if(n){let r=0,s={};const l=si(()=>{let a=!1;const c=e.s;for(const u in c)c[u]!==s[u]&&(s[u]=c[u],a=!0);return a&&r++,r});i=()=>h(l)}t.b.length&&fa(()=>{Zn(e,i),nn(t.b)}),Nn(()=>{const r=at(()=>t.m.map(Ms));return()=>{for(const s of r)typeof s=="function"&&s()}}),t.a.length&&Nn(()=>{Zn(e,i),nn(t.a)})}function Zn(n,e){if(n.l.s)for(const t of n.l.s)h(t);e()}const $t=[];function Ya(n,e=wt){let t=null;const i=new Set;function r(a){if(Cr(n,a)&&(n=a,t)){const c=!$t.length;for(const u of i)u[1](),$t.push(u,n);if(c){for(let u=0;u<$t.length;u+=2)$t[u][0]($t[u+1]);$t.length=0}}}function s(a){r(a(n))}function l(a,c=wt){const u=[a,c];return i.add(u),i.size===1&&(t=e(r,s)||wt),a(n),()=>{i.delete(u),i.size===0&&t&&(t(),t=null)}}return{set:r,update:s,subscribe:l}}let mi=!1;function Ja(n){var e=mi;try{return mi=!1,[n(),mi]}finally{mi=e}}function ye(n,e,t,i){var ee;var r=(t&Xs)!==0,s=!di||(t&Qs)!==0,l=(t&Js)!==0,a=(t&ea)!==0,c=!1,u;l?[u,c]=Ja(()=>n[e]):u=n[e];var d=pt in n||Os in n,f=l&&(((ee=jt(n,e))==null?void 0:ee.set)??(d&&e in n&&(N=>n[e]=N)))||void 0,v=i,g=!0,m=!1,S=()=>(m=!0,g&&(g=!1,a?v=at(i):v=i),v);u===void 0&&i!==void 0&&(f&&s&&Us(),u=S(),f&&f(u));var p;if(s)p=()=>{var N=n[e];return N===void 0?S():(g=!0,m=!1,N)};else{var C=(r?si:ue)(()=>n[e]);C.f|=Sr,p=()=>{var N=h(C);return N!==void 0&&(v=void 0),N===void 0?v:N}}if(!(t&Ys))return p;if(f){var w=n.$$legacy;return function(N,H){return arguments.length>0?((!s||!H||w||c)&&f(H?p():N),N):p()}}var b=!1,P=!1,q=ri(u),Z=si(()=>{var N=p(),H=h(q);return b?(b=!1,P=!0,H):(P=!1,q.v=N)});return r||(Z.equals=_n),function(N,H){if(Ct!==null&&(b=P,p(),h(q)),arguments.length>0){const $=H?h(Z):s&&l?kt(N):N;return Z.equals($)||(b=!0,x(q,$),m&&v!==void 0&&(v=$),at(()=>h(Z))),N}return h(Z)}}const eo="5";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(eo);Gs();class eu{constructor(e,t,i){o(this,"_dbname");o(this,"_dbversion");o(this,"dbPromise");o(this,"getTran",async(e,t)=>(await this.dbPromise).transaction(e,t));o(this,"reset",async()=>(await indexedDB.databases().then(e=>{console.log(e)}),await new Promise((e,t)=>{const i=indexedDB.deleteDatabase(this._dbname);i.onsuccess=()=>{console.log("onsuccess"),e()},i.onerror=r=>{console.log("onerror"),t(r)}})));o(this,"getAll",async e=>{const t=await this.dbPromise;return new Promise((i,r)=>{const a=t.transaction([e],"readonly").objectStore(e).getAll();a.onsuccess=()=>{i(a.result)},a.onerror=c=>{r(c)}})});o(this,"get",async(e,t)=>{const i=await this.dbPromise;return new Promise((r,s)=>{const c=i.transaction([e],"readonly").objectStore(e).get(t);c.onsuccess=()=>{r(c.result)},c.onerror=u=>{s(u)}})});o(this,"getMany",async(e,t)=>{const s=(await this.dbPromise).transaction([e],"readonly").objectStore(e),l=t.map(a=>new Promise((c,u)=>{const d=s.get(a);d.onsuccess=()=>{c(d.result)},d.onerror=f=>{u(f)}}));return await Promise.all(l)});o(this,"putRecords",async(e,t)=>{const r=(await this.dbPromise).transaction([e],"readwrite"),s=r.objectStore(e),l=t.map(a=>({record:a,request:s.put(a)}));return new Promise((a,c)=>{r.oncomplete=()=>a(l.map(u=>Object.assign({id:u.request.result},u.record))),r.onerror=u=>c(u)})});o(this,"deleteRecords",async(e,t)=>{const r=(await this.dbPromise).transaction([e],"readwrite"),s=r.objectStore(e),l=t.map(a=>({key:a,request:s.delete(a)}));return new Promise((a,c)=>{r.oncomplete=()=>{console.log(l.map(u=>u.request.result)),a()},r.onerror=u=>c(u)})});this._dbname=e,this._dbversion=t,this.dbPromise=new Promise((r,s)=>{const l=indexedDB.open(e,t);l.onsuccess=a=>{if(console.log(a),!a.target){console.log("event.target is undefined"),s("event.target is undefined");return}const c=a.target.result;if(!c){console.log("event.target.result is undefined"),s("event.target.result is undefined");return}c.onversionchange=u=>{console.log(u),c.close()},r(c)},l.onupgradeneeded=a=>{console.log("onupgradeneeded");const c=a.target.result;i.filter(u=>!c.objectStoreNames.contains(u)).map(u=>c.createObjectStore(u,{keyPath:"id",autoIncrement:!0}))},l.onerror=a=>{console.log(a),s(a)},l.onblocked=a=>{console.log(a),s(a)}}),console.log(this.dbPromise)}get dbversion(){return this._dbversion}}class Ae{constructor(){o(this,"handlers",[])}append(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter(t=>t!==e)}trigger(e){this.handlers.slice(0).filter(t=>t(e)==="RemoveMe").forEach(t=>this.remove(t))}clear(){this.handlers.splice(0)}expose(){return this}}class Vn{constructor(){o(this,"handlers",[])}append(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter(t=>t!==e)}async trigger(e){(await Promise.all(this.handlers.slice(0).map(async i=>{const r=await i(e);return{h:i,result:r}}))).filter(i=>i.result==="RemoveMe").map(i=>i.h).forEach(i=>this.remove(i))}clear(){this.handlers.splice(0)}expose(){return this}}class zn{constructor(){o(this,"handler")}set(e){this.handler=e}async call(e){if(!this.handler)throw Error("illegal state error");return await this.handler(e)}expose(){return this}}class An{constructor(e,t,i,r){o(this,"_name");o(this,"_createVersion");o(this,"mountResolver",()=>{});o(this,"_indexedDb");o(this,"onInsertEvent",new Ae);o(this,"onBeforeInsertEvent",new zn);o(this,"onUpdateEvent",new Ae);o(this,"onBeforeUpdateEvent",new zn);o(this,"onDeleteEvent",new Ae);o(this,"prepareInitialRecords",()=>{const e=new Date;return this._prepareInitialRecords().map(t=>Object.assign(t,{createdAt:e,updatedAt:e,dbVersion:this._createVersion}))});o(this,"resolveMount",()=>this.mountResolver());o(this,"patchForInsert",(e,t)=>{e.newRecords.forEach(i=>{t[i.id]=i})});o(this,"patchForUpdate",(e,t)=>{e.recordPairs.forEach(i=>{t[i.newRecord.id]={...i.newRecord}})});o(this,"patchForDelete",(e,t)=>{e.oldRecords.forEach(i=>{delete t[i.id]})});this._indexedDb=e,this._name=t,this._createVersion=e.dbversion,this.getAll().then(s=>s.reduce((l,a)=>(l[a.id]=a,l),{})).then(s=>{console.log(this.name,s),this.onBeforeInsertEvent.set(i??(()=>Promise.resolve())),this.onBeforeUpdateEvent.set(r??(()=>Promise.resolve()))})}get name(){return this._name}get createVersion(){return this._createVersion}get oninsert(){return this.onInsertEvent.expose()}get onbeforeinsert(){return this.onBeforeInsertEvent.expose()}get onupdate(){return this.onUpdateEvent.expose()}get onbeforeupdate(){return this.onBeforeUpdateEvent.expose()}get ondelete(){return this.onDeleteEvent.expose()}getAll(){return this._indexedDb.getAll(this.name)}get(e){return this._indexedDb.get(this.name,e)}async insertMany(e){const t=new Date,i=e.map(s=>{const l={createdAt:t,updatedAt:t,dbVersion:this._createVersion};return Object.assign(s,l)});await this.onBeforeInsertEvent.call({sender:this,newRecords:i,timestamp:t});const r=await this._indexedDb.putRecords(this.name,i);return this.onInsertEvent.trigger({sender:this,newRecords:r,timestamp:t}),r}async insert(e){return(await this.insertMany([e]))[0]}async updateMany(e,t){const i=new Date,r=[];return(await this._indexedDb.getMany(this.name,e)).forEach(l=>{const a={...l},c={...a};r.push({newRecord:Object.assign(t(c),{updatedAt:i,dbVersion:this._createVersion}),oldRecord:a})}),await this.onBeforeUpdateEvent.call({sender:this,recordPairs:r,timestamp:i}),await this._indexedDb.putRecords(this.name,r.map(l=>l.newRecord)),this.onUpdateEvent.trigger({sender:this,recordPairs:r,timestamp:i}),r.map(l=>l.newRecord)}async update(e,t){return(await this.updateMany([e],t))[0]}async delete(e){const t=new Date,i=await this._indexedDb.getMany(this.name,e);await this._indexedDb.deleteRecords(this.name,e),this.onDeleteEvent.trigger({sender:this,oldRecords:i,timestamp:t})}}const Pi=(...n)=>n.length?n.reduce((e,t)=>e>t?e:t):-Number.MAX_VALUE,cn=(...n)=>n.length?n.reduce((e,t)=>e<t?e:t):Number.MAX_VALUE,Ut=(n,e)=>{if((n[0]??Number.MAX_VALUE)>e)return 0;if(n.slice(-1)[0]<e)return n.length;let t=0,i=n.length-1;for(;;){const r=Math.round((t+i)/2);if(r===i||r===t)return n[t]<e?i:t;if(n[r]<e){t=r;continue}i=r}},it=[3,5,5,6,6,6,7,8,9,10,11,11,11,12,12,13,13,14,15,15,15,15,15,15,16,16,16,17,18,18,18,21,21,21,22,23,25,25,26,28,28,28,30,30,31,32,32,33,33,34,35,35,36,36,36,37,37,38,38,38,39,41,42,42,43,45,45,45,45,48,48,48,50,51,52,54,54,54,54,56,57,58,59,59,59,59,60,61,63,65,65,65,65,66,67,67,67,69,69,71,71,72,73,73,73,73,73,74,75,75,76,76,77,78,79,80,80,80,80,84,84,84,84,84,84,85,85,85,87,90,91,94,96,96,97,98,101,101,101,101,101];console.log(it.length);it.forEach((n,e)=>{((it[Ut(it,e)-1]||-Number.MAX_VALUE)>=e||(it[Ut(it,e)]||Number.MAX_VALUE)<e)&&console.log(e,Ut(it,e),(it[Ut(it,e)-1]||-Number.MAX_VALUE)<e,(it[Ut(it,e)]||Number.MAX_VALUE)>=e)});const Ke=class Ke{constructor(e){o(this,"id");o(this,"name");o(this,"description");o(this,"previousNpcId");o(this,"previousNpcDeckId");o(this,"previousStartMode");o(this,"save",async e=>{console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER);const t=e??{id:this.id,name:this.name,description:this.description,previousNpcId:this.previousNpcId,previousStartMode:this.previousStartMode,previousNpcDeckId:this.previousNpcDeckId>-1?this.previousNpcDeckId:Number.MIN_SAFE_INTEGER};console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER,t);const i=await Ke.tblHeader.update(this.id,r=>({...r,...t}));return console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER,t,i),new Ke(i)});var t;this.id=e.id,this.name=e.name,this.description=e.description,this.previousNpcId=((t=Kn.find(i=>i.id===e.previousNpcId))==null?void 0:t.id)??cn(...Kn.map(i=>i.id)),this.previousStartMode=Wo.includes(e.previousStartMode)?e.previousStartMode:"Random",this.previousNpcDeckId=e.previousNpcDeckId}get npcLvl(){return Number.MAX_VALUE}};o(Ke,"tblHeader"),o(Ke,"getOrCreateNew",async e=>{Ke.tblHeader||(Ke.tblHeader=new to(e));const t=await Ke.tblHeader.getAll();if(t.length)return console.log(t[0].previousNpcDeckId),new Ke(t[0]);const i=await Ke.tblHeader.insert({name:"あなた",description:"ここの文字列を何に使うかは未定。",previousNpcId:0,previousNpcDeckId:Number.MIN_SAFE_INTEGER,previousStartMode:"Random"});return new Ke(i)});let Gn=Ke;class to extends An{constructor(t){super(t,"TblDuelistProfile");o(this,"_prepareInitialRecords",()=>[])}}let Qi=-1;const Kn=[{id:Qi--,name:"サンドバッグくん棒立ち",description:"攻撃宣言なし、強制効果以外の効果の発動なし。",npcLvl:0},{id:Qi--,name:"サンドバッグくん非暴力",description:"攻撃宣言なし。",npcLvl:100},{id:Qi--,name:"サンドバッグくん白帯",description:"とくに制限なし。",npcLvl:200}],Fi=class Fi{constructor(e,t,i){o(this,"seq");o(this,"entity");o(this,"_definition");o(this,"validateDuelist",e=>this.entity.controller===e?this.definition.executableDuelistTypes.includes("Controller"):this.definition.executableDuelistTypes.includes("Opponent"));this.seq=e==="AutoSeq"?Fi.nextSeq++:e,this.entity=t,this._definition=i}get definition(){return this._definition}get title(){return this.definition.title}get isMandatory(){return this.definition.isMandatory}get executableCells(){return this.definition.executableCells}get executablePeriods(){return this.definition.executablePeriods}get executableDuelistTypes(){return this.definition.executableDuelistTypes}get isOnlyNTimesPerDuel(){return this.definition.isOnlyNTimesPerDuel??0}get isOnlyNTimesPerTurn(){return this.definition.isOnlyNTimesPerTurn??0}get isOnlyNTimesPerTurnIfFaceup(){return this.definition.isOnlyNTimesPerTurnIfFaceup??0}get isOnlyNTimesIfFaceup(){return this.definition.isOnlyNTimesIfFaceup??0}get isOnlyNTimesPerChain(){return this.definition.isOnlyNTimesPerChain??0}get actionGroupName(){return this.definition.actionGroupName}get duel(){return this.entity.duel}};o(Fi,"nextSeq",0);let Di=Fi;const oe=class oe{constructor(){}};o(oe,"_tryMarkForDestory",(e,t)=>{if(e.info.isDying||e.kind==="XyzMaterial"||!e.isOnFieldStrictly&&e.fieldCell.cellType!=="Deck"&&e.fieldCell.cellType!=="Hand")return!1;const i=t.action.playType==="Battle"?"BattleDestroy":"EffectDestroy",r=i==="BattleDestroy"&&t.action.entity===e?t.selectedEntities[0]:t.action.entity;return e.info.isDying=e.validateDestory(i,t.activator,r,t.action),e.info.isDying&&(e.info.causeOfDeath=[i],e.info.isKilledBy=r,e.info.isKilledByWhom=t.activator,i==="BattleDestroy"&&(e.info.isKilledByWhom=r.controller)),e.info.isDying}),o(oe,"releaseManyForTheSameReason",(e,t,i,r)=>e.length?(t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をリリースし――、`),oe.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",["Release",...t],i,r)):Promise.resolve()),o(oe,"sendManyToGraveyardForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&(t.includes("FusionMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を融合素材とし――、`):t.includes("SyncroMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をシンクロと素材し――、`):t.includes("LinkMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をリンクマーカーにセッティング――、`):r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を墓地に送り――、`)),oe.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",t,i,r)):Promise.resolve()),o(oe,"addManyToHand",(e,t,i,r)=>e.length?oe.bringManyToSameCellForTheSameReason("Hand","Bottom",e,"FaceDown","Vertical",t,i,r):Promise.resolve()),o(oe,"discardManyForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を手札から捨て――、`),oe.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",["Discard",...t],i,r)):Promise.resolve()),o(oe,"banishManyForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をゲームから除外し――、`),oe.bringManyToSameCellForTheSameReason("Banished","Top",e,"FaceUp","Vertical",t,i,r)):Promise.resolve()),o(oe,"returnManyToDeckForTheSameReason",(e,t,i,r,s)=>t.length?(s&&i.includes("Cost")&&s.writeInfoLog(`${t.map(l=>l.toString()).join(" ")}をデッキに戻し――、`),oe.bringManyToSameCellForTheSameReason("Deck",e,t,"FaceDown","Vertical",i,r,s)):Promise.resolve()),o(oe,"returnManyToHandForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を手札に戻し――、`),oe.bringManyToSameCellForTheSameReason("Hand","Bottom",e,"FaceDown","Vertical",t,i,r)):Promise.resolve()),o(oe,"convertManyToXyzMaterials",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}によって、オーバーレイネットワークを構築――、`),ne.moveMany(e.map(s=>[s,s.fieldCell,"XyzMaterial","FaceUp","Vertical","Top",t,i,r,r]))):Promise.resolve()),o(oe,"moveToXyzOwner",(e,t,i,r,s)=>t.length?(i.includes("Effect")&&s.writeInfoLog(`${t.map(l=>l.toString()).join(" ")}をXYZ素材として吸収。`),ne.moveMany(t.map(l=>[l,e,"XyzMaterial","FaceUp","Vertical","Top",i,r,s,s]))):Promise.resolve()),o(oe,"banishMany",(e,t)=>ne.bringManyToSameCell("Banished","Top",e.map(i=>({...i,face:"FaceUp",orientation:"Vertical"})),t)),o(oe,"bringManyToSameCellForTheSameReason",(e,t,i,r,s,l,a,c)=>ne.bringManyToSameCell(e,t,i.map(u=>({entity:u,face:r,orientation:s,causedAs:l,causedBy:a,activator:c})))),o(oe,"tryDestroy",async(e,t)=>{const i=await oe.tryMarkForDestory(e,t);return await oe.waitCorpseDisposal(t.activator.duel),i}),o(oe,"waitCorpseDisposal",e=>ne.sendManyToGraveyard([...e.field.getCardsOnFieldStrictly(),...e.field.getPendingCardsOnField()].filter(t=>t.info.isDying).map(t=>({entity:t,causedAs:t.info.causeOfDeath??[],causedBy:t.info.isKilledBy,activator:t.info.isKilledByWhom})))),o(oe,"tryMarkForDestory",async(e,t)=>{let i=e.filter(a=>oe._tryMarkForDestory(a,t));if(!i.length)return[];const r=t.action.playType==="Battle"?"BattleDestroy":"EffectDestroy";(await Promise.all(e[0].field.getAllEntities().flatMap(a=>a.substituteEffects.filter(c=>c.isMandatory).filter(c=>c.executableCells.includes(a.fieldCell.cellType)).filter(c=>c.isApplicableTo(r,e,t).length).flatMap(c=>c.substitute(r,e,t))))).flatMap(a=>a).forEach(a=>{a.resetCauseOfDeath()}),i=i.filter(a=>a.info.isDying);let s=e[0].field.getAllEntities().flatMap(a=>a.substituteEffects.filter(c=>!c.isMandatory).filter(c=>c.executableCells.includes(a.fieldCell.cellType)).filter(c=>c.isApplicableTo(r,e,t).length).map(c=>({chooser:a.owner,effect:c,sacrifice:a})));for(const a of s.map(c=>c.sacrifice.controller).getDistinct()){const c=s.filter(d=>d.sacrifice.controller===a),u=await a.duel.view.waitSelectAction(a,c.map(d=>({entity:d.sacrifice,title:d.effect.title,origin:d.effect})),"身代わり効果を適用する？",!0);if(u){if((await u.substitute(r,i,t)).forEach(d=>{d.resetCauseOfDeath()}),i=i.filter(d=>d.info.isDying),!i.length)return[];s=s.filter(d=>d.effect.isApplicableTo(r,e,t).length)}}const l=i.filter(a=>a.info.isDying);return l.forEach(a=>a.duel.log.info(`${a.toString()}を${Lo[r]}。`,a.info.isKilledByWhom)),l}),o(oe,"tryBanish",async(e,t,i)=>{const r=t.filter(s=>s.canBeBanished(e,i.activator,i.action.entity,i.action));return await oe.banishManyForTheSameReason(r,["Effect"],i.action.entity,i.activator),r.filter(s=>s.fieldCell.cellType==="Banished").filter(s=>s.moveLog.latestRecord.movedBy===i.action.entity)}),o(oe,"negateSummonMany",(e,t)=>{const i=t.duel.field.getPendingMonstersOnField();return i.forEach(r=>{r.info.summonKinds=[],r.info.materials=[],r.moveLog.negateSummon(e,t)}),t.writeInfoLog(`${i.map(r=>r.toString()).join(" ")}.の召喚は無効にされた。`),i});let Ge=oe;const io=["NormalSummon","SpecialSummon","FlipSummon"],Pn=["IgnitionEffect","TriggerEffect","QuickEffect","CardActivation"],no=["ChangeBattlePosition","Battle","SpellTrapSet","LingeringEffect"],ro=n=>n==="CardActivation"?"CardActivation":Pn.some(e=>e===n)?"EffectActivation":"NonActivate",Wn=["NormalSummon","AdvanceSummon","SpecialSummon","SpecialSummonFromDeck","SendToGraveyardFromDeck","Draw","SearchFromDeck","BanishFromDeck","BanishFromGraveyard","AddToHandFromGraveyard","ReturnToDeckFromGraveyard","SpecialSummonFromGraveyard","SpecialSummonFromBanished","ReturnToHandFromGraveyard","ReturnToHandFromField","BanishFromField","BanishFromHand","Destroy","DestroyMultiple","DestroyOnField","DestroyMultipleOnField","DestroyOnOpponentField","DestroyMultipleOnOpponentField","DestroyMonsterOnField","DestroyMonstersOnField","DestroySpellTrapOnField","DestroySpellTrapsOnField","SpecialSummonFromHand","SpecialSummonFromExtraDeck","IfNormarlSummonSucceed","IfSpecialSummonSucceed","DamageToOpponent","DamageToSelf","PayLifePoint","DiscordAsCost","DiscordAsEffect","RollDice","BounceToHand","NegateCardEffect","NegateCardActivation","NegateNormalSummon","NegateSpecialSummon"],xt=class xt extends Di{constructor(t,i,r,s){super(t,i,r);o(this,"toString",()=>this.isWithChainBlock&&this.playType!=="CardActivation"?`${this.entity.toString()}の«${this.title}»`:`${this.entity.toString()}の${this.title}`);o(this,"addhocMaterialLimitation");o(this,"getClone",t=>new xt(this.seq,this.entity,this.definition,t));o(this,"getEnableMaterialPatterns",t=>{var i,r;return((r=(i=this.definition).getEnableMaterialPatterns)==null?void 0:r.call(i,t).filter(this.addhocMaterialLimitation))??[]});o(this,"validateCount",(t,i)=>{const r=i.filter(l=>this.isSameGroup(l.action)).length;if(this.isOnlyNTimesPerDuel>0&&this.entity.field.duel.chainBlockLog.records.filter(l=>!l.chainBlockInfo.isNegatedActivationBy).filter(l=>this.isSameGroup(l.chainBlockInfo.action)).filter(l=>l.chainBlockInfo.activator===t).length+r>=this.isOnlyNTimesPerDuel||this.isOnlyNTimesPerTurn>0&&this.entity.field.duel.chainBlockLog.records.filter(l=>!l.chainBlockInfo.isNegatedActivationBy).filter(l=>this.isSameGroup(l.chainBlockInfo.action)).filter(l=>l.clock.turn===this.entity.field.duel.clock.turn).filter(l=>l.chainBlockInfo.activator===t).length+r>=this.isOnlyNTimesPerTurn||this.isOnlyNTimesPerChain>0&&r>=this.isOnlyNTimesPerChain)return!1;const s=r+this.entity.counterHolder.getActionCount(this);return!(this.isOnlyNTimesPerTurnIfFaceup>0&&s>=this.isOnlyNTimesPerTurnIfFaceup||this.isOnlyNTimesIfFaceup>0&&s>=this.isOnlyNTimesIfFaceup)});o(this,"validate",(t,i,r)=>{if(this.playType==="CardActivation"&&this.entity.isOnFieldStrictly&&this.entity.face==="FaceUp"||this.isWithChainBlock&&!this.entity.status.canActivateEffect||r&&this.needsToPayCost||!this.validateCount(t,i))return;const s=Pi(0,...i.map(c=>c.chainNumber??-1)),l={index:i.length,chainNumber:this.isWithChainBlock?s+1:void 0,action:this,activator:t,targetChainBlock:i.slice(-1)[0],isActivatedIn:this.entity.fieldCell,isActivatedAt:this.duel.clock.getClone(),costInfo:{},state:"unloaded",dest:void 0,ignoreCost:!1};if(this.definition.canPayCosts&&!r&&!this.definition.canPayCosts(l,this.playType==="AfterChainBlock"?[]:i))return;const a=this.definition.validate(l,this.playType==="AfterChainBlock"?[]:i);if(a)return{action:this,dests:a,originSeq:this.seq}});o(this,"prepare",async(t,i,r,s,l,a)=>{var m,S;let c=l;this.isLikeContinuousSpell&&(this.entity.info.isPending=!0);const u=this.isWithChainBlock?Pi(0,...s.map(p=>p.chainNumber??-1))+1:void 0;let d="";if(u!==void 0&&(d+=`チェーン${u}: `),this.playType==="CardActivation"||this.playType==="SpellTrapSet")if(this.entity.fieldCell.cellType==="Hand"){let p=i?[i]:this.entity.status.spellCategory==="Field"?[t.getFieldZone()]:t.getAvailableSpellTrapZones();if(this.entity.status.spellCategory==="Field"){const w=t.getFieldZone().cardEntities;if(w.length){const b=w[0];await Ge.sendManyToGraveyardForTheSameReason(t.getFieldZone().cardEntities,["Rule"],this.entity,t),t.writeInfoLog(`フィールド魔法の上書きにより、${b.toString()}は墓地に送られた。`),c=!1}}(m=this.entity.status.monsterCategories)!=null&&m.includes("Pendulum")&&(p=p.filter(w=>w.isAvailableForPendulum));let C=p[0];if(p.length>1){C=p.randomPick();const w=this.playType==="SpellTrapSet"?"セット":"カードの発動",b=await this.duel.view.waitSelectDestination(t,this.entity,p,"カードを移動先へドラッグ",w,c);if(!b)return;C=b}d+="手札から",this.playType==="SpellTrapSet"?d+="魔法・罠カードをセット。":d+=`${this.entity.toString()}を発動。`,t.writeInfoLog(d),(S=this.entity.status.monsterCategories)!=null&&S.includes("Pendulum")?await this.entity.activateAsPendulumScale(C,["CardActivation"],this.entity,t):this.playType==="CardActivation"?await this.entity.activateSpellTrapFromHand(C,this.entity.kind,["CardActivation"],this.entity,t):await this.entity.setAsSpellTrap(C,this.entity.kind,["SpellTrapSet"],this.entity,t),c=!1}else this.entity.isOnField&&this.entity.face==="FaceDown"&&(d+=`セットされていた${this.entity.toString()}を発動。`,t.writeInfoLog(d),await this.entity.setNonFieldMonsterPosition(this.entity.origin.kind,"FaceUp",["Rule"]),c=!1);else u!==void 0&&(d+=`${this.toString()}を発動。`,t.writeInfoLog(d));const f={index:s.length,chainNumber:u,action:this,activator:t,targetChainBlock:r,isActivatedIn:this.entity.fieldCell,isActivatedAt:this.duel.clock.getClone(),costInfo:{},state:"ready",dest:i,ignoreCost:!1};if(console.log(this.definition.payCosts,a),this.definition.payCosts&&!a){const p=await this.definition.payCosts(f,s,c);if(!p)return;f.costInfo=p}const v=await this.definition.prepare(f,s,c);if(v===void 0)return;const g={...v};if(io.some(p=>p===this.playType)){const p=v.nextChainBlockFilter??(()=>!0);g.nextChainBlockFilter=(C,w)=>w.negateSummon&&p(C,w)}return{...f,...g}});o(this,"execute",async(t,i)=>{if(t.action.isLikeContinuousSpell&&!t.action.entity.isOnField)return this.entity.info.isPending=!1,!1;const r=await this.definition.execute(t,i);return this.entity.determine(),r});o(this,"settle",(t,i)=>(this.isOnlyNTimesPerTurnIfFaceup>0?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&this.entity.counterHolder.incrementActionCount(this),this.definition.settle(t,i)));o(this,"directExecute",async(t,i,r)=>{const s=await this.prepare(t,void 0,i,[],!1,r);if(!s)throw new de("想定されない状態",this,t,r);const l=await this.execute(s,[]);return await this.settle(s,[]),l});o(this,"isSame",t=>this.entity.origin.name===t.entity.origin.name&&this.title===t.title);o(this,"isSameGroup",t=>this.actionGroupName?this.entity.origin.name===t.entity.origin.name&&this.actionGroupName===t.actionGroupName:this.isSame(t));o(this,"calcChainBlockTagsForDestroy",t=>{if(!Wn.length)return[];const i=["Destroy"];Wn.length>1&&i.push("DestroyMultiple");const r=t.filter(c=>c.isOnFieldStrictly);r.length&&(i.push("DestroyOnField"),r.length>1&&i.push("DestroyMultipleOnField"));const s=r.filter(c=>c.kind==="Monster");s.length&&(i.push("DestroyMonsterOnField"),s.length>1&&i.push("DestroyMonstersOnField")),r.filter(c=>c.kind!=="Monster").length&&(i.push("DestroySpellTrapOnField"),s.length>1&&i.push("DestroySpellTrapsOnField"));const a=r.filter(c=>c.controller!==this.entity.controller);return a.length&&(i.push("DestroyOnOpponentField"),a.length>1&&i.push("DestroyMultipleOnOpponentField")),i});this.addhocMaterialLimitation=s??(()=>!0)}get definition(){return super.definition}get playType(){return this.definition.playType}get spellSpeed(){return this.definition.spellSpeed}get needsToPayCost(){return this.definition.needsToPayCost??!1}get hasToTargetCards(){return this.definition.hasToTargetCards??!1}get isWithChainBlock(){return Pn.some(t=>t===this.playType)}get isLikeContinuousSpell(){return this.definition.isLikeContinuousSpell||this.entity.isLikeContinuousSpell&&this.playType==="CardActivation"}get negatePreviousBlock(){return this.definition.negatePreviousBlock??!1}get negateSummon(){return this.definition.negateSummon??!1}get priorityForNPC(){return this.definition.priorityForNPC??Number.NaN}};o(xt,"createNew",(t,i)=>new xt("AutoSeq",t,i)),o(xt,"createDummyAction",(t,i,r,s,l)=>({action:xt.createNew(t,{title:i,isMandatory:!1,executableCells:[],executablePeriods:[],executableDuelistTypes:[],playType:"Dammy",spellSpeed:"Dammy",validate:()=>r,prepare:async()=>{},execute:async()=>!1,settle:async()=>!1}),dests:r,battlePosition:s,originSeq:(l==null?void 0:l.seq)??-1}));let zt=xt;const xi=class xi{constructor(e,t,i,r,s,l=[]){o(this,"duel");o(this,"seat");o(this,"_entity");o(this,"profile");o(this,"deckInfo");o(this,"info");o(this,"infoOrigin");o(this,"status");o(this,"statusOrigin");o(this,"duelistType");o(this,"lifeLog");o(this,"actionBlackListForNPC");o(this,"_lp");o(this,"initHand");o(this,"writeInfoLog",e=>{this.duel.log.info(e,this)});o(this,"initForDrawPhase",()=>{this.info={...this.infoOrigin}});o(this,"canDiscard",e=>(console.log(e),!0));o(this,"canSendToGraveyard",e=>(console.log(e),!0));o(this,"canRelease",e=>(console.log(e),!0));o(this,"canTryBanish",(e,t,i)=>this.entity.procFilterBundle.effectiveOperators.filter(r=>r.procTypes.includes(t)).every(r=>r.filter(this,this.entity,i,[e])));o(this,"battleDamage",(e,t)=>this.setLp(this._lp-e,t,"BattleDamage"));o(this,"effectDamage",(e,t)=>this.setLp(this._lp-e,t,"EffectDamage"));o(this,"lostLp",(e,t)=>this.setLp(this._lp-e,t,"Lost"));o(this,"payLp",(e,t)=>this.setLp(this._lp-e,t,"Pay"));o(this,"heal",(e,t)=>this.setLp(this._lp+e,t,"Heal"));o(this,"setLp",(e,t,i)=>{const r={clock:this.duel.clock.getClone(),reason:i||"Set",beforeLp:this._lp,afterLp:e,entity:t};return this.lifeLog.push(r),this._lp=e,this.writeInfoLog(`ライフポイント変動：${r.afterLp-r.beforeLp}（${r.beforeLp} ⇒ ${r.afterLp}）`),r});o(this,"getOpponentPlayer",()=>this.duel.firstPlayer===this?this.duel.secondPlayer:this.duel.firstPlayer);o(this,"getHandCell",()=>this.duel.field.getCells("Hand").filter(e=>e.owner===this)[0]);o(this,"getDeckCell",()=>this.duel.field.getCells("Deck").filter(e=>e.owner===this)[0]);o(this,"getExtraDeck",()=>this.duel.field.getCells("ExtraDeck").filter(e=>e.owner===this)[0]);o(this,"getGraveyard",()=>this.duel.field.getCells("Graveyard").filter(e=>e.owner===this)[0]);o(this,"getFieldZone",()=>this.duel.field.getCells("FieldSpellZone").filter(e=>e.owner===this)[0]);o(this,"getBanished",()=>this.duel.field.getCells("Banished").filter(e=>e.owner===this)[0]);o(this,"getMonsterZones",()=>this.duel.field.getCells("MonsterZone").filter(e=>e.owner===this));o(this,"getExtraMonsterZones",()=>this.duel.field.getCells("ExtraMonsterZone").filter(e=>{var t;return((t=e.cardEntities[0])==null?void 0:t.controller)===this}));o(this,"getSpellTrapZones",()=>this.duel.field.getCells("SpellAndTrapZone").filter(e=>e.owner===this));o(this,"getXyzMaterialZone",()=>this.duel.field.getCells("XyzMaterialZone").filter(e=>e.owner===this)[0]);o(this,"getEmptyMonsterZones",()=>this.getMonsterZones().filter(e=>e.cardEntities.length===0));o(this,"getEmptyExtraZones",()=>this.getExtraMonsterZones().length===0?this.getMonsterZones().filter(e=>e.cardEntities.length===0):[]);o(this,"getAvailableMonsterZones",()=>this.getMonsterZones().filter(e=>e.isAvailable));o(this,"getAvailableExtraZones",()=>this.getExtraMonsterZones().length===0?this.duel.field.getCells("ExtraMonsterZone").filter(e=>e.isAvailable):[]);o(this,"getAvailableSpellTrapZones",()=>this.getSpellTrapZones().filter(e=>e.isAvailable));o(this,"getReleasableMonsters",()=>this.getMonstersOnField());o(this,"getMonstersOnField",()=>this.duel.field.getMonstersOnFieldStrictly().filter(e=>e.controller===this));o(this,"getSpellTrapsOnField",()=>this.duel.field.getSpellTrapsOnFieldStrictly().filter(e=>e.controller===this));o(this,"getPendingMonstersOnField",()=>this.duel.field.getPendingMonstersOnField().filter(e=>e.controller===this));o(this,"getPendulumScaleMonsters",()=>this.duel.field.getCardsOnFieldStrictly().filter(e=>e.isPendulumScale).filter(e=>e.controller===this));o(this,"getPendulumScales",()=>{const e=this.getPendulumScaleMonsters();if(e.length<2)return;const t=e.find(l=>l.fieldCell.column===(this.seat==="Below"?1:5)),i=e.find(l=>l.fieldCell.column===(this.seat==="Below"?5:1));if(!t||!i)throw new de("想定されない状態",e);const r=t.psR,s=i.psL;if(r===void 0||s===void 0)throw new de("想定されない状態",e);return r>s?{upperBound:r,lowerBound:s}:{upperBound:s,lowerBound:r}});o(this,"getEntiteisOnField",()=>this.duel.field.getCardsOnFieldStrictly().filter(e=>e.controller===this));o(this,"pushDeck",()=>{this.deckInfo.cardNames.map(e=>dt[e]).filter(e=>e).forEach(e=>ne.createCardEntity(this,e)),this.duel.log.info(`デッキをセット。メイン${this.getDeckCell().cardEntities.length}枚。エクストラ${this.getExtraDeck().cardEntities.length}枚。`,this)});o(this,"draw",async(e,t,i)=>{var l;if(e<1)return;const r=this.getDeckCell(),s=[];this.writeInfoLog(`デッキからカードを${e}枚ドロー。`);for(const a of Array(e)){if(!r.cardEntities.length)throw this.writeInfoLog(s.length>0?`デッキからカードを${e}枚ドローしようとしたが、${s.length}枚しかドローできなかった。${s}`:"デッキからカードをドローできなかった。"),this.duel.isEnded=!0,this.setLp(0),new At(this.getOpponentPlayer(),"対戦相手がデッキからカードをドローできなかった。");const c=r.cardEntities[0];await c.draw(t?["Effect"]:["Rule"],t,i),s.push(((l=c.origin)==null?void 0:l.name)||"!名称取得失敗!")}});o(this,"discard",async(e,t,i,r,s,l)=>{const a=s||(()=>!0),c=this.getHandCell().cardEntities.filter(a);if(c.length<e)return[];let u=[];return(r||this).duelistType==="NPC"?u=c.randomPickMany(e):u=await this.duel.view.waitSelectEntities(r||this,{selectables:c,qty:e,validator:d=>d.length===e,cancelable:!1},`${e}枚カードを捨てる。`)||[],this.writeInfoLog(`手札からカードを${u.length}枚捨てた。${u.map(d=>{var f;return(f=d.origin)==null?void 0:f.name})}。`),await Ge.discardManyForTheSameReason(u,["Discard",...t],i,l),u});o(this,"getEnableSummonList",(e,t,i,r,s,l,a)=>{const c=this.duel.field.getCells("ExtraMonsterZone"),u=c.filter(f=>!l.map(v=>v.material).includes(f.cardEntities[0])).filter(f=>f.owner===this),d=[];return u.length&&d.push(...c.filter(f=>!u.includes(f)).filter(f=>f.isAvailable)),s.map(f=>({...f,summoner:this})).map(f=>{var v;return(t!=="LinkSummon"||!this.duel.field.canExtraLink(f.monster,l))&&(f.cells=f.cells.filter(g=>!d.includes(g))),(v=f.monster.status.monsterCategories)!=null&&v.includes("Link")&&(f.posList=f.posList.filter(g=>g==="Attack")),f}).map(f=>({...f,cells:f.cells.filter(v=>v.cardEntities.length===0||l.some(g=>g.material===v.cardEntities[0]))})).map(f=>{var v;return f.monster.fieldCell.cellType!=="ExtraDeck"?{...f,cells:f.cells.filter(g=>g.cellType!=="ExtraMonsterZone")}:(v=f.monster.status.monsterCategories)!=null&&v.includes("Link")||t==="PendulumSummon"?{...f,cells:f.cells.filter(g=>g.cellType==="ExtraMonsterZone"||g.linkArrowSources.filter(m=>!l.map(S=>S.material).includes(m)).length)}:f}).filter(f=>f.cells.length&&f.posList.length).map(f=>this.entity.summonFilterBundle.filter(e,t,i,r,f,l,a)).filter(f=>f.cells.length&&f.posList.length).map(f=>f.monster.summonFilterBundle.filter(e,t,i,r,f,l,a)).filter(f=>f.cells.length&&f.posList.length).map(f=>l.map(v=>v.material.summonFilterBundle).reduce((v,g)=>g.filter(e,t,i,r,v,l,a),f)).filter(f=>f.cells.length&&f.posList.length)});o(this,"prepareToSummonMany",async(e,t,i,r,s,l,a,c,u,d,f="特殊召喚するモンスターを選択。")=>{const v=this.getEnableSummonList(e,t,i,r,s,l,a);if(!v.length)return[];let g=v.map(S=>S.monster);(s.length!==1||u([]))&&(g=await this.duel.view.waitSelectEntities(this,{selectables:g,qty:c,validator:u,cancelable:d},f)??[]);const m=[];for(const S of v.filter(p=>g.includes(p.monster))){const p=S.cells.filter(b=>!m.map(P=>P.dest).includes(b));if(!p.length)continue;let C=[...S.posList].randomPick(),w=p.randomPick();if((p.length>1||S.posList.length>1)&&this.duelistType!=="NPC"){const b=await this.duel.view.waitSelectSummonDestination(S.summoner,S.monster,p,S.posList,d);if(!b)return[];w=b.dest,C=b.battlePosition}m.push({summoner:this,monster:S.monster,pos:C,dest:w})}return m});o(this,"summonAll",(e,t,i,r,s,l,a,c,u)=>this.summonMany(e,t,i,r,s,l,a,s.length,d=>d.length===s.length,c,u));o(this,"summonOne",(e,t,i,r,s,l,a,c,u)=>this.summonMany(e,t,i,r,s,l,a,1,d=>d.length===1,c,u));o(this,"summonMany",(e,t,i,r,s,l,a,c,u,d,f)=>xi.summonMany(e,t,i,r,s.map(v=>({...v,summoner:this})),l,a,c,u,d,f));o(this,"selectAttackTargetForNPC",(e,t)=>{const i=e.atk??0,r=e.getAttackTargets();if(!r.length)return;const s=r.find(l=>l.entityType==="Duelist");return s&&(i>=cn(1600,this.getOpponentPlayer().lp)||e.info.battlePotisionChangeCount>0)?s:r.find(l=>l.battlePosition==="Attack"?i>=(l.atk??0):i<(l.battlePosition==="Set"?1e3:l.def??0)?!1:l.validateDestory("BattleDestroy",this,e,t))});o(this,"selectActionForNPC",(e,t)=>{if(!e.length)return;const i=e.filter(p=>p.action.isMandatory);if(i.length)return i.randomPick();let r=e.filter(p=>!this.actionBlackListForNPC.includes(p.action.playType));const s=r.filter(p=>!Number.isNaN(p.action.priorityForNPC)).shuffle().sort((p,C)=>p.action.priorityForNPC-C.action.priorityForNPC);if(s.length)return s[0];const l=r.filter(p=>p.action.playType==="TriggerEffect");if(l.length)return l.randomPick();if(this.duel.phase!=="main1"&&this.duel.phase!=="main2"){const p=r.filter(C=>C.action.playType==="IgnitionEffect");if(p.length)return p.randomPick()}const a=r.filter(p=>p.action.playType==="Battle").sort((p,C)=>(p.action.entity.atk??0)-(C.action.entity.atk??0));if(a.length)return a.find(p=>this.selectAttackTargetForNPC(p.action.entity,p.action));r=r.filter(p=>p.action.playType!=="Battle");const c=r.length?t.slice(-1)[0]:void 0,u=r.filter(p=>p.action.negatePreviousBlock);if(c&&c.activator!==this&&u)return u.randomPick();if(r=r.filter(p=>!p.action.negatePreviousBlock),!r.length)return;const d=Pi(...this.getOpponentPlayer().getMonstersOnField().filter(p=>p.battlePosition==="Attack").map(p=>p.atk??0),1600),f=cn(...this.getOpponentPlayer().getMonstersOnField().map(p=>p.battlePosition==="Set"?1500:(p.battlePosition==="Attack"?p.atk:p.def)??0),1500),v=this.getMonstersOnField(),g=Pi(...v.filter(p=>p.battlePosition==="Attack").map(p=>p.atk??0),0);let m=r.filter(p=>p.action.playType!=="ChangeBattlePosition").filter(p=>p.action.entity.battlePosition!=="Attack").filter(p=>(p.action.entity.atk??0)>=d||(p.action.entity.atk??0)>f&&(p.action.entity.atk??0)>2300);if(m.length)return m.randomPick();r=r.filter(p=>p.action.playType!=="ChangeBattlePosition").filter(p=>p.action.playType!=="SpellTrapSet").filter(p=>p.action.entity.actions.filter(C=>C.playType!=="NormalSummon"&&C.playType!=="SpecialSummon").flatMap(C=>C.executableCells).every(C=>C!=="Hand")||p.action.playType!=="NormalSummon"&&p.action.playType!=="SpecialSummon");const S=[...r.filter(p=>p.action.playType==="NormalSummon").filter(p=>(p.action.entity.lvl??12)<5),...r.filter(p=>p.action.playType==="SpecialSummon"),...r.filter(p=>p.action.playType==="NormalSummon").filter(p=>(p.action.entity.atk??0)>2600||(p.action.entity.atk??0)>2300&&(p.action.entity.lvl??12)<7).filter(p=>(p.action.entity.atk??0)>=g),...r.filter(p=>p.action.entity.face==="FaceUp").filter(p=>p.action.entity.isOnFieldStrictly)];if(S.length)return S.randomPick();if(r=r.filter(p=>p.action.playType!=="NormalSummon").filter(p=>p.action.playType!=="SpecialSummon"),this.duel.phase==="main2"){if(m=e.filter(p=>p.action.playType==="ChangeBattlePosition").filter(p=>p.action.entity.battlePosition==="Attack").filter(p=>(p.action.entity.atk??0)<d||(p.action.entity.atk??0)>f&&(p.action.entity.atk??0)>2300),m.length)return m.randomPick();if(this.getAvailableSpellTrapZones.length>1)return e.filter(p=>p.action.playType==="SpellTrapSet").filter(p=>p.action.entity.kind!=="Spell"||p.action.entity.status.spellCategory==="QuickPlay").randomPick()}if(Math.random()<r.length/4)return r.randomPick()});this.duel=e,this.seat=t,this.profile=i,this.duelistType=r,this.deckInfo=s,this.initHand=l,this.lifeLog=[],this.infoOrigin={maxRuleNormalSummonCount:1,ruleNormalSummonCount:0,ruleNormalSummonCountQty:0,effectNormalSummonCount:0,effectNormalSummonCountQty:0,specialSummonCount:0,specialSummonCountQty:0},this.info={...this.infoOrigin},this.statusOrigin={maxSpecialSummonCount:Number.MAX_VALUE,canDrawByEffect:!0,canSearchFromDeck:!0,canDiscardAsCost:!0,canDiscardAsEffect:!0},this.status={...this.statusOrigin},this._lp=8e3;const a=[];this.duelistType==="NPC"&&(this.profile.npcLvl<1&&a.push("CardActivation","IgnitionEffect","TriggerEffect","QuickEffect"),this.profile.npcLvl<101&&a.push("Battle")),this.actionBlackListForNPC=a}get entity(){const e=this.getHandCell().entities.find(t=>t.entityType==="Duelist");return e||ne.createPlayerEntity(this)}get lp(){return this._lp}get isTurnPlayer(){return this.duel.getTurnPlayer()===this}get canDraw(){return!0}get canAddToHandFromDeck(){return!0}};o(xi,"summonMany",async(e,t,i,r,s,l,a,c,u,d,f="特殊召喚するモンスターを選択。")=>{const v=s.map(m=>m.summoner).getDistinct(),g=[];for(const m of v){const S=await m.prepareToSummonMany(e,t,i,r,s.filter(p=>p.summoner===m),l,a,c,u,d,f);g.push(...S)}if(g.length)return g.forEach(m=>m.monster.info.materials.reset(...l)),await Ge.moveToXyzOwner(g[0].dest,l.map(m=>m.material).filter(m=>m.kind==="XyzMaterial"),["XyzMaterial","Rule"],g[0].monster,e),await ne.summonMany(g,t,i,r.entity,e),g.map(m=>m.monster)});let Nt=xi;const Jr=["Deck","ExtraDeck"],es=["Graveyard","Banished"],ts=[...Jr,...es],so=[...ts,"Hand"],is=["MonsterZone","ExtraMonsterZone"],ns=["SpellAndTrapZone","FieldSpellZone"],Tt=[...is,...ns],rs=["XyzMaterialZone","Disable"],Yi=[...so,...Tt,...rs],un={0:{0:"Hand"},1:{0:"Deck",1:"SpellAndTrapZone",2:"SpellAndTrapZone",3:"SpellAndTrapZone",4:"SpellAndTrapZone",5:"SpellAndTrapZone",6:"ExtraDeck"},2:{0:"Graveyard",1:"MonsterZone",2:"MonsterZone",3:"MonsterZone",4:"MonsterZone",5:"MonsterZone",6:"FieldSpellZone"},3:{0:"Banished",1:"XyzMaterialZone",2:"ExtraMonsterZone",3:"Disable",4:"ExtraMonsterZone",5:"XyzMaterialZone",6:"Banished"},4:{0:"FieldSpellZone",1:"MonsterZone",2:"MonsterZone",3:"MonsterZone",4:"MonsterZone",5:"MonsterZone",6:"Graveyard"},5:{0:"ExtraDeck",1:"SpellAndTrapZone",2:"SpellAndTrapZone",3:"SpellAndTrapZone",4:"SpellAndTrapZone",5:"SpellAndTrapZone",6:"Deck"},6:{0:"Hand"}};let ao=class{constructor(e,t,i,r){o(this,"onUpdateEvent",new Ae);o(this,"field");o(this,"row");o(this,"column");o(this,"cellType");o(this,"_owner");o(this,"_requiresRecalcLinkArrows");o(this,"_linkArrowSources");o(this,"_needsShuffle",!1);o(this,"recalcLinkArrows",()=>{this.isMonsterZoneLikeCell&&(this._requiresRecalcLinkArrows=!1,this._linkArrowSources=this.neighbors.filter(e=>e.isMonsterZoneLikeCell).filter(e=>e.cardEntities.length).filter(e=>e.cardEntities[0].linkArrows.some(t=>this.row===e.row+t.offsetRow&&this.column===e.column+t.offsetColumn)).map(e=>e.cardEntities[0]))});o(this,"_entities");o(this,"releaseEntities",e=>{var t;return this._entities=this._entities.filter(i=>i!==e),this.isMonsterZoneLikeCell&&((t=e.origin.monsterCategories)!=null&&t.includes("Link"))&&(this._requiresRecalcLinkArrows=!0),this.onUpdateEvent.trigger(),e});o(this,"acceptEntities",(e,t)=>{var i;t==="Top"?this._entities.unshift(e):this._entities.push(e),t==="Random"&&(this._needsShuffle=!0),this._entities.forEach(r=>{r.fieldCell=this}),this.isMonsterZoneLikeCell&&((i=e.origin.monsterCategories)!=null&&i.includes("Link"))&&(this._requiresRecalcLinkArrows=!0),this.onUpdateEvent.trigger()});o(this,"shuffle",()=>{this._entities=this.entities.shuffle(),this._needsShuffle=!1,this.field.duel.log.info("デッキをシャッフル。",this.owner)});o(this,"toString",()=>this.isMonsterZoneLikeCell||this.cellType==="SpellAndTrapZone"?`${this.cellType}(${this.row},${this.column})`:this.cellType);this.field=e,this.row=t,this.column=i,this.cellType=un[t][i],this._owner=r,this._entities=[],this._linkArrowSources=[],this._requiresRecalcLinkArrows=!1}get onUpdate(){return this.onUpdateEvent.expose()}get owner(){var e;return this._owner||((e=this.cardEntities[0])==null?void 0:e.owner)}get requiresRecalcLinkArrows(){return this._requiresRecalcLinkArrows}get linkArrowSources(){return this._linkArrowSources}get needsShuffle(){return this._needsShuffle}get entities(){return this._entities}get visibleEntities(){return this._entities.filter(e=>er.find(t=>t===e.entityType))}get cardEntities(){return this._entities.filter(e=>er.find(t=>t===e.entityType)).filter(e=>e.kind!=="XyzMaterial")}get xyzMaterials(){return this._entities.filter(e=>e.kind==="XyzMaterial")}get targetForAttack(){return this.cellType==="Hand"?this._entities.find(e=>e.entityType==="Duelist"):this.cardEntities[0]}get isAvailable(){return this.cardEntities.length===0&&this._entities.filter(e=>Io.find(t=>t===e.entityType)).length===0}get isAvailableForPendulum(){return this.isAvailable&&this.isSpellTrapZoneLikeCell&&(this.column===1||this.column===5)}get isStackCell(){return ts.some(e=>e===this.cellType)}get isPlayFieldCell(){return Tt.some(e=>e===this.cellType)}get isMonsterZoneLikeCell(){return is.some(e=>e===this.cellType)}get isSpellTrapZoneLikeCell(){return ns.some(e=>e===this.cellType)}get isDisabledCell(){return rs.some(e=>e===this.cellType)}get isTrashCell(){return es.some(e=>e===this.cellType)}get neighbors(){const e=[this.row-1,this.row,this.row+1].filter(i=>i>=0&&i<=6),t=[this.column-1,this.column,this.column+1].filter(i=>i>=0&&i<=6);return e.flatMap(i=>t.map(r=>this.field.cells[i][r])).filter(i=>i.isMonsterZoneLikeCell).filter(i=>i!==this)}};class Zi{constructor(){o(this,"pooledOperators",[]);o(this,"bundles",[]);o(this,"excludesExpired",()=>{this.bundles=this.bundles.filter(e=>!e.entity.hasDisappeared),this.bundles.forEach(e=>e.excludesExpired()),this.pooledOperators=this.pooledOperators.filter(e=>e.validateAlive())});o(this,"append",e=>{this.bundles.push(e)});o(this,"push",e=>{if(!e.isContinuous)throw new de("staticへの追加は永続以外不可",e);this.excludesExpired(),this.distribute(e),this.pooledOperators.push(e)});o(this,"distributeAll",e=>(this.excludesExpired(),this.pooledOperators.flatMap(this.distribute).getDistinct().forEach(t=>t.operators.sort((i,r)=>i.seq-r.seq)),this.afterDistributeAll(e)));o(this,"distribute",e=>this.bundles.filter(t=>t.operators.every(i=>i.seq!==e.seq)).filter(t=>e.isApplicableTo(t.entity)).filter(t=>t.entity.canBeEffected(e.effectOwner,e.isSpawnedBy,e.actionAttr)).map(t=>(t.push(e),t)));o(this,"removeItem",e=>{this.pooledOperators=this.pooledOperators.filter(t=>t.seq!==e)})}}class Vi{constructor(e,t){o(this,"pool");o(this,"entity");o(this,"_operators");o(this,"excludesExpired",()=>{this._operators=this._operators.filter(e=>{const t=e.validateAlive()&&e.isApplicableTo(this.entity);return t||(console.info(`before remove ${this.entity.toString} ${e.title}`),e.beforeRemove(this)),t})});o(this,"push",e=>{this.entity.procFilterBundle.effectiveOperators.filter(t=>t.procTypes.includes("Effect")).some(t=>!t.filter(t.effectOwner,t.isSpawnedBy,t.actionAttr,[]))||(this.beforePush(e),this._operators.push(e))});o(this,"removeItem",e=>{this._operators=this._operators.filter(t=>t.seq!==e?!0:(t.beforeRemove(this),!1))});this.pool=e,this.entity=t,this._operators=[],this.pool.append(this)}get operators(){return this._operators}get effectiveOperators(){return this.operators.filter(e=>e.isSpawnedBy.isEffective||!e.isContinuous)}}const qi=class qi{constructor(e,t,i,r,s,l){o(this,"seq");o(this,"title");o(this,"validateAlive");o(this,"isContinuous");o(this,"isSpawnedBy");o(this,"isSpawnedAt");o(this,"activateType");o(this,"actionAttr");o(this,"isApplicableTo");o(this,"effectOwner");this.seq=qi.nextSeq++,this.title=e,this.validateAlive=()=>t(this),this.isContinuous=i,this.isSpawnedBy=r,this.isSpawnedAt=r.duel.clock.getClone(),this.isApplicableTo=a=>l(this,a),this.actionAttr=s,this.activateType=this.actionAttr.playType?ro(this.actionAttr.playType):"NonActivate",this.effectOwner=this.isSpawnedBy.controller}get isEffective(){return!this.isContinuous||this.activateType==="NonActivate"?!0:this.isSpawnedBy.isEffective}};o(qi,"nextSeq",0);let Kt=qi;class oo extends Zi{constructor(){super(...arguments);o(this,"afterDistributeAll",()=>this.bundles.every(t=>t.applyEffectFilter()))}}class lo extends Vi{constructor(){super(...arguments);o(this,"applyEffectFilter",()=>{const t=this.entity.allStickyEffectOperators.length,i=[];for(;;){const r=this.effectiveOperators.filter(s=>s.procTypes.includes("Effect")).filter(s=>s.isContinuous).find(s=>!i.includes(s.seq));if(!r)break;i.push(r.seq),r.eraseOperators(this.entity)}return this.entity.allStickyEffectOperators.length===t});o(this,"beforePush",t=>t.eraseOperators(this.entity))}}const Ht=class Ht extends Kt{constructor(t,i,r,s,l,a,c,u){super(t,i,r,s,l,a);o(this,"beforeRemove",()=>{});o(this,"procTypes");o(this,"filter");o(this,"eraseOperators",t=>{if(!this.procTypes.includes("Effect"))return 0;const i=t.allStickyEffectOperators.filter(r=>r.isContinuous).filter(r=>!this.filter(r.effectOwner,r.isSpawnedBy,r.actionAttr,[])).map(r=>r.seq);return i.forEach(t.procFilterBundle.removeItem),i.forEach(t.statusOperatorBundle.removeItem),i.forEach(t.numericOprsBundle.removeItem),i.length});this.procTypes=c,this.filter=u}};o(Ht,"createContinuous",(t,i,r,s,l,a,c)=>new Ht(t,i,!0,r,s,l,a,c)),o(Ht,"createLingering",(t,i,r,s,l,a,c)=>new Ht(t,i,!1,r,s,l,a,c));let Xn=Ht;const Qn={level:1,rank:1,attack:0,defense:0,pendulumScaleR:0,pendulumScaleL:0};class co extends Zi{constructor(){super(...arguments);o(this,"afterDistributeAll",t=>{if(this.bundles.forEach(r=>r.calcStateAll()),t.field.getMonstersOnFieldStrictly().flatMap(r=>r.numericOprsBundle).flatMap(r=>r.effectiveOperators).some(r=>r.targetStateGen==="calculated")){const s=t.field.getMonstersOnFieldStrictly().filter(l=>(l.atk??0)>=0).map(l=>l.atk??0).reduce((l,a)=>l>a?l:a,0);t.field.getMonstersOnFieldStrictly().forEach(l=>{l.numericOprsBundle.effectiveOperators.filter(a=>a.targetStateGen==="calculated").forEach(a=>{var c;if(!((c=l.status.monsterCategories)!=null&&c.includes("Link")&&a.targetState==="defense")){if(a.stateOperationType==="THE_DEVILS_AVATAR"){l.numericStatus.calculated[a.targetState]=s+100;return}l.numericStatus.calculated[a.targetState]=a.calcValue(l,l.numericStatus.calculated[a.targetState]??0)}})})}return!0})}}class uo extends Vi{constructor(){super(...arguments);o(this,"beforePush",t=>{const i=this.effectiveOperators.filter(s=>s.targetState===t.targetState).filter(s=>s.isEffective);if(t.kind==="O-L-F"||t.kind==="O-C-F"?(i.filter(s=>s.kind==="O-L-F").forEach(s=>s.negate()),i.filter(s=>s.kind==="L-F").forEach(s=>s.negate())):t.kind==="L-F"||t.kind==="C-F"?i.filter(s=>s.kind==="L-F"||s.kind==="L-A").forEach(s=>s.negate()):t.kind==="X-C-X"&&i.filter(s=>!s.isContinuous).forEach(s=>s.negate()),i.filter(s=>s.isEffective).some(s=>s.kind==="X-C-X")&&!t.isContinuous)return;if(t.stateOperationType!=="Addition"&&t.targetStateGen==="wip"&&i.filter(s=>!s.isContinuous).forEach(s=>s.negate()),t.stateOperationType==="THE_DEVILS_AVATAR"||t.stateOperationType==="Gradius'_Option"){this.entity.numericStatus.calculated[t.targetState]=-Number.MAX_VALUE;return}const r=this.entity.numericStatus.calculated[t.targetState]??0;if(t.stateOperationType==="THE_DEVILS_DREAD-ROOT"){this.entity.numericStatus.calculated[t.targetState]=t.calcValue(this.entity,r);return}if(t.kind==="L-F"){this.entity.numericStatus.wip[t.targetState]=t.calcValue(this.entity,r);return}});o(this,"calcStateAll",()=>cr.forEach(this.calcState));o(this,"calcState",t=>{if(this.entity.kind!=="Monster"&&!this.entity.isPendulumScale){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories){this.entity.numericStatus.calculated[t]=void 0;return}if(this.entity.status.monsterCategories.includes("Link")&&t!=="attack"){this.entity.numericStatus.calculated[t]=void 0;return}if(this.entity.status.monsterCategories.includes("Xyz")&&t==="level"){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories.includes("Xyz")&&t==="rank"){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories.includes("Pendulum")&&(t==="pendulumScaleL"||t==="pendulumScaleR")){this.entity.numericStatus.calculated[t]=void 0;return}if(t!=="level"&&!this.entity.isOnFieldStrictly){this.entity.numericStatus.origin[t]=this.entity.origin[t],this.entity.numericStatus.wip[t]=this.entity.origin[t],this.entity.numericStatus.calculated[t]=this.entity.origin[t];return}const i=this.entity.origin[t]??0,r=this.entity.numericStatus.wip[t]??0,s=this._operators.filter(d=>d.targetState===t).filter(d=>d.isEffective);if(s.some(d=>d.stateOperationType==="THE_DEVILS_AVATAR"||d.stateOperationType==="Gradius'_Option")&&this.entity.isEffective){this.entity.numericStatus.calculated[t]=-Number.MAX_VALUE;return}const l=s.filter(d=>d.targetState===t).findLast(d=>d.targetStateGen==="origin"),a=l?l.calcValue(this.entity,i??0):i;this.entity.numericStatus.origin[t]=a;let c=a;const u=s.filter(d=>d.targetState===t).filter(d=>d.targetStateGen==="wip").findLast(d=>d.stateOperationType==="Fixation");if(!u)c=s.filter(d=>d.stateOperationType==="Addition").reduce((d,f)=>f.calcValue(this.entity,d),c),this.entity.numericStatus.wip[t]=c;else if(u.isContinuous)c=u.calcValue(this.entity,c),c=s.filter(d=>d.stateOperationType==="Addition").reduce((d,f)=>f.calcValue(this.entity,d),c),this.entity.numericStatus.wip[t]=c;else{let d=!1;c=s.filter(f=>(d=d||f===u,d&&f!==u)).filter(f=>f.stateOperationType==="Addition").reduce((f,v)=>v.calcValue(this.entity,f),r)}c<Qn[t]&&(c=Qn[t]),this.entity.numericStatus.calculated[t]=c})}}const nt=class nt extends Kt{constructor(t,i,r,s,l,a,c,u,d,f){super(t,i,r,s,l,a);o(this,"beforeRemove",()=>{});o(this,"targetState");o(this,"targetStateGen");o(this,"stateOperationType");o(this,"calcValue");o(this,"_isEffective");o(this,"negate",()=>{this._isEffective=!1});this._isEffective=!0,this.targetState=c,this.targetStateGen=u,this.stateOperationType=d,this.calcValue=(v,g)=>f(this.isSpawnedBy,v,g)}get isEffective(){return this._isEffective&&super.isEffective}get kind(){if(this.targetStateGen==="origin"){if(this.stateOperationType==="Fixation")return this.isContinuous?"O-C-F":"O-L-F";throw new de("矛盾したプロパティ",this)}if(this.targetStateGen==="wip"){if(this.stateOperationType==="Addition")return this.isContinuous?"C-A":"L-A";if(this.stateOperationType==="Fixation")return this.isContinuous?"C-F":"L-F";throw new de("矛盾したプロパティ",this)}if(this.stateOperationType==="THE_DEVILS_DREAD-ROOT")return"X-C-F";if(this.stateOperationType==="THE_DEVILS_AVATAR"||this.stateOperationType==="Gradius'_Option")return"X-C-X";throw new de("矛盾したプロパティ",this)}};o(nt,"createContinuous",(t,i,r,s,l,a,c,u)=>new nt(t,i,!0,r,{},s,l,a,c,u)),o(nt,"createLingering",(t,i,r,s,l,a,c)=>new nt(t,i,!1,r,s,(u,d)=>d.isOnFieldAsMonsterStrictly,l,"wip",a,c)),o(nt,"createLingeringFixation",(t,i,r,s,l,a)=>nt.createLingering(t,i,r,s,l,"Fixation",a)),o(nt,"createLingeringAddition",(t,i,r,s,l,a)=>nt.createLingering(t,i,r,s,l,"Addition",a));let Yn=nt;const fo=n=>Object.keys(n),ho={draw:"ドローフェイズ",standby:"スタンバイフェイズ",main1:"メインフェイズ１",battle1:"バトルフェイズ",battle2:"バトルフェイズ（追加）",main2:"メインフェイズ２",end:"エンドフェイズ"},vo={start:"スタートステップ",battle:"バトルステップ",damage:"ダメージステップ",end:"エンドステップ"},po={start:"ダメージステップ開始時",beforeDmgCalc:"ダメージ計算前",dmgCalc:"ダメージ計算時",afterDmgCalc:"ダメージ計算後",end:"ダメージステップ終了時"},go=["draw","stanby","main1","b1Start","b1Battle","b1End","b2Start","b2Battle","b2End","main2","end"],mo=["b1DStart","b1DBeforeDmgCalc","b1DAfterDmgCalc","b1DEnd","b2DStart","b2DBeforeDmgCalc","b2DAfterDmgCalc","b2DEnd"],yo=["b1DDmgCalc","b2DDmgCalc"],ss=[...go,...mo,...yo],Jn={draw:{phase:"draw",step:void 0,stage:void 0},stanby:{phase:"standby",step:void 0,stage:void 0},main1:{phase:"main1",step:void 0,stage:void 0},b1Start:{phase:"battle1",step:"start",stage:void 0},b1Battle:{phase:"battle1",step:"battle",stage:void 0},b1DStart:{phase:"battle1",step:"battle",stage:"start"},b1DBeforeDmgCalc:{phase:"battle1",step:"battle",stage:"beforeDmgCalc"},b1DDmgCalc:{phase:"battle1",step:"battle",stage:"dmgCalc"},b1DAfterDmgCalc:{phase:"battle1",step:"battle",stage:"afterDmgCalc"},b1DEnd:{phase:"battle1",step:"battle",stage:"end"},b1End:{phase:"battle1",step:"end",stage:void 0},b2Start:{phase:"battle2",step:"start",stage:void 0},b2Battle:{phase:"battle2",step:"battle",stage:void 0},b2DStart:{phase:"battle2",step:"battle",stage:"start"},b2DBeforeDmgCalc:{phase:"battle2",step:"battle",stage:"beforeDmgCalc"},b2DDmgCalc:{phase:"battle2",step:"battle",stage:"dmgCalc"},b2DAfterDmgCalc:{phase:"battle2",step:"battle",stage:"afterDmgCalc"},b2DEnd:{phase:"battle2",step:"battle",stage:"end"},b2End:{phase:"battle2",step:"end",stage:void 0},main2:{phase:"main2",step:void 0,stage:void 0},end:{phase:"end",step:void 0,stage:void 0}},_o=n=>n.stage?po[n.stage]:n.step?vo[n.step]:ho[n.phase],Ft=fo(Jn).reduce((n,e)=>(n[e].key=e,n[e].name=_o(n[e]),n),Jn),Mi=class Mi{constructor(e,t){o(this,"entity");o(this,"isRegular");o(this,"_isStarted");o(this,"info");o(this,"continuousEffectBase");o(this,"updateState",async()=>{if(this.hasToStart!==this.isStarted){if(this.isStarted){if(!this.info)throw new de("illegal state");this._isStarted=!1,await this.continuousEffectBase.finish(this.entity,this.info),this.info=void 0;return}this.info=await this.continuousEffectBase.start(this.entity),this._isStarted=!0}});this._isStarted=!1,this.entity=e,this.continuousEffectBase=t,this.isRegular=this.appliableCellTypes.every(i=>Tt.find(r=>r===i))&&this.faceList.length===1&&this.faceList[0]==="FaceUp"}get isStarted(){return this._isStarted}get appliableCellTypes(){return this.continuousEffectBase.appliableCellTypes}get appliableDuelPeriodKeys(){return this.continuousEffectBase.appliableDuelPeriodKeys}get faceList(){return this.continuousEffectBase.faceList}get hasToStart(){return!this.appliableCellTypes.includes(this.entity.fieldCell.cellType)||!this.appliableDuelPeriodKeys.includes(this.entity.duel.clock.period.key)||!this.faceList.includes(this.entity.face)?!1:this.continuousEffectBase.canStart(this.entity)}};o(Mi,"createNew",(e,t)=>new Mi(e,t));let dn=Mi;const So=(n,e,t,i,r)=>({title:n,appliableCellTypes:e==="Monster"?["MonsterZone","ExtraMonsterZone"]:["FieldSpellZone","SpellAndTrapZone"],appliableDuelPeriodKeys:ss,faceList:["FaceUp"],canStart:s=>!s.info.isPending&&!s.info.isDying&&t(s),start:async s=>{const l=i(s);return l.forEach(r(s).push),l.map(a=>a.seq)},finish:async(s,l)=>{l.forEach(a=>r(s).removeItem(a))}}),Dn=(n,e,t,i,r,s)=>({title:n,appliableCellTypes:e==="Monster"?["MonsterZone","ExtraMonsterZone"]:["FieldSpellZone","SpellAndTrapZone"],appliableDuelPeriodKeys:ss,faceList:["FaceUp"],canStart:l=>!l.info.isPending&&!l.info.isDying&&i(l),start:async l=>{const a=r(l),c=t(l);return console.info(`start : ${l.toString()} ⇒ ${c.map(u=>u.toString()).join(" ")} (${a.map(u=>u.title).join(" ")})`),c.map(s).forEach(u=>a.forEach(u.push)),{targets:c,seqList:a.map(u=>u.seq)}},finish:async(l,a)=>{a.targets.map(s).forEach(c=>a.seqList.forEach(u=>c.removeItem(u)))}}),iu=(n,e,t,i,r)=>Dn(n,e,t,i,r,s=>s.procFilterBundle),nu=(n,e,t,i)=>So(n,e,t,i,r=>r.field.numericStateOperatorPool),ru=(n,e,t,i,r)=>Dn(n,e,t,i,r,s=>s.numericOprsBundle),su=(n,e,t,i,r)=>Dn(n,e,t,i,r,s=>s.statusOperatorBundle);class wo extends Zi{constructor(){super(...arguments);o(this,"afterDistributeAll",t=>t.field.getAllEntities().map(i=>i.statusOperatorBundle).every(i=>i.calcStatus()))}}class ko extends Vi{constructor(){super(...arguments);o(this,"calcStatus",()=>{const t=this.entity.isEffective;return this.entity.resetStatus(),this.entity.status=this._operators.filter(i=>i.isSpawnedBy.isEffective||!i.isContinuous).reduce((i,r)=>({...i,...r.statusCalculator(r,i)}),this.entity.status),this.entity.isEffective===t});o(this,"beforePush",()=>{})}}class Co extends Kt{constructor(t,i,r,s,l,a,c){super(t,i,r,s,l,a);o(this,"beforeRemove",()=>{});o(this,"statusCalculator");this.statusCalculator=c}}class bo extends Zi{constructor(){super(...arguments);o(this,"afterDistributeAll",()=>!0)}}class Eo extends Vi{constructor(){super(...arguments);o(this,"beforePush",()=>{});o(this,"filter",(t,i,r,s,l,a,c)=>this.effectiveOperators.filter(u=>u.summonKinds.includes(i)).reduce((u,d)=>({...u,...d.filter(this.entity,t,l.summoner,[i,...r],s,l.monster,a,u.posList,u.cells,c)}),l))}}class To extends Kt{constructor(t,i,r,s,l,a,c,u){super(t,i,r,s,l,a);o(this,"beforeRemove",()=>{});o(this,"summonKinds");o(this,"filter");this.summonKinds=c,this.filter=(...d)=>u(this,...d)}}class Ao{constructor(e){o(this,"cells");o(this,"duel");o(this,"summonFilterPool");o(this,"procFilterPool");o(this,"numericStateOperatorPool");o(this,"statusOperatorPool");o(this,"moveLog");o(this,"getAllCells",()=>this.cells.flat());o(this,"getCells",(...e)=>this.getAllCells().filter(t=>e.includes(t.cellType)));o(this,"getAvailableExtraMonsterZones",()=>this.getCells("ExtraMonsterZone").filter(e=>e.isAvailable));o(this,"getAllEntities",()=>this.getAllCells().map(e=>e.entities).flat());o(this,"getAllCardEntities",()=>this.getAllCells().map(e=>e.cardEntities).flat());o(this,"getCardsOnFieldStrictly",()=>this.getCells(...Tt).map(e=>e.cardEntities).filter(e=>e.length>0).map(e=>e[0]).filter(e=>e.isOnFieldStrictly));o(this,"getMonstersOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>e.isOnFieldAsMonsterStrictly));o(this,"getSpellTrapsOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>e.isOnFieldAsSpellTrapStrictly));o(this,"getPendulumScalesOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>{var t;return(t=e.origin.monsterCategories)==null?void 0:t.includes("Pendulum")}).filter(e=>e.isOnFieldAsSpellTrapStrictly).filter(e=>!e.status.spellCategory));o(this,"getPendingCardsOnField",()=>this.getCells(...Tt).map(e=>e.cardEntities).filter(e=>e.length>0).map(e=>e[0]).filter(e=>e.info.isPending));o(this,"getPendingMonstersOnField",()=>this.getPendingCardsOnField().filter(e=>e.kind==="Monster"));o(this,"getEntities",e=>this.getAllEntities().filter(t=>t.controller===e));o(this,"recalcLinkArrows",()=>{const e=this.getAllCells().filter(t=>t.isMonsterZoneLikeCell);e.some(t=>t.recalcLinkArrows)&&e.forEach(t=>t.recalcLinkArrows())});o(this,"canExtraLink",(e,t)=>{if(!e.linkArrows.length)return!1;const i=t.map(u=>u.material),r=this.getCells("ExtraMonsterZone").filter(u=>u.isAvailable||i.includes(u.cardEntities[0]));if(r.length!==1)return!1;const s=r[0],l=e.linkArrows.map(u=>this.cells[s.row+u.offsetRow][s.column+u.offsetColumn]);let a=s.linkArrowSources.filter(u=>!i.includes(u)).filter(u=>l.includes(u.fieldCell));if(!a.length)return!1;let c=-1;for(;c!==a.length;){const u=a.flatMap(d=>d.coLinkedEntities).filter(d=>!i.includes(d));if(u.some(d=>d.fieldCell.cellType==="ExtraMonsterZone"))return!0;a=[...a,...u].getDistinct(),c=a.length}return!1});o(this,"drawAtSameTime",async(e,t,i,r,s,l)=>{const a=[],c=[],u=[e.draw(t,s,l),i.draw(r,s,l)].map(d=>d.catch(f=>{f instanceof At?f.winner&&a.push(f.winner):c.push(f)}));if(await Promise.all(u),c.length)throw new de("ドロー処理で想定されない例外が発生した。",e,t,i,r,s,...c);if(a.length!==0)throw a.length===1?new At(a[0],"対戦相手がデッキからドローできなかった。"):new At(void 0,"お互いにデッキからカードをドローできなかった。")});o(this,"sendToGraveyard",async(e,t,i,r,s,l,a,c)=>{if(r>0&&i.length<r)return;const u=await this.duel.view.waitSelectEntities(t,{selectables:i,qty:r,validator:s,cancelable:c??!1},e);if(u)return await ne.sendManyToGraveyard(u.map(d=>({entity:d,causedAs:l,causedBy:a,activator:t}))),this.duel.log.info(`${u.map(d=>d.status.name).join(", ")}を墓地に送った（${l.getDistinct().join(", ")}）。`,t),u});this.duel=e,this.cells=[...Array(7)].map(()=>[]);for(const t of Object.keys(un).map(Number))for(const i of Object.keys(un[t]).map(Number))this.cells[t][i]=new ao(this,t,i,t<3?e.duelists.Above:t>3?e.duelists.Below:i<2?e.duelists.Above:i>4?e.duelists.Below:void 0);this.summonFilterPool=new bo,this.procFilterPool=new oo,this.numericStateOperatorPool=new co,this.statusOperatorPool=new wo,this.moveLog=new Po(this)}}class Po{constructor(e){o(this,"_field");o(this,"_records",[]);o(this,"getIndexOfStartPoint",e=>Ut(this._records.map(t=>t.movedAt.totalProcSeq),e));o(this,"push",e=>{this._records.push(e)});o(this,"getCurrentTurnLog",()=>this.getTermLog("Current","turn"));o(this,"getPriviousChainLog",()=>this.getTermLog("Previous","chainSeq"));this._field=e}*getTermLog(e,t){const i=e==="Current"?this._field.duel.clock.currentStartPoints[t]:this._field.duel.clock.previousStartPoints[t];for(let r=this.getIndexOfStartPoint(i);r<this._records.length;r++)yield this._records[r]}}class Do{constructor(e){o(this,"entity");o(this,"_records");o(this,"_push",e=>{this.entity.field.moveLog.push(e),this._records.push(e)});o(this,"pushForRuleAction",e=>{this._push({entity:this.entity,kind:this.entity.origin.kind,cell:this.entity.fieldCell,face:this.entity.face,orientation:this.entity.orientation,isPending:this.entity.info.isPending,movedAt:this.entity.duel.clock.getClone(),movedAs:[...e,"Rule"]})});o(this,"push",(e,t,i,r,s)=>{let l=this.entity.fieldCell;this.entity.kind==="XyzMaterial"&&(l=this.entity.controller.getXyzMaterialZone()),this._push({entity:this.entity,kind:e,cell:l,face:this.entity.face,orientation:this.entity.orientation,isPending:this.entity.info.isPending,movedAt:this.entity.duel.clock.getClone(),movedAs:t.getDistinct(),movedBy:i,actionOwner:r,chooser:s??r})});o(this,"finalize",()=>{if(!this.latestRecord.isPending)throw new de("想定されない状況");if(this.entity.info.isPending)throw new de("想定されない状況");this._push({...this.latestRecord,isPending:!1,movedAt:this.entity.duel.clock.getClone()})});o(this,"negateSummon",(e,t)=>{const i=this.records.slice(-1)[0];i.cell=this.entity.field.getCells("Disable")[0],i.movedBy=e,i.movedAs=["SummonNegated"],i.actionOwner=t});this.entity=e,this._records=[]}get records(){return this._records}get latestRecord(){return this.records.slice(-1)[0]}get previousPlaceRecord(){return this.records.findLast(e=>e.cell.cellType!==this.entity.fieldCell.cellType)??this._records[0]}get currentProcRecords(){return this.records.filter(e=>e.movedAt.totalProcSeq===this.entity.duel.clock.totalProcSeq)}}const fn=["SpellCounter","KaijuCounter","NamelessCounter","IceCounter"],hn=["CycleFlip","SonicBarrier","SonicVerse"],Fo=["GoldSarcophagus"],xo=[...fn,...hn,...Fo],qo={SpellCounter:"🔮",KaijuCounter:"☢",NamelessCounter:"💠",IceCounter:"❄"};class Mo{constructor(e){o(this,"dic");o(this,"temporaryCounterNames");o(this,"entity");o(this,"add",(e,t=1,i)=>{this.dic[e]=[...this.dic[e]??[],...Array(t).fill(i)];const r=this.entity.status.maxCounterQty[e]??0;return r&&(this.dic[e]=this.dic[e].slice(0,r)),this.dic[e]});o(this,"setQty",(e,t=1,i)=>(this.dic[e]=[...Array(t).fill(i)],this.dic[e]));o(this,"remove",(e,t=1,i)=>{const r=this.dic[e].length;if(r===void 0)return[];if(t>=r)return delete this.dic[e],[];if(i){const s=this.dic[e].filter(a=>a===i),l=this.dic[e].filter(a=>a!==i);this.dic[e]=[...s.slice(t),...l]}else this.dic[e]=this.dic[e].slice(t);return this.dic[e]});o(this,"removeAll",(e,t)=>{if(t){const r=this.dic[e].filter(s=>s===t).length;return this.dic[e]=this.dic[e].filter(s=>s!==t),r}const i=this.dic[e];return delete this.dic[e],i});o(this,"getQty",(e,t)=>this.dic[e]?t?this.dic[e].filter(i=>i===t).length:this.dic[e].length??0:0);o(this,"incrementActionCountPerTurn",e=>{this.temporaryCounterNames.push(e.title),this.incrementActionCount(e)});o(this,"incrementActionCount",e=>{this.dic[e.title]=[e.entity,...this.dic[e.title]??[]]});o(this,"getActionCount",e=>this.dic[e.title]?this.dic[e.title].filter(t=>t===e.entity).length:0);o(this,"corpseDisposal",()=>{this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),hn.forEach(e=>delete this.dic[e])});o(this,"removeAllActualCounters",()=>{fn.forEach(e=>delete this.dic[e])});o(this,"removeAllWhenfaceDown",()=>{this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),fn.forEach(e=>delete this.dic[e])});o(this,"clear",()=>{hn.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),xo.forEach(e=>delete this.dic[e])});this.dic={},this.temporaryCounterNames=[],this.entity=e}}const ni=class ni extends Di{constructor(){super(...arguments);o(this,"isApplicableTo",(t,i,r)=>{const s=this.entity.counterHolder.getActionCount(this);return this.isOnlyNTimesPerTurnIfFaceup>0&&s>=this.isOnlyNTimesPerTurnIfFaceup?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&s>=this.isOnlyNTimesIfFaceup&&this.entity.counterHolder.incrementActionCount(this),this.definition.isApplicableTo(this,t,i,r)});o(this,"substitute",async(t,i,r)=>{const s=await this.definition.substitute(this,t,i,r);return this.isOnlyNTimesPerTurnIfFaceup>0?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&this.entity.counterHolder.incrementActionCount(this),s});o(this,"getClone",()=>new ni(this.seq,this.entity,this.definition))}get definition(){return super.definition}};o(ni,"createNew",(t,i)=>new ni("AutoSeq",t,i));let vn=ni;const Bo=["FusionSummon","SyncroSummon","XyzSummon","PendulumSummon","LinkSummon","RitualSummon","FlipSummon"],Oo={FusionSummon:"融合召喚",SyncroSummon:"シンクロ召喚",XyzSummon:"エクシーズ召喚",PendulumSummon:"ペンデュラム召喚",LinkSummon:"リンク召喚",RitualSummon:"儀式召喚",FlipSummon:"反転召喚"},No=[...Bo,"AdvanceSummon","NormalSummon","SpecialSummon"],Lo={BattleDestroy:"戦闘破壊",EffectDestroy:"効果破壊",RuleDestroy:"ルール破壊"},as=n=>n+"Summon",er=["Card","Token","Avatar"],Io=["Duelist","Squatter"],os=(n,e)=>ur(n.origin,e.origin),we=class we{constructor(e,t,i,r,s,l,a){o(this,"onBeforeMoveEvent",new Vn);o(this,"onAfterMoveEvent",new Vn);o(this,"seq");o(this,"origin");o(this,"entityType");o(this,"summonFilterBundle");o(this,"procFilterBundle");o(this,"numericOprsBundle");o(this,"statusOperatorBundle");o(this,"moveLog");o(this,"counterHolder");o(this,"face");o(this,"orientation");o(this,"owner");o(this,"fieldCell");o(this,"_status");o(this,"_numericStatus");o(this,"_info");o(this,"actions",[]);o(this,"continuousEffects",[]);o(this,"substituteEffects",[]);o(this,"canBeReleased",(e,t,i,r)=>!this.isInTrashCell&&this.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.union(i).length).every(s=>s.filter(e,t,r,[this])));o(this,"canBeSentToGraveyard",(e,t,i,r)=>!this.info.willBeBanished&&!this.info.willReturnToDeck&&this.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.includes(i)).every(s=>s.filter(e,t,r,[this])));o(this,"_hasDisappeared",!1);o(this,"cardDefinition");o(this,"toString",()=>this.entityType==="Card"?`《${this.nm}》`:this.nm);o(this,"onUsedAsMaterial",(e,t)=>{this.cardDefinition&&this.cardDefinition.onUsedAsMaterial&&this.cardDefinition.onUsedAsMaterial(e,t)});o(this,"setBattlePosition",async(e,t,i,r)=>{let s=`表示形式の変更：${this.toString()}（${this.battlePositionName}⇒${vi[e]}）`;const l=[...t];this.battlePosition==="Set"&&(l.push("Flip"),t.includes("Rule")&&(this.info.isPending=!0,s=`${this.toString()}を反転召喚`,this.info.summonKinds.push("FlipSummon"),l.push("FlipSummon"),l.push("AttackSummon"))),this.duel.log.info(s,r),await this.moveAlone(this.fieldCell,"Monster",e==="Set"?"FaceDown":"FaceUp",e==="Attack"?"Vertical":"Horizontal","Top",l,i,r,r)});o(this,"activateAsPendulumScale",(e,t,i,r)=>this.moveAlone(e,"Spell","FaceUp","Vertical","Top",["CardActivation",...t],i,r,r));o(this,"setNonFieldMonsterPosition",async(e,t,i,r,s)=>{this.moveAlone(this.fieldCell,e,t==="FaceUp"?"FaceUp":"FaceDown","Vertical","Top",i,r,s,s)});o(this,"setAsSpellTrap",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceDown","Vertical","Top",[...i,"SpellTrapSet"],r,s,s)});o(this,"activateSpellTrapFromHand",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceUp","Vertical","Top",[...i,"CardActivation"],r,s,s)});o(this,"putDirectly",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceUp","Vertical","Top",[...i,"PutDirectly"],r,s,s)});o(this,"activateSpellTrapOnField",async(e,t,i,r)=>{await this.moveAlone(this.fieldCell,e,"FaceUp","Vertical","Top",[...t,"CardActivation"],i,r,r)});o(this,"draw",async(e,t,i)=>await this.addToHand([...e,"Draw"],t,i));o(this,"addToHand",async(e,t,i)=>await this.moveAlone(this.owner.getHandCell(),this.origin.kind,"FaceDown","Vertical","Bottom",[...e],t,i,i));o(this,"summon",(e,t,i,r,s,l,a)=>we.summonMany([{monster:this,dest:e,summoner:a??l,pos:t}],i,r,s,l));o(this,"moveForcibly",async(e,t,i,r,s,l,a)=>{await this.moveAlone(e,this.origin.kind,t,i,r,["Rule",...s],l,a,a)});o(this,"moveAlone",async(e,t,i,r,s,l,a,c,u)=>(await we.moveMany([[this,e,t,i,r,s,l,a,c,u]],void 0),this.fieldCell));o(this,"determine",()=>{this.info.isPending&&(this.info.isPending=!1,this.moveLog.finalize(),this.continuousEffects.forEach(e=>e.updateState()))});o(this,"_move",async(e,t,i,r,s,l,a,c,u)=>{if(!e)throw new Error("illegal argument: to");if(await this.onBeforeMoveEvent.trigger({entity:this,args:[e,t,i,r,s,l,a,c,u]}),this.face=i,this.orientation=r,e!==this.fieldCell){if(this.field.duel.clock.turn>0&&(this.duel.log.info(`移動：${this.toString()}  ${this.fieldCell.toString()} ⇒ ${e.toString()}`,c),await this.field.duel.view.waitAnimation({entity:this,to:e,index:s,count:0})),this.fieldCell.releaseEntities(this),this.fieldCell.isPlayFieldCell&&!e.isPlayFieldCell&&(this.counterHolder.clear(),this.resetCauseOfDeath(),this.entityType==="Token")){this._hasDisappeared=!0,this.field.duel.log.info(`${this.nm}は消滅した。`,this.controller);return}this.kind!=="XyzMaterial"&&(this.fieldCell.isMonsterZoneLikeCell&&!e.isMonsterZoneLikeCell||t!=="Monster")&&(this.info.equipEntities.filter(d=>d.isOnFieldAsSpellTrapStrictly).forEach(d=>{d.info.isDying=!0,d.info.causeOfDeath=["RuleDestroy"],this.controller.writeInfoLog(`装備対象${this.toString()}不在により${d.toString()}は破壊された。`)}),this.info.equipEntities=[],this.fieldCell.xyzMaterials.forEach(d=>{d.info.isDying=!0,d.info.causeOfDeath=["LostXyzOwner"],this.controller.writeInfoLog(`エクシーズモンスター${this.toString()}不在により${d.toString()}は墓地に送られた。`)}),this.resetNumericStatus(),this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.info.isEffectiveIn.push(...Tt)),this.fieldCell.cellType==="SpellAndTrapZone"&&e.cellType!=="SpellAndTrapZone"&&(this.info.equipedBy=void 0,this.info.equipedAs=void 0,this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.info.isEffectiveIn.push(...Tt)),e.acceptEntities(this,s),(e===this.isBelongTo||e.cellType==="Hand"||e.cellType==="Banished"&&this.face==="FaceDown")&&(this.counterHolder.clear(),this.resetInfoAll(),this.resetStatusAll())}return(this.isOnFieldStrictly&&this.face==="FaceDown"||t==="XyzMaterial")&&(this.info.equipEntities.forEach(d=>{d.info.isDying=!0,d.info.causeOfDeath=["RuleDestroy"],this.controller.writeInfoLog(`装備対象${this.toString()}不在により${d.toString()}は破壊された。`)}),this.counterHolder.removeAllWhenfaceDown(),this.info.materials=[],this._status.isEffective=!0,this.info.isEffectiveIn=[...Yi],this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.resetNumericStatus(),this.info.isSettingSickness=this.kind==="Trap"||this.status.spellCategory==="QuickPlay"),this._info.kind=t,this.moveLog.push(t,l,a,c,u),await this.onAfterMoveEvent.trigger(this),e});o(this,"initForTurn",()=>{this.info.isSettingSickness=!1,this.info.attackCount=0,this.info.battlePotisionChangeCount=0,this.counterHolder.corpseDisposal()});o(this,"resetInfoIfLeavesTheField",()=>{this._info={...this._info,isDying:!1,isPending:!1,causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,effectTargets:{},attackCount:0,battlePotisionChangeCount:0,materials:[],equipedBy:void 0,equipedAs:void 0,equipEntities:[]},this._info.isEffectiveIn.push(...Tt),this._info.isEffectiveIn.distinct()});o(this,"resetInfoAll",()=>{var e;this._info={kind:this.origin.kind,isDying:!1,isPending:!1,isEffectiveIn:[...Yi],causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,isVanished:!1,isRebornable:((e=this.origin.monsterCategories)==null?void 0:e.union(_s).length)===0,isSettingSickness:!1,summonKinds:[],materials:[],effectTargets:{},willBeBanished:!1,willReturnToDeck:void 0,attackCount:0,battlePotisionChangeCount:0,equipedBy:void 0,equipedAs:void 0,validateEquipOwner:()=>!0,equipEntities:[],battleLog:[]},this.counterHolder.clear()});o(this,"resetNumericStatus",()=>{const e=cr.reduce((t,i)=>(t[i]=this.origin[i],t),{});this._numericStatus={origin:{...e},wip:{...e},calculated:{...e}}});o(this,"resetStatus",()=>{this._status={...this.origin,canAttack:!0,isEffective:!0,canDirectAttack:!1,canActivateEffect:!0,isSelectableForAttack:!0,allowHandSyncro:!1,allowHandLink:!1,maxCounterQty:{}}});o(this,"resetStatusAll",()=>{this.resetNumericStatus(),this.resetStatus()});o(this,"resetCauseOfDeath",()=>{this.info.isDying=!1,this.info.causeOfDeath=[],this.info.isKilledBy=void 0,this.info.isKilledByWhom=void 0});var d,f;this.seq=we.nextEntitySeq++,this.counterHolder=new Mo(this),this.cardDefinition=a,this.owner=e,this.fieldCell=t,this.entityType=i,this.origin=r,this._status=JSON.parse(JSON.stringify(r)),this._numericStatus=JSON.parse(JSON.stringify(r)),this.resetStatusAll(),this._info={kind:this.origin.kind,isEffectiveIn:[...Yi],attackCount:0,battlePotisionChangeCount:0,isDying:!1,isPending:!1,causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,isVanished:!1,isRebornable:!0,isSettingSickness:!1,summonKinds:[],materials:[],effectTargets:{},willBeBanished:!1,willReturnToDeck:void 0,equipedBy:void 0,equipedAs:void 0,validateEquipOwner:()=>!0,equipEntities:[],battleLog:[]},this.resetInfoAll(),this.face=s,this.orientation=l,this.summonFilterBundle=new Eo(t.field.summonFilterPool,this),this.procFilterBundle=new lo(t.field.procFilterPool,this),this.numericOprsBundle=new uo(t.field.numericStateOperatorPool,this),this.statusOperatorBundle=new ko(t.field.statusOperatorPool,this),t.acceptEntities(this,"Top"),this.moveLog=new Do(this),this.moveLog.pushForRuleAction(["Spawn"]);let c=[],u=[];this.origin.kind==="Monster"&&((d=this.origin.monsterCategories)!=null&&d.includes("Normal"))&&!((f=this.origin.monsterCategories)!=null&&f.includes("Pendulum"))?c=[Ss,ws,ks,Cs]:a&&(c=a.actions,u=a.continuousEffects??[],this.substituteEffects.push(...(a.substituteEffects??[]).map(v=>vn.createNew(this,v))),this.origin.kind==="Monster"&&this.entityType==="Card"&&this.summonFilterBundle.push(new To("default",()=>!0,!0,this,{},()=>!0,No,a.defaultSummonFilter??ys)),a.defaultStatus&&this.statusOperatorBundle.push(new Co("default",()=>!0,!0,this,{},()=>!0,()=>a.defaultStatus??{}))),this.actions.push(...c.map(v=>zt.createNew(this,v))),this.continuousEffects.push(...u.map(v=>dn.createNew(this,v)))}get onBeforeMove(){return this.onBeforeMoveEvent.expose()}get onAfterMove(){return this.onAfterMoveEvent.expose()}get isUnderControl(){return this.face==="FaceUp"||Jr.every(e=>e!==this.fieldCell.cellType)}get controller(){return this.fieldCell.owner??this.owner}get field(){return this.owner.duel.field}get duel(){return this.owner.duel.field.duel}get actionLogRecords(){return this.duel.chainBlockLog.records.filter(e=>e.chainBlockInfo.action.entity===this)}get status(){return this._status}set status(e){this._status={...e}}get numericStatus(){return this._numericStatus}get info(){return this._info}get kind(){return this.info.kind}get nm(){return this.status.name}get atk(){return this._numericStatus.calculated.attack}get def(){return this._numericStatus.calculated.defense}get lvl(){return this._numericStatus.calculated.level}get rank(){return this._numericStatus.calculated.rank}get attr(){return this.status.attributes??[]}get types(){return this.status.types??[]}get psL(){return this._numericStatus.calculated.pendulumScaleL}get psR(){return this._numericStatus.calculated.pendulumScaleR}get linkArrows(){let e=(this.origin.linkArrowKeys??[]).map(t=>ms[t].linkArrow);return this.controller.seat==="Above"&&(e=e.map(t=>({offsetColumn:t.offsetColumn*-1,offsetRow:t.offsetRow*-1}))),e}get linkArrowDests(){var e;return(e=this.origin.monsterCategories)!=null&&e.includes("Link")?this.isOnFieldAsMonsterStrictly?this.linkArrows.map(t=>[this.fieldCell.row+t.offsetRow,this.fieldCell.column+t.offsetColumn]).map(([t,i])=>this.field.cells[t][i]).filter(t=>t.isMonsterZoneLikeCell):[]:[]}get linkedEntities(){return this.isOnFieldAsMonsterStrictly?[...this.linkArrowDests.map(e=>e.cardEntities[0]).map(e=>e),...this.fieldCell.linkArrowSources].getDistinct():[]}get coLinkedEntities(){var e;return this.isOnFieldAsMonsterStrictly?(e=this.origin.monsterCategories)!=null&&e.includes("Link")?this.linkArrowDests.map(t=>t.cardEntities[0]).filter(t=>t).union(this.fieldCell.linkArrowSources):[]:[]}get isEffective(){return this.status.isEffective&&this.info.isEffectiveIn.includes(this.fieldCell.cellType)}get isEffectiveWeakly(){return this.status.isEffective}get battlePosition(){if(this.isOnFieldStrictly&&this.kind==="Monster")return this.orientation==="Vertical"?"Attack":this.face==="FaceUp"?"Defense":"Set"}get battlePositionName(){const e=this.battlePosition;if(e)return vi[e]}get wasMovedAtCurrentProc(){return this.field.duel.clock.totalProcSeq===this.moveLog.latestRecord.movedAt.totalProcSeq}get wasMovedAtPreviousProc(){return this.field.duel.clock.totalProcSeq===this.moveLog.latestRecord.movedAt.totalProcSeq+1}get wasMovedAtCurrentTurn(){return this.field.duel.clock.isSameTurn(this.moveLog.latestRecord.movedAt)}get wasMovedAtCurrentChain(){return this.field.duel.clock.isSameChain(this.moveLog.latestRecord.movedAt)}get wasMovedAtPreviousChain(){return this.field.duel.clock.isPreviousChain(this.moveLog.latestRecord.movedAt)}get wasMovedAtPreviousTurn(){return this.field.duel.clock.isPreviousTurn(this.moveLog.latestRecord.movedAt)}get wasMovedFrom(){return this.moveLog.previousPlaceRecord.cell}get isPendulumScale(){var e;return!(!((e=this.origin.monsterCategories)!=null&&e.includes("Pendulum"))||!this.isOnField||!this.fieldCell.isSpellTrapZoneLikeCell||this.status.spellCategory)}get isOnField(){return this.fieldCell.isPlayFieldCell}get isOnFieldStrictly(){return this.isOnField&&!this.info.isPending&&this.kind!=="XyzMaterial"}get isOnFieldAsMonsterStrictly(){return this.fieldCell.isMonsterZoneLikeCell&&this.isOnFieldStrictly}get isOnFieldAsSpellTrapStrictly(){return this.fieldCell.isSpellTrapZoneLikeCell&&this.isOnFieldStrictly}get isInTrashCell(){return this.fieldCell.isTrashCell}get isLikeContinuousSpell(){return this.status.spellCategory==="Continuous"||this.status.spellCategory==="Field"||this.status.spellCategory==="Equip"||this.status.trapCategory==="Continuous"||(this.status.monsterCategories??[]).includes("Pendulum")}get isBelongTo(){return this.origin.monsterCategories&&this.origin.monsterCategories.union(xn).length?this.owner.getExtraDeck():this.owner.getDeckCell()}get hasDisappeared(){return this._hasDisappeared}get allStickyEffectOperators(){return[...this.procFilterBundle.effectiveOperators,...this.numericOprsBundle.effectiveOperators]}};o(we,"nextEntitySeq",0),o(we,"splitBattlePos",e=>({face:e==="Set"?"FaceDown":"FaceUp",orientation:e==="Attack"?"Vertical":"Horizontal"})),o(we,"recreateArray",(e,t)=>{if(!t.length)return[];const i=e.getAllCells().flatMap(r=>r.entities);return t.map(r=>r.seq).map(r=>i.find(s=>s.seq===r)).filter(r=>r!==void 0)}),o(we,"createPlayerEntity",e=>{const t=e.getHandCell();return new we(e,t,"Duelist",{name:e.profile.name,kind:"Monster",wikiEncodedName:"%A5%D7%A5%EC%A5%A4%A5%E4%A1%BC"},"FaceUp","Vertical",{name:e.profile.name,actions:[...gs]})}),o(we,"createCardEntity",(e,t)=>{var l,a;const i=t.monsterCategories&&t.monsterCategories.union(xn).length?e.getExtraDeck():e.getDeckCell(),r=qn(t),s=Xo.get(t.name);if(r.kind==="Monster"&&((l=r.monsterCategories)!=null&&l.includes("Normal"))&&!((a=r.monsterCategories)!=null&&a.includes("Pendulum"))||s)return new we(e,i,"Card",qn(t),"FaceDown","Vertical",s);console.info(`${t.name}のカード効果が未定義のため、デッキに投入されなかった。`)}),o(we,"moveMany",async(e,t)=>{if(!e.length)return;const i=e[0][0].duel,s=[...e.filter(([a,c])=>a.fieldCell!==c).map(([a])=>a).filter(a=>!(t??[]).includes(a)),...i.field.getCardsOnFieldStrictly().filter(a=>a.info.isDying)],l=new Map;for(e.forEach(([a,c,u,d,f,v,...g])=>{var b;let m=c,S=u,p=d,C=v,w=f;a.info.willBeBanished?(m=a.owner.getBanished(),p="FaceUp",w="Vertical"):a.info.willReturnToDeck?(m=a.isBelongTo,p="FaceDown",C=a.info.willReturnToDeck,w="Vertical"):(b=a.status.monsterCategories)!=null&&b.includes("Pendulum")&&a.isOnFieldStrictly&&a.face==="FaceUp"&&c.isTrashCell&&(m=a.owner.getExtraDeck(),p="FaceUp",C="Top",w="Vertical"),m.cellType==="ExtraDeck"&&(C=p==="FaceUp"?"Top":"Bottom"),a.isBelongTo.cellType==="ExtraDeck"&&(m.cellType==="Hand"||m.cellType==="Deck")&&(m=a.isBelongTo,p="FaceDown",w="Vertical"),m.isPlayFieldCell||(console.log(we.toString(),u,c),S=a.origin.kind),m.isMonsterZoneLikeCell||(w="Vertical"),l.set(m,[[a,m,S,p,w,C,...g],...l.get(m)??[]])});;){const a=Array.from(l.values()).map(u=>u.pop()).filter(u=>u!==void 0).map(([u,...d])=>u._move(...d));if(!a.length)break;await Promise.all(a);const c=i.field.getCardsOnFieldStrictly().filter(u=>u.info.isDying).filter(u=>!s.includes(u)).map(u=>({entity:u,causedAs:u.info.causeOfDeath??[],causedBy:u.info.isKilledBy,activator:u.info.isKilledByWhom}));c.length&&await we.sendManyToGraveyard(c,s)}we.settleEntityMove(i)}),o(we,"summonMany",async(e,t,i,r,s)=>{if(!e.length)return;const l={Attack:"AttackSummon",Defense:"DefenseSummon",Set:"SetSummon"},a=e.map(({monster:c,dest:u,pos:d,summoner:f})=>{if(c.info.summonKinds=[t],t==="NormalSummon"||t==="AdvanceSummon"){c.info.summonKinds.push("NormalSummon");const m=t==="AdvanceSummon"?"アドバンス":"";d==="Attack"?c.field.duel.log.info(`${c.toString()}を${m}召喚`,f):c.duel.log.info(`${c.toString()}を${m}セット`,f),i.includes("Rule")?f.info.ruleNormalSummonCountQty++:f.info.effectNormalSummonCountQty++}else t==="SpecialSummon"?c.duel.log.info(`${c.toString()}を${vi[d]}で特殊召喚`,f):(c.info.summonKinds.push("SpecialSummon"),c.duel.log.info(`${c.toString()}を${vi[d]}で${Oo[t]}！`,f)),f.info.specialSummonCountQty++;c.info.summonKinds=c.info.summonKinds.getDistinct(),c.info.battlePotisionChangeCount=1;const{face:v,orientation:g}=we.splitBattlePos(d);return i.includes("Rule")&&(c.info.isPending=!0),{entity:c,args:[u,"Monster",v,g,"Top",[t,l[d],...i],r,s,f]}}).map(c=>c.entity._move(...c.args));await Promise.all(a),e.map(c=>c.summoner).forEach(c=>{t==="NormalSummon"||t==="AdvanceSummon"?i.includes("Rule")?c.info.ruleNormalSummonCount++:c.info.effectNormalSummonCount++:c.info.specialSummonCount++}),we.settleEntityMove(e[0].monster.duel)}),o(we,"sendManyToGraveyard",(e,t)=>we.bringManyToSameCell("Graveyard","Top",e.map(i=>({...i,face:"FaceUp",orientation:"Vertical"})),t)),o(we,"bringManyToSameCell",(e,t,i,r)=>we.moveMany(i.map(s=>[s.entity,s.entity.field.getCells(e).filter(l=>l.owner===s.entity.owner)[0],s.entity.origin.kind,s.face,s.orientation,t,s.causedAs,s.causedBy,s.activator,s.activator]),r)),o(we,"settleEntityMove",e=>{e.field.recalcLinkArrows(),e.distributeOperators(e.clock);const t=e.field.getAllEntities().filter(i=>i.wasMovedAtCurrentProc);t.filter(i=>!i.isOnFieldStrictly&&!i.info.isPending).forEach(i=>i.resetInfoIfLeavesTheField()),t.filter(i=>i.face==="FaceDown").filter(i=>i.fieldCell===i.isBelongTo).forEach(i=>{i.resetInfoAll(),i.resetStatusAll()}),t.flatMap(i=>i.continuousEffects).forEach(i=>i.updateState()),e.field.getAllCells().filter(i=>i.needsShuffle).map(i=>i.shuffle())});let ne=we;ne.prototype.hasBeenSummonedNow=function(n,e=["Attack","Defense"]){const t=this,i=e.map(as),r=t.moveLog.latestRecord.movedAs;return!(!t.wasMovedAtPreviousChain||!r.union(n).length||!r.union(i).length)};ne.prototype.hasBeenSummonedJustNow=function(n,e=["Attack","Defense"]){const t=this,i=e.map(as),r=t.moveLog.latestRecord.movedAs;return!(!t.wasMovedAtPreviousProc||!r.union(n).length||!r.union(i).length)};ne.prototype.getAttackTargets=function(){if(!this.hasAttackRight())return[];const n=this.controller.getOpponentPlayer().getMonstersOnField().filter(e=>e.status.isSelectableForAttack);return console.log(this.toString(),this.status.canDirectAttack),(this.status.canDirectAttack||!n.length)&&n.push(this.controller.getOpponentPlayer().entity),n.filter(e=>e.canBeTargetOfBattle(this.controller,this)).filter(e=>this.procFilterBundle.effectiveOperators.filter(t=>t.procTypes.includes("BattleTarget")).every(t=>t.filter(this.controller,this,{},[e])))};ne.prototype.canDirectAttack=function(){return this.getAttackTargets().some(n=>n.entityType==="Duelist")};ne.prototype.canAttackToMonster=function(){return this.getAttackTargets().some(n=>n.entityType!=="Duelist")};ne.prototype.hasAttackRight=function(){return this.battlePosition==="Attack"&&this.info.attackCount===0&&this.status.canAttack};ne.prototype.canBeEffected=function(n,e,t){return this.procFilterBundle.effectiveOperators.filter(r=>r.procTypes.some(s=>s==="Effect")).every(r=>r.filter(n,e,t,[this]))};const ls=(n,e,t,i,r)=>n.canBeEffected(t,i,r)&&n.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.some(l=>l===e)).every(s=>s.filter(t,i,r,[n]));ne.prototype.canBeTargetOfEffect=function(n){return ls(this,"EffectTarget",n.activator,n.action.entity,n.action)};ne.prototype.canBeBanished=function(n,e,t,i){return this.fieldCell.cellType==="Banished"?!1:ls(this,n,e,t,i)};ne.prototype.canBeTargetOfBattle=function(n,e){const t=this;return t.procFilterBundle.effectiveOperators.filter(i=>i.procTypes.some(r=>r==="BattleTarget")).every(i=>i.filter(n,e,{},[t]))};ne.prototype.validateDestory=function(n,e,t,i){const r=this;let s=r.procFilterBundle.effectiveOperators.filter(l=>l.procTypes.includes(n)).every(l=>l.filter(e,t,i??{},[r]));return s&&n==="EffectDestroy"&&(s=r.canBeEffected(e,t,i)),s};ne.prototype.getIndexInCell=function(){const n=this;if(n.info.isVanished)return-1;const e=n.fieldCell.cardEntities.indexOf(n);if(e<0)throw new de("エンティティとセルの状態が矛盾している。",[n,n.fieldCell]);return e};ne.prototype.getXyzMaterials=function(){const n=this;return(n.status.monsterCategories??[]).includes("Xyz")?n.fieldCell.xyzMaterials:[]};ne.prototype.wasMovedAfter=function(n){return this.moveLog.latestRecord.movedAt.totalProcSeq>n.totalProcSeq};ne.prototype.hadArrivedToFieldAt=function(){let n=this.moveLog.latestRecord.movedAt;return this.moveLog.records.findLast(e=>!e.cell.isPlayFieldCell||e.isPending||e.kind!==this.kind||e.face==="FaceDown"?!0:(n=e.movedAt,!1)),n};ne.prototype.release=async function(n,e,t){return await this.sendToGraveyard([...n,"Release"],e,t),this.info.isVanished?void 0:this.fieldCell};ne.prototype.ruleDestory=async function(){return await this.sendToGraveyard(["RuleDestroy"],void 0,void 0),this.info.isVanished?void 0:this.fieldCell};ne.prototype.sendToGraveyard=function(n,e,t){return Ge.sendManyToGraveyardForTheSameReason([this],n,e,t)};ne.prototype.discard=function(n,e,t){return Ge.discardManyForTheSameReason([this],n,e,t)};ne.prototype.returnToDeck=function(n,e,t,i){return Ge.returnManyToDeckForTheSameReason(n,[this],e,t,i)};ne.prototype.banish=function(n,e,t){return Ge.banishManyForTheSameReason([this],n,e,t)};Nt.prototype.summon=async function(n,e,t,i,r,s,l,a){return(await this.summonMany(this,n,e,t,[{monster:i,posList:r,cells:s}],l,!1,1,u=>u.length===1,a)??[])[0]};Nt.prototype.waitSelectEntities=function(n,e,t,i,r=!1){return this.duel.view.waitSelectEntities(this,{selectables:n,qty:e,validator:t,cancelable:r},i)};Nt.prototype.waitSelectEntity=async function(n,e,t=!1){const i=await this.waitSelectEntities(n,1,r=>r.length===1,e,t);return i?i[0]:void 0};let Ro=class{constructor(e){o(this,"onUpdateEvent",new Ae);o(this,"nextSeq");o(this,"records",[]);o(this,"duel");o(this,"dispose",()=>{this.onUpdateEvent.clear()});o(this,"error",e=>{console.error(e);const t=["エラー発生"];e instanceof Error?(e instanceof de&&(t.push("-- エラーメッセージ --"),t.push(e.message),t.push("-- 関連オブジェクト --"),e.items.forEach(i=>t.push(JSON.stringify(i))),console.error(e.items)),t.push("-- エラー名称 --"),t.push(e.name||"エラー名称取得失敗"),t.push("-- スタックトレース --"),t.push(e.stack||"スタックトレース取得失敗")):(t.push("-- エラー型特定失敗 --"),t.push(JSON.stringify(e))),this.write("error","System",t,void 0,void 0,void 0,void 0,void 0)});o(this,"warn",e=>{this.write("warn","System",["【注意】",e],void 0,void 0,void 0,void 0,void 0)});o(this,"info",(e,t)=>{this.write("info","Others",[e],t,void 0,void 0,void 0,void 0)});o(this,"pushMoveLog",(e,t,i,r)=>{this.write("info","EntityMove",["移動"],e,t,void 0,i,r)});o(this,"write",(e,t,i,r,s,l,a,c)=>{const u=i.join(`
`);this.records.push({seq:this.nextSeq++,lvl:e,type:t,clock:this.duel.clock.getClone(),text:u,duelist:r,mainEntity:s,subEntities:l??[],from:a,to:c}),this.onUpdateEvent.trigger(this.nextSeq-1)});this.nextSeq=0,this.duel=e}get onUpdate(){return this.onUpdateEvent.expose()}get lastRecord(){return this.records.slice(-1)[0]}};const $o=n=>new Promise(e=>setTimeout(e,n)),cs=()=>{let n=()=>{},e=()=>{};return{promise:new Promise((i,r)=>{n=i,e=r}),resolve:n,reject:e}};class Ji{constructor(e){o(this,"onUpdateEvent",new Ae);o(this,"_state","Disable");o(this,"defaultArgs");o(this,"_args");o(this,"resolve",()=>{});o(this,"show",e=>{this._args=e,this._state="Shown",this.onUpdateEvent.trigger();const{promise:t,resolve:i}=cs();return this.resolve=r=>{this._state="Disable",i(r),this.resolve=()=>{},this.onUpdateEvent.trigger()},t});o(this,"cancel",()=>{this._state!=="Disable"&&this.resolve(void 0),this.terminate()});o(this,"terminate",()=>{this._state="Disable",this._args=this.defaultArgs,this.resolve=()=>{}});this.defaultArgs=e,this._args=e}get onUpdate(){return this.onUpdateEvent.expose()}get state(){return this._state}get args(){return this._args}}class Uo{constructor(e){o(this,"onUpdateEvent",new Ae);o(this,"actionSelector",new Ji({title:"カード操作を選択。",activator:void 0,dummyActionInfos:[],cancelable:!1}));o(this,"entitySelector",new Ji({title:"対象を選択",entitiesChoices:{selectables:[],validator:()=>!0,cancelable:!1},cancelable:!1,chainBlockInfos:[]}));o(this,"textSelector",new Ji({title:"カード操作を選択。",choises:[],cancelable:!1}));o(this,"modals",[this.actionSelector,this.entitySelector,this.textSelector]);o(this,"view");o(this,"terminateAll",()=>{this.modals.forEach(e=>e.terminate()),this.onUpdateEvent.trigger()});this.view=e,this.modals.forEach(t=>t.onUpdate.append(()=>this.onUpdateEvent.trigger()))}get onUpdate(){return this.onUpdateEvent.expose()}}const tr=n=>{let e=[];do{const t=n.qty&&n.qty>0?n.qty:Math.floor(Math.random()*n.selectables.length+1);e=n.selectables.randomPickMany(t)}while(!n.validator(e));return e},Ho=[{seq:10,name:"Internet Explorer",key:"msie"},{seq:20,name:"Internet Explorer",key:"trident"},{seq:30,name:"Edge",key:"edge"},{seq:40,name:"Google Chrome",key:"chrome"},{seq:50,name:"Safari",key:"safari"},{seq:60,name:"Mozilla Firefox",key:"firefox"},{seq:70,name:"Opera",key:"opera"}],jo=[{seq:10,name:"Microsoft Windows",key:"windows nt"},{seq:20,name:"Android",key:"android"},{seq:30,name:"iOS",key:"iphone"},{seq:40,name:"iOS",key:"ipad"},{seq:50,name:"macOS",key:"mac os x"}],ci=window.navigator.userAgent.toLowerCase();var or;const Zo=((or=Ho.find(n=>ci.indexOf(n.key)!==-1))==null?void 0:or.name)??"Unknown Browser";var lr;const Fn=((lr=jo.find(n=>ci.indexOf(n.key)!==-1))==null?void 0:lr.name)??"Unknown OS",us=ci.indexOf("iphone")!==-1||Fn==="Android"&&ci.indexOf("mobile")!==-1,Vo=ci.indexOf("ipad")!==-1||Fn==="Android"&&!us,ir=us?"Smart Phone":Vo?"Tablet Device":"PC",en={canDragElement:ir==="PC",text:`${ir} ${Fn} ${Zo}`};class zo{constructor(e){o(this,"onDuelUpdateEvent",new Ae);o(this,"requireUpdate",()=>{this.onDuelUpdateEvent.trigger()});o(this,"onWaitStartEvent",new Ae);o(this,"onWaitEndEvent",new Ae);o(this,"onDragStartEvent",new Ae);o(this,"onDragEndEvent",new Ae);o(this,"onAnimationStartEvent",new Ae);o(this,"onShowCardEntityEvent",new Ae);o(this,"duel");o(this,"modalController");o(this,"_message");o(this,"waitMode");o(this,"infoBoardState");o(this,"infoBoardCell");o(this,"getCell",(e,t)=>this.duel.field.cells[e][t]);o(this,"showCardInfo",(e,t)=>{this.onShowCardEntityEvent.trigger({card:e,mode:t})});o(this,"dispose",()=>{this.onDragStartEvent.clear(),this.onDragEndEvent.clear(),this.onDuelUpdateEvent.clear(),this.onWaitStartEvent.clear(),this.onWaitEndEvent.clear()});o(this,"waitFieldAction",async e=>{if(this.duel.getTurnPlayer().duelistType==="NPC"){const s=this.duel.getTurnPlayer().selectActionForNPC(e,[]);return s?{actionInfo:s}:{phaseChange:this.duel.nextPhaseList[0]}}const t=await this._waitDuelistAction(this.duel.getTurnPlayer(),e,"Free","",void 0,void 0,!1);if(!t.actionInfo)return{...t,actionInfo:void 0};const i={...t.actionInfo},r=e.find(s=>{var l;return((l=t.actionInfo)==null?void 0:l.originSeq)===s.originSeq});if(!r)throw new de("想定されない状態",e,t);return{...t,actionInfo:{dest:i.dest,battlePosition:i.battlePosition,action:r.action,originSeq:r.originSeq}}});o(this,"waitQuickEffect",async(e,t,i,r,s)=>{if(t.length===0)return;if(e.duelistType==="NPC")return e.selectActionForNPC(t,i);const l=[];return l.push(this.modalController.actionSelector.show({title:r,activator:e,dummyActionInfos:t,cancelable:s}).then(a=>{if(a)return t.find(c=>c.originSeq===a.originSeq)})),l.push(this._waitDuelistAction(e,t,"Modal",this.message,void 0,void 0,!1).then(a=>(this.infoBoardState="Log",t.find(c=>{var u;return((u=a.actionInfo)==null?void 0:u.originSeq)===c.originSeq})))),await Promise.any(l)});o(this,"waitSubAction",async(e,t,i,r=!1)=>{if(e.duelistType==="NPC")throw Error("Not implemented");const s=await this._waitDuelistAction(e,t,"Modal",i,void 0,void 0,r);if(s&&s.actionInfo)return s.actionInfo});o(this,"waitSelectEntities",async(e,t,i)=>{if(!t.selectables.length)return;if(t.qty&&t.selectables.length===t.qty)return[...t.selectables];if(e.duelistType==="NPC")return tr(t);let r;t.selectables.some(l=>l.entityType==="Duelist")&&(r={...t,selectables:t.selectables.filter(l=>l.entityType==="Duelist").map(l=>l.fieldCell),qty:1,validator:l=>l.length===1});const s=await this._waitDuelistAction(e,[],"Modal",i,t,r,t.cancelable);return[...s.selectedEntities??[],...(s.selectedCells??[]).flatMap(l=>l.entities).filter(l=>l.entityType==="Duelist")]});o(this,"waitSelectText",(e,t,i=!1)=>this.modalController.textSelector.show({title:t,choises:e,cancelable:i}));o(this,"waitAnimation",async e=>(this._message="",this.waitMode="Animation",this.onDuelUpdateEvent.trigger(),new Promise(t=>this.onAnimationStartEvent.trigger({...e,resolve:t}))));o(this,"setDraggingActions",e=>{this.onDragStartEvent.trigger(e),this.requireUpdate()});o(this,"removeDraggingActions",()=>{this.onDragEndEvent.trigger()});o(this,"waitSelectAction",async(e,t,i,r)=>{var c;const s=t.map(u=>zt.createDummyAction(u.entity,u.title,[],void 0,u.origin)),l=await this._waitDammyAction(e,s,i,r);if(!l)return;const a=(c=t.find(u=>u.origin.seq===l.originSeq))==null?void 0:c.origin;if(!a)throw new de("想定されない状態",t,l);return a});o(this,"waitSelectSummonDestination",async(e,t,i,r,s)=>{const l=i.length>1&&en.canDragElement?"カードを召喚先へドラッグ。":"表示形式を選択。";if(!i.length&&!r.length){if(s)return;throw new de("想定されない状態",e,t,i,r,s)}let a=[...r];for(;;){const c={dest:i.randomPick(),battlePosition:a[0]};if(a.length===1&&!en.canDragElement){const f=await this.waitSelectCell(e,i,s,"召喚先を選択。");return f?{dest:f,battlePosition:r[0]}:void 0}const u=a.map(f=>zt.createDummyAction(t,f,i,f)),d=await this._waitDammyAction(e,u,l,s);if(!d)return;if(d.battlePosition&&(a=[d.battlePosition]),!(i.length>1&&!d.dest))return c.dest=d.dest??c.dest,c.battlePosition=d.battlePosition??c.battlePosition,c}});o(this,"waitSelectDestination",async(e,t,i,r,s,l=!1)=>{if(!i.length)return;if(i.length===1)return i[0];if(!en.canDragElement)return await this.waitSelectCell(e,i,l,r);let a=i.randomPick();const c=[zt.createDummyAction(t,s,i,void 0)],u=await this._waitDammyAction(e,c,r,l);if(u)return a=u.dest??a,a});o(this,"_waitDammyAction",async(e,t,i,r=!1)=>{if(!t.length)return;const s=t.randomPick();let l={...s,dest:s.dest??s.dests.randomPick()};if(e.duelistType!=="NPC"){const a=[this.modalController.actionSelector.show({title:i,activator:e,dummyActionInfos:t,cancelable:!1}),this.duel.view.waitSubAction(e,t,i,r)],c=await Promise.any(a);if(!c&&!r)throw new nr(c,a);if(!c)return;l=c??l}return l});o(this,"waitSelectCell",async(e,t,i,r)=>t.length?e.duelistType==="NPC"?t.randomPick():(await this.waitSelectCells(e,{selectables:t,qty:1,validator:l=>l.length===1,cancelable:i},r)??[])[0]:void 0);o(this,"waitSelectCells",async(e,t,i)=>{if(!t.selectables.length)return;if(e.duelistType==="NPC")return tr(t);const r=await this._waitDuelistAction(e,[],"Modal",i,void 0,t,t.cancelable);if((!r||!r.selectedCells)&&!t.cancelable)throw new nr(e,t,i);return r.selectedCells});o(this,"_waitDuelistAction",async(e,t,i,r,s,l,a=!1)=>{this.waitMode=i,this._message=r,this.onDuelUpdateEvent.trigger();const c=cs(),u={resolve:c.resolve,activator:e,dummyActionInfos:t,chainBlockInfos:e.duel.chainBlockInfos,entitiesChoices:s,cellsChoices:l};this.onWaitStartEvent.trigger(u);const d=await c.promise;if(this.modalController.terminateAll(),this.waitMode="None",this.onWaitEndEvent.trigger(),d.surrender)throw new At(e.getOpponentPlayer(),`${e.profile.name}がサレンダーした。`);if(!a&&d.cancel)throw new de("キャンセル不可のアクションがキャンセルされた。",d,t,i,s,l);return this.infoBoardState="Log",d});this.duel=e,this._message="",this.waitMode="None",this.infoBoardState="Log",this.infoBoardCell=e.duelists.Below.getExtraDeck(),this.modalController=new Uo(this)}get onDuelUpdate(){return this.onDuelUpdateEvent.expose()}get onWaitStart(){return this.onWaitStartEvent.expose()}get onWaitEnd(){return this.onWaitEndEvent.expose()}get onDragStart(){return this.onDragStartEvent.expose()}get onDragEnd(){return this.onDragEndEvent.expose()}get onAnimation(){return this.onAnimationStartEvent.expose()}get onShowCardEntity(){return this.onShowCardEntityEvent.expose()}get message(){return this._message||this.duel.log.lastRecord.text}}const pn=["turn","phaseSeq","stepSeq","stageSeq","chainSeq","chainBlockSeq","procSeq"];[...pn];class Go{constructor(){o(this,"onClockChangeEvents",{turn:new Ae,phaseSeq:new Ae,stepSeq:new Ae,stageSeq:new Ae,chainSeq:new Ae,chainBlockSeq:new Ae,procSeq:new Ae});o(this,"_turn",0);o(this,"_phaseSeq",0);o(this,"_stepSeq",0);o(this,"_stageSeq",0);o(this,"_chainSeq",0);o(this,"_chainBlockSeq",0);o(this,"_procSeq",0);o(this,"_totalProcSeq",0);o(this,"_periodKey");o(this,"_previousStartPoints",{turn:0,phaseSeq:0,stepSeq:0,stageSeq:0,chainSeq:0,chainBlockSeq:0,procSeq:0});o(this,"_currentStartPoints",{turn:0,phaseSeq:0,stepSeq:0,stageSeq:0,chainSeq:0,chainBlockSeq:0,procSeq:0});o(this,"setPhase",(e,t)=>{const i=Object.values(Ft).filter(r=>r.phase===t).find(r=>(r.step??"start")==="start");if(!i)throw new de("想定されない状態",this.period,t,Ft);t==="draw"?(this.turn>0&&e.log.info("ターン終了。",e.getTurnPlayer()),this._turn++,this._phaseSeq=0):(e.log.info(`フェイズ移行（${this.period.name}→${i.name}）`,e.getTurnPlayer()),this._phaseSeq++),this._stepSeq=0,this._stageSeq=0,this.periodKey=i.key});o(this,"setStep",(e,t)=>{const i=this.period.phase,r=Object.values(Ft).filter(s=>s.phase===i).find(s=>(s.step??"")===t);if(!r)throw new de("想定されない状態",this.period,t,Ft);this.period.name!==r.name&&(e.log.info(`ステップ移行（${this.period.name}→${r.name}）`,e.getTurnPlayer()),this._stepSeq++,this._stageSeq=0,this.periodKey=r.key)});o(this,"setStage",(e,t)=>{const i=this.period,r=Object.values(Ft).filter(s=>s.phase===i.phase).filter(s=>s.step===i.step).find(s=>(s.stage??"")===t);if(!r)throw new de("想定されない状態",this.period,t,Ft);e.log.info(`タイミング移行（${this.period.name}→${r.name}）`,e.getTurnPlayer()),this._stageSeq++,this.periodKey=r.key});o(this,"incrementChainSeq",()=>{this._chainSeq++,this._chainBlockSeq=0,this._procSeq=0,this.incrementTotalProcSeq()});o(this,"incrementChainBlockSeq",()=>{this._chainBlockSeq++,this._procSeq=0,this.incrementTotalProcSeq()});o(this,"incrementProcSeq",()=>{this._procSeq++,this.incrementTotalProcSeq()});o(this,"incrementTotalProcSeq",()=>{this._totalProcSeq++;let e=!1;pn.toReversed().forEach(t=>{e&&(this._previousStartPoints[t]=this.currentStartPoints[t],this._currentStartPoints[t]=this.totalProcSeq),e=this[t]===0}),pn.toReversed().filter(t=>this._currentStartPoints[t]=this.totalProcSeq).filter(t=>t!=="procSeq").forEach(t=>this.onClockChangeEvents[t].trigger(this)),this.onClockChangeEvents.procSeq.trigger(this)});o(this,"toString",()=>`${this.totalProcSeq}(t${this.turn}-phs${this.phaseSeq}-stp${this.stepSeq}-stg${this.stepSeq}-c${this.chainSeq}-cb${this.chainBlockSeq}-prc${this.procSeq})`);o(this,"getClone",()=>({turn:this.turn,phaseSeq:this.phaseSeq,stepSeq:this.stepSeq,stageSeq:this.stageSeq,chainSeq:this.chainSeq,chainBlockSeq:this.chainBlockSeq,procSeq:this.procSeq,totalProcSeq:this.totalProcSeq,period:this.period}));o(this,"isSameTurn",e=>this.turn===e.turn);o(this,"isSameChain",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq&&this.chainSeq===e.chainSeq);o(this,"isPreviousChain",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq&&this.chainSeq===e.chainSeq+1);o(this,"isPreviousStage",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq+1);o(this,"isPreviousTurn",e=>this.turn===e.turn+1);o(this,"isPreviousProc",e=>this.totalProcSeq===e.totalProcSeq+1);o(this,"isUponAttackDeclaration",()=>this.period.step==="battle"&&this.chainSeq===1);this._periodKey="end"}get onTurnChange(){return this.onClockChangeEvents.turn.expose()}get onStageChange(){return this.onClockChangeEvents.stageSeq.expose()}get onProcSeqChange(){return this.onClockChangeEvents.procSeq.expose()}get previousStartPoints(){return this._previousStartPoints}get currentStartPoints(){return this._currentStartPoints}set periodKey(e){this._periodKey!==e&&(this._periodKey=e,this._chainSeq=0,this._chainBlockSeq=0,this._procSeq=0,this.incrementTotalProcSeq())}get periodKey(){return this._periodKey}get period(){return Ft[this.periodKey]}get turn(){return this._turn}get phaseSeq(){return this._phaseSeq}get stepSeq(){return this._stepSeq}get stageSeq(){return this._stageSeq}get chainSeq(){return this._chainSeq}get chainBlockSeq(){return this._chainBlockSeq}get procSeq(){return this._procSeq}get totalProcSeq(){return this._totalProcSeq}get isFirstChain(){return this.chainSeq===0}}class Ko{constructor(e){o(this,"nextSeq");o(this,"records",[]);o(this,"duel");o(this,"push",e=>{this.records.push({seq:this.nextSeq++,clock:this.duel.clock.getClone(),chainBlockInfo:e})});this.nextSeq=0,this.duel=e}}const Wo=["PlayFirst","DrawFirst","Random"],ou={PlayFirst:"先攻",DrawFirst:"後攻",Random:"ランダム"};class At extends Error{constructor(t,i){super(t?`デュエルが終了した。勝者：${t.profile.name}`:"デュエルが終了した。ドロー。");o(this,"winner");o(this,"message");this.winner=t,this.message=i}}class de extends Error{constructor(t,...i){super(t);o(this,"message");o(this,"items");this.message=t,this.items=i}}class nr extends de{constructor(...e){super("キャンセル不可のアクションがキャンセルされた。",...e)}}class lu{constructor(e,t,i,r=[],s,l,a,c=[],u="Random"){o(this,"onDuelEndEvent",new Ae);o(this,"view");o(this,"log");o(this,"chainBlockLog");o(this,"clock");o(this,"nextPhaseList");o(this,"field");o(this,"attackingMonster");o(this,"targetForAttack");o(this,"_chainBlockInfos");o(this,"duelists");o(this,"priorityHolder");o(this,"isEnded");o(this,"winner");o(this,"coin",!1);o(this,"startMode");o(this,"distributeOperators",e=>{console.info(`[totalProcSeq]:${e.totalProcSeq}`);let t=0;for(;;){if(t++,t>10)throw new de("無限ループ発生");if(this.field.procFilterPool.distributeAll(this)&&this.field.statusOperatorPool.distributeAll(this)&&this.field.numericStateOperatorPool.distributeAll(this)&&this.field.summonFilterPool.distributeAll(this))return}});o(this,"getTurnPlayer",()=>this.clock.turn%2===0?this.secondPlayer:this.firstPlayer);o(this,"getNonTurnPlayer",()=>this.clock.turn%2===0?this.firstPlayer:this.secondPlayer);o(this,"main",async()=>{console.info("main start!"),this.coin=this.startMode==="PlayFirst"?!0:this.startMode==="DrawFirst"?!1:Math.random()>.5,this.priorityHolder=this.firstPlayer;for(const e of Object.values(this.duelists))e.pushDeck(),e.getDeckCell().shuffle(),e.initHand.length&&e.initHand.forEach(t=>{const i=e.getDeckCell().cardEntities.find(r=>r.origin.name===t);if(!i){this.log.info(`初手操作により${t}を手札に加えようとしたが、デッキに存在しない。`);return}i.addToHand(["System"],void 0,void 0),this.log.info(`初手操作により${i.toString()}を手札に加えた`,e)}),await e.draw(5-e.getHandCell().cardEntities.length,void 0,void 0);this.log.info(`【デュエル開始】${this.firstPlayer.profile.name} V.S. ${this.secondPlayer.profile.name}`),this.log.info(`先攻：${this.firstPlayer.profile.name} 後攻：${this.secondPlayer.profile.name}`),this.moveNextPhase("draw");try{for(const e of Object.values(this.duelists))for(const t of this.getEnableActions(e,["Exodia"],["Normal"],[]))await t.action.directExecute(e,void 0,!1);for(;!this.isEnded&&(this.clock.period.phase==="draw"?await this.procDrawPhase():this.phase==="standby"?await this.procStanbyPhase():this.phase==="main1"?await this.procMainPhase():this.phase==="battle1"?await this.procBattlePhase():this.phase==="battle2"?await this.procBattlePhase():this.phase==="main2"?await this.procMainPhase():this.phase==="end"&&await this.procEndPhase(),!(this.clock.turn>1e3)););}catch(e){e instanceof At?(this.clock.incrementChainSeq(),console.info(e),this.isEnded=!0,this.winner=e.winner,this.log.info(e.winner?`デュエル終了。勝者${e.winner.profile.name}。${e.message}`:`デュエル終了。引き分け。${e.message}`),this.onDuelEndEvent.trigger()):e instanceof Error&&this.log.error(e)}finally{this.log.dispose()}});o(this,"moveNextPhase",e=>{this.clock.setPhase(this,e),this.phase==="main2"||this.clock.turn===1?this.nextPhaseList=["end"]:this.phase==="battle1"||this.phase==="battle2"?this.nextPhaseList=["main2"]:this.phase==="main1"?this.nextPhaseList=["battle1","end"]:this.nextPhaseList=[]});o(this,"declareAnAttack",(e,t)=>{var r;this.attackingMonster=e,this.targetForAttack=t;let i=" ("+((r=t.battlePosition==="Attack"?t.atk:t.def)==null?void 0:r.toString())+")";t.face==="FaceDown"&&(i=" (????)"),t.entityType==="Duelist"&&(i=""),e.info.attackCount++,this.log.info(`攻撃宣言：${e.toString()} (${e.atk})⇒ ${t.toString()}${i}`,e.controller)});o(this,"procDrawPhase",async()=>{if(Object.values(this.duelists).forEach(e=>e.initForDrawPhase()),this.log.info("ドローフェイズ開始。",this.getTurnPlayer()),this.clock.turn===1)this.log.info("先攻プレイヤーはドローできない。",this.getTurnPlayer());else{await this.getTurnPlayer().draw(1,void 0,void 0);for(const e of this.getEnableActions(this.getTurnPlayer(),["Exodia"],["Normal"],[]))await e.action.directExecute(this.getTurnPlayer(),void 0,!1)}this.field.getCardsOnFieldStrictly().forEach(e=>e.initForTurn()),await this.procSpellSpeed1(),this.moveNextPhase("standby")});o(this,"procStanbyPhase",async()=>{await this.procSpellSpeed1(),this.moveNextPhase("main1")});o(this,"procMainPhase",async()=>{for(;;){this.priorityHolder=this.getTurnPlayer();const e=await this.view.waitFieldAction(this.getEnableActions(this.priorityHolder,["NormalSummon","SpellTrapSet","SpecialSummon","FlipSummon","ChangeBattlePosition","IgnitionEffect","QuickEffect","CardActivation"],["Normal","Quick","Counter"],[]));if(console.info("response",e),e&&e.actionInfo){if([...no].includes(e.actionInfo.action.playType)){const i=await e.actionInfo.action.prepare(this.priorityHolder,e.actionInfo.dest,void 0,[],!0,!1);if(i===void 0)continue;await e.actionInfo.action.execute(i,this.chainBlockInfos),this.clock.incrementChainSeq()}else if(await this.procChainBlock({activator:this.priorityHolder,actionInfo:e.actionInfo},void 0)==="cancel")continue;await this.procFreeChain();continue}const t=e.phaseChange;if(t){this.priorityHolder=this.getNonTurnPlayer();let i="done";for(;;){const r=await this.view.waitQuickEffect(this.priorityHolder,this.getEnableActions(this.priorityHolder,["QuickEffect","TriggerEffect"],["Quick","Counter"],[]),[],"",!0);if(!r){this.moveNextPhase(t);return}if(i=await this.procChainBlock({activator:this.priorityHolder,actionInfo:r},void 0),i==="done")break}if(i==="done"){await this.procFreeChain();continue}}}});o(this,"procBattlePhase",async()=>{await this.procBattlePhaseStartStep(),await this.procBattlePhaseBattleStep(),await this.procBattlePhaseEndStep()});o(this,"procBattlePhaseStartStep",async()=>{this.clock.setStep(this,"start"),this.priorityHolder=this.getTurnPlayer(),this.attackingMonster=void 0,this.targetForAttack=void 0,await this.procSpellSpeed1()});o(this,"procBattlePhaseBattleStep",async()=>{for(;;){this.clock.setStep(this,"battle"),this.priorityHolder=this.getTurnPlayer();const e=await this.view.waitFieldAction(this.getEnableActions(this.priorityHolder,["Battle"],["Normal"],[]));if(e.phaseChange)break;if(e.actionInfo){const t=await e.actionInfo.action.prepare(this.priorityHolder,e.actionInfo.dest,void 0,[],!0,!1);if(!t)continue;await e.actionInfo.action.execute(t,[]),this.clock.incrementChainSeq();let i=!0;for(;;){const r=this.getNonTurnPlayer().getMonstersOnField().map(l=>[l.seq,l.moveLog.latestRecord.movedAt.totalProcSeq]);if(await this.procFreeChain(),!this.attackingMonster)throw new de("想定されない状態");this.attackingMonster.isOnFieldStrictly?this.attackingMonster.face==="FaceDown"?(this.log.info(`${this.attackingMonster.toString()}が裏側守備表示になったため、戦闘が中断された。`),i=!1):this.attackingMonster.orientation==="Horizontal"&&(this.log.info(`${this.attackingMonster.toString()}が守備表示になったため、戦闘が中断された。`),i=!1):(this.log.info(`${this.attackingMonster.toString()}がフィールドにいなくなったため、戦闘が中断された。`),i=!1);const s=this.getNonTurnPlayer().getMonstersOnField().map(l=>[l.seq,l.moveLog.latestRecord.movedAt.totalProcSeq]);if(r.length!==s.length)throw this.log.info("モンスターの数が増減したためバトルステップの巻き戻しが発生。"),new de("巻き戻し未実装");if(r.some(([l,a])=>s.every(([c,u])=>c!==l||u!==a)))throw this.log.info("モンスターの数が増減したためバトルステップの巻き戻しが発生。"),new de("巻き戻し未実装");break}if(!i)continue;await this.procBattlePhaseDamageStep(t)}}});o(this,"procBattlePhaseDamageStep",async e=>{if(!this.attackingMonster||!this.targetForAttack)throw new de("想定されない状態",this.attackingMonster,this.targetForAttack);if(this.targetForAttack.entityType!=="Duelist"&&!this.targetForAttack.isOnFieldAsMonsterStrictly)throw new de("想定されない状態",this.attackingMonster,this.targetForAttack);await this.procBattlePhaseDamageStep1(),await this.procBattlePhaseDamageStep2(this.attackingMonster,this.targetForAttack),await this.procBattlePhaseDamageStep3(e,this.attackingMonster,this.targetForAttack),await this.procBattlePhaseDamageStep4(),await this.procBattlePhaseDamageStep5()});o(this,"procBattlePhaseDamageStep1",async()=>{this.clock.setStage(this,"start"),await this.procFreeChain()});o(this,"procBattlePhaseDamageStep2",async(e,t)=>{this.clock.setStage(this,"beforeDmgCalc"),(t==null?void 0:t.battlePosition)==="Set"&&t.setBattlePosition("Defense",["Flip","FlipByBattle"],e,e.controller),await this.procFreeChain()});o(this,"procBattlePhaseDamageStep3",async(e,t,i)=>{if(t.atk===void 0)throw new de("想定されない状態",this.attackingMonster,this.targetForAttack);this.clock.setStage(this,"dmgCalc"),await this.procFreeChain();const r=t.atk,s=(i.battlePosition==="Attack"?i.atk:i.def)??0;i.entityType==="Duelist"?(e.activator.writeInfoLog(`ダメージ計算：${t.toString()} (${r}) ⇒ ${i.toString()}`),t.controller.getOpponentPlayer().battleDamage(r-s,t)):(e.activator.writeInfoLog(`ダメージ計算：${t.toString()} (${r}) ⇒ ${i.toString()} (${s})`),r>0&&r>s&&i.battlePosition==="Attack"?t.controller.getOpponentPlayer().battleDamage(r-s,t):r<s&&t.controller.battleDamage(s-r,i),r>0&&(r>s||r===s&&i.battlePosition==="Attack")&&await Ge.tryMarkForDestory([i],e),i.battlePosition==="Attack"&&r<=s&&await Ge.tryMarkForDestory([t],e)),t.info.battleLog.push({enemy:i,timestamp:this.clock.getClone()}),i.info.battleLog.push({enemy:t,timestamp:this.clock.getClone()});const l=Object.values(this.duelists).filter(a=>a.lp<=0);if(l.length)throw l.length===1?new At(l[0].getOpponentPlayer(),"戦闘ダメージによって、相手のライフポイントをゼロにした。"):new At(void 0,"戦闘ダメージによって、お互いのライフポイントがゼロになった。")});o(this,"procBattlePhaseDamageStep4",async()=>{this.clock.setStage(this,"afterDmgCalc"),await this.procFreeChain()});o(this,"procBattlePhaseDamageStep5",async()=>{this.clock.setStage(this,"end"),await Ge.waitCorpseDisposal(this),this.clock.incrementChainSeq(),await this.procFreeChain()});o(this,"procBattlePhaseEndStep",async()=>{this.clock.setStep(this,"end"),this.priorityHolder=this.getTurnPlayer(),await this.procSpellSpeed1(),this.moveNextPhase("main2")});o(this,"procEndPhase",async()=>{for(await this.procSpellSpeed1();;){const t=this.getTurnPlayer().getHandCell().cardEntities.length;if(t<7)break;await this.getTurnPlayer().discard(t-6,["Rule"])}this.moveNextPhase("draw")});o(this,"procSpellSpeed1",async()=>{this.priorityHolder=this.getTurnPlayer();let e=0;const t={Above:Number.MAX_VALUE,Below:Number.MAX_VALUE};for(;Object.values(t).some(i=>i!==0);){const i=this.getEnableActions(this.priorityHolder,["IgnitionEffect","QuickEffect","CardActivation","LingeringEffect"],["Normal","Quick","Counter"],[]);t[this.priorityHolder.seat]=i.filter(a=>a.action.isMandatory).length;const r=i.find(a=>a.action.isMandatory);let s=r?{action:r.action,originSeq:r.action.seq}:void 0,l=!s;if(this.priorityHolder.isTurnPlayer?e===0&&(l=!0):t[this.priorityHolder.getOpponentPlayer().seat]>=0&&(l=!0),i.length&&(i.length>1||!s)&&(s=await this.view.waitQuickEffect(this.priorityHolder,i,[],l?"":"まだ発動しなければならない効果が残っている。",l)),s){if(Pn.some(a=>a===s.action.playType))await this.procChainBlock({activator:this.priorityHolder,actionInfo:s},void 0);else{const a=await s.action.prepare(this.priorityHolder,void 0,void 0,[],!0,!1);if(!a)continue;await s.action.execute(a,[]),await s.action.settle(a,[]),this.clock.incrementChainSeq()}await this.procFreeChain(),this.priorityHolder=this.getTurnPlayer(),e=0;continue}this.priorityHolder=this.priorityHolder.getOpponentPlayer(),e++}});o(this,"procFreeChain",async()=>{for(;await this.procChainBlock(void 0,void 0)!=="pass";);});o(this,"procChainBlock",async(e,t)=>{const i=this.chainBlockInfos.length===0;let r=e?[]:t??Object.values(this.duelists).flatMap(l=>this.getEnableActions(l,["TriggerEffect"],[this.chainBlockInfos.length?"Quick":"Normal"],this.chainBlockInfos).map(a=>({activator:l,actionInfo:a,targetChainBlock:this.chainBlockInfos.slice(-1)[0]}))),s;if(e)s={activator:e.activator,action:e.actionInfo.action,dest:e.actionInfo.dest,targetChainBlock:void 0},this.priorityHolder=s.activator;else if(r.length>0){const l=await this.selectTriggerEffect(r);l?(r=r.filter(a=>a!==l),s={...l,action:l.actionInfo.action},this.priorityHolder=s.activator):r=[]}if(!s){let l=0;for(;l<2;){this.priorityHolder=this.priorityHolder.getOpponentPlayer();const a=["Counter"];this.chainBlockInfos.every(d=>d.action.spellSpeed!=="Counter")&&a.push("Quick");const c=this.chainBlockInfos.length?"※メッセージ考え中※":"クイックエフェクト発動タイミング。効果を発動しますか？",u=await this.view.waitQuickEffect(this.priorityHolder,this.getEnableActions(this.priorityHolder,["QuickEffect","CardActivation"],a,this.chainBlockInfos),this.chainBlockInfos,c,!0);if(u){s={...u,activator:this.priorityHolder,targetChainBlock:this.chainBlockInfos.slice(-1)[0]};break}l++}}if(console.info("selected action: ",s),s){const l=s.activator,a=await s.action.prepare(l,s.dest,s.targetChainBlock,this.chainBlockInfos,i,!1);if(!a)return"cancel";this.chainBlockLog.push(a);const c=[...a.action.entity.info.isEffectiveIn];if(this._chainBlockInfos.push(a),this.clock.incrementProcSeq(),this.clock.incrementChainBlockSeq(),r=r.filter(u=>u.actionInfo.action.seq!==(s==null?void 0:s.action.seq)).filter(u=>u.actionInfo.action.validateCount(u.activator,this.chainBlockInfos)),await this.procChainBlock(void 0,r.length?r:void 0),a.chainNumber&&this.log.info(`チェーン${a.chainNumber}: ${a.action.toString()}の効果処理。`,l),a.isNegatedActivationBy)a.chainNumber&&this.log.info(`チェーン${a.chainNumber}: ${a.action.toString()}を${a.isNegatedActivationBy.toString()}によって発動を無効にした。`,a.activator);else{let u=a.action.entity.isEffective,d="";if(u){if(a.isNegatedEffectBy)d=`チェーン${a.chainNumber}: ${a.action.toString()}を${a.isNegatedEffectBy.toString()}によって効果を無効にした。`,u=!1;else if(!c.includes(a.isActivatedIn.cellType)){const f=a.action.entity.moveLog.records.findLast(v=>v.face==="FaceDown"&&v.orientation==="Horizontal");u=(f&&this.clock.isSameChain(f.movedAt))??!1}}if(u?(await a.action.execute(a,this.chainBlockInfos),a.state="done"):(a.state="failed",a.chainNumber&&(d=d||`チェーン${a.chainNumber}: カードの効果が無効となっているため${a.action.toString()}の効果処理を行えない。`),this.log.info(d,a.activator)),await s.action.settle(a,this.chainBlockInfos),a.state==="done")for(const f of[this.getTurnPlayer(),this.getNonTurnPlayer()]){for(const v of this.getEnableActions(f,["Exodia"],["Normal"],[a]))await v.action.directExecute(f,a,!1);for(const v of this.getEnableActions(f,["AfterChainBlock"],["Normal"],[a])){await v.action.directExecute(f,a,!1);for(const g of this.getEnableActions(f,["Exodia"],["Normal"],[a]))await g.action.directExecute(f,a,!1)}}}i?(await Ge.sendManyToGraveyardForTheSameReason(this._chainBlockInfos.filter(u=>u.action.playType==="CardActivation").filter(u=>!u.action.isLikeContinuousSpell).map(u=>u.action.entity).filter(u=>u.isOnFieldStrictly).filter(u=>u.face==="FaceUp"),["Rule"],void 0,void 0),this._chainBlockInfos.reset(),a.nextActionInfo&&await this.procChainBlock({activator:a.activator,actionInfo:a.nextActionInfo},void 0),this.clock.incrementChainSeq()):(a.nextActionInfo&&await a.nextActionInfo.action.directExecute(a.activator,void 0,!1),this.clock.incrementChainBlockSeq())}return s?"done":"pass"});o(this,"selectTriggerEffect",async e=>{if(e.length>0)for(const t of[!0,!1])for(const i of[this.getTurnPlayer(),this.getNonTurnPlayer()]){const r=e.filter(l=>l.actionInfo.action.isMandatory===t&&l.activator===i);if(r.length===0)continue;if(r.length===1&&t)return r[0];const s=await this.view.waitQuickEffect(i,r.map(l=>l.actionInfo),this.chainBlockInfos,"トリガーエフェクトを選択。",!t);if(s)return r.find(l=>l.actionInfo.action===s.action)}});o(this,"executeSystemPeriodActions",()=>{Object.values(this.duelists).flatMap(e=>this.getEnableActions(e,["SystemPeriodAction"],["Normal"],[]).map(t=>({duelist:e,action:t})))});o(this,"getEnableActions",(e,t,i,r)=>{var l;const s=((l=r.slice(-1)[0])==null?void 0:l.nextChainBlockFilter)??(()=>!0);return[...this.field.getAllCardEntities(),e.entity].flatMap(a=>a.actions).filter(a=>a.executableCells.includes(a.entity.fieldCell.cellType)).filter(a=>a.executablePeriods.includes(this.clock.period.key)).filter(a=>i.includes(a.spellSpeed)).filter(a=>a.validateDuelist(e)).filter(a=>t.includes(a.playType)).filter(a=>s(e,a)).map(a=>a.validate(e,r,!1)).filter(a=>a!==void 0)});this.clock=new Go,this.nextPhaseList=[],this.isEnded=!1,this.startMode=u,this.duelists={Below:new Nt(this,"Below",e,t,i,r),Above:new Nt(this,"Above",s,l,a,c)},this.priorityHolder=this.firstPlayer,this._chainBlockInfos=[],this.field=new Ao(this),this.clock.onProcSeqChange.append(this.distributeOperators),this.clock.onStageChange.append(this.executeSystemPeriodActions),this.view=new zo(this),this.log=new Ro(this),this.chainBlockLog=new Ko(this)}get onDuelEnd(){return this.onDuelEndEvent.expose()}get phase(){return this.clock.period.phase}get step(){return this.clock.period.step}get stage(){return this.clock.period.stage}get chainBlockInfos(){return this._chainBlockInfos}get firstPlayer(){return this.coin?this.duelists.Below:this.duelists.Above}get secondPlayer(){return this.coin?this.duelists.Above:this.duelists.Below}}const ds=new Map;bs().forEach(n=>{ds.set(n.name,n)});const Xo=ds,Qo=Ts,dt=Object.values(Qo).reduce((n,e)=>(n[e.name]=e,n),{}),fs=[{id:-1,name:"サンプルデッキ１",description:"",cardNames:["アンノウン・シンクロン","六武衆のご隠居","ジャンク・フォアード","ジャンク・フォアード","ジャンク・フォアード","チューン・ウォリアー","チューン・ウォリアー","ガード・オブ・フレムベル","ガード・オブ・フレムベル","守護竜ユスティア","守護竜ユスティア","エンジェル・トランペッター","エンジェル・トランペッター","ジェムナイト・サフィア","ジェムナイト・サフィア","魂虎","魂虎","暗黒界の番兵 レンジ","暗黒界の番兵 レンジ","バトルフットボーラー","バトルフットボーラー","球騎士の三人娘","球騎士の三人娘","エンジェル・トランペッター","エンジェル・トランペッター","Ｇ戦隊 シャインブラック","Ｇ戦隊 シャインブラック","しゃりの軍貫","しゃりの軍貫","ジョングルグールの幻術師","ジョングルグールの幻術師","ゾンビーノ","ゾンビーノ","メガロスマッシャーＸ","メガロスマッシャーＸ","ライドロン","ライドロン","機界騎士アヴラム","機界騎士アヴラム","幻のグリフォン","幻のグリフォン","幻殻竜","幻殻竜","アレキサンドライドラゴン","アレキサンドライドラゴン","ジェネティック・ワーウルフ","ジェネティック・ワーウルフ","サイバー・ドラゴン","フロストザウルス","フロストザウルス","フロストザウルス","青眼の白龍","マジカル・アンドロイド","マジカル・アンドロイド","マジカル・アンドロイド","大地の騎士ガイアナイト","大地の騎士ガイアナイト","大地の騎士ガイアナイト","スクラップ・デスデーモン","スクラップ・デスデーモン","スクラップ・デスデーモン","スターダスト・ドラゴン","スターダスト・ドラゴン","スターダスト・ドラゴン","ナチュル・ガオドレイク","ナチュル・ガオドレイク","ナチュル・ガオドレイク"]},{id:-2,name:"サンプルデッキ２",description:"",cardNames:["アンノウン・シンクロン","六武衆のご隠居","ジャンク・フォアード","グローアップ・バルブ","ガード・オブ・フレムベル","伝説の白石","伝説の白石","伝説の白石","守護竜ユスティア","ギャラクシーサーペント","ジェネクス・コントローラー","Ｅ・ＨＥＲＯ フェザーマン","Ｅ・ＨＥＲＯ バーストレディ","チューン・ウォリアー","Ｅ・ＨＥＲＯ クレイマン","Ｅ・ＨＥＲＯ スパークマン","しゃりの軍貫","ジョングルグールの幻術師","ゾンビーノ","ジェネティック・ワーウルフ","ライトロード・ビースト ウォルフ","サイバー・ドラゴン","サイバー・ドラゴン","サイバー・ドラゴン","ラブラドライドラゴン","Ｄ－ＨＥＲＯ ディアボリックガイ","Ｄ－ＨＥＲＯ ディアボリックガイ","Ｄ－ＨＥＲＯ ディアボリックガイ","フロストザウルス","Ｅ・ＨＥＲＯ ネオス","青眼の白龍","青眼の白龍","青眼の白龍","Ｅ－エマージェンシーコール","おろかな埋葬","トレード・イン","トレード・イン","トレード・イン","闇の量産工場","強欲な壺","強欲な壺","強欲な壺","死者蘇生","死者蘇生","死者蘇生","召喚師のスキル","召喚師のスキル","召喚師のスキル","成金ゴブリン","成金ゴブリン","成金ゴブリン","戦士の生還","増援","調和の宝札","調和の宝札","調和の宝札","天使の施し","天使の施し","天使の施し","貪欲な壺","貪欲な壺","貪欲な壺","マジカル・アンドロイド","マジカル・アンドロイド","マジカル・アンドロイド","大地の騎士ガイアナイト","大地の騎士ガイアナイト","大地の騎士ガイアナイト","スクラップ・デスデーモン","スクラップ・デスデーモン","スクラップ・デスデーモン","スターダスト・ドラゴン","スターダスト・ドラゴン","スターダスト・ドラゴン","ナチュル・ガオドレイク","ナチュル・ガオドレイク","ナチュル・ガオドレイク"]}],Q=class Q{constructor(e,t){o(this,"id");o(this,"name");o(this,"description");o(this,"lastUsedAt");o(this,"cardNames");o(this,"getIllegalCardNames",()=>Array.from(new Set(this.cardNames.filter(e=>!Object.keys(dt).includes(e)))));o(this,"getDisableCardNames",()=>Array.from(new Set(this.cardNames.filter(e=>!Object.keys(dt).includes(e)))));o(this,"createCardInfos",()=>{const e=this.getIllegalCardNames();if(e.length>0)throw new Error(`存在しないカード名からデッキを生成しようとした。${e}`);return this.cardNames.map(t=>dt==null?void 0:dt[t]).filter(t=>t)});o(this,"copy",async()=>Q.createNewDeck(this.name,this.description,this.cardNames));o(this,"updateTimestamp",async()=>{await Q.tblHeader.update(this.id,e=>({...e,lastUsedAt:new Date}))});o(this,"saveDeckInfo",async e=>{const t=e??this;await Q.tblHeader.update(this.id,s=>({...s,name:t.name,description:t.description,lastUsedAt:new Date}));const i=(await Q.tblDetail.getAll()).filter(s=>s.deckId===this.id);await Q.tblDetail.delete(i.map(s=>s.id));const r=await Q.tblDetail.insertMany(t.cardNames.map((s,l)=>({deckId:this.id,seq:l,name:s,description:""})));return new Q(await Q.tblHeader.get(this.id),r)});o(this,"delete",async()=>{await Q.tblHeader.delete([this.id]);const e=(await Q.tblDetail.getAll()).filter(t=>t.deckId===this.id);await Q.tblDetail.delete(e.map(t=>t.id))});this.id=e.id,this.name=e.name,this.description=e.description,this.lastUsedAt=e.lastUsedAt,this.cardNames=t.filter(i=>i.deckId===this.id).map(i=>i.name)}};o(Q,"toJson",e=>{const t=e.map(i=>{const{id:r,name:s,description:l,lastUsedAt:a,cardNames:c}=i;return{id:r,name:s,description:l,lastUsedAt:a,cardNames:c}});return t.forEach(i=>{i.cardNames=i.cardNames.map(r=>dt[r]).sort(ur).map(r=>r.name)}),JSON.stringify(t,null,2)}),o(Q,"convertToObjectURL",e=>{const t=Q.toJson(e),i=new Blob([t],{type:"text/plain"});return window.URL.createObjectURL(i)}),o(Q,"idb"),o(Q,"tblHeader"),o(Q,"tblDetail"),o(Q,"getAllDeckInfo",async e=>{if(e&&(Q.idb=e),!Q.idb)throw new Error("illegal argument: idb is undefined.");Q.tblHeader||(Q.tblHeader=new Yo(Q.idb)),Q.tblDetail||(Q.tblDetail=new Jo(Q.idb));const t=await Q.tblHeader.getAll(),i=await Q.tblDetail.getAll();return t.length?t.map(r=>new Q(r,i)):[await Q.prepareSampleDeck()]}),o(Q,"createNewDeck",async(e,t,i)=>{const r=await Q.tblHeader.insert({name:e,description:t,lastUsedAt:new Date}),s=await Q.tblDetail.insertMany(i.map((l,a)=>({deckId:r.id,seq:a,name:l,description:""})));return new Q(r,s)}),o(Q,"prepareSampleDeck",async()=>{const e=fs.slice(-1)[0];return await Q.createNewDeck(e.name,e.description,e.cardNames)});let rr=Q;class Yo extends An{constructor(t){super(t,"TblDeckHeader");o(this,"_prepareInitialRecords",()=>[])}}class Jo extends An{constructor(t){super(t,"TblDeckDetail");o(this,"_prepareInitialRecords",()=>[])}}const cu=fs.map(n=>({...n,lastUsedAt:new Date})).filter(n=>n.id<0),el=n=>n;function tl(n){const e=n-1;return e*e*e+1}function uu(n,{delay:e=0,duration:t=400,easing:i=el}={}){const r=+getComputedStyle(n).opacity;return{delay:e,duration:t,easing:i,css:s=>`opacity: ${s*r}`}}function sr(n,e){for(const t in e)n[t]=e[t];return n}function il({fallback:n,...e}){const t=new Map,i=new Map;function r(l,a,c){const{delay:u=0,duration:d=Z=>Math.sqrt(Z)*30,easing:f=tl}=sr(sr({},e),c),v=l.getBoundingClientRect(),g=a.getBoundingClientRect(),m=v.left-g.left,S=v.top-g.top,p=v.width/g.width,C=v.height/g.height,w=Math.sqrt(m*m+S*S),b=getComputedStyle(a),P=b.transform==="none"?"":b.transform,q=+b.opacity;return{delay:u,duration:typeof d=="function"?d(w):d,easing:f,css:(Z,ee)=>`
			   opacity: ${Z*q};
			   transform-origin: top left;
			   transform: ${P} translate(${ee*m}px,${ee*S}px) scale(${Z+(1-Z)*p}, ${Z+(1-Z)*C});
		   `}}function s(l,a,c){return(u,d)=>(l.set(d.key,u),()=>{if(a.has(d.key)){const f=a.get(d.key);return a.delete(d.key),r(f,u,d)}return l.delete(d.key),n&&n(u,d,c)})}return[s(i,t,!1),s(t,i,!0)]}var nl=A("<div></div>"),rl=A('<div class="duel_card_row svelte-14cfp8z"><div> </div> <div> </div></div>'),sl=A('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"> </div></div>'),al=A('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"> </div></div>'),ol=A('<div class="duel_card_row svelte-14cfp8z"><div> </div> <div> </div></div>'),ll=A('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z">ペンデュラム</div></div>'),cl=A('<div class="duel_card_row duel_card_detail svelte-14cfp8z"><div class="svelte-14cfp8z"> </div></div> <div class="duel_card_row duel_card_detail svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"><span> </span> / <span> </span></div></div>',1),ul=A('<button><div class="duel_card_body svelte-14cfp8z"><div class="duel_card_row svelte-14cfp8z" style="position:relative"><div class="svelte-14cfp8z"> </div> <div class="svelte-14cfp8z"></div> <!></div> <!> <!> <!> <!></div></button>'),dl=A('<button><div class="svelte-14cfp8z">裏守備</div></button>'),fl=A('<div class="duel_card duel_card_face_down svelte-14cfp8z"><div class="svelte-14cfp8z">セット</div></div>');function ft(n,e){Je(e,!1);let t=ye(e,"entity",8),i=ye(e,"state",8,"Disabled"),r=ye(e,"selectedList",28,()=>[]),s=ye(e,"isVisibleForcibly",8,!1),l=ye(e,"isWideMode",8,!1),a=ye(e,"dummyActionInfos",24,()=>[]),c=ye(e,"cardActionResolve",8),u=ye(e,"entitySelectResolve",8,()=>{}),d,f=Te(!1),v=()=>{},g=ye(e,"qty",12,void 0);const m=$=>{var O;d=$.activator,x(f,!1),g((O=$.entitiesChoices)==null?void 0:O.qty),v=$.resolve};t().field.duel.view.onWaitStart.append(m);let S=Te(!1);const p=()=>{if(i()!=="Disabled"&&i()==="Selectable"&&g()===1){if(r().some($=>$.seq!==t().seq)){r([t()]);return}g()===1&&u()&&u()([t()])}},C=$=>{(t().face==="FaceUp"||t().owner===t().field.duel.duelists.Below&&(t().isUnderControl||s()))&&t().field.duel.view.showCardInfo(t(),$??"Normal")},w=()=>{if(C(),console.log(t().toString(),i(),a().length,c()),i()==="Disabled")return;if(i()==="Selectable"){x(f,!h(f)),g()===1&&(r().splice(0),t().duel.view.requireUpdate()),r(h(f)?[...r(),t()]:r().filter(O=>O!==t()));return}if(a().length===0)return;if(a().length===1){const O=a()[0];if(c()){c()(O);return}console.log(t().toString(),i(),a().length,v),v({actionInfo:O});return}if(!d)return;t().field.duel.view.modalController.actionSelector.show({title:"行動を選択。",activator:d,dummyActionInfos:a(),cancelable:!0}).then(O=>{O&&v({actionInfo:O})})},b=$=>{var O;window.getSelection&&((O=window.getSelection())==null||O.removeAllRanges()),console.info("drag start",$,a()),t().field.duel.view.setDraggingActions(a()),x(S,!0)},P=$=>{console.info("drag end",$,a()),t().field.duel.view.removeDraggingActions(),$.dataTransfer&&x(S,!1)},q=()=>(C("Debug"),!1);lt();var Z=_e(),ee=G(Z);{var N=$=>{var O=ul(),Pe=y(O),Be=y(Pe),K=y(Be),V=y(K),ie=k(K,4);ce(ie,1,()=>t().attr,le,(L,I)=>{var E=nl();M(()=>ge(E,`monster_attr ${h(I)??""} svelte-14cfp8z`)),_(L,E)});var he=k(Be,2);{var ke=L=>{var I=rl(),E=y(I),T=y(E),U=k(E,2),j=y(U);M((W,J)=>{ge(E,It(t().lvl!==t().origin.level?"different_from_its_origin":""),"svelte-14cfp8z"),F(T,W),ge(U,It(t().rank!==t().origin.rank?"different_from_its_origin":""),"svelte-14cfp8z"),F(j,J)},[()=>"★".repeat(t().lvl||0),()=>"☆".repeat(t().rank||0)],ue),_(L,I)},Me=L=>{var I=_e(),E=G(I);{var T=j=>{var W=sl(),J=k(y(W),2),me=y(J);M(()=>F(me,`${pr[t().status.spellCategory]??""}魔法`)),_(j,W)},U=j=>{var W=_e(),J=G(W);{var me=re=>{var X=al(),te=k(y(X),2),z=y(te);M(()=>F(z,`${gr[t().status.trapCategory]??""}罠`)),_(re,X)};B(J,re=>{t().kind==="Trap"&&t().status.trapCategory&&re(me)},!0)}_(j,W)};B(E,j=>{t().kind==="Spell"&&t().status.spellCategory?j(T):j(U,!1)},!0)}_(L,I)};B(he,L=>{t().kind==="Monster"?L(ke):L(Me,!1)})}var $e=k(he,2);{var qe=L=>{var I=ol(),E=y(I),T=y(E),U=k(E,2),j=y(U);M(()=>{ge(E,It(t().psL!==t().origin.pendulumScaleL?"different_from_its_origin":""),"svelte-14cfp8z"),F(T,`◀ ${t().psL??""}`),ge(U,It(t().psR!==t().origin.pendulumScaleR?"different_from_its_origin":""),"svelte-14cfp8z"),F(j,`${t().psR??""} ▶`)}),_(L,I)};B($e,L=>{var I;(I=t().status.monsterCategories)!=null&&I.includes("Pendulum")&&L(qe)})}var D=k($e,2);{var R=L=>{var I=ll();_(L,I)};B(D,L=>{t().kind==="Spell"&&t().isPendulumScale&&L(R)})}var Y=k(D,2);{var Se=L=>{var I=cl(),E=G(I),T=y(E),U=y(T),j=k(E,2),W=k(y(j),2),J=y(W),me=y(J),re=k(J,2),X=y(re);M((te,z)=>{F(U,`${te??""}
            ${z??""}`),ge(J,It(t().atk!==t().origin.attack?"different_from_its_origin":""),"svelte-14cfp8z"),F(me,t().atk??"?"),ge(re,It(t().def!==t().origin.defense?"different_from_its_origin":""),"svelte-14cfp8z"),F(X,t().def??"?")},[()=>t().types.map(te=>dr[te]+(l()?fr[te]:"")).join(),()=>{var te;return(te=t().status.monsterCategories)==null?void 0:te.map(z=>hr[z]+(l()?vr[z]:"")).join()}],ue),_(L,I)};B(Y,L=>{t().kind==="Monster"&&L(Se)})}M(L=>{ge(O,`duel_card button_style_reset ${t().origin.kind??""} ${L??""} ${(h(f)?"duel_card_selected":"")??""} ${i()??""} duel_card_${t().orientation??""} ${(h(S)?"isDragging":"")??""} ${(l()?"duel_card_wide":"")??""} duel_card_${t().face??""} ${(t().isOnField?"duel_card_is_on_field":"")??""} svelte-14cfp8z`),li(O,"draggable",i()==="Draggable"),li(O,"title",t().nm),F(V,t().nm)},[()=>{var L;return((L=t().status.monsterCategories)==null?void 0:L.join(" "))||""}],ue),je("dragstart",O,b),je("dragend",O,P),je("click",O,w),je("dblclick",O,p),je("mouseenter",O,()=>C()),je("contextmenu",O,q),_($,O)},H=$=>{var O=_e(),Pe=G(O);{var Be=V=>{var ie=dl();M(()=>ge(ie,`duel_card duel_card_face_down duel_card_face_down_defense ${i()??""}  ${(h(f)?"duel_card_selected":"")??""} svelte-14cfp8z`)),je("click",ie,w),je("dblclick",ie,p),_(V,ie)},K=V=>{var ie=fl();_(V,ie)};B(Pe,V=>{t().battlePosition==="Set"?V(Be):V(K,!1)},!0)}_($,O)};B(ee,$=>{t().face==="FaceUp"||s()||t().controller.duelistType==="Player"&&t().isUnderControl?$(N):$(H,!1)})}_(n,Z),et()}var hl=A('<div class="phase_display svelte-1mv96a1"><span class="svelte-1mv96a1"> </span> </div>'),vl=A('<div class="lifepoint_display svelte-1mv96a1"><div class="svelte-1mv96a1"> </div> <div class="svelte-1mv96a1"> </div></div>'),pl=(n,e,t)=>e(h(t)),gl=A('<div class="svelte-1mv96a1"><button class="phase_button svelte-1mv96a1"> </button></div>'),ml=A("<div><!></div>"),yl=A('<div class="svelte-1mv96a1"><!></div>'),_l=A("<div><!></div>"),Sl=A("<!> <!> <!>",1),wl=A('<div style="position: absolute;" class="card_animation_receiver svelte-1mv96a1"><!></div>'),kl=A('<div style="position: absolute; top:0rem" class="svelte-1mv96a1">｛効果対象｝</div>'),Cl=A('<!> <div style="position: absolute; display:flex;justify-content: center;" class="svelte-1mv96a1"><!></div>',1),bl=A(" <!> 】",1),El=A('<div style="position: absolute; bottom:0rem" class="svelte-1mv96a1"> <!></div>'),Tl=A("<!> <!>",1),Al=A('<div class="badge svelte-1mv96a1"> </div>'),Pl=A('<div class="card_animation_receiver svelte-1mv96a1"><!></div>'),Dl=A("<!> <!> <!> <!>",1),Fl=A('<td><div role="listitem"><!></div></td>');function xl(n,e){Je(e,!1);let t=ye(e,"view",8),i=ye(e,"row",8),r=ye(e,"column",8),s=ye(e,"selectedEntities",28,()=>[]),l=ye(e,"selectedCells",28,()=>[]),a=Te(t().getCell(i(),r()));const c=()=>{x(a,t().getCell(i(),r()))};h(a).onUpdate.append(c),t().onDuelUpdate.append(c),t().modalController.onUpdate.append(c);let u,d=Te([]),f=()=>{},v,g=Te([]),m=Te(!1),S=Te(!1),p=!1;const C=D=>{var R,Y;x(H,[]),s().reset(),u=D.activator,f=D.resolve,x(d,D.dummyActionInfos),x(g,D.chainBlockInfos.flatMap(Se=>Se.selectedEntities).getDistinct()),v=D.entitiesChoices,x(m,!1),x(S,((R=D.cellsChoices)==null?void 0:R.selectables.includes(h(a)))??!1),p=h(S)&&((Y=D.cellsChoices)==null?void 0:Y.qty)===1};t().onWaitStart.append(C);const w=()=>{u=void 0,x(d,[]),f=()=>{},v=void 0,x(g,[]),x(m,!1),x(S,!1),p=!1};t().onWaitEnd.append(w);let b=Te(!1),P=[];const q=D=>{P=D.filter(R=>R.dests.includes(h(a))),x(b,P.length>0),c()},Z=()=>{P=[],x(b,!1),c()};t().onDragStart.append(q),t().onDragEnd.append(Z);const[ee,N]=Nc;let H=Te([]);const $=D=>{if(u=void 0,h(a)===D.to||h(a).entities.includes(D.entity)){x(H,[...h(H),D]);const R=D.resolve;x(a,h(a)),setTimeout(()=>{x(H,h(H).filter(Y=>Y!==D)),D.count++,D.count>1&&R()},600)}};t().onAnimation.append($);const O=D=>{f({phaseChange:D})},Pe=()=>h(a).isStackCell&&h(a).entities.flatMap(D=>D.actions).filter(D=>h(d).map(R=>R.action.seq).some(R=>R===D.seq)).length>0,Be=()=>{if(ti(a,h(a).field.duel.view.infoBoardState="Log"),p)f({selectedCells:[h(a)]});else if(h(S))x(m,!h(m)),l(h(m)?[...l(),h(a)]:l().filter(D=>D!==h(a)));else if(h(a).isStackCell){ti(a,h(a).field.duel.view.infoBoardState="CellInfo"),ti(a,h(a).field.duel.view.infoBoardCell=h(a)),h(a).field.duel.view.requireUpdate();const D=h(a).entities.flatMap(Y=>Y.actions).map(Y=>Y.seq),R=h(d).filter(Y=>D.includes(Y.action.seq));if(R.length){if(!u)return;h(a).field.duel.view.modalController.actionSelector.show({title:"カードを選択。",activator:u,dummyActionInfos:R,cancelable:!0}).then(Se=>{Se&&f({actionInfo:Se})});return}}h(a).field.duel.view.requireUpdate(),console.info(h(a))},K=D=>{D.preventDefault(),D.dataTransfer&&(D.dataTransfer.dropEffect="move")},V=D=>{D.preventDefault(),console.info("drop",D,h(b),P),D.dataTransfer&&(D.dataTransfer.dropEffect="move");try{if(h(b)&&P){if(P.length===1){const R=P[0];f({actionInfo:{...R,dest:h(a)}})}else if(P.length>1){if(!u)throw new de("想定されない状態");h(a).field.duel.view.modalController.terminateAll(),h(a).field.duel.view.modalController.actionSelector.show({title:"選択",activator:u,dummyActionInfos:P.map(R=>({...R,dest:h(a)})),cancelable:!1}).then(R=>{f({actionInfo:R})})}}}finally{t().removeDraggingActions()}},ie=(...D)=>{if(t().waitMode==="Animation")return"Disabled";if(v&&v.selectables.find(Y=>D.find(Se=>Y===Se)))return"Selectable";if(!h(d)||h(d).length===0||t().waitMode!=="Free"||Object.values(t().modalController.modals).some(Y=>Y.state==="Shown"))return"Disabled";const R=h(d).filter(Y=>D.includes(Y.action.entity));return R.length===0?"Disabled":h(a).isStackCell||R[0].action.entity!==D[0]?"Clickable":R.some(Y=>Y.dests.length)?"Draggable":"Clickable"};lt();var he=Fl(),ke=y(he);ke.__click=Be;var Me=y(ke);{var $e=D=>{var R=_e(),Y=G(R);{var Se=L=>{var I=_e(),E=G(I);{var T=j=>{var W=hl(),J=y(W),me=y(J),re=k(J,1,!0);M((X,te)=>{F(me,X),F(re,te)},[()=>String(h(a).field.duel.clock.turn).padStart(2,"0"),()=>h(a).field.duel.phase.toUpperCase()],ue),_(j,W)},U=j=>{var W=_e(),J=G(W);{var me=X=>{var te=vl(),z=y(te),be=y(z),De=k(z,2),Ne=y(De);M(()=>{F(be,h(a).field.duel.duelists.Above.lp),F(Ne,h(a).field.duel.duelists.Below.lp)}),_(X,te)},re=X=>{var te=_e(),z=G(te);{var be=De=>{var Ne=_e(),yt=G(Ne);{var Ze=xe=>{var Ue=_e(),_t=G(Ue);{var Dt=He=>{var se=_e(),ae=G(se);ce(ae,1,()=>t().duel.nextPhaseList,le,(pe,Ce)=>{var Ee=gl(),tt=y(Ee);tt.__click=[pl,O,Ce];var Ve=y(tt);M(ct=>F(Ve,ct),[()=>h(Ce).toUpperCase()],ue),_(pe,Ee)}),_(He,se)};B(_t,He=>{t().duel.isEnded||He(Dt)})}_(xe,Ue)};B(yt,xe=>{t().waitMode==="Free"&&xe(Ze)})}_(De,Ne)};B(z,De=>{h(a).column===5&&De(be)},!0)}_(X,te)};B(J,X=>{h(a).column===3?X(me):X(re,!1)},!0)}_(j,W)};B(E,j=>{h(a).column===1?j(T):j(U,!1)})}_(L,I)};B(Y,L=>{h(a).row===3&&L(Se)})}_(D,R)},qe=D=>{var R=_e(),Y=G(R);{var Se=I=>{var E=Sl();const T=ue(()=>h(H).find(re=>re.to===h(a)));var U=G(E);{var j=re=>{var X=ml(),te=y(X);ft(te,{get entity(){return h(T).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),M(()=>ge(X,`card_animation_receiver ${h(a).cellType??""} svelte-1mv96a1`)),Rt(1,X,()=>N,()=>({key:h(T).entity.seq})),_(re,X)};B(U,re=>{h(T)&&h(T).index==="Top"&&re(j)})}var W=k(U,2);ce(W,1,()=>h(a).visibleEntities,le,(re,X)=>{var te=_e(),z=G(te);{var be=De=>{var Ne=yl(),yt=y(Ne);const Ze=ue(()=>ie(h(X))),xe=ue(()=>h(d).filter(Ue=>Ue.action.entity===h(X)));ft(yt,{get entity(){return h(X)},get state(){return h(Ze)},get dummyActionInfos(){return h(xe)},cardActionResolve:void 0,get selectedList(){return s()},set selectedList(Ue){s(Ue)},$$legacy:!0}),Rt(2,Ne,()=>ee,()=>({key:h(X).seq})),_(De,Ne)};B(z,De=>{h(H).every(Ne=>Ne.entity.seq!==h(X).seq)&&De(be)})}_(re,te)});var J=k(W,2);{var me=re=>{var X=_l(),te=y(X);ft(te,{get entity(){return h(T).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),M(()=>ge(X,`card_animation_receiver ${h(a).cellType??""} svelte-1mv96a1`)),Rt(1,X,()=>N,()=>({key:h(T).entity.seq})),_(re,X)};B(J,re=>{h(T)&&h(T).index!=="Top"&&re(me)})}_(I,E)},L=I=>{var E=Dl();const T=ue(()=>h(H).find(z=>z.to===h(a)));var U=G(E);{var j=z=>{var be=wl(),De=y(be);ft(De,{get entity(){return h(T).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),Rt(1,be,()=>N,()=>({key:h(T).entity.seq})),_(z,be)};B(U,z=>{h(T)&&h(T).index!=="Top"&&z(j)})}var W=k(U,2);{var J=z=>{var be=Tl(),De=G(be);ce(De,1,()=>h(a).visibleEntities.map((Ze,xe)=>({index:xe,entity:Ze})).toReversed(),le,(Ze,xe)=>{var Ue=_e(),_t=G(Ue);{var Dt=He=>{var se=Cl(),ae=G(se);{var pe=ct=>{var hs=kl();_(ct,hs)};B(ae,ct=>{h(g).includes(h(xe).entity)&&ct(pe)})}var Ce=k(ae,2),Ee=y(Ce);const tt=ue(()=>!h(a).isStackCell&&h(xe).index===0?ie(...h(a).visibleEntities):void 0),Ve=ue(()=>h(xe).index===0?h(d).filter(ct=>h(a).visibleEntities.includes(ct.action.entity)):void 0);ft(Ee,{get entity(){return h(xe).entity},get state(){return h(tt)},get dummyActionInfos(){return h(Ve)},cardActionResolve:void 0,get selectedList(){return s()},set selectedList(ct){s(ct)},$$legacy:!0}),Rt(2,Ce,()=>ee,()=>({key:h(xe).entity.seq})),_(He,se)};B(_t,He=>{h(H).every(se=>se.entity.seq!==h(xe).entity.seq)&&He(Dt)})}_(Ze,Ue)});var Ne=k(De,2);{var yt=Ze=>{var xe=El(),Ue=y(xe),_t=k(Ue);ce(_t,1,()=>Object.keys(h(a).visibleEntities[0].status.maxCounterQty),le,(Dt,He)=>{var se=bl(),ae=G(se),pe=k(ae);{var Ce=Ee=>{var tt=Ba();M(()=>F(tt,`/${h(a).visibleEntities[0].status.maxCounterQty[h(He)]??""}`)),_(Ee,tt)};B(pe,Ee=>{(h(a).visibleEntities[0].status.maxCounterQty[h(He)]??!1)&&Ee(Ce)})}M(Ee=>F(ae,`【
              ${qo[h(He)]??""}${Ee??""} `),[()=>h(a).visibleEntities[0].counterHolder.getQty(h(He))],ue),_(Dt,se)}),M(()=>F(Ue,`【${h(a).visibleEntities[0].battlePositionName??""}】 `)),_(Ze,xe)};B(Ne,Ze=>{h(a).visibleEntities[0].battlePosition&&Ze(yt)})}_(z,be)};B(W,z=>{h(a).visibleEntities.length>0&&z(J)})}var me=k(W,2);{var re=z=>{var be=Al(),De=y(be);M(()=>F(De,h(a).visibleEntities.length)),_(z,be)};B(me,z=>{h(a).isStackCell&&z(re)})}var X=k(me,2);{var te=z=>{var be=Pl(),De=y(be);ft(De,{get entity(){return h(T).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),Rt(1,be,()=>N,()=>({key:h(T).entity.seq})),_(z,be)};B(X,z=>{h(T)&&h(T).index==="Top"&&z(te)})}_(I,E)};B(Y,I=>{h(a).cellType==="Hand"?I(Se):I(L,!1)},!0)}_(D,R)};B(Me,D=>{h(a).isDisabledCell?D($e):D(qe,!1)})}M(D=>{ge(he,`${`duel_field_cell duel_field_cell_${h(a).cellType} ${h(a).linkArrowSources.length===0?"":"duel_field_cell_linked"}`??""} svelte-1mv96a1`),li(he,"colspan",h(a).cellType==="Hand"?7:1),ge(ke,`${D??""} svelte-1mv96a1`)},[()=>`duel_card_wrapper ${h(a).cellType} ${h(b)?"can_accept_drop":""} ${Pe()?"can_action":""} ${h(m)?"is_selected":h(S)?"is_selectable":""} `],ue),je("dragover",ke,K),je("drop",ke,V),_(n,he),et()}Jt(["click"]);var ql=A('<div class="title svelte-1sjjr5s"> </div>'),Ml=A('<div class="title svelte-1sjjr5s"> </div>'),Bl=A('<div class="duel_log_record svelte-1sjjr5s"> </div>'),Ol=A('<div><div style=" white-space: nowrap;text-align: center;"> </div> <!></div>'),Nl=A("<div><!> <!></div>"),Ll=A("<div><!> <!></div>"),Il=A('<div class="duel_log svelte-1sjjr5s"><div class="duel_log_header svelte-1sjjr5s"></div> <div class="duel_log_body svelte-1sjjr5s"></div> <div class="duel_log_footer svelte-1sjjr5s"></div></div>');function Rl(n,e){Je(e,!1);let t=Te(void 0),i=ye(e,"log",8),r,s=Te([]);const l=()=>{const d=((r==null?void 0:r.seq)??-1)+1;i().records.slice(d).forEach(f=>{if(!r){x(s,[[[[f]]]]),r=f;return}if(!h(s)[f.clock.turn]){ti(s,h(s)[f.clock.turn]=[[[f]]]),r=f;return}if(!h(s)[f.clock.turn][f.clock.phaseSeq]){ti(s,h(s)[f.clock.turn][f.clock.phaseSeq]=[[f]]),r=f;return}if(r.clock.chainSeq===f.clock.chainSeq&&r.clock.chainBlockSeq===f.clock.chainBlockSeq&&r.duelist===f.duelist){h(s)[f.clock.turn][f.clock.phaseSeq].slice(-1)[0].push(f),r=f;return}h(s)[f.clock.turn][f.clock.phaseSeq].push([f]),r=f}),x(s,h(s)),Ea().then(()=>h(t)&&h(t).scroll(0,h(t).clientHeight*990))};i().onUpdate.append(l),i().duel.view.onDuelUpdate.append(l),lt();var a=_e(),c=G(a);{var u=d=>{var f=Il(),v=k(y(f),2);ce(v,5,()=>h(s),le,(g,m)=>{var S=Ll(),p=y(S);{var C=b=>{var P=ql(),q=y(P);M(()=>F(q,`ターン：${h(m)[0][0][0].clock.turn??""}`)),_(b,P)};B(p,b=>{h(m)[0][0][0].clock.turn>0&&b(C)})}var w=k(p,2);ce(w,1,()=>h(m),le,(b,P)=>{var q=Nl(),Z=y(q);{var ee=H=>{var $=Ml(),O=y($);M(()=>F(O,h(P)[0][0].clock.period.name)),_(H,$)};B(Z,H=>{h(P)[0][0].clock.turn>0&&H(ee)})}var N=k(Z,2);ce(N,1,()=>h(P),le,(H,$)=>{var O=Ol(),Pe=y(O),Be=y(Pe),K=k(Pe,2);ce(K,1,()=>h($),le,(V,ie)=>{var he=Bl(),ke=y(he);M(()=>F(ke,h(ie).text)),_(V,he)}),M(()=>{var V,ie,he;ge(O,`duel_log_block_duelist duel_log_block_duelist_${((V=h($)[0].duelist)==null?void 0:V.seat)??"system"} svelte-1sjjr5s`),ge(Pe,`duelist ${((ie=h($)[0].duelist)==null?void 0:ie.seat)??""} svelte-1sjjr5s`),F(Be,((he=h($)[0].duelist)==null?void 0:he.profile.name)||"SYSTEM")}),_(H,O)}),M(()=>ge(q,`duel_log_block_phase duel_log_block_phase_${h(P)[0][0].clock.period.key??""} svelte-1sjjr5s`)),_(b,q)}),M(()=>ge(S,`duel_log_block_turn duel_log_block_turn_${h(m)[0][0][0].clock.turn??""} svelte-1sjjr5s`)),_(g,S)}),Qa(v,g=>x(t,g),()=>h(t)),_(d,f)};B(c,d=>{i().duel.view.infoBoardState==="Log"&&d(u)})}_(n,a),et()}var $l=A('<div><div class="duelist_name svelte-1u7codf"> </div> <div> </div></div>');function ar(n,e){Je(e,!1);let t=ye(e,"duelist",12),i=Te(0),r=Te();const s=async()=>{const v=t().lp-h(i);if(!h(r)||Math.abs(v)<10){x(i,t().lp),h(r)&&(h(r)(),x(r,void 0));return}x(i,h(i)+Math.floor(Math.random()*v)),await $o(100),s()},l=()=>{t(t()),!h(r)&&t().lp!==h(i)&&new Promise(v=>{x(r,v),Math.abs(t().lp-h(i)),s()})};t().duel.log.onUpdate.append(l),s(),lt();var a=$l(),c=y(a),u=y(c),d=k(c,2),f=y(d);M(()=>{ge(a,`duelist ${t().seat??""} svelte-1u7codf`),F(u,t().profile.name),ge(d,`duelist_lp ${(h(r)?"vibration":"")??""} svelte-1u7codf`),F(f,h(i))}),_(n,a),et()}const Ul=(n,e,t)=>{e.resolve(h(t))};var Hl=A("<div><!></div>"),jl=A("<div></div>"),Zl=(n,e)=>e.resolve(void 0),Vl=A('<button class="svelte-ynkuoo">Cancel</button>'),zl=A('<div class="modal_window svelte-ynkuoo"><div> </div> <!> <div><button class="svelte-ynkuoo">OK</button> <!></div></div>');function Gl(n,e){Je(e,!0);let t=aa(kt([])),i=e.args.chainBlockInfos.flatMap(a=>a.selectedEntities).getDistinct();var r=_e(),s=G(r);{var l=a=>{var c=zl(),u=y(c),d=y(u),f=k(u,2);ce(f,17,()=>e.args.entitiesChoices.selectables.map(p=>p.controller.seat).getDistinct(),le,(p,C)=>{var w=jl();ce(w,21,()=>e.args.entitiesChoices.selectables.filter(b=>b.controller.seat===h(C)).toSorted(os),le,(b,P)=>{var q=Hl(),Z=y(q);ft(Z,{get entity(){return h(P)},isVisibleForcibly:!0,state:"Selectable",entitySelectResolve:ee=>e.resolve(ee),get qty(){return e.args.entitiesChoices.qty},cardActionResolve:void 0,get selectedList(){return h(t)},set selectedList(ee){x(t,kt(ee))}}),M(ee=>ge(q,`entities_list_item ${ee??""} svelte-ynkuoo`),[()=>i.includes(h(P))?"effect_target":""]),_(b,q)}),M(()=>ge(w,`entities_list ${h(C)??""} svelte-ynkuoo`)),_(p,w)});var v=k(f,2),g=y(v);g.__click=[Ul,e,t];var m=k(g,2);{var S=p=>{var C=Vl();C.__click=[Zl,e],_(p,C)};B(m,p=>{e.args.entitiesChoices.cancelable&&p(S)})}M(p=>{F(d,e.args.title),g.disabled=p},[()=>!e.args.entitiesChoices.validator(h(t))]),_(a,c)};B(s,a=>{a(l)})}_(n,r),et()}Jt(["click"]);var Kl=A('<div class="duel_card_wrapper svelte-1k3dhp1"><!> <div> </div></div>'),Wl=(n,e)=>e()(),Xl=A('<div><button class="cancel_button svelte-1k3dhp1">Cancel</button></div>'),Ql=A('<div class="modal_window svelte-1k3dhp1"><div> </div> <div class="flex svelte-1k3dhp1" style="display: flex;"></div> <!></div>');function Yl(n,e){Je(e,!1);let t=ye(e,"view",8),i=ye(e,"args",8),r=ye(e,"resolve",8),s=Ya(!1);const l=()=>s.set(!0),a=()=>s.set(!1);t().onDragStart.append(l),t().onDragEnd.append(a),lt();var c=_e(),u=G(c);{var d=f=>{var v=Ql(),g=y(v),m=y(g),S=k(g,2);ce(S,5,()=>i().dummyActionInfos,le,(w,b)=>{var P=Kl(),q=y(P);const Z=ue(()=>h(b).dests.length?"Draggable":"Clickable"),ee=ue(()=>i().dragAndDropOnly?[]:[h(b)]);ft(q,{get entity(){return h(b).action.entity},isVisibleForcibly:!0,get state(){return h(Z)},get dummyActionInfos(){return h(ee)},get cardActionResolve(){return r()}});var N=k(q,2),H=y(N);M(()=>F(H,`«${h(b).action.title??""}»`)),_(w,P)});var p=k(S,2);{var C=w=>{var b=Xl(),P=y(b);P.__click=[Wl,r],_(w,b)};B(p,w=>{i().cancelable&&w(C)})}M(()=>F(m,i().title)),_(f,v)};B(u,f=>{f(d)})}_(n,c),et()}Jt(["click"]);var Jl=(n,e,t)=>e()(t()),ec=A('<li><button class="svelte-1w70c2f"> </button></li>'),tc=(n,e)=>e()(void 0),ic=A('<button class="svelte-1w70c2f">Cancel</button>'),nc=A('<div class="modal_window svelte-1w70c2f"><div class="svelte-1w70c2f"> </div> <ui class="text_list svelte-1w70c2f"></ui> <!></div>');function rc(n,e){Je(e,!1);let t=ye(e,"arg",8),i=ye(e,"resolve",8);lt();var r=_e(),s=G(r);{var l=a=>{var c=nc(),u=y(c),d=y(u),f=k(u,2);ce(f,5,()=>t().choises,le,(m,S)=>{let p=()=>h(S).seq,C=()=>h(S).text;var w=ec(),b=y(w);b.__click=[Jl,i,p];var P=y(b);M(()=>{ge(w,`text_item ${p()??""} svelte-1w70c2f`),F(P,C())}),_(m,w)});var v=k(f,2);{var g=m=>{var S=ic();S.__click=[tc,i],_(m,S)};B(v,m=>{t().cancelable&&m(g)})}M(()=>F(d,t().title)),_(a,c)};B(s,a=>{a(l)})}_(n,r),et()}Jt(["click"]);const sc=(n,e)=>{e().modals.forEach(t=>t.cancel())};var ac=A('<button class="overlay svelte-5wiqd8">☆</button> <!> <!> <!>',1),oc=A('<div class="base svelte-5wiqd8"><!></div>');function lc(n,e){var a,c;Je(e,!1);let t=ye(e,"modalController",12);const i=()=>{t(t())};(c=(a=t())==null?void 0:a.onUpdate)==null||c.append(i),lt();var r=oc(),s=y(r);{var l=u=>{var d=ac(),f=G(d);f.__click=[sc,t];var v=k(f,2);{var g=w=>{Gl(w,{get args(){return t().entitySelector.args},get resolve(){return t().entitySelector.resolve}})};B(v,w=>{t().entitySelector.state==="Shown"&&w(g)})}var m=k(v,2);{var S=w=>{Yl(w,{get view(){return t().view},get args(){return t().actionSelector.args},get resolve(){return t().actionSelector.resolve}})};B(m,w=>{t().actionSelector.state==="Shown"&&w(S)})}var p=k(m,2);{var C=w=>{rc(w,{get arg(){return t().textSelector.args},get resolve(){return t().textSelector.resolve}})};B(p,w=>{t().textSelector.state==="Shown"&&w(C)})}_(u,d)};B(s,u=>{t().modals.some(d=>d.state==="Shown")&&u(l)})}_(n,r),et()}Jt(["click"]);const cc=(n,e)=>(e(e()==="Normal"?"Debug":"Normal"),!0);var uc=A('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><pre class="description svelte-1qknre5"> </pre></div></div> <div class="duel_card_info_row svelte-1qknre5" style=" justify-content: space-between;"><div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div></div>',1),dc=A('<div></div> <div class="svelte-1qknre5"> </div>',1),fc=A("<div> </div>"),hc=A("<div> </div>"),vc=A('<div class="duel_card_info_row svelte-1qknre5"><!> <!></div> <div class="duel_card_info_row svelte-1qknre5"></div>',1),pc=A('<div class="duel_card_row svelte-1qknre5"><div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div></div>'),gc=A('<div class="duel_card_row svelte-1qknre5"><div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div></div>'),mc=A("<!> <!>",1),yc=A('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><pre class="description svelte-1qknre5"> </pre></div></div>'),_c=A('<div class="svelte-1qknre5"> </div>'),Sc=A('<div class="svelte-1qknre5"> </div>'),wc=A('<div class="svelte-1qknre5"> </div>'),kc=A('<div class="svelte-1qknre5"> </div>'),Cc=A('<div class="svelte-1qknre5"> </div>'),bc=A('<div class="svelte-1qknre5"> </div>'),Ec=A('<div class="svelte-1qknre5"> </div>'),Tc=A('<div class="svelte-1qknre5"> </div>'),Ac=A('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"></div></div></div>'),Pc=A('<div class="svelte-1qknre5">※テスト用カードです</div>'),Dc=A('<div class="duel_card_info_links svelte-1qknre5"><a target="_blank" rel="noopener noreferrer" title="遊戯王カードWiki" class="svelte-1qknre5">⇒遊戯王カードWiki</a> <a target="_blank" rel="noopener noreferrer" title="コナミカードデータベース" class="svelte-1qknre5"> </a></div>'),Fc=A('<div role="contentinfo"><div class="duel_card_info_header svelte-1qknre5"><div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"> </div></div> <div class="duel_card_info_row svelte-1qknre5" style="position:sticky; top:0;"><div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div></div> <!></div> <div class="duel_card_info_body svelte-1qknre5"><!></div> <div class="duel_card_info_footer svelte-1qknre5"><!></div></div>');function xc(n,e){Je(e,!1);let t=ye(e,"entity",8,void 0);const i=()=>t()?dt[t().origin.name]:void 0,r=()=>{var u;return t()&&(t().origin.cardId??!1)?`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${t().origin.cardId}`:`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=10&mode=&sort=1&keyword=${(u=i())==null?void 0:u.name}&stype=1&ctype=&othercon=2&starfr=&starto=&pscalefr=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`};let s=ye(e,"mode",12,"Normal");lt();var l=_e(),a=G(l);{var c=u=>{var d=Fc();d.__contextmenu=[cc,s];var f=y(d),v=y(f),g=y(v),m=y(g),S=k(v,2),p=y(S),C=y(p),w=k(p,2),b=y(w),P=k(S,2);{var q=K=>{var V=mc(),ie=G(V);{var he=qe=>{var D=uc(),R=G(D),Y=y(R),Se=y(Y),L=y(Se),I=k(R,2),E=y(I),T=y(E),U=k(E,2),j=y(U);M(()=>{F(L,dt[t().origin.name].pendulumDescription),F(T,`◀ ${t().psL??""}`),F(j,`${t().psR??""} ▶`)}),_(qe,D)};B(ie,qe=>{var D;(D=t().status.monsterCategories)!=null&&D.includes("Pendulum")&&qe(he)})}var ke=k(ie,2);{var Me=qe=>{var D=vc(),R=G(D),Y=y(R);ce(Y,1,()=>t().attr,le,(I,E)=>{var T=dc(),U=G(T),j=k(U,2),W=y(j);M(()=>{ge(U,`monster_attr ${h(E)??""} svelte-1qknre5`),F(W,`${Es[h(E)]??""}属性`)}),_(I,T)});var Se=k(Y,2);ce(Se,1,()=>t().types,le,(I,E)=>{var T=fc(),U=y(T);M(()=>{ge(T,`monster_cat ${h(E)??""} svelte-1qknre5`),F(U,`${dr[h(E)]??""}${fr[h(E)]??""}族`)}),_(I,T)});var L=k(R,2);ce(L,5,()=>t().status.monsterCategories??[],le,(I,E)=>{var T=hc(),U=y(T);M(()=>{ge(T,`monster_cat ${h(E)??""} svelte-1qknre5`),F(U,`${hr[h(E)]??""}${vr[h(E)]??""}`)}),_(I,T)}),_(qe,D)},$e=qe=>{var D=_e(),R=G(D);{var Y=L=>{var I=pc(),E=k(y(I),2),T=y(E);M(()=>F(T,`${pr[t().status.spellCategory]??""}魔法`)),_(L,I)},Se=L=>{var I=_e(),E=G(I);{var T=U=>{var j=gc(),W=k(y(j),2),J=y(W);M(()=>F(J,`${gr[t().status.trapCategory]??""}罠`)),_(U,j)};B(E,U=>{t().kind==="Trap"&&t().status.trapCategory&&U(T)},!0)}_(L,I)};B(R,L=>{t().kind==="Spell"&&t().status.spellCategory?L(Y):L(Se,!1)},!0)}_(qe,D)};B(ke,qe=>{t().kind==="Monster"?qe(Me):qe($e,!1)})}_(K,V)};B(P,K=>{s()==="Normal"&&K(q)})}var Z=k(f,2),ee=y(Z);{var N=K=>{var V=yc(),ie=y(V),he=y(ie),ke=y(he);M(Me=>F(ke,Me),[()=>{var Me;return(Me=i())==null?void 0:Me.description}],ue),_(K,V)},H=K=>{var V=Ac(),ie=y(V),he=y(ie);he.textContent='"info" :{';var ke=k(he,2);ce(ke,1,()=>Object.entries(t().info),le,(se,ae)=>{let pe=()=>h(ae)[0],Ce=()=>h(ae)[1];var Ee=_c(),tt=y(Ee);M(Ve=>F(tt,`"${pe()??""}" :${Ve??""},`),[()=>{var Ve;return(Ve=Ce())==null?void 0:Ve.toString()}],ue),_(se,Ee)});var Me=k(ke,2);Me.textContent="},";var $e=k(Me,2);$e.textContent='"status" :{';var qe=k($e,2);ce(qe,1,()=>Object.entries(t().status),le,(se,ae)=>{let pe=()=>h(ae)[0],Ce=()=>h(ae)[1];var Ee=Sc(),tt=y(Ee);M(Ve=>F(tt,`"${pe()??""}" :${Ve??""},`),[()=>{var Ve;return(Ve=Ce())==null?void 0:Ve.toString()}],ue),_(se,Ee)});var D=k(qe,2);D.textContent="},";var R=k(D,2);R.textContent='"actions" :[';var Y=k(R,2);ce(Y,1,()=>t().actions,le,(se,ae)=>{var pe=wc(),Ce=y(pe);M(()=>F(Ce,`"${h(ae).playType??""} ${h(ae).title??""}",`)),_(se,pe)});var Se=k(Y,2);Se.textContent="],";var L=k(Se,2);L.textContent='"substituteEffects" :[';var I=k(L,2);ce(I,1,()=>t().substituteEffects,le,(se,ae)=>{var pe=kc(),Ce=y(pe);M(()=>F(Ce,`"${h(ae).title??""}",`)),_(se,pe)});var E=k(I,2);E.textContent="],";var T=k(E,2);T.textContent='"continuousEffects" :[';var U=k(T,2);ce(U,1,()=>t().continuousEffects,le,(se,ae)=>{var pe=Cc(),Ce=y(pe);M(()=>F(Ce,`"${h(ae).isStarted??""}",`)),_(se,pe)});var j=k(U,2);j.textContent="],";var W=k(j,2);W.textContent='"procFilters" :[';var J=k(W,2);ce(J,1,()=>t().procFilterBundle.operators,le,(se,ae)=>{var pe=bc(),Ce=y(pe);M(Ee=>F(Ce,`"${Ee??""} ${h(ae).title??""}",`),[()=>h(ae).isSpawnedBy.toString()],ue),_(se,pe)});var me=k(J,2);me.textContent="],";var re=k(me,2);re.textContent='"numericStateOperators" :[';var X=k(re,2);ce(X,1,()=>t().numericOprsBundle.operators,le,(se,ae)=>{var pe=Ec(),Ce=y(pe);M(Ee=>F(Ce,`"${Ee??""} ${h(ae).title??""}",`),[()=>h(ae).isSpawnedBy.toString()],ue),_(se,pe)});var te=k(X,2);te.textContent="],";var z=k(te,2);z.textContent='"stateOperators" :[';var be=k(z,2);ce(be,1,()=>t().statusOperatorBundle.operators,le,(se,ae)=>{var pe=Tc(),Ce=y(pe);M(Ee=>F(Ce,`"${Ee??""} ${h(ae).title??""}",`),[()=>h(ae).isSpawnedBy.toString()],ue),_(se,pe)});var De=k(be,2);De.textContent="],";var Ne=k(De,2);Ne.textContent='"lastMoveLogRecord" :{';var yt=k(Ne,2),Ze=y(yt),xe=k(yt,2),Ue=y(xe),_t=k(xe,2),Dt=y(_t),He=k(_t,2);He.textContent="},",M((se,ae)=>{F(Ze,`"movedBy":"${se??""}",`),F(Ue,`"movedAs":"${ae??""}",`),F(Dt,`"movedAt":"${t().moveLog.latestRecord.movedAt.totalProcSeq??""}",`)},[()=>{var se;return(se=t().moveLog.latestRecord.movedBy)==null?void 0:se.toString()},()=>t().moveLog.latestRecord.movedAs.join(" ")],ue),_(K,V)};B(ee,K=>{s()==="Normal"?K(N):K(H,!1)})}var $=k(Z,2),O=y($);{var Pe=K=>{var V=Pc();_(K,V)},Be=K=>{var V=Dc(),ie=y(V),he=k(ie,2),ke=y(he);M(Me=>{var $e;li(ie,"href",`https://yugioh-wiki.net/index.php?${t().origin.wikiEncodedName}`),li(he,"href",Me),F(ke,`⇒${(($e=t())!=null&&$e.origin.cardId?"公式カードページ":"公式で検索")??""}`)},[r],ue),_(K,V)};B(O,K=>{var V;(V=t())!=null&&V.origin.isForTest?K(Pe):K(Be,!1)})}M((K,V,ie)=>{ge(d,`duel_card duel_card_info ${t().origin.kind??""} ${K??""} svelte-1qknre5`),F(m,t().nm),F(C,V),F(b,ie)},[()=>{var K;return(K=t().origin.monsterCategories)==null?void 0:K.join(" ")},()=>"★".repeat(t().lvl||0),()=>"☆".repeat(t().rank||0)],ue),_(u,d)};B(a,u=>{t()&&u(c)})}_(n,l),et()}Jt(["contextmenu"]);var qc=A('<div class="duel_field_cell_info_item svelte-1xj7qf1"><!></div>'),Mc=A('<div class="duel_field_cell_info_box svelte-1xj7qf1"><div class="duel_field_cell_info_label svelte-1xj7qf1"> </div> <!></div>'),Bc=A('<div class="duel_field_cell_info svelte-1xj7qf1"><div class="duel_field_cell_info_header item_btn svelte-1xj7qf1"><div class="svelte-1xj7qf1"> </div> <div class="svelte-1xj7qf1"> </div></div> <div class="duel_field_cell_info_body svelte-1xj7qf1"></div></div>');function Oc(n,e){Je(e,!1);let t=ye(e,"cell",12);const i=()=>{t(t())},r=c=>t().cardEntities.filter(u=>u.face===c);t().field.duel.view.onDuelUpdate.append(i),lt();var s=_e(),l=G(s);{var a=c=>{var u=Bc(),d=y(u),f=y(d),v=y(f),g=k(f,2),m=y(g),S=k(d,2);ce(S,4,()=>["FaceUp","FaceDown"],le,(p,C)=>{var w=_e(),b=G(w);{var P=q=>{var Z=Mc(),ee=y(Z),N=y(ee),H=k(ee,2);ce(H,1,()=>r(C).toSorted(os),le,($,O)=>{var Pe=qc(),Be=y(Pe);const K=ue(()=>t().owner===t().field.duel.duelists.Below);ft(Be,{get entity(){return h(O)},get isVisibleForcibly(){return h(K)},isWideMode:!0,cardActionResolve:void 0}),_($,Pe)}),M(()=>F(N,C==="FaceUp"?"表向き":"裏向き")),_(q,Z)};B(b,q=>{r(C).length&&q(P)})}_(p,w)}),M(()=>{var p;F(v,(p=t().owner)==null?void 0:p.profile.name),F(m,t().cellType)}),_(c,u)};B(l,c=>{t().field.duel.view.infoBoardState==="CellInfo"&&c(a)})}_(n,s),et()}const Nc=il({duration:400});var Lc=A('<div class="duel_field_header_message svelte-accyye"> </div> <div class="duel_field_header_buttons svelte-accyye"><button class="svelte-accyye">サレンダー</button></div>',1),Ic=A("<tr></tr>"),Rc=A('<table class="duel_field svelte-accyye"><tbody class="svelte-accyye"></tbody></table>'),$c=A('<button class="svelte-accyye">cancel</button>'),Uc=A('<button class="svelte-accyye">OK</button> <!>',1),Hc=A('<button class="svelte-accyye"> </button>'),jc=A('<div class="flex duel_desk svelte-accyye"><div class="duel_desk_left v_flex svelte-accyye"><!> <!> <!></div> <div class=" duel_desk_center v_flex svelte-accyye"><div class="duel_field_header svelte-accyye"><!></div> <div class="svelte-accyye"><!></div> <div class="duel_field_footer svelte-accyye"><!></div></div> <div class=" duel_desk_right svelte-accyye" style="text-align: left;"><!> <!></div></div> <div style="position:absolute;left:0;bottom:0"> </div> <!>',1);function du(n,e){Je(e,!1);let t=ye(e,"duel",12),i=Te([]),r=Te([]),s=()=>{},l=Te([]),a=Te(),c=Te(),u=Te(()=>!1),d=Te(!1);const f=E=>{s=E.resolve,x(l,E.dummyActionInfos.filter(T=>T.action.entity.entityType==="Duelist").filter(T=>T.action.entity.controller.seat==="Below")),x(a,void 0),x(c,void 0),x(r,[]),x(i,[]),x(d,!1),E.entitiesChoices&&(x(a,E.entitiesChoices),x(u,()=>{var T;return((T=E.entitiesChoices)==null?void 0:T.validator(h(i)))??!1}),x(d,E.entitiesChoices.cancelable),h(a).selectables.every(T=>T.fieldCell.isPlayFieldCell&&T.getIndexInCell()===0||T.fieldCell.cellType==="Hand"&&T.controller.duelistType==="Player"||T.entityType==="Duelist")||t().view.modalController.entitySelector.show({title:t().view.message,entitiesChoices:E.entitiesChoices,chainBlockInfos:E.chainBlockInfos,cancelable:E.entitiesChoices.cancelable}).then(T=>{s({selectedEntities:T})})),E.cellsChoices&&(x(c,E.cellsChoices),x(u,()=>{var T;return((T=E.cellsChoices)==null?void 0:T.validator(h(r)))??!1}),x(d,E.cellsChoices.cancelable))};t().view.onWaitStart.append(f);const v=()=>{s=()=>{},x(c,void 0),x(a,void 0),x(r,[]),x(i,[]),x(u,()=>!1),x(d,!1)};t().view.onWaitEnd.append(v);let g=Te(void 0),m=Te("Normal");const S=({card:E,mode:T})=>{x(g,E),x(m,T)};t().view.onShowCardEntity.append(S);const p=()=>{t(t())};t().view.onDuelUpdate.append(p),t().log.onUpdate.append(p);const C=()=>{h(a)&&h(a).validator(h(i))&&s({selectedEntities:h(i)}),h(c)&&h(c).validator(h(r))&&s({selectedCells:h(r)})},w=()=>{s({})},b=E=>{s({actionInfo:E})},P=()=>{s({surrender:!0})};t().main(),lt();var q=jc(),Z=G(q),ee=y(Z),N=y(ee);ar(N,{get duelist(){return t().duelists.Above}});var H=k(N,2);xc(H,{get entity(){return h(g)},get mode(){return h(m)}});var $=k(H,2);ar($,{get duelist(){return t().duelists.Below}});var O=k(ee,2),Pe=y(O),Be=y(Pe);{var K=E=>{var T=Lc(),U=G(T),j=y(U),W=k(U,2),J=y(W);M(()=>F(j,`[TURN:${t().clock.turn}][PHASE:${t().phase}] ${t().view.message}`)),je("click",J,P),_(E,T)};B(Be,E=>{t().isEnded||E(K)})}var V=k(Pe,2),ie=y(V);{var he=E=>{var T=Rc(),U=y(T);ce(U,5,()=>t().field.cells,le,(j,W,J)=>{var me=Ic();ge(me,`${`duel_desk_row_${J}`??""} svelte-accyye`),ce(me,5,()=>h(W),le,(re,X,te)=>{xl(re,{get view(){return t().view},row:J,column:te,get selectedEntities(){return h(i)},set selectedEntities(z){x(i,z)},get selectedCells(){return h(r)},set selectedCells(z){x(r,z)},$$legacy:!0})}),_(j,me)}),_(E,T)};B(ie,E=>{t().clock.turn>0&&E(he)})}var ke=k(V,2),Me=y(ke);{var $e=E=>{var T=Uc(),U=G(T),j=k(U,2);{var W=J=>{var me=$c();je("click",me,w),_(J,me)};B(j,J=>{h(d)&&J(W)})}M(J=>U.disabled=J,[()=>!h(u)()],ue),je("click",U,C),_(E,T)},qe=E=>{var T=_e(),U=G(T);{var j=W=>{var J=_e(),me=G(J);ce(me,1,()=>h(l),le,(re,X)=>{var te=Hc(),z=y(te);M(()=>F(z,h(X).action.title)),je("click",te,()=>b(h(X))),_(re,te)}),_(W,J)};B(U,W=>{h(l)&&h(l).length&&W(j)},!0)}_(E,T)};B(Me,E=>{h(a)&&h(a).selectables.length||h(c)&&h(c).selectables?E($e):E(qe,!1)})}var D=k(O,2),R=y(D);Rl(R,{get log(){return t().log}});var Y=k(R,2);Oc(Y,{get cell(){return t().view.infoBoardCell}});var Se=k(Z,2),L=y(Se),I=k(Se,2);lc(I,{get modalController(){return t().view.modalController}}),M(E=>F(L,E),[()=>t().clock.toString()],ue),_(n,q),et()}export{Gn as $,_ as A,Ba as B,F as C,Ge as D,ue as E,Xo as F,je as G,G as H,nr as I,et as J,_e as K,dt as L,li as M,Yn as N,Te as O,Xn as P,rr as Q,Qc as R,de as S,ti as T,Wc as U,Xc as V,Yc as W,x as X,Gc as Y,Jc as Z,eu as _,Co as a,du as a0,Rt as a1,uu as a2,en as a3,Kn as a4,ou as a5,fo as a6,cu as a7,lu as a8,Kc as a9,mo as b,su as c,Yi as d,iu as e,go as f,ss as g,nu as h,ru as i,ne as j,At as k,ye as l,is as m,Bo as n,lt as o,Je as p,ce as q,k as r,ns as s,A as t,y as u,h as v,le as w,B as x,M as y,ge as z};
