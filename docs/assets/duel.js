var eo=Object.defineProperty;var to=(n,e,t)=>e in n?eo(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>to(n,typeof e!="symbol"?e+"":e,t);import{_ as cr,a as dr,b as ur,c as fr,d as hr,e as vr,f as pr,g as _r,h as gr,i as mr,j as yr,k as Sr,l as wr,m as Cr,n as kr,o as br,p as Er,q as Dr,r as Tr,s as Pr,t as Ar,u as Fr,v as Mr,w as qr,x as xr,y as Br,z as Or,A as Nr,B as Lr,C as Rr,D as Ir,E as $r,F as Ur,G as Hr,H as jr,I as Zr,J as Vr,K as zr,L as io,M as no,N as ro}from"./entity_proc.js";import{j as so}from"./json.js";const nn=!1;var mn=Array.isArray,oo=Array.prototype.indexOf,yn=Array.from,ao=Object.defineProperty,Ht=Object.getOwnPropertyDescriptor,Gr=Object.getOwnPropertyDescriptors,lo=Object.prototype,co=Array.prototype,Sn=Object.getPrototypeOf;function uo(n){return typeof n=="function"}const wt=()=>{};function fo(n){return typeof(n==null?void 0:n.then)=="function"}function ho(n){return n()}function rn(n){for(var e=0;e<n.length;e++)n[e]()}const Xe=2,Wr=4,Oi=8,Ni=16,_t=32,ci=64,yi=128,Ke=256,Si=512,Ie=1024,gt=2048,Wt=4096,vt=8192,Li=16384,Kr=32768,Ri=65536,Xr=1<<17,vo=1<<19,Qr=1<<20,pt=Symbol("$state"),po=Symbol("legacy props"),_o=Symbol("");function Yr(n){return n===this.v}function Jr(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function wn(n){return!Jr(n,this.v)}function go(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function mo(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function yo(n){throw new Error("https://svelte.dev/e/effect_orphan")}function So(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function wo(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function Co(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function ko(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function bo(){throw new Error("https://svelte.dev/e/state_unsafe_local_read")}function Eo(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}let di=!1,Do=!1;function To(){di=!0}const Cn=1,kn=2,es=4,Po=8,Ao=16,Fo=1,Mo=2,qo=4,xo=8,Bo=16,Oo=1,No=2,Lo=4,Ro=1,Io=2,Oe=Symbol();let Fe=null;function wi(n){Fe=n}function Je(n,e=!1,t){Fe={p:Fe,c:null,e:null,m:!1,s:n,x:null,l:null},di&&!e&&(Fe.l={s:null,u:null,r1:[],r2:Le(!1)})}function et(n){const e=Fe;if(e!==null){const l=e.e;if(l!==null){var t=fe,i=ve;e.e=null;try{for(var r=0;r<l.length;r++){var s=l[r];Ye(s.effect),Qe(s.reaction),Qt(s.fn)}}finally{Ye(t),Qe(i)}}Fe=e.p,e.m=!0}return{}}function Kt(){return!di||Fe!==null&&Fe.l===null}function Le(n,e){var t={f:0,v:n,reactions:null,equals:Yr,rv:0,wv:0};return t}function $o(n){return ts(Le(n))}function ni(n,e=!1){var i;const t=Le(n);return e||(t.equals=wn),di&&Fe!==null&&Fe.l!==null&&((i=Fe.l).s??(i.s=[])).push(t),t}function De(n,e=!1){return ts(ni(n,e))}function ts(n){return ve!==null&&!st&&ve.f&Xe&&(ot===null?Qo([n]):ot.push(n)),n}function ei(n,e){return M(n,at(()=>h(n))),e}function M(n,e){return ve!==null&&!st&&Kt()&&ve.f&(Xe|Ni)&&(ot===null||!ot.includes(n))&&Eo(),Et(n,e)}function Et(n,e){return n.equals(e)||(n.v,n.v=e,n.wv=Ss(),is(n,gt),Kt()&&fe!==null&&fe.f&Ie&&!(fe.f&(_t|ci))&&(ut===null?Yo([n]):ut.push(n))),e}function is(n,e){var t=n.reactions;if(t!==null)for(var i=Kt(),r=t.length,s=0;s<r;s++){var l=t[s],o=l.f;o&gt||!i&&l===fe||(lt(l,e),o&(Ie|Ke)&&(o&Xe?is(l,Wt):ji(l)))}}let ns=!1;function Ct(n,e=null,t){if(typeof n!="object"||n===null||pt in n)return n;const i=Sn(n);if(i!==lo&&i!==co)return n;var r=new Map,s=mn(n),l=Le(0);s&&r.set("length",Le(n.length));var o;return new Proxy(n,{defineProperty(c,d,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&Co();var f=r.get(d);return f===void 0?(f=Le(u.value),r.set(d,f)):M(f,Ct(u.value,o)),!0},deleteProperty(c,d){var u=r.get(d);if(u===void 0)d in c&&r.set(d,Le(Oe));else{if(s&&typeof d=="string"){var f=r.get("length"),v=Number(d);Number.isInteger(v)&&v<f.v&&M(f,v)}M(u,Oe),xn(l)}return!0},get(c,d,u){var g;if(d===pt)return n;var f=r.get(d),v=d in c;if(f===void 0&&(!v||(g=Ht(c,d))!=null&&g.writable)&&(f=Le(Ct(v?c[d]:Oe,o)),r.set(d,f)),f!==void 0){var _=h(f);return _===Oe?void 0:_}return Reflect.get(c,d,u)},getOwnPropertyDescriptor(c,d){var u=Reflect.getOwnPropertyDescriptor(c,d);if(u&&"value"in u){var f=r.get(d);f&&(u.value=h(f))}else if(u===void 0){var v=r.get(d),_=v==null?void 0:v.v;if(v!==void 0&&_!==Oe)return{enumerable:!0,configurable:!0,value:_,writable:!0}}return u},has(c,d){var _;if(d===pt)return!0;var u=r.get(d),f=u!==void 0&&u.v!==Oe||Reflect.has(c,d);if(u!==void 0||fe!==null&&(!f||(_=Ht(c,d))!=null&&_.writable)){u===void 0&&(u=Le(f?Ct(c[d],o):Oe),r.set(d,u));var v=h(u);if(v===Oe)return!1}return f},set(c,d,u,f){var b;var v=r.get(d),_=d in c;if(s&&d==="length")for(var g=u;g<v.v;g+=1){var S=r.get(g+"");S!==void 0?M(S,Oe):g in c&&(S=Le(Oe),r.set(g+"",S))}v===void 0?(!_||(b=Ht(c,d))!=null&&b.writable)&&(v=Le(void 0),M(v,Ct(u,o)),r.set(d,v)):(_=v.v!==Oe,M(v,Ct(u,o)));var p=Reflect.getOwnPropertyDescriptor(c,d);if(p!=null&&p.set&&p.set.call(f,u),!_){if(s&&typeof d=="string"){var k=r.get("length"),w=Number(d);Number.isInteger(w)&&w>=k.v&&M(k,w+1)}xn(l)}return!0},ownKeys(c){h(l);var d=Reflect.ownKeys(c).filter(v=>{var _=r.get(v);return _===void 0||_.v!==Oe});for(var[u,f]of r)f.v!==Oe&&!(u in c)&&d.push(u);return d},setPrototypeOf(){ko()}})}function xn(n,e=1){M(n,n.v+e)}function Bn(n){return n!==null&&typeof n=="object"&&pt in n?n[pt]:n}function rs(n,e){return Object.is(Bn(n),Bn(e))}var On,ss,os,as;function Uo(){if(On===void 0){On=window,ss=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype;os=Ht(e,"firstChild").get,as=Ht(e,"nextSibling").get,n.__click=void 0,n.__className="",n.__attributes=null,n.__styles=null,n.__e=void 0,Text.prototype.__t=void 0}}function Ii(n=""){return document.createTextNode(n)}function Ci(n){return os.call(n)}function $i(n){return as.call(n)}function m(n,e){return Ci(n)}function G(n,e){{var t=Ci(n);return t instanceof Comment&&t.data===""?$i(t):t}}function C(n,e=1,t=!1){let i=n;for(;e--;)i=$i(i);return i}function Ho(n){n.textContent=""}function ri(n){var e=Xe|gt,t=ve!==null&&ve.f&Xe?ve:null;return fe===null||t!==null&&t.f&Ke?e|=Ke:fe.f|=Qr,{ctx:Fe,deps:null,effects:null,equals:Yr,f:e,fn:n,reactions:null,rv:0,v:null,wv:0,parent:t??fe}}function ue(n){const e=ri(n);return e.equals=wn,e}function ls(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)Pt(e[t])}}function jo(n){for(var e=n.parent;e!==null;){if(!(e.f&Xe))return e;e=e.parent}return null}function Zo(n){var e,t=fe;Ye(jo(n));try{ls(n),e=Cs(n)}finally{Ye(t)}return e}function cs(n){var e=Zo(n),t=(bt||n.f&Ke)&&n.deps!==null?Wt:Ie;lt(n,t),n.equals(e)||(n.v=e,n.wv=Ss())}function ds(n){fe===null&&ve===null&&yo(),ve!==null&&ve.f&Ke&&fe===null&&mo(),En&&go()}function Vo(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function Xt(n,e,t,i=!0){var r=(n&ci)!==0,s=fe,l={ctx:Fe,deps:null,nodes_start:null,nodes_end:null,f:n|gt,first:null,fn:e,last:null,next:null,parent:r?null:s,prev:null,teardown:null,transitions:null,wv:0};if(t){var o=jt;try{Ln(!0),Dn(l),l.f|=Kr}catch(u){throw Pt(l),u}finally{Ln(o)}}else e!==null&&ji(l);var c=t&&l.deps===null&&l.first===null&&l.nodes_start===null&&l.teardown===null&&(l.f&(Qr|yi))===0;if(!c&&!r&&i&&(s!==null&&Vo(l,s),ve!==null&&ve.f&Xe)){var d=ve;(d.effects??(d.effects=[])).push(l)}return l}function us(n){const e=Xt(Oi,null,!1);return lt(e,Ie),e.teardown=n,e}function Nn(n){ds();var e=fe!==null&&(fe.f&_t)!==0&&Fe!==null&&!Fe.m;if(e){var t=Fe;(t.e??(t.e=[])).push({fn:n,effect:fe,reaction:ve})}else{var i=Qt(n);return i}}function zo(n){return ds(),ui(n)}function Go(n){const e=Xt(ci,n,!0);return(t={})=>new Promise(i=>{t.outro?xt(e,()=>{Pt(e),i(void 0)}):(Pt(e),i(void 0))})}function Qt(n){return Xt(Wr,n,!1)}function ui(n){return Xt(Oi,n,!0)}function x(n,e=[],t=ri){const i=e.map(t);return Ui(()=>n(...i.map(h)))}function Ui(n,e=0){return Xt(Oi|Ni|e,n,!0)}function Bt(n,e=!0){return Xt(Oi|_t,n,!0,e)}function fs(n){var e=n.teardown;if(e!==null){const t=En,i=ve;Rn(!0),Qe(null);try{e.call(null)}finally{Rn(t),Qe(i)}}}function hs(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){var i=t.next;Pt(t,e),t=i}}function Wo(n){for(var e=n.first;e!==null;){var t=e.next;e.f&_t||Pt(e),e=t}}function Pt(n,e=!0){var t=!1;if((e||n.f&vo)&&n.nodes_start!==null){for(var i=n.nodes_start,r=n.nodes_end;i!==null;){var s=i===r?null:$i(i);i.remove(),i=s}t=!0}hs(n,e&&!t),Ei(n,0),lt(n,Li);var l=n.transitions;if(l!==null)for(const c of l)c.stop();fs(n);var o=n.parent;o!==null&&o.first!==null&&vs(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes_start=n.nodes_end=null}function vs(n){var e=n.parent,t=n.prev,i=n.next;t!==null&&(t.next=i),i!==null&&(i.prev=t),e!==null&&(e.first===n&&(e.first=i),e.last===n&&(e.last=t))}function xt(n,e){var t=[];bn(n,t,!0),ps(t,()=>{Pt(n),e&&e()})}function ps(n,e){var t=n.length;if(t>0){var i=()=>--t||e();for(var r of n)r.out(i)}else e()}function bn(n,e,t){if(!(n.f&vt)){if(n.f^=vt,n.transitions!==null)for(const l of n.transitions)(l.is_global||t)&&e.push(l);for(var i=n.first;i!==null;){var r=i.next,s=(i.f&Ri)!==0||(i.f&_t)!==0;bn(i,e,s?t:!1),i=r}}}function zt(n){_s(n,!0)}function _s(n,e){if(n.f&vt){n.f^=vt,n.f&Ie||(n.f^=Ie),fi(n)&&(lt(n,gt),ji(n));for(var t=n.first;t!==null;){var i=t.next,r=(t.f&Ri)!==0||(t.f&_t)!==0;_s(t,r?e:!1),t=i}if(n.transitions!==null)for(const s of n.transitions)(s.is_global||e)&&s.in()}}let ki=!1,sn=[];function gs(){ki=!1;const n=sn.slice();sn=[],rn(n)}function Ot(n){ki||(ki=!0,queueMicrotask(gs)),sn.push(n)}function Ko(){ki&&gs()}const ms=0,Xo=1;let gi=!1,mi=ms,si=!1,oi=null,jt=!1,En=!1;function Ln(n){jt=n}function Rn(n){En=n}let qt=[],Zt=0;let ve=null,st=!1;function Qe(n){ve=n}let fe=null;function Ye(n){fe=n}let ot=null;function Qo(n){ot=n}let Re=null,ze=0,ut=null;function Yo(n){ut=n}let ys=1,bi=0,bt=!1,kt=null;function Ss(){return++ys}function fi(n){var f;var e=n.f;if(e&gt)return!0;if(e&Wt){var t=n.deps,i=(e&Ke)!==0;if(t!==null){var r,s,l=(e&Si)!==0,o=i&&fe!==null&&!bt,c=t.length;if(l||o){var d=n,u=d.parent;for(r=0;r<c;r++)s=t[r],(l||!((f=s==null?void 0:s.reactions)!=null&&f.includes(d)))&&(s.reactions??(s.reactions=[])).push(d);l&&(d.f^=Si),o&&u!==null&&!(u.f&Ke)&&(d.f^=Ke)}for(r=0;r<c;r++)if(s=t[r],fi(s)&&cs(s),s.wv>n.wv)return!0}(!i||fe!==null&&!bt)&&lt(n,Ie)}return!1}function Jo(n,e){for(var t=e;t!==null;){if(t.f&yi)try{t.fn(n);return}catch{t.f^=yi}t=t.parent}throw gi=!1,n}function ea(n){return(n.f&Li)===0&&(n.parent===null||(n.parent.f&yi)===0)}function Hi(n,e,t,i){if(gi){if(t===null&&(gi=!1),ea(e))throw n;return}t!==null&&(gi=!0);{Jo(n,e);return}}function ws(n,e,t=!0){var i=n.reactions;if(i!==null)for(var r=0;r<i.length;r++){var s=i[r];s.f&Xe?ws(s,e,!1):e===s&&(t?lt(s,gt):s.f&Ie&&lt(s,Wt),ji(s))}}function Cs(n){var _;var e=Re,t=ze,i=ut,r=ve,s=bt,l=ot,o=Fe,c=st,d=n.f;Re=null,ze=0,ut=null,ve=d&(_t|ci)?null:n,bt=(d&Ke)!==0&&(!jt||r===null||c),ot=null,wi(n.ctx),st=!1,bi++;try{var u=(0,n.fn)(),f=n.deps;if(Re!==null){var v;if(Ei(n,ze),f!==null&&ze>0)for(f.length=ze+Re.length,v=0;v<Re.length;v++)f[ze+v]=Re[v];else n.deps=f=Re;if(!bt)for(v=ze;v<f.length;v++)((_=f[v]).reactions??(_.reactions=[])).push(n)}else f!==null&&ze<f.length&&(Ei(n,ze),f.length=ze);if(Kt()&&ut!==null&&!st&&f!==null&&!(n.f&(Xe|Wt|gt)))for(v=0;v<ut.length;v++)ws(ut[v],n);return r!==null&&bi++,u}finally{Re=e,ze=t,ut=i,ve=r,bt=s,ot=l,wi(o),st=c}}function ta(n,e){let t=e.reactions;if(t!==null){var i=oo.call(t,n);if(i!==-1){var r=t.length-1;r===0?t=e.reactions=null:(t[i]=t[r],t.pop())}}t===null&&e.f&Xe&&(Re===null||!Re.includes(e))&&(lt(e,Wt),e.f&(Ke|Si)||(e.f^=Si),ls(e),Ei(e,0))}function Ei(n,e){var t=n.deps;if(t!==null)for(var i=e;i<t.length;i++)ta(n,t[i])}function Dn(n){var e=n.f;if(!(e&Li)){lt(n,Ie);var t=fe,i=Fe;fe=n;try{e&Ni?Wo(n):hs(n),fs(n);var r=Cs(n);n.teardown=typeof r=="function"?r:null,n.wv=ys;var s=n.deps,l;nn&&Do&&n.f&gt}catch(o){Hi(o,n,t,i||n.ctx)}finally{fe=t}}}function ks(){if(Zt>1e3){Zt=0;try{So()}catch(n){if(oi!==null)Hi(n,oi,null);else throw n}}Zt++}function bs(n){var e=n.length;if(e!==0){ks();var t=jt;jt=!0;try{for(var i=0;i<e;i++){var r=n[i];r.f&Ie||(r.f^=Ie);var s=ra(r);ia(s)}}finally{jt=t}}}function ia(n){var e=n.length;if(e!==0)for(var t=0;t<e;t++){var i=n[t];if(!(i.f&(Li|vt)))try{fi(i)&&(Dn(i),i.deps===null&&i.first===null&&i.nodes_start===null&&(i.teardown===null?vs(i):i.fn=null))}catch(r){Hi(r,i,null,i.ctx)}}}function na(){if(si=!1,Zt>1001)return;const n=qt;qt=[],bs(n),si||(Zt=0,oi=null)}function ji(n){mi===ms&&(si||(si=!0,queueMicrotask(na))),oi=n;for(var e=n;e.parent!==null;){e=e.parent;var t=e.f;if(t&(ci|_t)){if(!(t&Ie))return;e.f^=Ie}}qt.push(e)}function ra(n){var e=[],t=n.first;e:for(;t!==null;){var i=t.f,r=(i&_t)!==0,s=r&&(i&Ie)!==0,l=t.next;if(!s&&!(i&vt)){if(i&Wr)e.push(t);else if(r)t.f^=Ie;else{var o=ve;try{ve=t,fi(t)&&Dn(t)}catch(u){Hi(u,t,null,t.ctx)}finally{ve=o}}var c=t.first;if(c!==null){t=c;continue}}if(l===null){let u=t.parent;for(;u!==null;){if(n===u)break e;var d=u.next;if(d!==null){t=d;continue e}u=u.parent}}t=l}return e}function Tn(n){var e=mi,t=qt;try{ks();const r=[];mi=Xo,qt=r,si=!1,bs(t);var i=n==null?void 0:n();return Ko(),(qt.length>0||r.length>0)&&Tn(),Zt=0,oi=null,i}finally{mi=e,qt=t}}async function sa(){await Promise.resolve(),Tn()}function h(n){var e=n.f,t=(e&Xe)!==0;if(kt!==null&&kt.add(n),ve!==null&&!st){ot!==null&&ot.includes(n)&&bo();var i=ve.deps;n.rv<bi&&(n.rv=bi,Re===null&&i!==null&&i[ze]===n?ze++:Re===null?Re=[n]:(!bt||!Re.includes(n))&&Re.push(n))}else if(t&&n.deps===null&&n.effects===null){var r=n,s=r.parent;s!==null&&!(s.f&Ke)&&(r.f^=Ke)}return t&&(r=n,fi(r)&&cs(r)),n.v}function oa(n){var e=kt;kt=new Set;var t=kt,i;try{if(at(n),e!==null)for(i of kt)e.add(i)}finally{kt=e}return t}function xd(n){var e=oa(()=>at(n));for(var t of e)if(t.f&Xr)for(const i of t.deps||[])i.f&Xe||Et(i,i.v);else Et(t,t.v)}function at(n){var e=st;try{return st=!0,n()}finally{st=e}}const aa=-7169;function lt(n,e){n.f=n.f&aa|e}function la(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(pt in n)on(n);else if(!Array.isArray(n))for(let e in n){const t=n[e];typeof t=="object"&&t&&pt in t&&on(t)}}}function on(n,e=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!e.has(n)){e.add(n),n instanceof Date&&n.getTime();for(let i in n)try{on(n[i],e)}catch{}const t=Sn(n);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const i=Gr(t);for(let r in i){const s=i[r].get;if(s)try{s.call(n)}catch{}}}}}const ca=["touchstart","touchmove"];function da(n){return ca.includes(n)}let In=!1;function ua(){In||(In=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Pn(n){var e=ve,t=fe;Qe(null),Ye(null);try{return n()}finally{Qe(e),Ye(t)}}function Zi(n,e,t,i=t){n.addEventListener(e,()=>Pn(t));const r=n.__on_r;r?n.__on_r=()=>{r(),i(!0)}:n.__on_r=()=>i(!0),ua()}const Es=new Set,an=new Set;function fa(n,e,t,i={}){function r(s){if(i.capture||Jt.call(e,s),!s.cancelBubble)return Pn(()=>t==null?void 0:t.call(this,s))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Ot(()=>{e.addEventListener(n,r,i)}):e.addEventListener(n,r,i),r}function je(n,e,t,i,r){var s={capture:i,passive:r},l=fa(n,e,t,s);(e===document.body||e===window||e===document)&&us(()=>{e.removeEventListener(n,l,s)})}function Yt(n){for(var e=0;e<n.length;e++)Es.add(n[e]);for(var t of an)t(n)}function Jt(n){var w;var e=this,t=e.ownerDocument,i=n.type,r=((w=n.composedPath)==null?void 0:w.call(n))||[],s=r[0]||n.target,l=0,o=n.__root;if(o){var c=r.indexOf(o);if(c!==-1&&(e===document||e===window)){n.__root=e;return}var d=r.indexOf(e);if(d===-1)return;c<=d&&(l=c)}if(s=r[l]||n.target,s!==e){ao(n,"currentTarget",{configurable:!0,get(){return s||t}});var u=ve,f=fe;Qe(null),Ye(null);try{for(var v,_=[];s!==null;){var g=s.assignedSlot||s.parentNode||s.host||null;try{var S=s["__"+i];if(S!==void 0&&!s.disabled)if(mn(S)){var[p,...k]=S;p.apply(s,[n,...k])}else S.call(s,n)}catch(b){v?_.push(b):v=b}if(n.cancelBubble||g===e||g===null)break;s=g}if(v){for(let b of _)queueMicrotask(()=>{throw b});throw v}}finally{n.__root=e,delete n.currentTarget,Qe(u),Ye(f)}}}function ha(n){var e=document.createElement("template");return e.innerHTML=n,e.content}function Di(n,e){var t=fe;t.nodes_start===null&&(t.nodes_start=n,t.nodes_end=e)}function T(n,e){var t=(e&Ro)!==0,i=(e&Io)!==0,r,s=!n.startsWith("<!>");return()=>{r===void 0&&(r=ha(s?n:"<!>"+n),t||(r=Ci(r)));var l=i||ss?document.importNode(r,!0):r.cloneNode(!0);if(t){var o=Ci(l),c=l.lastChild;Di(o,c)}else Di(l,l);return l}}function va(n=""){{var e=Ii(n+"");return Di(e,e),e}}function ye(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Ii();return n.append(e,t),Di(e,t),n}function y(n,e){n!==null&&n.before(e)}let ln=!0;function F(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Bd(n,e){return pa(n,e)}const Nt=new Map;function pa(n,{target:e,anchor:t,props:i={},events:r,context:s,intro:l=!0}){Uo();var o=new Set,c=f=>{for(var v=0;v<f.length;v++){var _=f[v];if(!o.has(_)){o.add(_);var g=da(_);e.addEventListener(_,Jt,{passive:g});var S=Nt.get(_);S===void 0?(document.addEventListener(_,Jt,{passive:g}),Nt.set(_,1)):Nt.set(_,S+1)}}};c(yn(Es)),an.add(c);var d=void 0,u=Go(()=>{var f=t??e.appendChild(Ii());return Bt(()=>{if(s){Je({});var v=Fe;v.c=s}r&&(i.$$events=r),ln=l,d=n(f,i)||{},ln=!0,s&&et()}),()=>{var g;for(var v of o){e.removeEventListener(v,Jt);var _=Nt.get(v);--_===0?(document.removeEventListener(v,Jt),Nt.delete(v)):Nt.set(v,_)}an.delete(c),f!==t&&((g=f.parentNode)==null||g.removeChild(f))}});return _a.set(d,u),d}let _a=new WeakMap;const Gi=0,hi=1,Wi=2;function Od(n,e,t,i,r){var s=n,l=Kt(),o=Fe,c=Oe,d,u,f,v=(l?Le:ni)(void 0),_=(l?Le:ni)(void 0),g=!1;function S(k,w){g=!0,w&&(Ye(p),Qe(p),wi(o));try{k===Gi&&t&&(d?zt(d):d=Bt(()=>t(s))),k===hi&&i&&(u?zt(u):u=Bt(()=>i(s,v))),k!==Gi&&d&&xt(d,()=>d=null),k!==hi&&u&&xt(u,()=>u=null),k!==Wi&&f&&xt(f,()=>f=null)}finally{w&&(wi(null),Qe(null),Ye(null),Tn())}}var p=Ui(()=>{if(c!==(c=e())){if(fo(c)){var k=c;g=!1,k.then(w=>{k===c&&(Et(v,w),S(hi,!0))},w=>{if(k===c)throw Et(_,w),S(Wi,!0),_.v}),Ot(()=>{g||S(Gi,!0)})}else Et(v,c),S(hi,!1);return()=>c=Oe}})}function B(n,e,t=!1){var i=n,r=null,s=null,l=Oe,o=t?Ri:0,c=!1;const d=(f,v=!0)=>{c=!0,u(v,f)},u=(f,v)=>{l!==(l=f)&&(l?(r?zt(r):v&&(r=Bt(()=>v(i))),s&&xt(s,()=>{s=null})):(s?zt(s):v&&(s=Bt(()=>v(i))),r&&xt(r,()=>{r=null})))};Ui(()=>{c=!1,e(d),c||u(null,null)},o)}function ce(n,e){return e}function ga(n,e,t,i){for(var r=[],s=e.length,l=0;l<s;l++)bn(e[l].e,r,!0);var o=s>0&&r.length===0&&t!==null;if(o){var c=t.parentNode;Ho(c),c.append(t),i.clear(),St(n,e[0].prev,e[s-1].next)}ps(r,()=>{for(var d=0;d<s;d++){var u=e[d];o||(i.delete(u.k),St(n,u.prev,u.next)),Pt(u.e,!o)}})}function de(n,e,t,i,r,s=null){var l=n,o={flags:e,items:new Map,first:null},c=(e&es)!==0;if(c){var d=n;l=d.appendChild(Ii())}var u=null,f=!1,v=ue(()=>{var _=t();return mn(_)?_:_==null?[]:yn(_)});Ui(()=>{var _=h(v),g=_.length;f&&g===0||(f=g===0,ma(_,o,l,r,e,i,t),s!==null&&(g===0?u?zt(u):u=Bt(()=>s(l)):u!==null&&xt(u,()=>{u=null})),h(v))})}function ma(n,e,t,i,r,s,l){var W,V,ie,he;var o=(r&Po)!==0,c=(r&(Cn|kn))!==0,d=n.length,u=e.items,f=e.first,v=f,_,g=null,S,p=[],k=[],w,b,P,q;if(o)for(q=0;q<d;q+=1)w=n[q],b=s(w,q),P=u.get(b),P!==void 0&&((W=P.a)==null||W.measure(),(S??(S=new Set)).add(P));for(q=0;q<d;q+=1){if(w=n[q],b=s(w,q),P=u.get(b),P===void 0){var Z=v?v.e.nodes_start:t;g=Sa(Z,e,g,g===null?e.first:g.next,w,b,q,i,r,l),u.set(b,g),p=[],k=[],v=g.next;continue}if(c&&ya(P,w,q,r),P.e.f&vt&&(zt(P.e),o&&((V=P.a)==null||V.unfix(),(S??(S=new Set)).delete(P))),P!==v){if(_!==void 0&&_.has(P)){if(p.length<k.length){var ee=k[0],N;g=ee.prev;var H=p[0],$=p[p.length-1];for(N=0;N<p.length;N+=1)$n(p[N],ee,t);for(N=0;N<k.length;N+=1)_.delete(k[N]);St(e,H.prev,$.next),St(e,g,H),St(e,$,ee),v=ee,g=$,q-=1,p=[],k=[]}else _.delete(P),$n(P,v,t),St(e,P.prev,P.next),St(e,P,g===null?e.first:g.next),St(e,g,P),g=P;continue}for(p=[],k=[];v!==null&&v.k!==b;)v.e.f&vt||(_??(_=new Set)).add(v),k.push(v),v=v.next;if(v===null)continue;P=v}p.push(P),g=P,v=P.next}if(v!==null||_!==void 0){for(var O=_===void 0?[]:yn(_);v!==null;)v.e.f&vt||O.push(v),v=v.next;var Pe=O.length;if(Pe>0){var Be=r&es&&d===0?t:null;if(o){for(q=0;q<Pe;q+=1)(ie=O[q].a)==null||ie.measure();for(q=0;q<Pe;q+=1)(he=O[q].a)==null||he.fix()}ga(e,O,Be,u)}}o&&Ot(()=>{var we;if(S!==void 0)for(P of S)(we=P.a)==null||we.apply()}),fe.first=e.first&&e.first.e,fe.last=g&&g.e}function ya(n,e,t,i){i&Cn&&Et(n.v,e),i&kn?Et(n.i,t):n.i=t}function Sa(n,e,t,i,r,s,l,o,c,d){var u=(c&Cn)!==0,f=(c&Ao)===0,v=u?f?ni(r):Le(r):r,_=c&kn?Le(l):l,g={i:_,v,k:s,a:null,e:null,prev:t,next:i};try{return g.e=Bt(()=>o(n,v,_,d),ns),g.e.prev=t&&t.e,g.e.next=i&&i.e,t===null?e.first=g:(t.next=g,t.e.next=g.e),i!==null&&(i.prev=g,i.e.prev=g.e),g}finally{}}function $n(n,e,t){for(var i=n.next?n.next.e.nodes_start:t,r=e?e.e.nodes_start:t,s=n.e.nodes_start;s!==i;){var l=$i(s);r.before(s),s=l}}function St(n,e,t){e===null?n.first=t:(e.next=t,e.e.next=t&&t.e),t!==null&&(t.prev=e,t.e.prev=e&&e.e)}function Ds(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=Ds(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function wa(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=Ds(n))&&(i&&(i+=" "),i+=e);return i}function Lt(n){return typeof n=="object"?wa(n):n??""}function ai(n,e,t,i){var r=n.__attributes??(n.__attributes={});r[e]!==(r[e]=t)&&(e==="style"&&"__styles"in n&&(n.__styles={}),e==="loading"&&(n[_o]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Ca(n).includes(e)?n[e]=t:n.setAttribute(e,t))}var Un=new Map;function Ca(n){var e=Un.get(n.nodeName);if(e)return e;Un.set(n.nodeName,e=[]);for(var t,i=n,r=Element.prototype;r!==i;){t=Gr(i);for(var s in t)t[s].set&&e.push(s);i=Sn(i)}return e}function _e(n,e,t){var i=n.__className,r=ka(e,t);(i!==r||ns)&&(e==null&&!t?n.removeAttribute("class"):n.className=r,n.__className=r)}function ka(n,e){return(n??"")+(e?" "+e:"")}const ba=()=>performance.now(),ht={tick:n=>requestAnimationFrame(n),now:()=>ba(),tasks:new Set};function Ts(){const n=ht.now();ht.tasks.forEach(e=>{e.c(n)||(ht.tasks.delete(e),e.f())}),ht.tasks.size!==0&&ht.tick(Ts)}function Ea(n){let e;return ht.tasks.size===0&&ht.tick(Ts),{promise:new Promise(t=>{ht.tasks.add(e={c:n,f:t})}),abort(){ht.tasks.delete(e)}}}function vi(n,e){Pn(()=>{n.dispatchEvent(new CustomEvent(e))})}function Da(n){if(n==="float")return"cssFloat";if(n==="offset")return"cssOffset";if(n.startsWith("--"))return n;const e=n.split("-");return e.length===1?e[0]:e[0]+e.slice(1).map(t=>t[0].toUpperCase()+t.slice(1)).join("")}function Hn(n){const e={},t=n.split(";");for(const i of t){const[r,s]=i.split(":");if(!r||s===void 0)break;const l=Da(r.trim());e[l]=s.trim()}return e}const Ta=n=>n;function Rt(n,e,t,i){var r=(n&Oo)!==0,s=(n&No)!==0,l=r&&s,o=(n&Lo)!==0,c=l?"both":r?"in":"out",d,u=e.inert,f=e.style.overflow,v,_;function g(){var b=ve,P=fe;Qe(null),Ye(null);try{return d??(d=t()(e,(i==null?void 0:i())??{},{direction:c}))}finally{Qe(b),Ye(P)}}var S={is_global:o,in(){var b;if(e.inert=u,!r){_==null||_.abort(),(b=_==null?void 0:_.reset)==null||b.call(_);return}s||v==null||v.abort(),vi(e,"introstart"),v=cn(e,g(),_,1,()=>{vi(e,"introend"),v==null||v.abort(),v=d=void 0,e.style.overflow=f})},out(b){if(!s){b==null||b(),d=void 0;return}e.inert=!0,vi(e,"outrostart"),_=cn(e,g(),v,0,()=>{vi(e,"outroend"),b==null||b()})},stop:()=>{v==null||v.abort(),_==null||_.abort()}},p=fe;if((p.transitions??(p.transitions=[])).push(S),r&&ln){var k=o;if(!k){for(var w=p.parent;w&&w.f&Ri;)for(;(w=w.parent)&&!(w.f&Ni););k=!w||(w.f&Kr)!==0}k&&Qt(()=>{at(()=>S.in())})}}function cn(n,e,t,i,r){var s=i===1;if(uo(e)){var l,o=!1;return Ot(()=>{if(!o){var p=e({direction:s?"in":"out"});l=cn(n,p,t,i,r)}}),{abort:()=>{o=!0,l==null||l.abort()},deactivate:()=>l.deactivate(),reset:()=>l.reset(),t:()=>l.t()}}if(t==null||t.deactivate(),!(e!=null&&e.duration))return r(),{abort:wt,deactivate:wt,reset:wt,t:()=>i};const{delay:c=0,css:d,tick:u,easing:f=Ta}=e;var v=[];if(s&&t===void 0&&(u&&u(0,1),d)){var _=Hn(d(0,1));v.push(_,_)}var g=()=>1-i,S=n.animate(v,{duration:c});return S.onfinish=()=>{var p=(t==null?void 0:t.t())??1-i;t==null||t.abort();var k=i-p,w=e.duration*Math.abs(k),b=[];if(w>0){var P=!1;if(d)for(var q=Math.ceil(w/16.666666666666668),Z=0;Z<=q;Z+=1){var ee=p+k*f(Z/q),N=Hn(d(ee,1-ee));b.push(N),P||(P=N.overflow==="hidden")}P&&(n.style.overflow="hidden"),g=()=>{var H=S.currentTime;return p+k*f(H/w)},u&&Ea(()=>{if(S.playState!=="running")return!1;var H=g();return u(H,1-H),!0})}S=n.animate(b,{duration:w,fill:"forwards"}),S.onfinish=()=>{g=()=>i,u==null||u(i,1-i),r()}},{abort:()=>{S&&(S.cancel(),S.effect=null,S.onfinish=wt)},deactivate:()=>{r=wt},reset:()=>{i===0&&(u==null||u(1,0))},t:()=>g()}}function Nd(n,e,t=e){var i=Kt();Zi(n,"input",r=>{var s=r?n.defaultValue:n.value;if(s=Xi(n)?Qi(s):s,t(s),i&&s!==(s=e())){var l=n.selectionStart,o=n.selectionEnd;n.value=s??"",o!==null&&(n.selectionStart=l,n.selectionEnd=Math.min(o,n.value.length))}}),at(e)==null&&n.value&&t(Xi(n)?Qi(n.value):n.value),ui(()=>{var r=e();Xi(n)&&r===Qi(n.value)||n.type==="date"&&!r&&!n.value||r!==n.value&&(n.value=r??"")})}const Ki=new Set;function Ld(n,e,t,i,r=i){var s=t.getAttribute("type")==="checkbox",l=n;if(e!==null)for(var o of e)l=l[o]??(l[o]=[]);l.push(t),Zi(t,"change",()=>{var c=t.__value;s&&(c=Pa(l,c,t.checked)),r(c)},()=>r(s?[]:null)),ui(()=>{var c=i();s?(c=c||[],t.checked=c.includes(t.__value)):t.checked=rs(t.__value,c)}),us(()=>{var c=l.indexOf(t);c!==-1&&l.splice(c,1)}),Ki.has(l)||(Ki.add(l),Ot(()=>{l.sort((c,d)=>c.compareDocumentPosition(d)===4?-1:1),Ki.delete(l)})),Ot(()=>{})}function Rd(n,e,t=e){Zi(n,"change",i=>{var r=i?n.defaultChecked:n.checked;t(r)}),at(e)==null&&t(n.checked),ui(()=>{var i=e();n.checked=!!i})}function Pa(n,e,t){for(var i=new Set,r=0;r<n.length;r+=1)n[r].checked&&i.add(n[r].__value);return t||i.delete(e),Array.from(i)}function Xi(n){var e=n.type;return e==="number"||e==="range"}function Qi(n){return n===""?null:+n}function Ps(n,e,t){if(n.multiple)return Fa(n,e);for(var i of n.options){var r=ti(i);if(rs(r,e)){i.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Aa(n,e){Qt(()=>{var t=new MutationObserver(()=>{var i=n.__value;Ps(n,i)});return t.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{t.disconnect()}})}function Id(n,e,t=e){var i=!0;Zi(n,"change",r=>{var s=r?"[selected]":":checked",l;if(n.multiple)l=[].map.call(n.querySelectorAll(s),ti);else{var o=n.querySelector(s)??n.querySelector("option:not([disabled])");l=o&&ti(o)}t(l)}),Qt(()=>{var r=e();if(Ps(n,r,i),i&&r===void 0){var s=n.querySelector(":checked");s!==null&&(r=ti(s),t(r))}n.__value=r,i=!1}),Aa(n)}function Fa(n,e){for(var t of n.options)t.selected=~e.indexOf(ti(t))}function ti(n){return"__value"in n?n.__value:n.value}function jn(n,e){return n===e||(n==null?void 0:n[pt])===e}function Ma(n={},e,t,i){return Qt(()=>{var r,s;return ui(()=>{r=s,s=[],at(()=>{n!==t(...s)&&(e(n,...s),r&&jn(t(...r),n)&&e(null,...r))})}),()=>{Ot(()=>{s&&jn(t(...s),n)&&e(null,...s)})}}),n}function ct(n=!1){const e=Fe,t=e.l.u;if(!t)return;let i=()=>la(e.s);if(n){let r=0,s={};const l=ri(()=>{let o=!1;const c=e.s;for(const d in c)c[d]!==s[d]&&(s[d]=c[d],o=!0);return o&&r++,r});i=()=>h(l)}t.b.length&&zo(()=>{Zn(e,i),rn(t.b)}),Nn(()=>{const r=at(()=>t.m.map(ho));return()=>{for(const s of r)typeof s=="function"&&s()}}),t.a.length&&Nn(()=>{Zn(e,i),rn(t.a)})}function Zn(n,e){if(n.l.s)for(const t of n.l.s)h(t);e()}const It=[];function qa(n,e=wt){let t=null;const i=new Set;function r(o){if(Jr(n,o)&&(n=o,t)){const c=!It.length;for(const d of i)d[1](),It.push(d,n);if(c){for(let d=0;d<It.length;d+=2)It[d][0](It[d+1]);It.length=0}}}function s(o){r(o(n))}function l(o,c=wt){const d=[o,c];return i.add(d),i.size===1&&(t=e(r,s)||wt),o(n),()=>{i.delete(d),i.size===0&&t&&(t(),t=null)}}return{set:r,update:s,subscribe:l}}let pi=!1;function xa(n){var e=pi;try{return pi=!1,[n(),pi]}finally{pi=e}}function me(n,e,t,i){var ee;var r=(t&Fo)!==0,s=!di||(t&Mo)!==0,l=(t&xo)!==0,o=(t&Bo)!==0,c=!1,d;l?[d,c]=xa(()=>n[e]):d=n[e];var u=pt in n||po in n,f=l&&(((ee=Ht(n,e))==null?void 0:ee.set)??(u&&e in n&&(N=>n[e]=N)))||void 0,v=i,_=!0,g=!1,S=()=>(g=!0,_&&(_=!1,o?v=at(i):v=i),v);d===void 0&&i!==void 0&&(f&&s&&wo(),d=S(),f&&f(d));var p;if(s)p=()=>{var N=n[e];return N===void 0?S():(_=!0,g=!1,N)};else{var k=(r?ri:ue)(()=>n[e]);k.f|=Xr,p=()=>{var N=h(k);return N!==void 0&&(v=void 0),N===void 0?v:N}}if(!(t&qo))return p;if(f){var w=n.$$legacy;return function(N,H){return arguments.length>0?((!s||!H||w||c)&&f(H?p():N),N):p()}}var b=!1,P=!1,q=ni(d),Z=ri(()=>{var N=p(),H=h(q);return b?(b=!1,P=!0,H):(P=!1,q.v=N)});return r||(Z.equals=wn),function(N,H){if(kt!==null&&(b=P,p(),h(q)),arguments.length>0){const $=H?h(Z):s&&l?Ct(N):N;return Z.equals($)||(b=!0,M(q,$),g&&v!==void 0&&(v=$),at(()=>h(Z))),N}return h(Z)}}const Ba="5";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Ba);To();class $d{constructor(e,t,i){a(this,"_dbname");a(this,"_dbversion");a(this,"dbPromise");a(this,"getTran",async(e,t)=>(await this.dbPromise).transaction(e,t));a(this,"reset",async()=>(await indexedDB.databases().then(e=>{console.log(e)}),await new Promise((e,t)=>{const i=indexedDB.deleteDatabase(this._dbname);i.onsuccess=()=>{console.log("onsuccess"),e()},i.onerror=r=>{console.log("onerror"),t(r)}})));a(this,"getAll",async e=>{const t=await this.dbPromise;return new Promise((i,r)=>{const o=t.transaction([e],"readonly").objectStore(e).getAll();o.onsuccess=()=>{i(o.result)},o.onerror=c=>{r(c)}})});a(this,"get",async(e,t)=>{const i=await this.dbPromise;return new Promise((r,s)=>{const c=i.transaction([e],"readonly").objectStore(e).get(t);c.onsuccess=()=>{r(c.result)},c.onerror=d=>{s(d)}})});a(this,"getMany",async(e,t)=>{const s=(await this.dbPromise).transaction([e],"readonly").objectStore(e),l=t.map(o=>new Promise((c,d)=>{const u=s.get(o);u.onsuccess=()=>{c(u.result)},u.onerror=f=>{d(f)}}));return await Promise.all(l)});a(this,"putRecords",async(e,t)=>{const r=(await this.dbPromise).transaction([e],"readwrite"),s=r.objectStore(e),l=t.map(o=>({record:o,request:s.put(o)}));return new Promise((o,c)=>{r.oncomplete=()=>o(l.map(d=>Object.assign({id:d.request.result},d.record))),r.onerror=d=>c(d)})});a(this,"deleteRecords",async(e,t)=>{const r=(await this.dbPromise).transaction([e],"readwrite"),s=r.objectStore(e),l=t.map(o=>({key:o,request:s.delete(o)}));return new Promise((o,c)=>{r.oncomplete=()=>{console.log(l.map(d=>d.request.result)),o()},r.onerror=d=>c(d)})});this._dbname=e,this._dbversion=t,this.dbPromise=new Promise((r,s)=>{const l=indexedDB.open(e,t);l.onsuccess=o=>{if(console.log(o),!o.target){console.log("event.target is undefined"),s("event.target is undefined");return}const c=o.target.result;if(!c){console.log("event.target.result is undefined"),s("event.target.result is undefined");return}c.onversionchange=d=>{console.log(d),c.close()},r(c)},l.onupgradeneeded=o=>{console.log("onupgradeneeded");const c=o.target.result;i.filter(d=>!c.objectStoreNames.contains(d)).map(d=>c.createObjectStore(d,{keyPath:"id",autoIncrement:!0}))},l.onerror=o=>{console.log(o),s(o)},l.onblocked=o=>{console.log(o),s(o)}}),console.log(this.dbPromise)}get dbversion(){return this._dbversion}}class Te{constructor(){a(this,"handlers",[])}append(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter(t=>t!==e)}trigger(e){this.handlers.slice(0).filter(t=>t(e)==="RemoveMe").forEach(t=>this.remove(t))}clear(){this.handlers.splice(0)}expose(){return this}}class Vn{constructor(){a(this,"handlers",[])}append(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter(t=>t!==e)}async trigger(e){(await Promise.all(this.handlers.slice(0).map(async i=>{const r=await i(e);return{h:i,result:r}}))).filter(i=>i.result==="RemoveMe").map(i=>i.h).forEach(i=>this.remove(i))}clear(){this.handlers.splice(0)}expose(){return this}}class zn{constructor(){a(this,"handler")}set(e){this.handler=e}async call(e){if(!this.handler)throw Error("illegal state error");return await this.handler(e)}expose(){return this}}class An{constructor(e,t,i,r){a(this,"_name");a(this,"_createVersion");a(this,"mountResolver",()=>{});a(this,"_indexedDb");a(this,"onInsertEvent",new Te);a(this,"onBeforeInsertEvent",new zn);a(this,"onUpdateEvent",new Te);a(this,"onBeforeUpdateEvent",new zn);a(this,"onDeleteEvent",new Te);a(this,"prepareInitialRecords",()=>{const e=new Date;return this._prepareInitialRecords().map(t=>Object.assign(t,{createdAt:e,updatedAt:e,dbVersion:this._createVersion}))});a(this,"resolveMount",()=>this.mountResolver());a(this,"patchForInsert",(e,t)=>{e.newRecords.forEach(i=>{t[i.id]=i})});a(this,"patchForUpdate",(e,t)=>{e.recordPairs.forEach(i=>{t[i.newRecord.id]={...i.newRecord}})});a(this,"patchForDelete",(e,t)=>{e.oldRecords.forEach(i=>{delete t[i.id]})});this._indexedDb=e,this._name=t,this._createVersion=e.dbversion,this.getAll().then(s=>s.reduce((l,o)=>(l[o.id]=o,l),{})).then(s=>{console.log(this.name,s),this.onBeforeInsertEvent.set(i??(()=>Promise.resolve())),this.onBeforeUpdateEvent.set(r??(()=>Promise.resolve()))})}get name(){return this._name}get createVersion(){return this._createVersion}get oninsert(){return this.onInsertEvent.expose()}get onbeforeinsert(){return this.onBeforeInsertEvent.expose()}get onupdate(){return this.onUpdateEvent.expose()}get onbeforeupdate(){return this.onBeforeUpdateEvent.expose()}get ondelete(){return this.onDeleteEvent.expose()}getAll(){return this._indexedDb.getAll(this.name)}get(e){return this._indexedDb.get(this.name,e)}async insertMany(e){const t=new Date,i=e.map(s=>{const l={createdAt:t,updatedAt:t,dbVersion:this._createVersion};return Object.assign(s,l)});await this.onBeforeInsertEvent.call({sender:this,newRecords:i,timestamp:t});const r=await this._indexedDb.putRecords(this.name,i);return this.onInsertEvent.trigger({sender:this,newRecords:r,timestamp:t}),r}async insert(e){return(await this.insertMany([e]))[0]}async updateMany(e,t){const i=new Date,r=[];return(await this._indexedDb.getMany(this.name,e)).forEach(l=>{const o={...l},c={...o};r.push({newRecord:Object.assign(t(c),{updatedAt:i,dbVersion:this._createVersion}),oldRecord:o})}),await this.onBeforeUpdateEvent.call({sender:this,recordPairs:r,timestamp:i}),await this._indexedDb.putRecords(this.name,r.map(l=>l.newRecord)),this.onUpdateEvent.trigger({sender:this,recordPairs:r,timestamp:i}),r.map(l=>l.newRecord)}async update(e,t){return(await this.updateMany([e],t))[0]}async delete(e){const t=new Date,i=await this._indexedDb.getMany(this.name,e);await this._indexedDb.deleteRecords(this.name,e),this.onDeleteEvent.trigger({sender:this,oldRecords:i,timestamp:t})}}const Ud=["Deck","ExtraDeck"],Hd={Deck:"メインデッキ",ExtraDeck:"エクストラデッキ"},Oa=["Monster","Spell","Trap","XyzMaterial"],jd={Monster:"モンスター",Spell:"魔法",Trap:"罠",XyzMaterial:"XYZ素材"},Ti=["Fusion","Syncro","Xyz","Link"],As=[...Ti,"SpecialSummon","Ritual"],Fs=[...As,"NormalSummonOnly","RegularSpecialSummonOnly","FreeReborn"],Na=["Toon","Spirit","Union","Gemini","FlipEffect"],La=["Tuner","Effect","Normal","Pendulum","Token"],Zd=[...Na,...La,...Fs],Ms={Syncro:"シンクロ",Fusion:"融合",Xyz:"エクシーズ",Link:"リンク",Ritual:"儀式",SpecialSummon:"特殊召喚",Toon:"トゥーン",Spirit:"スピリット",Union:"ユニオン",Gemini:"デュアル",FlipEffect:"リバース",Tuner:"チューナー",Effect:"効果",Normal:"通常",Pendulum:"ペンデュラム",Token:"トークン",FreeReborn:"特殊召喚モンスター（蘇生制限なし）",NormalSummonOnly:"特殊召喚不可",RegularSpecialSummonOnly:"正規の方法以外での特殊召喚不可"},qs={Syncro:"🎵",Fusion:"🌀",Xyz:"📰",Link:"⛓️",Ritual:"📜",SpecialSummon:"🔯",Toon:"📖",Spirit:"👻",Union:"🚗",Gemini:"👫",FlipEffect:"🔄",Tuner:"🎶",Effect:"✨",Normal:"🔘",Pendulum:"💠",Token:"🐏",FreeReborn:"🆓",NormalSummonOnly:"🔲",RegularSpecialSummonOnly:"❗"},Vd=["Light","Dark","Earth","Water","Fire","Wind","Divine"],Ra={Light:"光",Dark:"闇",Earth:"地",Water:"水",Fire:"炎",Wind:"風",Divine:"神"},zd=["Aqua","Beast","BeastWarrior","CreatorGod","Cyberse","Dinosaur","DivineBeast","Dragon","Fairy","Fiend","Fish","Insect","Illusion","Machine","Plant","Psychic","Pyro","Reptile","Rock","SeaSerpent","Spellcaster","Thunder","Warrior","WingedBeast","Wyrm","Zombie"],Gd=["Normal","Continuous","Field","QuickPlay","Equip","Ritual","PendulumScale"],xs={Normal:"通常",Continuous:"永続",Field:"フィールド",QuickPlay:"速攻",Equip:"装備",Ritual:"儀式",PendulumScale:"ペンデュラム"},Wd=["Normal","Continuous","Counter"],Bs={Normal:"通常",Continuous:"永続",Counter:"カウンター"},Kd=["Attack","Defense"],_i={Attack:"攻撃表示",Defense:"守備表示",Set:"裏側守備表示"},Os=["level","rank","attack","defense","pendulumScaleR","pendulumScaleL"],Ns={Aqua:"水",Beast:"獣",BeastWarrior:"獣戦士",CreatorGod:"創造神",Cyberse:"サイバース",Dinosaur:"恐竜",DivineBeast:"幻獣神",Dragon:"ドラゴン",Fairy:"天使",Fiend:"悪魔",Fish:"魚",Insect:"昆虫",Illusion:"幻想魔",Machine:"機械",Plant:"植物",Psychic:"サイキック",Pyro:"炎",Reptile:"爬虫類",Rock:"岩石",SeaSerpent:"海竜",Spellcaster:"魔法使い",Thunder:"雷",Warrior:"戦士",WingedBeast:"鳥獣",Wyrm:"幻竜",Zombie:"アンデット"},Ls={Aqua:"🚰",Beast:"🐅",BeastWarrior:"🦁",CreatorGod:"🔆",Cyberse:"💻️",Dinosaur:"🦖",DivineBeast:"💫",Dragon:"🐲",Fairy:"👼",Fiend:"👿",Fish:"🐟️",Insect:"🦋",Illusion:"🤡",Machine:"🤖",Plant:"🌱",Psychic:"👁️",Pyro:"🔥",Reptile:"🦎",Rock:"⛰",SeaSerpent:"🐍",Spellcaster:"🧙",Thunder:"⚡️",Warrior:"⚔️",WingedBeast:"🦅",Wyrm:"🐉",Zombie:"🦴"},Ia=["TopLeft","TopCenter","TopRight","MiddleLeft","MiddleRight","BottomLeft","BottomCenter","BottomRight"],Rs={TopLeft:{name:"左上",linkArrow:{offsetRow:-1,offsetColumn:-1}},TopCenter:{name:"上",linkArrow:{offsetRow:-1,offsetColumn:0}},TopRight:{name:"右上",linkArrow:{offsetRow:-1,offsetColumn:1}},MiddleLeft:{name:"左",linkArrow:{offsetRow:0,offsetColumn:-1}},MiddleRight:{name:"右",linkArrow:{offsetRow:0,offsetColumn:1}},BottomLeft:{name:"左下",linkArrow:{offsetRow:1,offsetColumn:-1}},BottomCenter:{name:"下",linkArrow:{offsetRow:1,offsetColumn:0}},BottomRight:{name:"右下",linkArrow:{offsetRow:1,offsetColumn:1}}};Ia.reduce((n,e)=>(n[Rs[e].name]=e,n),{});const Xd=n=>n.cardId??!1?`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${n.cardId}`:`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=10&mode=&sort=1&keyword=${n.name}&stype=1&ctype=&othercon=2&starfr=&starto=&pscalefr=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`,Is=(n,e)=>{const t=n.monsterCategories??[],i=e.monsterCategories??[];for(const r of Ti.toReversed()){if(t.includes(r)&&!i.includes(r))return 1;if(!t.includes(r)&&i.includes(r))return-1}if(n.kind===e.kind){if(n.kind==="Monster"){if((n.link??0)!==(e.link??0))return(n.link??0)-(e.link??0);if((n.rank??0)!==(e.rank??0))return(n.rank??0)-(e.rank??0);if((n.level??0)!==(e.level??0))return(n.level??0)-(e.level??0);if((n.attack??0)!==(e.attack??0))return(n.attack??0)-(e.attack??0);if((n.defense??0)!==(e.defense??0))return(n.defense??0)-(e.defense??0)}return n.name.localeCompare(e.name,"Ja")}for(const r of Oa){if(n.kind===r)return-1;if(e.kind===r)return 1}return n.name.localeCompare(e.name,"Ja")},$s=["Deck","ExtraDeck"],Us=["Graveyard","Banished"],Hs=[...$s,...Us],$a=[...Hs,"Hand"],js=["MonsterZone","ExtraMonsterZone"],Zs=["SpellAndTrapZone","FieldSpellZone"],Dt=[...js,...Zs],Vs=["XyzMaterialZone","Disable"],Yi=[...$a,...Dt,...Vs],dn={0:{0:"Hand"},1:{0:"Deck",1:"SpellAndTrapZone",2:"SpellAndTrapZone",3:"SpellAndTrapZone",4:"SpellAndTrapZone",5:"SpellAndTrapZone",6:"ExtraDeck"},2:{0:"Graveyard",1:"MonsterZone",2:"MonsterZone",3:"MonsterZone",4:"MonsterZone",5:"MonsterZone",6:"FieldSpellZone"},3:{0:"Banished",1:"XyzMaterialZone",2:"ExtraMonsterZone",3:"Disable",4:"ExtraMonsterZone",5:"XyzMaterialZone",6:"Banished"},4:{0:"FieldSpellZone",1:"MonsterZone",2:"MonsterZone",3:"MonsterZone",4:"MonsterZone",5:"MonsterZone",6:"Graveyard"},5:{0:"ExtraDeck",1:"SpellAndTrapZone",2:"SpellAndTrapZone",3:"SpellAndTrapZone",4:"SpellAndTrapZone",5:"SpellAndTrapZone",6:"Deck"},6:{0:"Hand"}};let Ua=class{constructor(e,t,i,r){a(this,"onUpdateEvent",new Te);a(this,"field");a(this,"row");a(this,"column");a(this,"cellType");a(this,"_owner");a(this,"_requiresRecalcLinkArrows");a(this,"_linkArrowSources");a(this,"_needsShuffle",!1);a(this,"recalcLinkArrows",()=>{this.isMonsterZoneLikeCell&&(this._requiresRecalcLinkArrows=!1,this._linkArrowSources=this.neighbors.filter(e=>e.isMonsterZoneLikeCell).filter(e=>e.cardEntities.length).filter(e=>e.cardEntities[0].linkArrows.some(t=>this.row===e.row+t.offsetRow&&this.column===e.column+t.offsetColumn)).map(e=>e.cardEntities[0]))});a(this,"_entities");a(this,"releaseEntities",e=>{var t;return this._entities=this._entities.filter(i=>i!==e),this.isMonsterZoneLikeCell&&((t=e.origin.monsterCategories)!=null&&t.includes("Link"))&&(this._requiresRecalcLinkArrows=!0),this.onUpdateEvent.trigger(),e});a(this,"acceptEntities",(e,t)=>{var i;t==="Top"?this._entities.unshift(e):this._entities.push(e),t==="Random"&&(this._needsShuffle=!0),this._entities.forEach(r=>{r.fieldCell=this}),this.isMonsterZoneLikeCell&&((i=e.origin.monsterCategories)!=null&&i.includes("Link"))&&(this._requiresRecalcLinkArrows=!0),this.onUpdateEvent.trigger()});a(this,"shuffle",()=>{this._entities=this.entities.shuffle(),this._needsShuffle=!1,this.field.duel.log.info("デッキをシャッフル。",this.owner)});a(this,"toString",()=>this.isMonsterZoneLikeCell||this.cellType==="SpellAndTrapZone"?`${this.cellType}(${this.row},${this.column})`:this.cellType);this.field=e,this.row=t,this.column=i,this.cellType=dn[t][i],this._owner=r,this._entities=[],this._linkArrowSources=[],this._requiresRecalcLinkArrows=!1}get onUpdate(){return this.onUpdateEvent.expose()}get owner(){var e;return this._owner||((e=this.cardEntities[0])==null?void 0:e.owner)}get requiresRecalcLinkArrows(){return this._requiresRecalcLinkArrows}get linkArrowSources(){return this._linkArrowSources}get needsShuffle(){return this._needsShuffle}get entities(){return this._entities}get visibleEntities(){return this._entities.filter(e=>Qn.find(t=>t===e.entityType))}get cardEntities(){return this._entities.filter(e=>Qn.find(t=>t===e.entityType)).filter(e=>e.kind!=="XyzMaterial")}get xyzMaterials(){return this._entities.filter(e=>e.kind==="XyzMaterial")}get targetForAttack(){return this.cellType==="Hand"?this._entities.find(e=>e.entityType==="Duelist"):this.cardEntities[0]}get isAvailable(){return this.cardEntities.length===0&&this._entities.filter(e=>gl.find(t=>t===e.entityType)).length===0}get isAvailableForPendulum(){return this.isAvailable&&this.isSpellTrapZoneLikeCell&&(this.column===1||this.column===5)}get isStackCell(){return Hs.some(e=>e===this.cellType)}get isPlayFieldCell(){return Dt.some(e=>e===this.cellType)}get isMonsterZoneLikeCell(){return js.some(e=>e===this.cellType)}get isSpellTrapZoneLikeCell(){return Zs.some(e=>e===this.cellType)}get isDisabledCell(){return Vs.some(e=>e===this.cellType)}get isTrashCell(){return Us.some(e=>e===this.cellType)}get neighbors(){const e=[this.row-1,this.row,this.row+1].filter(i=>i>=0&&i<=6),t=[this.column-1,this.column,this.column+1].filter(i=>i>=0&&i<=6);return e.flatMap(i=>t.map(r=>this.field.cells[i][r])).filter(i=>i.isMonsterZoneLikeCell).filter(i=>i!==this)}};Array.prototype.shuffle=function(){return this.map(e=>({item:e,seq:Math.random()})).toSorted((e,t)=>e.seq-t.seq).map(e=>e.item)};Array.prototype.randomPickMany=function(n){return this.shuffle().slice(0,n)};Array.prototype.randomPick=function(){return this.shuffle().slice(0,1)[0]};Array.prototype.reset=function(...n){this.splice(0),this.push(...n)};Array.prototype.union=function(n){return this.filter(e=>n.find(t=>e===t))};Array.prototype.getAllOnOffPattern=function(){const n=[];return this.forEach(e=>{if(n.length==0){n.push([e]),n.push([]);return}n.forEach(t=>n.push([...t,e]))}),n};Array.prototype.getDistinct=function(){return Array.from(new Set(this))};Array.prototype.distinct=function(){this.reset(...this.getDistinct())};class Vi{constructor(){a(this,"pooledOperators",[]);a(this,"bundles",[]);a(this,"excludesExpired",()=>{this.bundles=this.bundles.filter(e=>!e.entity.hasDisappeared),this.bundles.forEach(e=>e.excludesExpired()),this.pooledOperators=this.pooledOperators.filter(e=>e.validateAlive())});a(this,"append",e=>{this.bundles.push(e)});a(this,"push",e=>{if(!e.isContinuous)throw new le("staticへの追加は永続以外不可",e);this.excludesExpired(),this.distribute(e),this.pooledOperators.push(e)});a(this,"distributeAll",e=>(this.excludesExpired(),this.pooledOperators.flatMap(this.distribute).getDistinct().forEach(t=>t.operators.sort((i,r)=>i.seq-r.seq)),this.afterDistributeAll(e)));a(this,"distribute",e=>this.bundles.filter(t=>t.operators.every(i=>i.seq!==e.seq)).filter(t=>e.isApplicableTo(t.entity)).filter(t=>t.entity.canBeEffected(e.effectOwner,e.isSpawnedBy,e.actionAttr)).map(t=>(t.push(e),t)));a(this,"removeItem",e=>{this.pooledOperators=this.pooledOperators.filter(t=>t.seq!==e)})}}class zi{constructor(e,t){a(this,"pool");a(this,"entity");a(this,"_operators");a(this,"excludesExpired",()=>{this._operators=this._operators.filter(e=>{const t=e.validateAlive()&&e.isApplicableTo(this.entity);return t||(console.info(`before remove ${this.entity.toString} ${e.title}`),e.beforeRemove(this)),t})});a(this,"push",e=>{this.entity.procFilterBundle.effectiveOperators.filter(t=>t.procTypes.includes("Effect")).some(t=>!t.filter(t.effectOwner,t.isSpawnedBy,t.actionAttr,[]))||(this.beforePush(e),this._operators.push(e))});a(this,"removeItem",e=>{this._operators=this._operators.filter(t=>t.seq!==e?!0:(t.beforeRemove(this),!1))});this.pool=e,this.entity=t,this._operators=[],this.pool.append(this)}get operators(){return this._operators}get effectiveOperators(){return this.operators.filter(e=>e.isSpawnedBy.isEffective||!e.isContinuous)}}const Mi=class Mi{constructor(e,t,i,r,s,l){a(this,"seq");a(this,"title");a(this,"validateAlive");a(this,"isContinuous");a(this,"isSpawnedBy");a(this,"isSpawnedAt");a(this,"activateType");a(this,"actionAttr");a(this,"isApplicableTo");a(this,"effectOwner");this.seq=Mi.nextSeq++,this.title=e,this.validateAlive=()=>t(this),this.isContinuous=i,this.isSpawnedBy=r,this.isSpawnedAt=r.duel.clock.getClone(),this.isApplicableTo=o=>l(this,o),this.actionAttr=s,this.activateType=this.actionAttr.playType?xl(this.actionAttr.playType):"NonActivate",this.effectOwner=this.isSpawnedBy.controller}get isEffective(){return!this.isContinuous||this.activateType==="NonActivate"?!0:this.isSpawnedBy.isEffective}};a(Mi,"nextSeq",0);let Gt=Mi;class Ha extends Vi{constructor(){super(...arguments);a(this,"afterDistributeAll",()=>this.bundles.every(t=>t.applyEffectFilter()))}}class ja extends zi{constructor(){super(...arguments);a(this,"applyEffectFilter",()=>{const t=this.entity.allStickyEffectOperators.length,i=[];for(;;){const r=this.effectiveOperators.filter(s=>s.procTypes.includes("Effect")).filter(s=>s.isContinuous).find(s=>!i.includes(s.seq));if(!r)break;i.push(r.seq),r.eraseOperators(this.entity)}return this.entity.allStickyEffectOperators.length===t});a(this,"beforePush",t=>t.eraseOperators(this.entity))}}const Ut=class Ut extends Gt{constructor(t,i,r,s,l,o,c,d){super(t,i,r,s,l,o);a(this,"beforeRemove",()=>{});a(this,"procTypes");a(this,"filter");a(this,"eraseOperators",t=>{if(!this.procTypes.includes("Effect"))return 0;const i=t.allStickyEffectOperators.filter(r=>r.isContinuous).filter(r=>!this.filter(r.effectOwner,r.isSpawnedBy,r.actionAttr,[])).map(r=>r.seq);return i.forEach(t.procFilterBundle.removeItem),i.forEach(t.statusOperatorBundle.removeItem),i.forEach(t.numericOprsBundle.removeItem),i.length});this.procTypes=c,this.filter=d}};a(Ut,"createContinuous",(t,i,r,s,l,o,c)=>new Ut(t,i,!0,r,s,l,o,c)),a(Ut,"createLingering",(t,i,r,s,l,o,c)=>new Ut(t,i,!1,r,s,l,o,c));let Gn=Ut;const Wn={level:1,rank:1,attack:0,defense:0,pendulumScaleR:0,pendulumScaleL:0};class Za extends Vi{constructor(){super(...arguments);a(this,"afterDistributeAll",t=>{if(this.bundles.forEach(r=>r.calcStateAll()),t.field.getMonstersOnFieldStrictly().flatMap(r=>r.numericOprsBundle).flatMap(r=>r.effectiveOperators).some(r=>r.targetStateGen==="calculated")){const s=t.field.getMonstersOnFieldStrictly().filter(l=>(l.atk??0)>=0).map(l=>l.atk??0).reduce((l,o)=>l>o?l:o,0);t.field.getMonstersOnFieldStrictly().forEach(l=>{l.numericOprsBundle.effectiveOperators.filter(o=>o.targetStateGen==="calculated").forEach(o=>{var c;if(!((c=l.status.monsterCategories)!=null&&c.includes("Link")&&o.targetState==="defense")){if(o.stateOperationType==="THE_DEVILS_AVATAR"){l.numericStatus.calculated[o.targetState]=s+100;return}l.numericStatus.calculated[o.targetState]=o.calcValue(l,l.numericStatus.calculated[o.targetState]??0)}})})}return!0})}}class Va extends zi{constructor(){super(...arguments);a(this,"beforePush",t=>{const i=this.effectiveOperators.filter(s=>s.targetState===t.targetState).filter(s=>s.isEffective);if(t.kind==="O-L-F"||t.kind==="O-C-F"?(i.filter(s=>s.kind==="O-L-F").forEach(s=>s.negate()),i.filter(s=>s.kind==="L-F").forEach(s=>s.negate())):t.kind==="L-F"||t.kind==="C-F"?i.filter(s=>s.kind==="L-F"||s.kind==="L-A").forEach(s=>s.negate()):t.kind==="X-C-X"&&i.filter(s=>!s.isContinuous).forEach(s=>s.negate()),i.filter(s=>s.isEffective).some(s=>s.kind==="X-C-X")&&!t.isContinuous)return;if(t.stateOperationType!=="Addition"&&t.targetStateGen==="wip"&&i.filter(s=>!s.isContinuous).forEach(s=>s.negate()),t.stateOperationType==="THE_DEVILS_AVATAR"||t.stateOperationType==="Gradius'_Option"){this.entity.numericStatus.calculated[t.targetState]=-Number.MAX_VALUE;return}const r=this.entity.numericStatus.calculated[t.targetState]??0;if(t.stateOperationType==="THE_DEVILS_DREAD-ROOT"){this.entity.numericStatus.calculated[t.targetState]=t.calcValue(this.entity,r);return}if(t.kind==="L-F"){this.entity.numericStatus.wip[t.targetState]=t.calcValue(this.entity,r);return}});a(this,"calcStateAll",()=>Os.forEach(this.calcState));a(this,"calcState",t=>{if(this.entity.kind!=="Monster"&&!this.entity.isPendulumScale){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories){this.entity.numericStatus.calculated[t]=void 0;return}if(this.entity.status.monsterCategories.includes("Link")&&t!=="attack"){this.entity.numericStatus.calculated[t]=void 0;return}if(this.entity.status.monsterCategories.includes("Xyz")&&t==="level"){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories.includes("Xyz")&&t==="rank"){this.entity.numericStatus.calculated[t]=void 0;return}if(!this.entity.status.monsterCategories.includes("Pendulum")&&(t==="pendulumScaleL"||t==="pendulumScaleR")){this.entity.numericStatus.calculated[t]=void 0;return}if(t!=="level"&&!this.entity.isOnFieldStrictly){this.entity.numericStatus.origin[t]=this.entity.origin[t],this.entity.numericStatus.wip[t]=this.entity.origin[t],this.entity.numericStatus.calculated[t]=this.entity.origin[t];return}const i=this.entity.origin[t]??0,r=this.entity.numericStatus.wip[t]??0,s=this._operators.filter(u=>u.targetState===t).filter(u=>u.isEffective);if(s.some(u=>u.stateOperationType==="THE_DEVILS_AVATAR"||u.stateOperationType==="Gradius'_Option")&&this.entity.isEffective){this.entity.numericStatus.calculated[t]=-Number.MAX_VALUE;return}const l=s.filter(u=>u.targetState===t).findLast(u=>u.targetStateGen==="origin"),o=l?l.calcValue(this.entity,i??0):i;this.entity.numericStatus.origin[t]=o;let c=o;const d=s.filter(u=>u.targetState===t).filter(u=>u.targetStateGen==="wip").findLast(u=>u.stateOperationType==="Fixation");if(!d)c=s.filter(u=>u.stateOperationType==="Addition").reduce((u,f)=>f.calcValue(this.entity,u),c),this.entity.numericStatus.wip[t]=c;else if(d.isContinuous)c=d.calcValue(this.entity,c),c=s.filter(u=>u.stateOperationType==="Addition").reduce((u,f)=>f.calcValue(this.entity,u),c),this.entity.numericStatus.wip[t]=c;else{let u=!1;c=s.filter(f=>(u=u||f===d,u&&f!==d)).filter(f=>f.stateOperationType==="Addition").reduce((f,v)=>v.calcValue(this.entity,f),r)}c<Wn[t]&&(c=Wn[t]),this.entity.numericStatus.calculated[t]=c})}}const nt=class nt extends Gt{constructor(t,i,r,s,l,o,c,d,u,f){super(t,i,r,s,l,o);a(this,"beforeRemove",()=>{});a(this,"targetState");a(this,"targetStateGen");a(this,"stateOperationType");a(this,"calcValue");a(this,"_isEffective");a(this,"negate",()=>{this._isEffective=!1});this._isEffective=!0,this.targetState=c,this.targetStateGen=d,this.stateOperationType=u,this.calcValue=(v,_)=>f(this.isSpawnedBy,v,_)}get isEffective(){return this._isEffective&&super.isEffective}get kind(){if(this.targetStateGen==="origin"){if(this.stateOperationType==="Fixation")return this.isContinuous?"O-C-F":"O-L-F";throw new le("矛盾したプロパティ",this)}if(this.targetStateGen==="wip"){if(this.stateOperationType==="Addition")return this.isContinuous?"C-A":"L-A";if(this.stateOperationType==="Fixation")return this.isContinuous?"C-F":"L-F";throw new le("矛盾したプロパティ",this)}if(this.stateOperationType==="THE_DEVILS_DREAD-ROOT")return"X-C-F";if(this.stateOperationType==="THE_DEVILS_AVATAR"||this.stateOperationType==="Gradius'_Option")return"X-C-X";throw new le("矛盾したプロパティ",this)}};a(nt,"createContinuous",(t,i,r,s,l,o,c,d)=>new nt(t,i,!0,r,{},s,l,o,c,d)),a(nt,"createLingering",(t,i,r,s,l,o,c)=>new nt(t,i,!1,r,s,(d,u)=>u.isOnFieldAsMonsterStrictly,l,"wip",o,c)),a(nt,"createLingeringFixation",(t,i,r,s,l,o)=>nt.createLingering(t,i,r,s,l,"Fixation",o)),a(nt,"createLingeringAddition",(t,i,r,s,l,o)=>nt.createLingering(t,i,r,s,l,"Addition",o));let Kn=nt;const za=n=>Object.keys(n),Ga={draw:"ドローフェイズ",standby:"スタンバイフェイズ",main1:"メインフェイズ１",battle1:"バトルフェイズ",battle2:"バトルフェイズ（追加）",main2:"メインフェイズ２",end:"エンドフェイズ"},Wa={start:"スタートステップ",battle:"バトルステップ",damage:"ダメージステップ",end:"エンドステップ"},Ka={start:"ダメージステップ開始時",beforeDmgCalc:"ダメージ計算前",dmgCalc:"ダメージ計算時",afterDmgCalc:"ダメージ計算後",end:"ダメージステップ終了時"},Xa=["draw","stanby","main1","b1Start","b1Battle","b1End","b2Start","b2Battle","b2End","main2","end"],Qa=["b1DStart","b1DBeforeDmgCalc","b1DAfterDmgCalc","b1DEnd","b2DStart","b2DBeforeDmgCalc","b2DAfterDmgCalc","b2DEnd"],Ya=["b1DDmgCalc","b2DDmgCalc"],zs=[...Xa,...Qa,...Ya],Xn={draw:{phase:"draw",step:void 0,stage:void 0},stanby:{phase:"standby",step:void 0,stage:void 0},main1:{phase:"main1",step:void 0,stage:void 0},b1Start:{phase:"battle1",step:"start",stage:void 0},b1Battle:{phase:"battle1",step:"battle",stage:void 0},b1DStart:{phase:"battle1",step:"battle",stage:"start"},b1DBeforeDmgCalc:{phase:"battle1",step:"battle",stage:"beforeDmgCalc"},b1DDmgCalc:{phase:"battle1",step:"battle",stage:"dmgCalc"},b1DAfterDmgCalc:{phase:"battle1",step:"battle",stage:"afterDmgCalc"},b1DEnd:{phase:"battle1",step:"battle",stage:"end"},b1End:{phase:"battle1",step:"end",stage:void 0},b2Start:{phase:"battle2",step:"start",stage:void 0},b2Battle:{phase:"battle2",step:"battle",stage:void 0},b2DStart:{phase:"battle2",step:"battle",stage:"start"},b2DBeforeDmgCalc:{phase:"battle2",step:"battle",stage:"beforeDmgCalc"},b2DDmgCalc:{phase:"battle2",step:"battle",stage:"dmgCalc"},b2DAfterDmgCalc:{phase:"battle2",step:"battle",stage:"afterDmgCalc"},b2DEnd:{phase:"battle2",step:"battle",stage:"end"},b2End:{phase:"battle2",step:"end",stage:void 0},main2:{phase:"main2",step:void 0,stage:void 0},end:{phase:"end",step:void 0,stage:void 0}},Ja=n=>n.stage?Ka[n.stage]:n.step?Wa[n.step]:Ga[n.phase],Ft=za(Xn).reduce((n,e)=>(n[e].key=e,n[e].name=Ja(n[e]),n),Xn),qi=class qi{constructor(e,t){a(this,"entity");a(this,"isRegular");a(this,"_isStarted");a(this,"info");a(this,"continuousEffectBase");a(this,"updateState",async()=>{if(this.hasToStart!==this.isStarted){if(this.isStarted){if(!this.info)throw new le("illegal state");this._isStarted=!1,await this.continuousEffectBase.finish(this.entity,this.info),this.info=void 0;return}this.info=await this.continuousEffectBase.start(this.entity),this._isStarted=!0}});this._isStarted=!1,this.entity=e,this.continuousEffectBase=t,this.isRegular=this.appliableCellTypes.every(i=>Dt.find(r=>r===i))&&this.faceList.length===1&&this.faceList[0]==="FaceUp"}get isStarted(){return this._isStarted}get appliableCellTypes(){return this.continuousEffectBase.appliableCellTypes}get appliableDuelPeriodKeys(){return this.continuousEffectBase.appliableDuelPeriodKeys}get faceList(){return this.continuousEffectBase.faceList}get hasToStart(){return!this.appliableCellTypes.includes(this.entity.fieldCell.cellType)||!this.appliableDuelPeriodKeys.includes(this.entity.duel.clock.period.key)||!this.faceList.includes(this.entity.face)?!1:this.continuousEffectBase.canStart(this.entity)}};a(qi,"createNew",(e,t)=>new qi(e,t));let un=qi;const el=(n,e,t,i,r)=>({title:n,appliableCellTypes:e==="Monster"?["MonsterZone","ExtraMonsterZone"]:["FieldSpellZone","SpellAndTrapZone"],appliableDuelPeriodKeys:zs,faceList:["FaceUp"],canStart:s=>!s.info.isPending&&!s.info.isDying&&t(s),start:async s=>{const l=i(s);return l.forEach(r(s).push),l.map(o=>o.seq)},finish:async(s,l)=>{l.forEach(o=>r(s).removeItem(o))}}),Fn=(n,e,t,i,r,s)=>({title:n,appliableCellTypes:e==="Monster"?["MonsterZone","ExtraMonsterZone"]:["FieldSpellZone","SpellAndTrapZone"],appliableDuelPeriodKeys:zs,faceList:["FaceUp"],canStart:l=>!l.info.isPending&&!l.info.isDying&&i(l),start:async l=>{const o=r(l),c=t(l);return console.info(`start : ${l.toString()} ⇒ ${c.map(d=>d.toString()).join(" ")} (${o.map(d=>d.title).join(" ")})`),c.map(s).forEach(d=>o.forEach(d.push)),{targets:c,seqList:o.map(d=>d.seq)}},finish:async(l,o)=>{o.targets.map(s).forEach(c=>o.seqList.forEach(d=>c.removeItem(d)))}}),Yd=(n,e,t,i,r)=>Fn(n,e,t,i,r,s=>s.procFilterBundle),Jd=(n,e,t,i)=>el(n,e,t,i,r=>r.field.numericStateOperatorPool),eu=(n,e,t,i,r)=>Fn(n,e,t,i,r,s=>s.numericOprsBundle),tu=(n,e,t,i,r)=>Fn(n,e,t,i,r,s=>s.statusOperatorBundle),Pi=(...n)=>n.length?n.reduce((e,t)=>e>t?e:t):-Number.MAX_VALUE,fn=(...n)=>n.length?n.reduce((e,t)=>e<t?e:t):Number.MAX_VALUE,$t=(n,e)=>{if((n[0]??Number.MAX_VALUE)>e)return 0;if(n.slice(-1)[0]<e)return n.length;let t=0,i=n.length-1;for(;;){const r=Math.round((t+i)/2);if(r===i||r===t)return n[t]<e?i:t;if(n[r]<e){t=r;continue}i=r}},it=[3,5,5,6,6,6,7,8,9,10,11,11,11,12,12,13,13,14,15,15,15,15,15,15,16,16,16,17,18,18,18,21,21,21,22,23,25,25,26,28,28,28,30,30,31,32,32,33,33,34,35,35,36,36,36,37,37,38,38,38,39,41,42,42,43,45,45,45,45,48,48,48,50,51,52,54,54,54,54,56,57,58,59,59,59,59,60,61,63,65,65,65,65,66,67,67,67,69,69,71,71,72,73,73,73,73,73,74,75,75,76,76,77,78,79,80,80,80,80,84,84,84,84,84,84,85,85,85,87,90,91,94,96,96,97,98,101,101,101,101,101];console.log(it.length);it.forEach((n,e)=>{((it[$t(it,e)-1]||-Number.MAX_VALUE)>=e||(it[$t(it,e)]||Number.MAX_VALUE)<e)&&console.log(e,$t(it,e),(it[$t(it,e)-1]||-Number.MAX_VALUE)<e,(it[$t(it,e)]||Number.MAX_VALUE)>=e)});class tl{constructor(e){a(this,"_field");a(this,"_records",[]);a(this,"getIndexOfStartPoint",e=>$t(this._records.map(t=>t.movedAt.totalProcSeq),e));a(this,"push",e=>{this._records.push(e)});a(this,"getCurrentTurnLog",()=>this.getTermLog("Current","turn"));a(this,"getPriviousChainLog",()=>this.getTermLog("Previous","chainSeq"));this._field=e}*getTermLog(e,t){const i=e==="Current"?this._field.duel.clock.currentStartPoints[t]:this._field.duel.clock.previousStartPoints[t];for(let r=this.getIndexOfStartPoint(i);r<this._records.length;r++)yield this._records[r]}}class il{constructor(e){a(this,"entity");a(this,"_records");a(this,"_push",e=>{this.entity.field.moveLog.push(e),this._records.push(e)});a(this,"pushForRuleAction",e=>{this._push({entity:this.entity,kind:this.entity.origin.kind,cell:this.entity.fieldCell,face:this.entity.face,orientation:this.entity.orientation,isPending:this.entity.info.isPending,movedAt:this.entity.duel.clock.getClone(),movedAs:[...e,"Rule"]})});a(this,"push",(e,t,i,r,s)=>{let l=this.entity.fieldCell;this.entity.kind==="XyzMaterial"&&(l=this.entity.controller.getXyzMaterialZone()),this._push({entity:this.entity,kind:e,cell:l,face:this.entity.face,orientation:this.entity.orientation,isPending:this.entity.info.isPending,movedAt:this.entity.duel.clock.getClone(),movedAs:t.getDistinct(),movedBy:i,actionOwner:r,chooser:s??r})});a(this,"finalize",()=>{if(!this.latestRecord.isPending)throw new le("想定されない状況");if(this.entity.info.isPending)throw new le("想定されない状況");this._push({...this.latestRecord,isPending:!1,movedAt:this.entity.duel.clock.getClone()})});a(this,"negateSummon",(e,t)=>{const i=this.records.slice(-1)[0];i.cell=this.entity.field.getCells("Disable")[0],i.movedBy=e,i.movedAs=["SummonNegated"],i.actionOwner=t});this.entity=e,this._records=[]}get records(){return this._records}get latestRecord(){return this.records.slice(-1)[0]}get previousPlaceRecord(){return this.records.findLast(e=>e.cell.cellType!==this.entity.fieldCell.cellType)??this._records[0]}get currentProcRecords(){return this.records.filter(e=>e.movedAt.totalProcSeq===this.entity.duel.clock.totalProcSeq)}}const hn=["SpellCounter","KaijuCounter","NamelessCounter","IceCounter"],vn=["CycleFlip","SonicBarrier","SonicVerse"],nl=["GoldSarcophagus"],rl=[...hn,...vn,...nl],sl={SpellCounter:"🔮",KaijuCounter:"☢",NamelessCounter:"💠",IceCounter:"❄"};class ol{constructor(e){a(this,"dic");a(this,"temporaryCounterNames");a(this,"entity");a(this,"add",(e,t=1,i)=>{this.dic[e]=[...this.dic[e]??[],...Array(t).fill(i)];const r=this.entity.status.maxCounterQty[e]??0;return r&&(this.dic[e]=this.dic[e].slice(0,r)),this.dic[e]});a(this,"setQty",(e,t=1,i)=>(this.dic[e]=[...Array(t).fill(i)],this.dic[e]));a(this,"remove",(e,t=1,i)=>{const r=this.dic[e].length;if(r===void 0)return[];if(t>=r)return delete this.dic[e],[];if(i){const s=this.dic[e].filter(o=>o===i),l=this.dic[e].filter(o=>o!==i);this.dic[e]=[...s.slice(t),...l]}else this.dic[e]=this.dic[e].slice(t);return this.dic[e]});a(this,"removeAll",(e,t)=>{if(t){const r=this.dic[e].filter(s=>s===t).length;return this.dic[e]=this.dic[e].filter(s=>s!==t),r}const i=this.dic[e];return delete this.dic[e],i});a(this,"getQty",(e,t)=>this.dic[e]?t?this.dic[e].filter(i=>i===t).length:this.dic[e].length??0:0);a(this,"incrementActionCountPerTurn",e=>{this.temporaryCounterNames.push(e.title),this.incrementActionCount(e)});a(this,"incrementActionCount",e=>{this.dic[e.title]=[e.entity,...this.dic[e.title]??[]]});a(this,"getActionCount",e=>this.dic[e.title]?this.dic[e.title].filter(t=>t===e.entity).length:0);a(this,"corpseDisposal",()=>{this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),vn.forEach(e=>delete this.dic[e])});a(this,"removeAllActualCounters",()=>{hn.forEach(e=>delete this.dic[e])});a(this,"removeAllWhenfaceDown",()=>{this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),hn.forEach(e=>delete this.dic[e])});a(this,"clear",()=>{vn.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.forEach(e=>delete this.dic[e]),this.temporaryCounterNames.reset(),rl.forEach(e=>delete this.dic[e])});this.dic={},this.temporaryCounterNames=[],this.entity=e}}class al extends Vi{constructor(){super(...arguments);a(this,"afterDistributeAll",t=>t.field.getAllEntities().map(i=>i.statusOperatorBundle).every(i=>i.calcStatus()))}}class ll extends zi{constructor(){super(...arguments);a(this,"calcStatus",()=>{const t=this.entity.isEffective;return this.entity.resetStatus(),this.entity.status=this._operators.filter(i=>i.isSpawnedBy.isEffective||!i.isContinuous).reduce((i,r)=>({...i,...r.statusCalculator(r,i)}),this.entity.status),this.entity.isEffective===t});a(this,"beforePush",()=>{})}}class cl extends Gt{constructor(t,i,r,s,l,o,c){super(t,i,r,s,l,o);a(this,"beforeRemove",()=>{});a(this,"statusCalculator");this.statusCalculator=c}}const xi=class xi{constructor(e,t,i){a(this,"seq");a(this,"entity");a(this,"_definition");a(this,"validateDuelist",e=>this.entity.controller===e?this.definition.executableDuelistTypes.includes("Controller"):this.definition.executableDuelistTypes.includes("Opponent"));this.seq=e==="AutoSeq"?xi.nextSeq++:e,this.entity=t,this._definition=i}get definition(){return this._definition}get title(){return this.definition.title}get isMandatory(){return this.definition.isMandatory}get executableCells(){return this.definition.executableCells}get executablePeriods(){return this.definition.executablePeriods}get executableDuelistTypes(){return this.definition.executableDuelistTypes}get isOnlyNTimesPerDuel(){return this.definition.isOnlyNTimesPerDuel??0}get isOnlyNTimesPerTurn(){return this.definition.isOnlyNTimesPerTurn??0}get isOnlyNTimesPerTurnIfFaceup(){return this.definition.isOnlyNTimesPerTurnIfFaceup??0}get isOnlyNTimesIfFaceup(){return this.definition.isOnlyNTimesIfFaceup??0}get isOnlyNTimesPerChain(){return this.definition.isOnlyNTimesPerChain??0}get actionGroupName(){return this.definition.actionGroupName}get duel(){return this.entity.duel}};a(xi,"nextSeq",0);let Ai=xi;const ii=class ii extends Ai{constructor(){super(...arguments);a(this,"isApplicableTo",(t,i,r)=>{const s=this.entity.counterHolder.getActionCount(this);return this.isOnlyNTimesPerTurnIfFaceup>0&&s>=this.isOnlyNTimesPerTurnIfFaceup?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&s>=this.isOnlyNTimesIfFaceup&&this.entity.counterHolder.incrementActionCount(this),this.definition.isApplicableTo(this,t,i,r)});a(this,"substitute",async(t,i,r)=>{const s=await this.definition.substitute(this,t,i,r);return this.isOnlyNTimesPerTurnIfFaceup>0?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&this.entity.counterHolder.incrementActionCount(this),s});a(this,"getClone",()=>new ii(this.seq,this.entity,this.definition))}get definition(){return super.definition}};a(ii,"createNew",(t,i)=>new ii("AutoSeq",t,i));let pn=ii;class dl extends Vi{constructor(){super(...arguments);a(this,"afterDistributeAll",()=>!0)}}class ul extends zi{constructor(){super(...arguments);a(this,"beforePush",()=>{});a(this,"filter",(t,i,r,s,l,o,c)=>this.effectiveOperators.filter(d=>d.summonKinds.includes(i)).reduce((d,u)=>({...d,...u.filter(this.entity,t,l.summoner,[i,...r],s,l.monster,o,d.posList,d.cells,c)}),l))}}class fl extends Gt{constructor(t,i,r,s,l,o,c,d){super(t,i,r,s,l,o);a(this,"beforeRemove",()=>{});a(this,"summonKinds");a(this,"filter");this.summonKinds=c,this.filter=(...u)=>d(this,...u)}}const ae=class ae{constructor(){}};a(ae,"_tryMarkForDestory",(e,t)=>{if(e.info.isDying||e.kind==="XyzMaterial"||!e.isOnFieldStrictly&&e.fieldCell.cellType!=="Deck"&&e.fieldCell.cellType!=="Hand")return!1;const i=t.action.playType==="Battle"?"BattleDestroy":"EffectDestroy",r=i==="BattleDestroy"&&t.action.entity===e?t.selectedEntities[0]:t.action.entity;return e.info.isDying=e.validateDestory(i,t.activator,r,t.action),e.info.isDying&&(e.info.causeOfDeath=[i],e.info.isKilledBy=r,e.info.isKilledByWhom=t.activator,i==="BattleDestroy"&&(e.info.isKilledByWhom=r.controller)),e.info.isDying}),a(ae,"releaseManyForTheSameReason",(e,t,i,r)=>e.length?(t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をリリースし――、`),ae.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",["Release",...t],i,r)):Promise.resolve()),a(ae,"sendManyToGraveyardForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&(t.includes("FusionMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を融合素材とし――、`):t.includes("SyncroMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をシンクロと素材し――、`):t.includes("LinkMaterial")?r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をリンクマーカーにセッティング――、`):r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を墓地に送り――、`)),ae.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",t,i,r)):Promise.resolve()),a(ae,"addManyToHand",(e,t,i,r)=>e.length?ae.bringManyToSameCellForTheSameReason("Hand","Bottom",e,"FaceDown","Vertical",t,i,r):Promise.resolve()),a(ae,"discardManyForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を手札から捨て――、`),ae.bringManyToSameCellForTheSameReason("Graveyard","Top",e,"FaceUp","Vertical",["Discard",...t],i,r)):Promise.resolve()),a(ae,"banishManyForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}をゲームから除外し――、`),ae.bringManyToSameCellForTheSameReason("Banished","Top",e,"FaceUp","Vertical",t,i,r)):Promise.resolve()),a(ae,"returnManyToDeckForTheSameReason",(e,t,i,r,s)=>t.length?(s&&i.includes("Cost")&&s.writeInfoLog(`${t.map(l=>l.toString()).join(" ")}をデッキに戻し――、`),ae.bringManyToSameCellForTheSameReason("Deck",e,t,"FaceDown","Vertical",i,r,s)):Promise.resolve()),a(ae,"returnManyToHandForTheSameReason",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}を手札に戻し――、`),ae.bringManyToSameCellForTheSameReason("Hand","Bottom",e,"FaceDown","Vertical",t,i,r)):Promise.resolve()),a(ae,"convertManyToXyzMaterials",(e,t,i,r)=>e.length?(r&&t.includes("Cost")&&r.writeInfoLog(`${e.map(s=>s.toString()).join(" ")}によって、オーバーレイネットワークを構築――、`),ne.moveMany(e.map(s=>[s,s.fieldCell,"XyzMaterial","FaceUp","Vertical","Top",t,i,r,r]))):Promise.resolve()),a(ae,"moveToXyzOwner",(e,t,i,r,s)=>t.length?(i.includes("Effect")&&s.writeInfoLog(`${t.map(l=>l.toString()).join(" ")}をXYZ素材として吸収。`),ne.moveMany(t.map(l=>[l,e,"XyzMaterial","FaceUp","Vertical","Top",i,r,s,s]))):Promise.resolve()),a(ae,"banishMany",(e,t)=>ne.bringManyToSameCell("Banished","Top",e.map(i=>({...i,face:"FaceUp",orientation:"Vertical"})),t)),a(ae,"bringManyToSameCellForTheSameReason",(e,t,i,r,s,l,o,c)=>ne.bringManyToSameCell(e,t,i.map(d=>({entity:d,face:r,orientation:s,causedAs:l,causedBy:o,activator:c})))),a(ae,"tryDestroy",async(e,t)=>{const i=await ae.tryMarkForDestory(e,t);return await ae.waitCorpseDisposal(t.activator.duel),i}),a(ae,"waitCorpseDisposal",e=>ne.sendManyToGraveyard([...e.field.getCardsOnFieldStrictly(),...e.field.getPendingCardsOnField()].filter(t=>t.info.isDying).map(t=>({entity:t,causedAs:t.info.causeOfDeath??[],causedBy:t.info.isKilledBy,activator:t.info.isKilledByWhom})))),a(ae,"tryMarkForDestory",async(e,t)=>{let i=e.filter(o=>ae._tryMarkForDestory(o,t));if(!i.length)return[];const r=t.action.playType==="Battle"?"BattleDestroy":"EffectDestroy";(await Promise.all(e[0].field.getAllEntities().flatMap(o=>o.substituteEffects.filter(c=>c.isMandatory).filter(c=>c.executableCells.includes(o.fieldCell.cellType)).filter(c=>c.isApplicableTo(r,e,t).length).flatMap(c=>c.substitute(r,e,t))))).flatMap(o=>o).forEach(o=>{o.resetCauseOfDeath()}),i=i.filter(o=>o.info.isDying);let s=e[0].field.getAllEntities().flatMap(o=>o.substituteEffects.filter(c=>!c.isMandatory).filter(c=>c.executableCells.includes(o.fieldCell.cellType)).filter(c=>c.isApplicableTo(r,e,t).length).map(c=>({chooser:o.owner,effect:c,sacrifice:o})));for(const o of s.map(c=>c.sacrifice.controller).getDistinct()){const c=s.filter(u=>u.sacrifice.controller===o),d=await o.duel.view.waitSelectAction(o,c.map(u=>({entity:u.sacrifice,title:u.effect.title,origin:u.effect})),"身代わり効果を適用する？",!0);if(d){if((await d.substitute(r,i,t)).forEach(u=>{u.resetCauseOfDeath()}),i=i.filter(u=>u.info.isDying),!i.length)return[];s=s.filter(u=>u.effect.isApplicableTo(r,e,t).length)}}const l=i.filter(o=>o.info.isDying);return l.forEach(o=>o.duel.log.info(`${o.toString()}を${_l[r]}。`,o.info.isKilledByWhom)),l}),a(ae,"tryBanish",async(e,t,i)=>{const r=t.filter(s=>s.canBeBanished(e,i.activator,i.action.entity,i.action));return await ae.banishManyForTheSameReason(r,["Effect"],i.action.entity,i.activator),r.filter(s=>s.fieldCell.cellType==="Banished").filter(s=>s.moveLog.latestRecord.movedBy===i.action.entity)}),a(ae,"negateSummonMany",(e,t)=>{const i=t.duel.field.getPendingMonstersOnField();return i.forEach(r=>{r.info.summonKinds=[],r.info.materials=[],r.moveLog.negateSummon(e,t)}),t.writeInfoLog(`${i.map(r=>r.toString()).join(" ")}.の召喚は無効にされた。`),i});let Ge=ae;const hl=["FusionSummon","SyncroSummon","XyzSummon","PendulumSummon","LinkSummon","RitualSummon","FlipSummon"],vl={FusionSummon:"融合召喚",SyncroSummon:"シンクロ召喚",XyzSummon:"エクシーズ召喚",PendulumSummon:"ペンデュラム召喚",LinkSummon:"リンク召喚",RitualSummon:"儀式召喚",FlipSummon:"反転召喚"},pl=[...hl,"AdvanceSummon","NormalSummon","SpecialSummon"],_l={BattleDestroy:"戦闘破壊",EffectDestroy:"効果破壊",RuleDestroy:"ルール破壊"},Gs=n=>n+"Summon",Qn=["Card","Token","Avatar"],gl=["Duelist","Squatter"],Ws=(n,e)=>Is(n.origin,e.origin),ke=class ke{constructor(e,t,i,r,s,l){a(this,"onBeforeMoveEvent",new Vn);a(this,"onAfterMoveEvent",new Vn);a(this,"seq");a(this,"origin");a(this,"entityType");a(this,"summonFilterBundle");a(this,"procFilterBundle");a(this,"numericOprsBundle");a(this,"statusOperatorBundle");a(this,"moveLog");a(this,"counterHolder");a(this,"face");a(this,"orientation");a(this,"owner");a(this,"fieldCell");a(this,"_status");a(this,"_numericStatus");a(this,"_info");a(this,"actions",[]);a(this,"continuousEffects",[]);a(this,"substituteEffects",[]);a(this,"canBeReleased",(e,t,i,r)=>!this.isInTrashCell&&this.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.union(i).length).every(s=>s.filter(e,t,r,[this])));a(this,"canBeSentToGraveyard",(e,t,i,r)=>!this.info.willBeBanished&&!this.info.willReturnToDeck&&this.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.includes(i)).every(s=>s.filter(e,t,r,[this])));a(this,"_hasDisappeared",!1);a(this,"definition");a(this,"toString",()=>this.entityType==="Card"?`《${this.nm}》`:this.nm);a(this,"onUsedAsMaterial",(e,t)=>{this.definition&&this.definition.onUsedAsMaterial&&this.definition.onUsedAsMaterial(e,t)});a(this,"setBattlePosition",async(e,t,i,r)=>{let s=`表示形式の変更：${this.toString()}（${this.battlePositionName}⇒${_i[e]}）`;const l=[...t];this.battlePosition==="Set"&&(l.push("Flip"),t.includes("Rule")&&(this.info.isPending=!0,s=`${this.toString()}を反転召喚`,this.info.summonKinds.push("FlipSummon"),l.push("FlipSummon"),l.push("AttackSummon"))),this.duel.log.info(s,r),await this.moveAlone(this.fieldCell,"Monster",e==="Set"?"FaceDown":"FaceUp",e==="Attack"?"Vertical":"Horizontal","Top",l,i,r,r)});a(this,"activateAsPendulumScale",(e,t,i,r)=>this.moveAlone(e,"Spell","FaceUp","Vertical","Top",["CardActivation",...t],i,r,r));a(this,"setNonFieldMonsterPosition",async(e,t,i,r,s)=>{this.moveAlone(this.fieldCell,e,t==="FaceUp"?"FaceUp":"FaceDown","Vertical","Top",i,r,s,s)});a(this,"setAsSpellTrap",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceDown","Vertical","Top",[...i,"SpellTrapSet"],r,s,s)});a(this,"activateSpellTrapFromHand",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceUp","Vertical","Top",[...i,"CardActivation"],r,s,s)});a(this,"putDirectly",async(e,t,i,r,s)=>{await this.moveAlone(e,t,"FaceUp","Vertical","Top",[...i,"PutDirectly"],r,s,s)});a(this,"activateSpellTrapOnField",async(e,t,i,r)=>{await this.moveAlone(this.fieldCell,e,"FaceUp","Vertical","Top",[...t,"CardActivation"],i,r,r)});a(this,"draw",async(e,t,i)=>await this.addToHand([...e,"Draw"],t,i));a(this,"addToHand",async(e,t,i)=>await this.moveAlone(this.owner.getHandCell(),this.origin.kind,"FaceDown","Vertical","Bottom",[...e],t,i,i));a(this,"summon",(e,t,i,r,s,l,o)=>ke.summonMany([{monster:this,dest:e,summoner:o??l,pos:t}],i,r,s,l));a(this,"moveForcibly",async(e,t,i,r,s,l,o)=>{await this.moveAlone(e,this.origin.kind,t,i,r,["Rule",...s],l,o,o)});a(this,"moveAlone",async(e,t,i,r,s,l,o,c,d)=>(await ke.moveMany([[this,e,t,i,r,s,l,o,c,d]],void 0),this.fieldCell));a(this,"determine",()=>{this.info.isPending&&(this.info.isPending=!1,this.moveLog.finalize(),this.continuousEffects.forEach(e=>e.updateState()))});a(this,"_move",async(e,t,i,r,s,l,o,c,d)=>{if(!e)throw new Error("illegal argument: to");if(await this.onBeforeMoveEvent.trigger({entity:this,args:[e,t,i,r,s,l,o,c,d]}),this.face=i,this.orientation=r,e!==this.fieldCell){if(this.field.duel.clock.turn>0&&(this.duel.log.info(`移動：${this.toString()}  ${this.fieldCell.toString()} ⇒ ${e.toString()}`,c),await this.field.duel.view.waitAnimation({entity:this,to:e,index:s,count:0})),this.fieldCell.releaseEntities(this),this.fieldCell.isPlayFieldCell&&!e.isPlayFieldCell&&(this.counterHolder.clear(),this.resetCauseOfDeath(),this.entityType==="Token")){this._hasDisappeared=!0,this.field.duel.log.info(`${this.nm}は消滅した。`,this.controller);return}this.kind!=="XyzMaterial"&&(this.fieldCell.isMonsterZoneLikeCell&&!e.isMonsterZoneLikeCell||t!=="Monster")&&(this.info.equipEntities.filter(u=>u.isOnFieldAsSpellTrapStrictly).forEach(u=>{u.info.isDying=!0,u.info.causeOfDeath=["RuleDestroy"],this.controller.writeInfoLog(`装備対象${this.toString()}不在により${u.toString()}は破壊された。`)}),this.info.equipEntities=[],this.fieldCell.xyzMaterials.forEach(u=>{u.info.isDying=!0,u.info.causeOfDeath=["LostXyzOwner"],this.controller.writeInfoLog(`エクシーズモンスター${this.toString()}不在により${u.toString()}は墓地に送られた。`)}),this.resetNumericStatus(),this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.info.isEffectiveIn.push(...Dt)),this.fieldCell.cellType==="SpellAndTrapZone"&&e.cellType!=="SpellAndTrapZone"&&(this.info.equipedBy=void 0,this.info.equipedAs=void 0,this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.info.isEffectiveIn.push(...Dt)),e.acceptEntities(this,s),(e===this.isBelongTo||e.cellType==="Hand"||e.cellType==="Banished"&&this.face==="FaceDown")&&(this.counterHolder.clear(),this.resetInfoAll(),this.resetStatusAll())}return(this.isOnFieldStrictly&&this.face==="FaceDown"||t==="XyzMaterial")&&(this.info.equipEntities.forEach(u=>{u.info.isDying=!0,u.info.causeOfDeath=["RuleDestroy"],this.controller.writeInfoLog(`装備対象${this.toString()}不在により${u.toString()}は破壊された。`)}),this.counterHolder.removeAllWhenfaceDown(),this.info.materials=[],this._status.isEffective=!0,this.info.isEffectiveIn=[...Yi],this.info.willBeBanished=!1,this.info.willReturnToDeck=void 0,this.resetNumericStatus(),this.info.isSettingSickness=this.kind==="Trap"||this.status.spellCategory==="QuickPlay"),this._info.kind=t,this.moveLog.push(t,l,o,c,d),await this.onAfterMoveEvent.trigger(this),e});a(this,"initForTurn",()=>{this.info.isSettingSickness=!1,this.info.attackCount=0,this.info.battlePotisionChangeCount=0,this.counterHolder.corpseDisposal()});a(this,"resetInfoIfLeavesTheField",()=>{this._info={...this._info,isDying:!1,isPending:!1,causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,effectTargets:{},attackCount:0,battlePotisionChangeCount:0,materials:[],equipedBy:void 0,equipedAs:void 0,equipEntities:[]},this._info.isEffectiveIn.push(...Dt),this._info.isEffectiveIn.distinct()});a(this,"resetInfoAll",()=>{var e;this._info={kind:this.origin.kind,isDying:!1,isPending:!1,isEffectiveIn:[...Yi],causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,isVanished:!1,isRebornable:((e=this.origin.monsterCategories)==null?void 0:e.union(As).length)===0,isSettingSickness:!1,summonKinds:[],materials:[],effectTargets:{},willBeBanished:!1,willReturnToDeck:void 0,attackCount:0,battlePotisionChangeCount:0,equipedBy:void 0,equipedAs:void 0,validateEquipOwner:()=>!0,equipEntities:[],battleLog:[]},this.counterHolder.clear()});a(this,"resetNumericStatus",()=>{const e=Os.reduce((t,i)=>(t[i]=this.origin[i],t),{});this._numericStatus={origin:{...e},wip:{...e},calculated:{...e}}});a(this,"resetStatus",()=>{this._status={...this.origin,canAttack:!0,isEffective:!0,canDirectAttack:!1,canActivateEffect:!0,isSelectableForAttack:!0,allowHandSyncro:!1,allowHandLink:!1,maxCounterQty:{}}});a(this,"resetStatusAll",()=>{this.resetNumericStatus(),this.resetStatus()});a(this,"resetCauseOfDeath",()=>{this.info.isDying=!1,this.info.causeOfDeath=[],this.info.isKilledBy=void 0,this.info.isKilledByWhom=void 0});this.seq=ke.nextEntitySeq++,this.counterHolder=new ol(this),this.definition=r,this.owner=e,this.fieldCell=t,this.entityType=i,this.origin=r.staticInfo,this._status=JSON.parse(JSON.stringify(r.staticInfo)),this._numericStatus=JSON.parse(JSON.stringify(r.staticInfo)),this.resetStatusAll(),this._info={kind:this.origin.kind,isEffectiveIn:[...Yi],attackCount:0,battlePotisionChangeCount:0,isDying:!1,isPending:!1,causeOfDeath:[],isKilledBy:void 0,isKilledByWhom:void 0,isVanished:!1,isRebornable:!0,isSettingSickness:!1,summonKinds:[],materials:[],effectTargets:{},willBeBanished:!1,willReturnToDeck:void 0,equipedBy:void 0,equipedAs:void 0,validateEquipOwner:()=>!0,equipEntities:[],battleLog:[]},this.resetInfoAll(),this.face=s,this.orientation=l,this.summonFilterBundle=new ul(t.field.summonFilterPool,this),this.procFilterBundle=new ja(t.field.procFilterPool,this),this.numericOprsBundle=new Va(t.field.numericStateOperatorPool,this),this.statusOperatorBundle=new ll(t.field.statusOperatorPool,this),t.acceptEntities(this,"Top"),this.moveLog=new il(this),this.moveLog.pushForRuleAction(["Spawn"]);let o=[],c=[];o=r.actions,c=r.continuousEffects??[],this.substituteEffects.push(...(r.substituteEffects??[]).map(d=>pn.createNew(this,d))),this.origin.kind==="Monster"&&this.entityType==="Card"&&r.summonFilter&&this.summonFilterBundle.push(new fl("default",()=>!0,!0,this,{},()=>!0,pl,r.summonFilter)),r.defaultStatus&&this.statusOperatorBundle.push(new cl("default",()=>!0,!0,this,{},()=>!0,()=>r.defaultStatus??{})),this.actions.push(...o.map(d=>Vt.createNew(this,d))),this.continuousEffects.push(...c.map(d=>un.createNew(this,d)))}get onBeforeMove(){return this.onBeforeMoveEvent.expose()}get onAfterMove(){return this.onAfterMoveEvent.expose()}get isUnderControl(){return this.face==="FaceUp"||$s.every(e=>e!==this.fieldCell.cellType)}get controller(){return this.fieldCell.owner??this.owner}get field(){return this.owner.duel.field}get duel(){return this.owner.duel.field.duel}get actionLogRecords(){return this.duel.chainBlockLog.records.filter(e=>e.chainBlockInfo.action.entity===this)}get status(){return this._status}set status(e){this._status={...e}}get numericStatus(){return this._numericStatus}get info(){return this._info}get kind(){return this.info.kind}get nm(){return this.status.name}get atk(){return this._numericStatus.calculated.attack}get def(){return this._numericStatus.calculated.defense}get lvl(){return this._numericStatus.calculated.level}get rank(){return this._numericStatus.calculated.rank}get attr(){return this.status.attributes??[]}get types(){return this.status.types??[]}get psL(){return this._numericStatus.calculated.pendulumScaleL}get psR(){return this._numericStatus.calculated.pendulumScaleR}get linkArrows(){let e=(this.origin.linkArrowKeys??[]).map(t=>Rs[t].linkArrow);return this.controller.seat==="Above"&&(e=e.map(t=>({offsetColumn:t.offsetColumn*-1,offsetRow:t.offsetRow*-1}))),e}get linkArrowDests(){var e;return(e=this.origin.monsterCategories)!=null&&e.includes("Link")?this.isOnFieldAsMonsterStrictly?this.linkArrows.map(t=>[this.fieldCell.row+t.offsetRow,this.fieldCell.column+t.offsetColumn]).map(([t,i])=>this.field.cells[t][i]).filter(t=>t.isMonsterZoneLikeCell):[]:[]}get linkedEntities(){return this.isOnFieldAsMonsterStrictly?[...this.linkArrowDests.map(e=>e.cardEntities[0]).map(e=>e),...this.fieldCell.linkArrowSources].getDistinct():[]}get coLinkedEntities(){var e;return this.isOnFieldAsMonsterStrictly?(e=this.origin.monsterCategories)!=null&&e.includes("Link")?this.linkArrowDests.map(t=>t.cardEntities[0]).filter(t=>t).union(this.fieldCell.linkArrowSources):[]:[]}get isEffective(){return this.status.isEffective&&this.info.isEffectiveIn.includes(this.fieldCell.cellType)}get isEffectiveWeakly(){return this.status.isEffective}get battlePosition(){if(this.isOnFieldStrictly&&this.kind==="Monster")return this.orientation==="Vertical"?"Attack":this.face==="FaceUp"?"Defense":"Set"}get battlePositionName(){const e=this.battlePosition;if(e)return _i[e]}get wasMovedAtCurrentProc(){return this.field.duel.clock.totalProcSeq===this.moveLog.latestRecord.movedAt.totalProcSeq}get wasMovedAtPreviousProc(){return this.field.duel.clock.totalProcSeq===this.moveLog.latestRecord.movedAt.totalProcSeq+1}get wasMovedAtCurrentTurn(){return this.field.duel.clock.isSameTurn(this.moveLog.latestRecord.movedAt)}get wasMovedAtCurrentChain(){return this.field.duel.clock.isSameChain(this.moveLog.latestRecord.movedAt)}get wasMovedAtPreviousChain(){return this.field.duel.clock.isPreviousChain(this.moveLog.latestRecord.movedAt)}get wasMovedAtPreviousTurn(){return this.field.duel.clock.isPreviousTurn(this.moveLog.latestRecord.movedAt)}get wasMovedFrom(){return this.moveLog.previousPlaceRecord.cell}get isPendulumScale(){var e;return!(!((e=this.origin.monsterCategories)!=null&&e.includes("Pendulum"))||!this.isOnField||!this.fieldCell.isSpellTrapZoneLikeCell||this.status.spellCategory)}get isOnField(){return this.fieldCell.isPlayFieldCell}get isOnFieldStrictly(){return this.isOnField&&!this.info.isPending&&this.kind!=="XyzMaterial"}get isOnFieldAsMonsterStrictly(){return this.fieldCell.isMonsterZoneLikeCell&&this.isOnFieldStrictly}get isOnFieldAsSpellTrapStrictly(){return this.fieldCell.isSpellTrapZoneLikeCell&&this.isOnFieldStrictly}get isInTrashCell(){return this.fieldCell.isTrashCell}get isLikeContinuousSpell(){return this.status.spellCategory==="Continuous"||this.status.spellCategory==="Field"||this.status.spellCategory==="Equip"||this.status.trapCategory==="Continuous"||(this.status.monsterCategories??[]).includes("Pendulum")}get isBelongTo(){return this.origin.monsterCategories&&this.origin.monsterCategories.union(Ti).length?this.owner.getExtraDeck():this.owner.getDeckCell()}get hasDisappeared(){return this._hasDisappeared}get allStickyEffectOperators(){return[...this.procFilterBundle.effectiveOperators,...this.numericOprsBundle.effectiveOperators]}};a(ke,"nextEntitySeq",0),a(ke,"splitBattlePos",e=>({face:e==="Set"?"FaceDown":"FaceUp",orientation:e==="Attack"?"Vertical":"Horizontal"})),a(ke,"recreateArray",(e,t)=>{if(!t.length)return[];const i=e.getAllCells().flatMap(r=>r.entities);return t.map(r=>r.seq).map(r=>i.find(s=>s.seq===r)).filter(r=>r!==void 0)}),a(ke,"createPlayerEntity",e=>{const t=e.getHandCell();return new ke(e,t,"Duelist",Nl(e),"FaceUp","Vertical")}),a(ke,"createCardEntity",(e,t)=>{const i=t.staticInfo.monsterCategories&&t.staticInfo.monsterCategories.union(Ti).length?e.getExtraDeck():e.getDeckCell();return new ke(e,i,"Card",t,"FaceDown","Vertical")}),a(ke,"moveMany",async(e,t)=>{if(!e.length)return;const i=e[0][0].duel,s=[...e.filter(([o,c])=>o.fieldCell!==c).map(([o])=>o).filter(o=>!(t??[]).includes(o)),...i.field.getCardsOnFieldStrictly().filter(o=>o.info.isDying)],l=new Map;for(e.forEach(([o,c,d,u,f,v,..._])=>{var b;let g=c,S=d,p=u,k=v,w=f;o.info.willBeBanished?(g=o.owner.getBanished(),p="FaceUp",w="Vertical"):o.info.willReturnToDeck?(g=o.isBelongTo,p="FaceDown",k=o.info.willReturnToDeck,w="Vertical"):(b=o.status.monsterCategories)!=null&&b.includes("Pendulum")&&o.isOnFieldStrictly&&o.face==="FaceUp"&&c.isTrashCell&&(g=o.owner.getExtraDeck(),p="FaceUp",k="Top",w="Vertical"),g.cellType==="ExtraDeck"&&(k=p==="FaceUp"?"Top":"Bottom"),o.isBelongTo.cellType==="ExtraDeck"&&(g.cellType==="Hand"||g.cellType==="Deck")&&(g=o.isBelongTo,p="FaceDown",w="Vertical"),g.isPlayFieldCell||(S=o.origin.kind),g.isMonsterZoneLikeCell||(w="Vertical"),l.set(g,[[o,g,S,p,w,k,..._],...l.get(g)??[]])});;){const o=Array.from(l.values()).map(d=>d.pop()).filter(d=>d!==void 0).map(([d,...u])=>d._move(...u));if(!o.length)break;await Promise.all(o);const c=i.field.getCardsOnFieldStrictly().filter(d=>d.info.isDying).filter(d=>!s.includes(d)).map(d=>({entity:d,causedAs:d.info.causeOfDeath??[],causedBy:d.info.isKilledBy,activator:d.info.isKilledByWhom}));c.length&&await ke.sendManyToGraveyard(c,s)}ke.settleEntityMove(i)}),a(ke,"summonMany",async(e,t,i,r,s)=>{if(!e.length)return;const l={Attack:"AttackSummon",Defense:"DefenseSummon",Set:"SetSummon"},o=e.map(({monster:c,dest:d,pos:u,summoner:f})=>{if(c.info.summonKinds=[t],t==="NormalSummon"||t==="AdvanceSummon"){c.info.summonKinds.push("NormalSummon");const g=t==="AdvanceSummon"?"アドバンス":"";u==="Attack"?c.field.duel.log.info(`${c.toString()}を${g}召喚`,f):c.duel.log.info(`${c.toString()}を${g}セット`,f),i.includes("Rule")?f.info.ruleNormalSummonCountQty++:f.info.effectNormalSummonCountQty++}else t==="SpecialSummon"?c.duel.log.info(`${c.toString()}を${_i[u]}で特殊召喚`,f):(c.info.summonKinds.push("SpecialSummon"),c.duel.log.info(`${c.toString()}を${_i[u]}で${vl[t]}！`,f)),f.info.specialSummonCountQty++;c.info.summonKinds=c.info.summonKinds.getDistinct(),c.info.battlePotisionChangeCount=1;const{face:v,orientation:_}=ke.splitBattlePos(u);return i.includes("Rule")&&(c.info.isPending=!0),{entity:c,args:[d,"Monster",v,_,"Top",[t,l[u],...i],r,s,f]}}).map(c=>c.entity._move(...c.args));await Promise.all(o),e.map(c=>c.summoner).forEach(c=>{t==="NormalSummon"||t==="AdvanceSummon"?i.includes("Rule")?c.info.ruleNormalSummonCount++:c.info.effectNormalSummonCount++:c.info.specialSummonCount++}),ke.settleEntityMove(e[0].monster.duel)}),a(ke,"sendManyToGraveyard",(e,t)=>ke.bringManyToSameCell("Graveyard","Top",e.map(i=>({...i,face:"FaceUp",orientation:"Vertical"})),t)),a(ke,"bringManyToSameCell",(e,t,i,r)=>ke.moveMany(i.map(s=>[s.entity,s.entity.field.getCells(e).filter(l=>l.owner===s.entity.owner)[0],s.entity.origin.kind,s.face,s.orientation,t,s.causedAs,s.causedBy,s.activator,s.activator]),r)),a(ke,"settleEntityMove",e=>{e.field.recalcLinkArrows(),e.distributeOperators(e.clock);const t=e.field.getAllEntities().filter(i=>i.wasMovedAtCurrentProc);t.filter(i=>!i.isOnFieldStrictly&&!i.info.isPending).forEach(i=>i.resetInfoIfLeavesTheField()),t.filter(i=>i.face==="FaceDown").filter(i=>i.fieldCell===i.isBelongTo).forEach(i=>{i.resetInfoAll(),i.resetStatusAll()}),t.flatMap(i=>i.continuousEffects).forEach(i=>i.updateState()),e.field.getAllCells().filter(i=>i.needsShuffle).map(i=>i.shuffle())});let ne=ke;ne.prototype.hasBeenSummonedNow=function(n,e=["Attack","Defense"]){const t=this,i=e.map(Gs),r=t.moveLog.latestRecord.movedAs;return!(!t.wasMovedAtPreviousChain||!r.union(n).length||!r.union(i).length)};ne.prototype.hasBeenSummonedJustNow=function(n,e=["Attack","Defense"]){const t=this,i=e.map(Gs),r=t.moveLog.latestRecord.movedAs;return!(!t.wasMovedAtPreviousProc||!r.union(n).length||!r.union(i).length)};ne.prototype.getAttackTargets=function(){if(!this.hasAttackRight())return[];const n=this.controller.getOpponentPlayer().getMonstersOnField().filter(e=>e.status.isSelectableForAttack);return console.log(this.toString(),this.status.canDirectAttack),(this.status.canDirectAttack||!n.length)&&n.push(this.controller.getOpponentPlayer().entity),n.filter(e=>e.canBeTargetOfBattle(this.controller,this)).filter(e=>this.procFilterBundle.effectiveOperators.filter(t=>t.procTypes.includes("BattleTarget")).every(t=>t.filter(this.controller,this,{},[e])))};ne.prototype.canDirectAttack=function(){return this.getAttackTargets().some(n=>n.entityType==="Duelist")};ne.prototype.canAttackToMonster=function(){return this.getAttackTargets().some(n=>n.entityType!=="Duelist")};ne.prototype.hasAttackRight=function(){return this.battlePosition==="Attack"&&this.info.attackCount===0&&this.status.canAttack};ne.prototype.canBeEffected=function(n,e,t){return this.procFilterBundle.effectiveOperators.filter(r=>r.procTypes.some(s=>s==="Effect")).every(r=>r.filter(n,e,t,[this]))};const Ks=(n,e,t,i,r)=>n.canBeEffected(t,i,r)&&n.procFilterBundle.effectiveOperators.filter(s=>s.procTypes.some(l=>l===e)).every(s=>s.filter(t,i,r,[n]));ne.prototype.canBeTargetOfEffect=function(n){return Ks(this,"EffectTarget",n.activator,n.action.entity,n.action)};ne.prototype.canBeBanished=function(n,e,t,i){return this.fieldCell.cellType==="Banished"?!1:Ks(this,n,e,t,i)};ne.prototype.canBeTargetOfBattle=function(n,e){const t=this;return t.procFilterBundle.effectiveOperators.filter(i=>i.procTypes.some(r=>r==="BattleTarget")).every(i=>i.filter(n,e,{},[t]))};ne.prototype.validateDestory=function(n,e,t,i){const r=this;let s=r.procFilterBundle.effectiveOperators.filter(l=>l.procTypes.includes(n)).every(l=>l.filter(e,t,i??{},[r]));return s&&n==="EffectDestroy"&&(s=r.canBeEffected(e,t,i)),s};ne.prototype.getIndexInCell=function(){const n=this;if(n.info.isVanished)return-1;const e=n.fieldCell.cardEntities.indexOf(n);if(e<0)throw new le("エンティティとセルの状態が矛盾している。",[n,n.fieldCell]);return e};ne.prototype.getXyzMaterials=function(){const n=this;return(n.status.monsterCategories??[]).includes("Xyz")?n.fieldCell.xyzMaterials:[]};ne.prototype.wasMovedAfter=function(n){return this.moveLog.latestRecord.movedAt.totalProcSeq>n.totalProcSeq};ne.prototype.hadArrivedToFieldAt=function(){let n=this.moveLog.latestRecord.movedAt;return this.moveLog.records.findLast(e=>!e.cell.isPlayFieldCell||e.isPending||e.kind!==this.kind||e.face==="FaceDown"?!0:(n=e.movedAt,!1)),n};ne.prototype.release=async function(n,e,t){return await this.sendToGraveyard([...n,"Release"],e,t),this.info.isVanished?void 0:this.fieldCell};ne.prototype.ruleDestory=async function(){return await this.sendToGraveyard(["RuleDestroy"],void 0,void 0),this.info.isVanished?void 0:this.fieldCell};ne.prototype.sendToGraveyard=function(n,e,t){return Ge.sendManyToGraveyardForTheSameReason([this],n,e,t)};ne.prototype.discard=function(n,e,t){return Ge.discardManyForTheSameReason([this],n,e,t)};ne.prototype.returnToDeck=function(n,e,t,i){return Ge.returnManyToDeckForTheSameReason(n,[this],e,t,i)};ne.prototype.banish=function(n,e,t){return Ge.banishManyForTheSameReason([this],n,e,t)};class ml{constructor(e){a(this,"cells");a(this,"duel");a(this,"summonFilterPool");a(this,"procFilterPool");a(this,"numericStateOperatorPool");a(this,"statusOperatorPool");a(this,"moveLog");a(this,"getAllCells",()=>this.cells.flat());a(this,"getCells",(...e)=>this.getAllCells().filter(t=>e.includes(t.cellType)));a(this,"getAvailableExtraMonsterZones",()=>this.getCells("ExtraMonsterZone").filter(e=>e.isAvailable));a(this,"getAllEntities",()=>this.getAllCells().map(e=>e.entities).flat());a(this,"getAllCardEntities",()=>this.getAllCells().map(e=>e.cardEntities).flat());a(this,"getCardsOnFieldStrictly",()=>this.getCells(...Dt).map(e=>e.cardEntities).filter(e=>e.length>0).map(e=>e[0]).filter(e=>e.isOnFieldStrictly));a(this,"getMonstersOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>e.isOnFieldAsMonsterStrictly));a(this,"getSpellTrapsOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>e.isOnFieldAsSpellTrapStrictly));a(this,"getPendulumScalesOnFieldStrictly",()=>this.getCardsOnFieldStrictly().filter(e=>{var t;return(t=e.origin.monsterCategories)==null?void 0:t.includes("Pendulum")}).filter(e=>e.isOnFieldAsSpellTrapStrictly).filter(e=>!e.status.spellCategory));a(this,"getPendingCardsOnField",()=>this.getCells(...Dt).map(e=>e.cardEntities).filter(e=>e.length>0).map(e=>e[0]).filter(e=>e.info.isPending));a(this,"getPendingMonstersOnField",()=>this.getPendingCardsOnField().filter(e=>e.kind==="Monster"));a(this,"getEntities",e=>this.getAllEntities().filter(t=>t.controller===e));a(this,"recalcLinkArrows",()=>{const e=this.getAllCells().filter(t=>t.isMonsterZoneLikeCell);e.some(t=>t.recalcLinkArrows)&&e.forEach(t=>t.recalcLinkArrows())});a(this,"canExtraLink",(e,t)=>{if(!e.linkArrows.length)return!1;const i=t.map(d=>d.material),r=this.getCells("ExtraMonsterZone").filter(d=>d.isAvailable||i.includes(d.cardEntities[0]));if(r.length!==1)return!1;const s=r[0],l=e.linkArrows.map(d=>this.cells[s.row+d.offsetRow][s.column+d.offsetColumn]);let o=s.linkArrowSources.filter(d=>!i.includes(d)).filter(d=>l.includes(d.fieldCell));if(!o.length)return!1;let c=-1;for(;c!==o.length;){const d=o.flatMap(u=>u.coLinkedEntities).filter(u=>!i.includes(u));if(d.some(u=>u.fieldCell.cellType==="ExtraMonsterZone"))return!0;o=[...o,...d].getDistinct(),c=o.length}return!1});a(this,"drawAtSameTime",async(e,t,i,r,s,l)=>{const o=[],c=[],d=[e.draw(t,s,l),i.draw(r,s,l)].map(u=>u.catch(f=>{f instanceof Tt?f.winner&&o.push(f.winner):c.push(f)}));if(await Promise.all(d),c.length)throw new le("ドロー処理で想定されない例外が発生した。",e,t,i,r,s,...c);if(o.length!==0)throw o.length===1?new Tt(o[0],"対戦相手がデッキからドローできなかった。"):new Tt(void 0,"お互いにデッキからカードをドローできなかった。")});a(this,"sendToGraveyard",async(e,t,i,r,s,l,o,c)=>{if(r>0&&i.length<r)return;const d=await this.duel.view.waitSelectEntities(t,{selectables:i,qty:r,validator:s,cancelable:c??!1},e);if(d)return await ne.sendManyToGraveyard(d.map(u=>({entity:u,causedAs:l,causedBy:o,activator:t}))),this.duel.log.info(`${d.map(u=>u.status.name).join(", ")}を墓地に送った（${l.getDistinct().join(", ")}）。`,t),d});this.duel=e,this.cells=[...Array(7)].map(()=>[]);for(const t of Object.keys(dn).map(Number))for(const i of Object.keys(dn[t]).map(Number))this.cells[t][i]=new Ua(this,t,i,t<3?e.duelists.Above:t>3?e.duelists.Below:i<2?e.duelists.Above:i>4?e.duelists.Below:void 0);this.summonFilterPool=new dl,this.procFilterPool=new Ha,this.numericStateOperatorPool=new Za,this.statusOperatorPool=new al,this.moveLog=new tl(this)}}let yl=class{constructor(e){a(this,"onUpdateEvent",new Te);a(this,"nextSeq");a(this,"records",[]);a(this,"duel");a(this,"dispose",()=>{this.onUpdateEvent.clear()});a(this,"error",e=>{console.error(e);const t=["エラー発生"];e instanceof Error?(e instanceof le&&(t.push("-- エラーメッセージ --"),t.push(e.message),t.push("-- 関連オブジェクト --"),e.items.forEach(i=>t.push(JSON.stringify(i))),console.error(e.items)),t.push("-- エラー名称 --"),t.push(e.name||"エラー名称取得失敗"),t.push("-- スタックトレース --"),t.push(e.stack||"スタックトレース取得失敗")):(t.push("-- エラー型特定失敗 --"),t.push(JSON.stringify(e))),this.write("error","System",t,void 0,void 0,void 0,void 0,void 0)});a(this,"warn",e=>{this.write("warn","System",["【注意】",e],void 0,void 0,void 0,void 0,void 0)});a(this,"info",(e,t)=>{this.write("info","Others",[e],t,void 0,void 0,void 0,void 0)});a(this,"pushMoveLog",(e,t,i,r)=>{this.write("info","EntityMove",["移動"],e,t,void 0,i,r)});a(this,"write",(e,t,i,r,s,l,o,c)=>{const d=i.join(`
`);this.records.push({seq:this.nextSeq++,lvl:e,type:t,clock:this.duel.clock.getClone(),text:d,duelist:r,mainEntity:s,subEntities:l??[],from:o,to:c}),this.onUpdateEvent.trigger(this.nextSeq-1)});this.nextSeq=0,this.duel=e}get onUpdate(){return this.onUpdateEvent.expose()}get lastRecord(){return this.records.slice(-1)[0]}};const Sl=n=>new Promise(e=>setTimeout(e,n)),Xs=()=>{let n=()=>{},e=()=>{};return{promise:new Promise((i,r)=>{n=i,e=r}),resolve:n,reject:e}};class Ji{constructor(e){a(this,"onUpdateEvent",new Te);a(this,"_state","Disable");a(this,"defaultArgs");a(this,"_args");a(this,"resolve",()=>{});a(this,"show",e=>{this._args=e,this._state="Shown",this.onUpdateEvent.trigger();const{promise:t,resolve:i}=Xs();return this.resolve=r=>{this._state="Disable",i(r),this.resolve=()=>{},this.onUpdateEvent.trigger()},t});a(this,"cancel",()=>{this._state!=="Disable"&&this.resolve(void 0),this.terminate()});a(this,"terminate",()=>{this._state="Disable",this._args=this.defaultArgs,this.resolve=()=>{}});this.defaultArgs=e,this._args=e}get onUpdate(){return this.onUpdateEvent.expose()}get state(){return this._state}get args(){return this._args}}class wl{constructor(e){a(this,"onUpdateEvent",new Te);a(this,"actionSelector",new Ji({title:"カード操作を選択。",activator:void 0,dummyActionInfos:[],cancelable:!1}));a(this,"entitySelector",new Ji({title:"対象を選択",entitiesChoices:{selectables:[],validator:()=>!0,cancelable:!1},cancelable:!1,chainBlockInfos:[]}));a(this,"textSelector",new Ji({title:"カード操作を選択。",choises:[],cancelable:!1}));a(this,"modals",[this.actionSelector,this.entitySelector,this.textSelector]);a(this,"view");a(this,"terminateAll",()=>{this.modals.forEach(e=>e.terminate()),this.onUpdateEvent.trigger()});this.view=e,this.modals.forEach(t=>t.onUpdate.append(()=>this.onUpdateEvent.trigger()))}get onUpdate(){return this.onUpdateEvent.expose()}}const Yn=n=>{let e=[];do{const t=n.qty&&n.qty>0?n.qty:Math.floor(Math.random()*n.selectables.length+1);e=n.selectables.randomPickMany(t)}while(!n.validator(e));return e},Cl=[{seq:10,name:"Internet Explorer",key:"msie"},{seq:20,name:"Internet Explorer",key:"trident"},{seq:30,name:"Edge",key:"edge"},{seq:40,name:"Google Chrome",key:"chrome"},{seq:50,name:"Safari",key:"safari"},{seq:60,name:"Mozilla Firefox",key:"firefox"},{seq:70,name:"Opera",key:"opera"}],kl=[{seq:10,name:"Microsoft Windows",key:"windows nt"},{seq:20,name:"Android",key:"android"},{seq:30,name:"iOS",key:"iphone"},{seq:40,name:"iOS",key:"ipad"},{seq:50,name:"macOS",key:"mac os x"}],li=window.navigator.userAgent.toLowerCase();var ar;const bl=((ar=Cl.find(n=>li.indexOf(n.key)!==-1))==null?void 0:ar.name)??"Unknown Browser";var lr;const Mn=((lr=kl.find(n=>li.indexOf(n.key)!==-1))==null?void 0:lr.name)??"Unknown OS",Qs=li.indexOf("iphone")!==-1||Mn==="Android"&&li.indexOf("mobile")!==-1,El=li.indexOf("ipad")!==-1||Mn==="Android"&&!Qs,Jn=Qs?"Smart Phone":El?"Tablet Device":"PC",en={canDragElement:Jn==="PC",text:`${Jn} ${Mn} ${bl}`};class Dl{constructor(e){a(this,"onDuelUpdateEvent",new Te);a(this,"requireUpdate",()=>{this.onDuelUpdateEvent.trigger()});a(this,"onWaitStartEvent",new Te);a(this,"onWaitEndEvent",new Te);a(this,"onDragStartEvent",new Te);a(this,"onDragEndEvent",new Te);a(this,"onAnimationStartEvent",new Te);a(this,"onShowCardEntityEvent",new Te);a(this,"duel");a(this,"modalController");a(this,"_message");a(this,"waitMode");a(this,"infoBoardState");a(this,"infoBoardCell");a(this,"getCell",(e,t)=>this.duel.field.cells[e][t]);a(this,"showCardInfo",(e,t)=>{this.onShowCardEntityEvent.trigger({card:e,mode:t})});a(this,"dispose",()=>{this.onDragStartEvent.clear(),this.onDragEndEvent.clear(),this.onDuelUpdateEvent.clear(),this.onWaitStartEvent.clear(),this.onWaitEndEvent.clear()});a(this,"waitFieldAction",async e=>{if(this.duel.getTurnPlayer().duelistType==="NPC"){const s=this.duel.getTurnPlayer().selectActionForNPC(e,[]);return s?{actionInfo:s}:{phaseChange:this.duel.nextPhaseList[0]}}const t=await this._waitDuelistAction(this.duel.getTurnPlayer(),e,"Free","",void 0,void 0,!1);if(!t.actionInfo)return{...t,actionInfo:void 0};const i={...t.actionInfo},r=e.find(s=>{var l;return((l=t.actionInfo)==null?void 0:l.originSeq)===s.originSeq});if(!r)throw new le("想定されない状態",e,t);return{...t,actionInfo:{dest:i.dest,battlePosition:i.battlePosition,action:r.action,originSeq:r.originSeq}}});a(this,"waitQuickEffect",async(e,t,i,r,s)=>{if(t.length===0)return;if(e.duelistType==="NPC")return e.selectActionForNPC(t,i);const l=[];return l.push(this.modalController.actionSelector.show({title:r,activator:e,dummyActionInfos:t,cancelable:s}).then(o=>{if(o)return t.find(c=>c.originSeq===o.originSeq)})),l.push(this._waitDuelistAction(e,t,"Modal",this.message,void 0,void 0,!1).then(o=>(this.infoBoardState="Log",t.find(c=>{var d;return((d=o.actionInfo)==null?void 0:d.originSeq)===c.originSeq})))),await Promise.any(l)});a(this,"waitSubAction",async(e,t,i,r=!1)=>{if(e.duelistType==="NPC")throw Error("Not implemented");const s=await this._waitDuelistAction(e,t,"Modal",i,void 0,void 0,r);if(s&&s.actionInfo)return s.actionInfo});a(this,"waitSelectEntities",async(e,t,i)=>{if(!t.selectables.length)return;if(t.qty&&t.selectables.length===t.qty)return[...t.selectables];if(e.duelistType==="NPC")return Yn(t);let r;t.selectables.some(l=>l.entityType==="Duelist")&&(r={...t,selectables:t.selectables.filter(l=>l.entityType==="Duelist").map(l=>l.fieldCell),qty:1,validator:l=>l.length===1});const s=await this._waitDuelistAction(e,[],"Modal",i,t,r,t.cancelable);return[...s.selectedEntities??[],...(s.selectedCells??[]).flatMap(l=>l.entities).filter(l=>l.entityType==="Duelist")]});a(this,"waitSelectText",(e,t,i=!1)=>this.modalController.textSelector.show({title:t,choises:e,cancelable:i}));a(this,"waitAnimation",async e=>(this._message="",this.waitMode="Animation",this.onDuelUpdateEvent.trigger(),new Promise(t=>this.onAnimationStartEvent.trigger({...e,resolve:t}))));a(this,"setDraggingActions",e=>{this.onDragStartEvent.trigger(e),this.requireUpdate()});a(this,"removeDraggingActions",()=>{this.onDragEndEvent.trigger()});a(this,"waitSelectAction",async(e,t,i,r)=>{var c;const s=t.map(d=>Vt.createDummyAction(d.entity,d.title,[],void 0,d.origin)),l=await this._waitDammyAction(e,s,i,r);if(!l)return;const o=(c=t.find(d=>d.origin.seq===l.originSeq))==null?void 0:c.origin;if(!o)throw new le("想定されない状態",t,l);return o});a(this,"waitSelectSummonDestination",async(e,t,i,r,s)=>{const l=i.length>1&&en.canDragElement?"カードを召喚先へドラッグ。":"表示形式を選択。";if(!i.length&&!r.length){if(s)return;throw new le("想定されない状態",e,t,i,r,s)}let o=[...r];for(;;){const c={dest:i.randomPick(),battlePosition:o[0]};if(o.length===1&&!en.canDragElement){const f=await this.waitSelectCell(e,i,s,"召喚先を選択。");return f?{dest:f,battlePosition:r[0]}:void 0}const d=o.map(f=>Vt.createDummyAction(t,f,i,f)),u=await this._waitDammyAction(e,d,l,s);if(!u)return;if(u.battlePosition&&(o=[u.battlePosition]),!(i.length>1&&!u.dest))return c.dest=u.dest??c.dest,c.battlePosition=u.battlePosition??c.battlePosition,c}});a(this,"waitSelectDestination",async(e,t,i,r,s,l=!1)=>{if(!i.length)return;if(i.length===1)return i[0];if(!en.canDragElement)return await this.waitSelectCell(e,i,l,r);let o=i.randomPick();const c=[Vt.createDummyAction(t,s,i,void 0)],d=await this._waitDammyAction(e,c,r,l);if(d)return o=d.dest??o,o});a(this,"_waitDammyAction",async(e,t,i,r=!1)=>{if(!t.length)return;const s=t.randomPick();let l={...s,dest:s.dest??s.dests.randomPick()};if(e.duelistType!=="NPC"){const o=[this.modalController.actionSelector.show({title:i,activator:e,dummyActionInfos:t,cancelable:!1}),this.duel.view.waitSubAction(e,t,i,r)],c=await Promise.any(o);if(!c&&!r)throw new er(c,o);if(!c)return;l=c??l}return l});a(this,"waitSelectCell",async(e,t,i,r)=>t.length?e.duelistType==="NPC"?t.randomPick():(await this.waitSelectCells(e,{selectables:t,qty:1,validator:l=>l.length===1,cancelable:i},r)??[])[0]:void 0);a(this,"waitSelectCells",async(e,t,i)=>{if(!t.selectables.length)return;if(e.duelistType==="NPC")return Yn(t);const r=await this._waitDuelistAction(e,[],"Modal",i,void 0,t,t.cancelable);if((!r||!r.selectedCells)&&!t.cancelable)throw new er(e,t,i);return r.selectedCells});a(this,"_waitDuelistAction",async(e,t,i,r,s,l,o=!1)=>{this.waitMode=i,this._message=r,this.onDuelUpdateEvent.trigger();const c=Xs(),d={resolve:c.resolve,activator:e,dummyActionInfos:t,chainBlockInfos:e.duel.chainBlockInfos,entitiesChoices:s,cellsChoices:l};this.onWaitStartEvent.trigger(d);const u=await c.promise;if(this.modalController.terminateAll(),this.waitMode="None",this.onWaitEndEvent.trigger(),u.surrender)throw new Tt(e.getOpponentPlayer(),`${e.profile.name}がサレンダーした。`);if(!o&&u.cancel)throw new le("キャンセル不可のアクションがキャンセルされた。",u,t,i,s,l);return this.infoBoardState="Log",u});this.duel=e,this._message="",this.waitMode="None",this.infoBoardState="Log",this.infoBoardCell=e.duelists.Below.getExtraDeck(),this.modalController=new wl(this)}get onDuelUpdate(){return this.onDuelUpdateEvent.expose()}get onWaitStart(){return this.onWaitStartEvent.expose()}get onWaitEnd(){return this.onWaitEndEvent.expose()}get onDragStart(){return this.onDragStartEvent.expose()}get onDragEnd(){return this.onDragEndEvent.expose()}get onAnimation(){return this.onAnimationStartEvent.expose()}get onShowCardEntity(){return this.onShowCardEntityEvent.expose()}get message(){return this._message||this.duel.log.lastRecord.text}}const _n=["turn","phaseSeq","stepSeq","stageSeq","chainSeq","chainBlockSeq","procSeq"];[..._n];class Tl{constructor(){a(this,"onClockChangeEvents",{turn:new Te,phaseSeq:new Te,stepSeq:new Te,stageSeq:new Te,chainSeq:new Te,chainBlockSeq:new Te,procSeq:new Te});a(this,"_turn",0);a(this,"_phaseSeq",0);a(this,"_stepSeq",0);a(this,"_stageSeq",0);a(this,"_chainSeq",0);a(this,"_chainBlockSeq",0);a(this,"_procSeq",0);a(this,"_totalProcSeq",0);a(this,"_periodKey");a(this,"_previousStartPoints",{turn:0,phaseSeq:0,stepSeq:0,stageSeq:0,chainSeq:0,chainBlockSeq:0,procSeq:0});a(this,"_currentStartPoints",{turn:0,phaseSeq:0,stepSeq:0,stageSeq:0,chainSeq:0,chainBlockSeq:0,procSeq:0});a(this,"setPhase",(e,t)=>{const i=Object.values(Ft).filter(r=>r.phase===t).find(r=>(r.step??"start")==="start");if(!i)throw new le("想定されない状態",this.period,t,Ft);t==="draw"?(this.turn>0&&e.log.info("ターン終了。",e.getTurnPlayer()),this._turn++,this._phaseSeq=0):(e.log.info(`フェイズ移行（${this.period.name}→${i.name}）`,e.getTurnPlayer()),this._phaseSeq++),this._stepSeq=0,this._stageSeq=0,this.periodKey=i.key});a(this,"setStep",(e,t)=>{const i=this.period.phase,r=Object.values(Ft).filter(s=>s.phase===i).find(s=>(s.step??"")===t);if(!r)throw new le("想定されない状態",this.period,t,Ft);this.period.name!==r.name&&(e.log.info(`ステップ移行（${this.period.name}→${r.name}）`,e.getTurnPlayer()),this._stepSeq++,this._stageSeq=0,this.periodKey=r.key)});a(this,"setStage",(e,t)=>{const i=this.period,r=Object.values(Ft).filter(s=>s.phase===i.phase).filter(s=>s.step===i.step).find(s=>(s.stage??"")===t);if(!r)throw new le("想定されない状態",this.period,t,Ft);e.log.info(`タイミング移行（${this.period.name}→${r.name}）`,e.getTurnPlayer()),this._stageSeq++,this.periodKey=r.key});a(this,"incrementChainSeq",()=>{this._chainSeq++,this._chainBlockSeq=0,this._procSeq=0,this.incrementTotalProcSeq()});a(this,"incrementChainBlockSeq",()=>{this._chainBlockSeq++,this._procSeq=0,this.incrementTotalProcSeq()});a(this,"incrementProcSeq",()=>{this._procSeq++,this.incrementTotalProcSeq()});a(this,"incrementTotalProcSeq",()=>{this._totalProcSeq++;let e=!1;_n.toReversed().forEach(t=>{e&&(this._previousStartPoints[t]=this.currentStartPoints[t],this._currentStartPoints[t]=this.totalProcSeq),e=this[t]===0}),_n.toReversed().filter(t=>this._currentStartPoints[t]=this.totalProcSeq).filter(t=>t!=="procSeq").forEach(t=>this.onClockChangeEvents[t].trigger(this)),this.onClockChangeEvents.procSeq.trigger(this)});a(this,"toString",()=>`${this.totalProcSeq}(t${this.turn}-phs${this.phaseSeq}-stp${this.stepSeq}-stg${this.stepSeq}-c${this.chainSeq}-cb${this.chainBlockSeq}-prc${this.procSeq})`);a(this,"getClone",()=>({turn:this.turn,phaseSeq:this.phaseSeq,stepSeq:this.stepSeq,stageSeq:this.stageSeq,chainSeq:this.chainSeq,chainBlockSeq:this.chainBlockSeq,procSeq:this.procSeq,totalProcSeq:this.totalProcSeq,period:this.period}));a(this,"isSameTurn",e=>this.turn===e.turn);a(this,"isSameChain",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq&&this.chainSeq===e.chainSeq);a(this,"isPreviousChain",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq&&this.chainSeq===e.chainSeq+1);a(this,"isPreviousStage",e=>this.turn===e.turn&&this.phaseSeq===e.phaseSeq&&this.stepSeq===e.stepSeq&&this.stageSeq===e.stageSeq+1);a(this,"isPreviousTurn",e=>this.turn===e.turn+1);a(this,"isPreviousProc",e=>this.totalProcSeq===e.totalProcSeq+1);a(this,"isUponAttackDeclaration",()=>this.period.step==="battle"&&this.chainSeq===1);this._periodKey="end"}get onTurnChange(){return this.onClockChangeEvents.turn.expose()}get onStageChange(){return this.onClockChangeEvents.stageSeq.expose()}get onProcSeqChange(){return this.onClockChangeEvents.procSeq.expose()}get previousStartPoints(){return this._previousStartPoints}get currentStartPoints(){return this._currentStartPoints}set periodKey(e){this._periodKey!==e&&(this._periodKey=e,this._chainSeq=0,this._chainBlockSeq=0,this._procSeq=0,this.incrementTotalProcSeq())}get periodKey(){return this._periodKey}get period(){return Ft[this.periodKey]}get turn(){return this._turn}get phaseSeq(){return this._phaseSeq}get stepSeq(){return this._stepSeq}get stageSeq(){return this._stageSeq}get chainSeq(){return this._chainSeq}get chainBlockSeq(){return this._chainBlockSeq}get procSeq(){return this._procSeq}get totalProcSeq(){return this._totalProcSeq}get isFirstChain(){return this.chainSeq===0}}class Pl{constructor(e){a(this,"nextSeq");a(this,"records",[]);a(this,"duel");a(this,"push",e=>{this.records.push({seq:this.nextSeq++,clock:this.duel.clock.getClone(),chainBlockInfo:e})});this.nextSeq=0,this.duel=e}}const Al=["PlayFirst","DrawFirst","Random"],nu={PlayFirst:"先攻",DrawFirst:"後攻",Random:"ランダム"};class Tt extends Error{constructor(t,i){super(t?`デュエルが終了した。勝者：${t.profile.name}`:"デュエルが終了した。ドロー。");a(this,"winner");a(this,"message");this.winner=t,this.message=i}}class le extends Error{constructor(t,...i){super(t);a(this,"message");a(this,"items");this.message=t,this.items=i}}class er extends le{constructor(...e){super("キャンセル不可のアクションがキャンセルされた。",...e)}}class ru{constructor(e,t,i,r=[],s,l,o,c=[],d="Random"){a(this,"onDuelEndEvent",new Te);a(this,"view");a(this,"log");a(this,"chainBlockLog");a(this,"clock");a(this,"nextPhaseList");a(this,"field");a(this,"attackingMonster");a(this,"targetForAttack");a(this,"_chainBlockInfos");a(this,"duelists");a(this,"priorityHolder");a(this,"isEnded");a(this,"winner");a(this,"coin",!1);a(this,"startMode");a(this,"distributeOperators",e=>{console.info(`[totalProcSeq]:${e.totalProcSeq}`);let t=0;for(;;){if(t++,t>10)throw new le("無限ループ発生");if(this.field.procFilterPool.distributeAll(this)&&this.field.statusOperatorPool.distributeAll(this)&&this.field.numericStateOperatorPool.distributeAll(this)&&this.field.summonFilterPool.distributeAll(this))return}});a(this,"getTurnPlayer",()=>this.clock.turn%2===0?this.secondPlayer:this.firstPlayer);a(this,"getNonTurnPlayer",()=>this.clock.turn%2===0?this.firstPlayer:this.secondPlayer);a(this,"main",async()=>{console.info("main start!"),this.coin=this.startMode==="PlayFirst"?!0:this.startMode==="DrawFirst"?!1:Math.random()>.5,this.priorityHolder=this.firstPlayer;const e=Ol(...Object.values(this.duelists).flatMap(t=>t.deckInfo.cardNames).getDistinct()).reduce((t,i)=>(t[i.name]=i,{...t}),{});for(const t of Object.values(this.duelists))t.pushDeck(e),t.getDeckCell().shuffle(),t.initHand.length&&t.initHand.forEach(i=>{const r=t.getDeckCell().cardEntities.find(s=>s.origin.name===i);if(!r){this.log.info(`初手操作により${i}を手札に加えようとしたが、デッキに存在しない。`);return}r.addToHand(["System"],void 0,void 0),this.log.info(`初手操作により${r.toString()}を手札に加えた`,t)}),await t.draw(5-t.getHandCell().cardEntities.length,void 0,void 0);this.log.info(`【デュエル開始】${this.firstPlayer.profile.name} V.S. ${this.secondPlayer.profile.name}`),this.log.info(`先攻：${this.firstPlayer.profile.name} 後攻：${this.secondPlayer.profile.name}`),this.moveNextPhase("draw");try{for(const t of Object.values(this.duelists))for(const i of this.getEnableActions(t,["Exodia"],["Normal"],[]))await i.action.directExecute(t,void 0,!1);for(;!this.isEnded&&(this.clock.period.phase==="draw"?await this.procDrawPhase():this.phase==="standby"?await this.procStanbyPhase():this.phase==="main1"?await this.procMainPhase():this.phase==="battle1"?await this.procBattlePhase():this.phase==="battle2"?await this.procBattlePhase():this.phase==="main2"?await this.procMainPhase():this.phase==="end"&&await this.procEndPhase(),!(this.clock.turn>1e3)););}catch(t){t instanceof Tt?(this.clock.incrementChainSeq(),console.info(t),this.isEnded=!0,this.winner=t.winner,this.log.info(t.winner?`デュエル終了。勝者${t.winner.profile.name}。${t.message}`:`デュエル終了。引き分け。${t.message}`),this.onDuelEndEvent.trigger()):t instanceof Error&&this.log.error(t)}finally{this.log.dispose()}});a(this,"moveNextPhase",e=>{this.clock.setPhase(this,e),this.phase==="main2"||this.clock.turn===1?this.nextPhaseList=["end"]:this.phase==="battle1"||this.phase==="battle2"?this.nextPhaseList=["main2"]:this.phase==="main1"?this.nextPhaseList=["battle1","end"]:this.nextPhaseList=[]});a(this,"declareAnAttack",(e,t)=>{var r;this.attackingMonster=e,this.targetForAttack=t;let i=" ("+((r=t.battlePosition==="Attack"?t.atk:t.def)==null?void 0:r.toString())+")";t.face==="FaceDown"&&(i=" (????)"),t.entityType==="Duelist"&&(i=""),e.info.attackCount++,this.log.info(`攻撃宣言：${e.toString()} (${e.atk})⇒ ${t.toString()}${i}`,e.controller)});a(this,"procDrawPhase",async()=>{if(Object.values(this.duelists).forEach(e=>e.initForDrawPhase()),this.log.info("ドローフェイズ開始。",this.getTurnPlayer()),this.clock.turn===1)this.log.info("先攻プレイヤーはドローできない。",this.getTurnPlayer());else{await this.getTurnPlayer().draw(1,void 0,void 0);for(const e of this.getEnableActions(this.getTurnPlayer(),["Exodia"],["Normal"],[]))await e.action.directExecute(this.getTurnPlayer(),void 0,!1)}this.field.getCardsOnFieldStrictly().forEach(e=>e.initForTurn()),await this.procSpellSpeed1(),this.moveNextPhase("standby")});a(this,"procStanbyPhase",async()=>{await this.procSpellSpeed1(),this.moveNextPhase("main1")});a(this,"procMainPhase",async()=>{for(;;){this.priorityHolder=this.getTurnPlayer();const e=await this.view.waitFieldAction(this.getEnableActions(this.priorityHolder,["NormalSummon","SpellTrapSet","SpecialSummon","FlipSummon","ChangeBattlePosition","IgnitionEffect","QuickEffect","CardActivation"],["Normal","Quick","Counter"],[]));if(console.info("response",e),e&&e.actionInfo){if([...ql].includes(e.actionInfo.action.playType)){const i=await e.actionInfo.action.prepare(this.priorityHolder,e.actionInfo.dest,void 0,[],!0,!1);if(i===void 0)continue;await e.actionInfo.action.execute(i,this.chainBlockInfos),this.clock.incrementChainSeq()}else if(await this.procChainBlock({activator:this.priorityHolder,actionInfo:e.actionInfo},void 0)==="cancel")continue;await this.procFreeChain();continue}const t=e.phaseChange;if(t){this.priorityHolder=this.getNonTurnPlayer();let i="done";for(;;){const r=await this.view.waitQuickEffect(this.priorityHolder,this.getEnableActions(this.priorityHolder,["QuickEffect","TriggerEffect"],["Quick","Counter"],[]),[],"",!0);if(!r){this.moveNextPhase(t);return}if(i=await this.procChainBlock({activator:this.priorityHolder,actionInfo:r},void 0),i==="done")break}if(i==="done"){await this.procFreeChain();continue}}}});a(this,"procBattlePhase",async()=>{await this.procBattlePhaseStartStep(),await this.procBattlePhaseBattleStep(),await this.procBattlePhaseEndStep()});a(this,"procBattlePhaseStartStep",async()=>{this.clock.setStep(this,"start"),this.priorityHolder=this.getTurnPlayer(),this.attackingMonster=void 0,this.targetForAttack=void 0,await this.procSpellSpeed1()});a(this,"procBattlePhaseBattleStep",async()=>{for(;;){this.clock.setStep(this,"battle"),this.priorityHolder=this.getTurnPlayer();const e=await this.view.waitFieldAction(this.getEnableActions(this.priorityHolder,["Battle"],["Normal"],[]));if(e.phaseChange)break;if(e.actionInfo){const t=await e.actionInfo.action.prepare(this.priorityHolder,e.actionInfo.dest,void 0,[],!0,!1);if(!t)continue;await e.actionInfo.action.execute(t,[]),this.clock.incrementChainSeq();let i=!0;for(;;){const r=this.getNonTurnPlayer().getMonstersOnField().map(l=>[l.seq,l.moveLog.latestRecord.movedAt.totalProcSeq]);if(await this.procFreeChain(),!this.attackingMonster)throw new le("想定されない状態");this.attackingMonster.isOnFieldStrictly?this.attackingMonster.face==="FaceDown"?(this.log.info(`${this.attackingMonster.toString()}が裏側守備表示になったため、戦闘が中断された。`),i=!1):this.attackingMonster.orientation==="Horizontal"&&(this.log.info(`${this.attackingMonster.toString()}が守備表示になったため、戦闘が中断された。`),i=!1):(this.log.info(`${this.attackingMonster.toString()}がフィールドにいなくなったため、戦闘が中断された。`),i=!1);const s=this.getNonTurnPlayer().getMonstersOnField().map(l=>[l.seq,l.moveLog.latestRecord.movedAt.totalProcSeq]);if(r.length!==s.length)throw this.log.info("モンスターの数が増減したためバトルステップの巻き戻しが発生。"),new le("巻き戻し未実装");if(r.some(([l,o])=>s.every(([c,d])=>c!==l||d!==o)))throw this.log.info("モンスターの数が増減したためバトルステップの巻き戻しが発生。"),new le("巻き戻し未実装");break}if(!i)continue;await this.procBattlePhaseDamageStep(t)}}});a(this,"procBattlePhaseDamageStep",async e=>{if(!this.attackingMonster||!this.targetForAttack)throw new le("想定されない状態",this.attackingMonster,this.targetForAttack);if(this.targetForAttack.entityType!=="Duelist"&&!this.targetForAttack.isOnFieldAsMonsterStrictly)throw new le("想定されない状態",this.attackingMonster,this.targetForAttack);await this.procBattlePhaseDamageStep1(),await this.procBattlePhaseDamageStep2(this.attackingMonster,this.targetForAttack),await this.procBattlePhaseDamageStep3(e,this.attackingMonster,this.targetForAttack),await this.procBattlePhaseDamageStep4(),await this.procBattlePhaseDamageStep5()});a(this,"procBattlePhaseDamageStep1",async()=>{this.clock.setStage(this,"start"),await this.procFreeChain()});a(this,"procBattlePhaseDamageStep2",async(e,t)=>{this.clock.setStage(this,"beforeDmgCalc"),(t==null?void 0:t.battlePosition)==="Set"&&t.setBattlePosition("Defense",["Flip","FlipByBattle"],e,e.controller),await this.procFreeChain()});a(this,"procBattlePhaseDamageStep3",async(e,t,i)=>{if(t.atk===void 0)throw new le("想定されない状態",this.attackingMonster,this.targetForAttack);this.clock.setStage(this,"dmgCalc"),await this.procFreeChain();const r=t.atk,s=(i.battlePosition==="Attack"?i.atk:i.def)??0;i.entityType==="Duelist"?(e.activator.writeInfoLog(`ダメージ計算：${t.toString()} (${r}) ⇒ ${i.toString()}`),t.controller.getOpponentPlayer().battleDamage(r-s,t)):(e.activator.writeInfoLog(`ダメージ計算：${t.toString()} (${r}) ⇒ ${i.toString()} (${s})`),r>0&&r>s&&i.battlePosition==="Attack"?t.controller.getOpponentPlayer().battleDamage(r-s,t):r<s&&t.controller.battleDamage(s-r,i),r>0&&(r>s||r===s&&i.battlePosition==="Attack")&&await Ge.tryMarkForDestory([i],e),i.battlePosition==="Attack"&&r<=s&&await Ge.tryMarkForDestory([t],e)),t.info.battleLog.push({enemy:i,timestamp:this.clock.getClone()}),i.info.battleLog.push({enemy:t,timestamp:this.clock.getClone()});const l=Object.values(this.duelists).filter(o=>o.lp<=0);if(l.length)throw l.length===1?new Tt(l[0].getOpponentPlayer(),"戦闘ダメージによって、相手のライフポイントをゼロにした。"):new Tt(void 0,"戦闘ダメージによって、お互いのライフポイントがゼロになった。")});a(this,"procBattlePhaseDamageStep4",async()=>{this.clock.setStage(this,"afterDmgCalc"),await this.procFreeChain()});a(this,"procBattlePhaseDamageStep5",async()=>{this.clock.setStage(this,"end"),await Ge.waitCorpseDisposal(this),this.clock.incrementChainSeq(),await this.procFreeChain()});a(this,"procBattlePhaseEndStep",async()=>{this.clock.setStep(this,"end"),this.priorityHolder=this.getTurnPlayer(),await this.procSpellSpeed1(),this.moveNextPhase("main2")});a(this,"procEndPhase",async()=>{for(await this.procSpellSpeed1();;){const t=this.getTurnPlayer().getHandCell().cardEntities.length;if(t<7)break;await this.getTurnPlayer().discard(t-6,["Rule"])}this.moveNextPhase("draw")});a(this,"procSpellSpeed1",async()=>{this.priorityHolder=this.getTurnPlayer();let e=0;const t={Above:Number.MAX_VALUE,Below:Number.MAX_VALUE};for(;Object.values(t).some(i=>i!==0);){const i=this.getEnableActions(this.priorityHolder,["IgnitionEffect","QuickEffect","CardActivation","LingeringEffect"],["Normal","Quick","Counter"],[]);t[this.priorityHolder.seat]=i.filter(o=>o.action.isMandatory).length;const r=i.find(o=>o.action.isMandatory);let s=r?{action:r.action,originSeq:r.action.seq}:void 0,l=!s;if(this.priorityHolder.isTurnPlayer?e===0&&(l=!0):t[this.priorityHolder.getOpponentPlayer().seat]>=0&&(l=!0),i.length&&(i.length>1||!s)&&(s=await this.view.waitQuickEffect(this.priorityHolder,i,[],l?"":"まだ発動しなければならない効果が残っている。",l)),s){if(qn.some(o=>o===s.action.playType))await this.procChainBlock({activator:this.priorityHolder,actionInfo:s},void 0);else{const o=await s.action.prepare(this.priorityHolder,void 0,void 0,[],!0,!1);if(!o)continue;await s.action.execute(o,[]),await s.action.settle(o,[]),this.clock.incrementChainSeq()}await this.procFreeChain(),this.priorityHolder=this.getTurnPlayer(),e=0;continue}this.priorityHolder=this.priorityHolder.getOpponentPlayer(),e++}});a(this,"procFreeChain",async()=>{for(;await this.procChainBlock(void 0,void 0)!=="pass";);});a(this,"procChainBlock",async(e,t)=>{const i=this.chainBlockInfos.length===0;let r=e?[]:t??Object.values(this.duelists).flatMap(l=>this.getEnableActions(l,["TriggerEffect"],[this.chainBlockInfos.length?"Quick":"Normal"],this.chainBlockInfos).map(o=>({activator:l,actionInfo:o,targetChainBlock:this.chainBlockInfos.slice(-1)[0]}))),s;if(e)s={activator:e.activator,action:e.actionInfo.action,dest:e.actionInfo.dest,targetChainBlock:void 0},this.priorityHolder=s.activator;else if(r.length>0){const l=await this.selectTriggerEffect(r);l?(r=r.filter(o=>o!==l),s={...l,action:l.actionInfo.action},this.priorityHolder=s.activator):r=[]}if(!s){let l=0;for(;l<2;){this.priorityHolder=this.priorityHolder.getOpponentPlayer();const o=["Counter"];this.chainBlockInfos.every(u=>u.action.spellSpeed!=="Counter")&&o.push("Quick");const c=this.chainBlockInfos.length?"※メッセージ考え中※":"クイックエフェクト発動タイミング。効果を発動しますか？",d=await this.view.waitQuickEffect(this.priorityHolder,this.getEnableActions(this.priorityHolder,["QuickEffect","CardActivation"],o,this.chainBlockInfos),this.chainBlockInfos,c,!0);if(d){s={...d,activator:this.priorityHolder,targetChainBlock:this.chainBlockInfos.slice(-1)[0]};break}l++}}if(console.info("selected action: ",s),s){const l=s.activator,o=await s.action.prepare(l,s.dest,s.targetChainBlock,this.chainBlockInfos,i,!1);if(!o)return"cancel";this.chainBlockLog.push(o);const c=[...o.action.entity.info.isEffectiveIn];if(this._chainBlockInfos.push(o),this.clock.incrementProcSeq(),this.clock.incrementChainBlockSeq(),r=r.filter(d=>d.actionInfo.action.seq!==(s==null?void 0:s.action.seq)).filter(d=>d.actionInfo.action.validateCount(d.activator,this.chainBlockInfos)),await this.procChainBlock(void 0,r.length?r:void 0),o.chainNumber&&this.log.info(`チェーン${o.chainNumber}: ${o.action.toString()}の効果処理。`,l),o.isNegatedActivationBy)o.chainNumber&&this.log.info(`チェーン${o.chainNumber}: ${o.action.toString()}を${o.isNegatedActivationBy.toString()}によって発動を無効にした。`,o.activator);else{let d=o.action.entity.isEffective,u="";if(d){if(o.isNegatedEffectBy)u=`チェーン${o.chainNumber}: ${o.action.toString()}を${o.isNegatedEffectBy.toString()}によって効果を無効にした。`,d=!1;else if(!c.includes(o.isActivatedIn.cellType)){const f=o.action.entity.moveLog.records.findLast(v=>v.face==="FaceDown"&&v.orientation==="Horizontal");d=(f&&this.clock.isSameChain(f.movedAt))??!1}}if(d?(await o.action.execute(o,this.chainBlockInfos),o.state="done"):(o.state="failed",o.chainNumber&&(u=u||`チェーン${o.chainNumber}: カードの効果が無効となっているため${o.action.toString()}の効果処理を行えない。`),this.log.info(u,o.activator)),await s.action.settle(o,this.chainBlockInfos),o.state==="done")for(const f of[this.getTurnPlayer(),this.getNonTurnPlayer()]){for(const v of this.getEnableActions(f,["Exodia"],["Normal"],[o]))await v.action.directExecute(f,o,!1);for(const v of this.getEnableActions(f,["AfterChainBlock"],["Normal"],[o])){await v.action.directExecute(f,o,!1);for(const _ of this.getEnableActions(f,["Exodia"],["Normal"],[o]))await _.action.directExecute(f,o,!1)}}}i?(await Ge.sendManyToGraveyardForTheSameReason(this._chainBlockInfos.filter(d=>d.action.playType==="CardActivation").filter(d=>!d.action.isLikeContinuousSpell).map(d=>d.action.entity).filter(d=>d.isOnFieldStrictly).filter(d=>d.face==="FaceUp"),["Rule"],void 0,void 0),this._chainBlockInfos.reset(),o.nextActionInfo&&await this.procChainBlock({activator:o.activator,actionInfo:o.nextActionInfo},void 0),this.clock.incrementChainSeq()):(o.nextActionInfo&&await o.nextActionInfo.action.directExecute(o.activator,void 0,!1),this.clock.incrementChainBlockSeq())}return s?"done":"pass"});a(this,"selectTriggerEffect",async e=>{if(e.length>0)for(const t of[!0,!1])for(const i of[this.getTurnPlayer(),this.getNonTurnPlayer()]){const r=e.filter(l=>l.actionInfo.action.isMandatory===t&&l.activator===i);if(r.length===0)continue;if(r.length===1&&t)return r[0];const s=await this.view.waitQuickEffect(i,r.map(l=>l.actionInfo),this.chainBlockInfos,"トリガーエフェクトを選択。",!t);if(s)return r.find(l=>l.actionInfo.action===s.action)}});a(this,"executeSystemPeriodActions",()=>{Object.values(this.duelists).flatMap(e=>this.getEnableActions(e,["SystemPeriodAction"],["Normal"],[]).map(t=>({duelist:e,action:t})))});a(this,"getEnableActions",(e,t,i,r)=>{var l;const s=((l=r.slice(-1)[0])==null?void 0:l.nextChainBlockFilter)??(()=>!0);return[...this.field.getAllCardEntities(),e.entity].flatMap(o=>o.actions).filter(o=>o.executableCells.includes(o.entity.fieldCell.cellType)).filter(o=>o.executablePeriods.includes(this.clock.period.key)).filter(o=>i.includes(o.spellSpeed)).filter(o=>o.validateDuelist(e)).filter(o=>t.includes(o.playType)).filter(o=>s(e,o)).map(o=>o.validate(e,r,!1)).filter(o=>o!==void 0)});this.clock=new Tl,this.nextPhaseList=[],this.isEnded=!1,this.startMode=d,this.duelists={Below:new Fi(this,"Below",e,t,i,r),Above:new Fi(this,"Above",s,l,o,c)},this.priorityHolder=this.firstPlayer,this._chainBlockInfos=[],this.field=new ml(this),this.clock.onProcSeqChange.append(this.distributeOperators),this.clock.onStageChange.append(this.executeSystemPeriodActions),this.view=new Dl(this),this.log=new yl(this),this.chainBlockLog=new Pl(this)}get onDuelEnd(){return this.onDuelEndEvent.expose()}get phase(){return this.clock.period.phase}get step(){return this.clock.period.step}get stage(){return this.clock.period.stage}get chainBlockInfos(){return this._chainBlockInfos}get firstPlayer(){return this.coin?this.duelists.Below:this.duelists.Above}get secondPlayer(){return this.coin?this.duelists.Above:this.duelists.Below}}const We=class We{constructor(e){a(this,"id");a(this,"name");a(this,"description");a(this,"previousNpcId");a(this,"previousNpcDeckId");a(this,"previousStartMode");a(this,"save",async e=>{console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER);const t=e??{id:this.id,name:this.name,description:this.description,previousNpcId:this.previousNpcId,previousStartMode:this.previousStartMode,previousNpcDeckId:this.previousNpcDeckId>-1?this.previousNpcDeckId:Number.MIN_SAFE_INTEGER};console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER,t);const i=await We.tblHeader.update(this.id,r=>({...r,...t}));return console.log(this.previousNpcDeckId,Number.MIN_SAFE_INTEGER,t,i),new We(i)});var t;this.id=e.id,this.name=e.name,this.description=e.description,this.previousNpcId=((t=ir.find(i=>i.id===e.previousNpcId))==null?void 0:t.id)??fn(...ir.map(i=>i.id)),this.previousStartMode=Al.includes(e.previousStartMode)?e.previousStartMode:"Random",this.previousNpcDeckId=e.previousNpcDeckId}get npcLvl(){return Number.MAX_VALUE}};a(We,"tblHeader"),a(We,"getOrCreateNew",async e=>{We.tblHeader||(We.tblHeader=new Fl(e));const t=await We.tblHeader.getAll();if(t.length)return console.log(t[0].previousNpcDeckId),new We(t[0]);const i=await We.tblHeader.insert({name:"あなた",description:"ここの文字列を何に使うかは未定。",previousNpcId:0,previousNpcDeckId:Number.MIN_SAFE_INTEGER,previousStartMode:"Random"});return new We(i)});let tr=We;class Fl extends An{constructor(t){super(t,"TblDuelistProfile");a(this,"_prepareInitialRecords",()=>[])}}let tn=-1;const ir=[{id:tn--,name:"サンドバッグくん棒立ち",description:"攻撃宣言なし、強制効果以外の効果の発動なし。",npcLvl:0},{id:tn--,name:"サンドバッグくん非暴力",description:"攻撃宣言なし。",npcLvl:100},{id:tn--,name:"サンドバッグくん白帯",description:"とくに制限なし。",npcLvl:200}],Bi=class Bi{constructor(e,t,i,r,s,l=[]){a(this,"duel");a(this,"seat");a(this,"_entity");a(this,"profile");a(this,"deckInfo");a(this,"info");a(this,"infoOrigin");a(this,"status");a(this,"statusOrigin");a(this,"duelistType");a(this,"lifeLog");a(this,"actionBlackListForNPC");a(this,"_lp");a(this,"initHand");a(this,"writeInfoLog",e=>{this.duel.log.info(e,this)});a(this,"initForDrawPhase",()=>{this.info={...this.infoOrigin}});a(this,"canDiscard",e=>(console.log(e),!0));a(this,"canSendToGraveyard",e=>(console.log(e),!0));a(this,"canRelease",e=>(console.log(e),!0));a(this,"canTryBanish",(e,t,i)=>this.entity.procFilterBundle.effectiveOperators.filter(r=>r.procTypes.includes(t)).every(r=>r.filter(this,this.entity,i,[e])));a(this,"battleDamage",(e,t)=>this.setLp(this._lp-e,t,"BattleDamage"));a(this,"effectDamage",(e,t)=>this.setLp(this._lp-e,t,"EffectDamage"));a(this,"lostLp",(e,t)=>this.setLp(this._lp-e,t,"Lost"));a(this,"payLp",(e,t)=>this.setLp(this._lp-e,t,"Pay"));a(this,"heal",(e,t)=>this.setLp(this._lp+e,t,"Heal"));a(this,"setLp",(e,t,i)=>{const r={clock:this.duel.clock.getClone(),reason:i||"Set",beforeLp:this._lp,afterLp:e,entity:t};return this.lifeLog.push(r),this._lp=e,this.writeInfoLog(`ライフポイント変動：${r.afterLp-r.beforeLp}（${r.beforeLp} ⇒ ${r.afterLp}）`),r});a(this,"getOpponentPlayer",()=>this.duel.firstPlayer===this?this.duel.secondPlayer:this.duel.firstPlayer);a(this,"getHandCell",()=>this.duel.field.getCells("Hand").filter(e=>e.owner===this)[0]);a(this,"getDeckCell",()=>this.duel.field.getCells("Deck").filter(e=>e.owner===this)[0]);a(this,"getExtraDeck",()=>this.duel.field.getCells("ExtraDeck").filter(e=>e.owner===this)[0]);a(this,"getGraveyard",()=>this.duel.field.getCells("Graveyard").filter(e=>e.owner===this)[0]);a(this,"getFieldZone",()=>this.duel.field.getCells("FieldSpellZone").filter(e=>e.owner===this)[0]);a(this,"getBanished",()=>this.duel.field.getCells("Banished").filter(e=>e.owner===this)[0]);a(this,"getMonsterZones",()=>this.duel.field.getCells("MonsterZone").filter(e=>e.owner===this));a(this,"getExtraMonsterZones",()=>this.duel.field.getCells("ExtraMonsterZone").filter(e=>{var t;return((t=e.cardEntities[0])==null?void 0:t.controller)===this}));a(this,"getSpellTrapZones",()=>this.duel.field.getCells("SpellAndTrapZone").filter(e=>e.owner===this));a(this,"getXyzMaterialZone",()=>this.duel.field.getCells("XyzMaterialZone").filter(e=>e.owner===this)[0]);a(this,"getEmptyMonsterZones",()=>this.getMonsterZones().filter(e=>e.cardEntities.length===0));a(this,"getEmptyExtraZones",()=>this.getExtraMonsterZones().length===0?this.getMonsterZones().filter(e=>e.cardEntities.length===0):[]);a(this,"getAvailableMonsterZones",()=>this.getMonsterZones().filter(e=>e.isAvailable));a(this,"getAvailableExtraZones",()=>this.getExtraMonsterZones().length===0?this.duel.field.getCells("ExtraMonsterZone").filter(e=>e.isAvailable):[]);a(this,"getAvailableSpellTrapZones",()=>this.getSpellTrapZones().filter(e=>e.isAvailable));a(this,"getReleasableMonsters",()=>this.getMonstersOnField());a(this,"getMonstersOnField",()=>this.duel.field.getMonstersOnFieldStrictly().filter(e=>e.controller===this));a(this,"getSpellTrapsOnField",()=>this.duel.field.getSpellTrapsOnFieldStrictly().filter(e=>e.controller===this));a(this,"getPendingMonstersOnField",()=>this.duel.field.getPendingMonstersOnField().filter(e=>e.controller===this));a(this,"getPendulumScaleMonsters",()=>this.duel.field.getCardsOnFieldStrictly().filter(e=>e.isPendulumScale).filter(e=>e.controller===this));a(this,"getPendulumScales",()=>{const e=this.getPendulumScaleMonsters();if(e.length<2)return;const t=e.find(l=>l.fieldCell.column===(this.seat==="Below"?1:5)),i=e.find(l=>l.fieldCell.column===(this.seat==="Below"?5:1));if(!t||!i)throw new le("想定されない状態",e);const r=t.psR,s=i.psL;if(r===void 0||s===void 0)throw new le("想定されない状態",e);return r>s?{upperBound:r,lowerBound:s}:{upperBound:s,lowerBound:r}});a(this,"getEntiteisOnField",()=>this.duel.field.getCardsOnFieldStrictly().filter(e=>e.controller===this));a(this,"pushDeck",e=>{this.deckInfo.cardNames.map(t=>e[t]).filter(t=>t).forEach(t=>ne.createCardEntity(this,t)),this.duel.log.info(`デッキをセット。メイン${this.getDeckCell().cardEntities.length}枚。エクストラ${this.getExtraDeck().cardEntities.length}枚。`,this)});a(this,"draw",async(e,t,i)=>{var l;if(e<1)return;const r=this.getDeckCell(),s=[];this.writeInfoLog(`デッキからカードを${e}枚ドロー。`);for(const o of Array(e)){if(!r.cardEntities.length)throw this.writeInfoLog(s.length>0?`デッキからカードを${e}枚ドローしようとしたが、${s.length}枚しかドローできなかった。${s}`:"デッキからカードをドローできなかった。"),this.duel.isEnded=!0,this.setLp(0),new Tt(this.getOpponentPlayer(),"対戦相手がデッキからカードをドローできなかった。");const c=r.cardEntities[0];await c.draw(t?["Effect"]:["Rule"],t,i),s.push(((l=c.origin)==null?void 0:l.name)||"!名称取得失敗!")}});a(this,"summon",async(e,t,i,r,s,l,o,c)=>(await this.summonMany(this,e,t,i,[{monster:r,posList:s,cells:l}],o,!1,1,u=>u.length===1,c)??[])[0]);a(this,"waitSelectEntities",(e,t,i,r,s=!1)=>this.duel.view.waitSelectEntities(this,{selectables:e,qty:t,validator:i,cancelable:s},r));a(this,"waitSelectEntity",async(e,t,i=!1)=>{const r=await this.waitSelectEntities(e,1,s=>s.length===1,t,i);return r?r[0]:void 0});a(this,"discard",async(e,t,i,r,s,l)=>{const o=s||(()=>!0),c=this.getHandCell().cardEntities.filter(o);if(c.length<e)return[];let d=[];return(r||this).duelistType==="NPC"?d=c.randomPickMany(e):d=await this.duel.view.waitSelectEntities(r||this,{selectables:c,qty:e,validator:u=>u.length===e,cancelable:!1},`${e}枚カードを捨てる。`)||[],this.writeInfoLog(`手札からカードを${d.length}枚捨てた。${d.map(u=>{var f;return(f=u.origin)==null?void 0:f.name})}。`),await Ge.discardManyForTheSameReason(d,["Discard",...t],i,l),d});a(this,"getEnableSummonList",(e,t,i,r,s,l,o)=>{const c=this.duel.field.getCells("ExtraMonsterZone"),d=c.filter(f=>!l.map(v=>v.material).includes(f.cardEntities[0])).filter(f=>f.owner===this),u=[];return d.length&&u.push(...c.filter(f=>!d.includes(f)).filter(f=>f.isAvailable)),s.map(f=>({...f,summoner:this})).map(f=>{var v;return(t!=="LinkSummon"||!this.duel.field.canExtraLink(f.monster,l))&&(f.cells=f.cells.filter(_=>!u.includes(_))),(v=f.monster.status.monsterCategories)!=null&&v.includes("Link")&&(f.posList=f.posList.filter(_=>_==="Attack")),f}).map(f=>({...f,cells:f.cells.filter(v=>v.cardEntities.length===0||l.some(_=>_.material===v.cardEntities[0]))})).map(f=>{var v;return f.monster.fieldCell.cellType!=="ExtraDeck"?{...f,cells:f.cells.filter(_=>_.cellType!=="ExtraMonsterZone")}:(v=f.monster.status.monsterCategories)!=null&&v.includes("Link")||t==="PendulumSummon"?{...f,cells:f.cells.filter(_=>_.cellType==="ExtraMonsterZone"||_.linkArrowSources.filter(g=>!l.map(S=>S.material).includes(g)).length)}:f}).filter(f=>f.cells.length&&f.posList.length).map(f=>this.entity.summonFilterBundle.filter(e,t,i,r,f,l,o)).filter(f=>f.cells.length&&f.posList.length).map(f=>f.monster.summonFilterBundle.filter(e,t,i,r,f,l,o)).filter(f=>f.cells.length&&f.posList.length).map(f=>l.map(v=>v.material.summonFilterBundle).reduce((v,_)=>_.filter(e,t,i,r,v,l,o),f)).filter(f=>f.cells.length&&f.posList.length)});a(this,"prepareToSummonMany",async(e,t,i,r,s,l,o,c,d,u,f="特殊召喚するモンスターを選択。")=>{const v=this.getEnableSummonList(e,t,i,r,s,l,o);if(!v.length)return[];let _=v.map(S=>S.monster);(s.length!==1||d([]))&&(_=await this.duel.view.waitSelectEntities(this,{selectables:_,qty:c,validator:d,cancelable:u},f)??[]);const g=[];for(const S of v.filter(p=>_.includes(p.monster))){const p=S.cells.filter(b=>!g.map(P=>P.dest).includes(b));if(!p.length)continue;let k=[...S.posList].randomPick(),w=p.randomPick();if((p.length>1||S.posList.length>1)&&this.duelistType!=="NPC"){const b=await this.duel.view.waitSelectSummonDestination(S.summoner,S.monster,p,S.posList,u);if(!b)return[];w=b.dest,k=b.battlePosition}g.push({summoner:this,monster:S.monster,pos:k,dest:w})}return g});a(this,"summonAll",(e,t,i,r,s,l,o,c,d)=>this.summonMany(e,t,i,r,s,l,o,s.length,u=>u.length===s.length,c,d));a(this,"summonOne",(e,t,i,r,s,l,o,c,d)=>this.summonMany(e,t,i,r,s,l,o,1,u=>u.length===1,c,d));a(this,"summonMany",(e,t,i,r,s,l,o,c,d,u,f)=>Bi.summonMany(e,t,i,r,s.map(v=>({...v,summoner:this})),l,o,c,d,u,f));a(this,"selectAttackTargetForNPC",(e,t)=>{const i=e.atk??0,r=e.getAttackTargets();if(!r.length)return;const s=r.find(l=>l.entityType==="Duelist");return s&&(i>=fn(1600,this.getOpponentPlayer().lp)||e.info.battlePotisionChangeCount>0)?s:r.find(l=>l.battlePosition==="Attack"?i>=(l.atk??0):i<(l.battlePosition==="Set"?1e3:l.def??0)?!1:l.validateDestory("BattleDestroy",this,e,t))});a(this,"selectActionForNPC",(e,t)=>{if(!e.length)return;const i=e.filter(p=>p.action.isMandatory);if(i.length)return i.randomPick();let r=e.filter(p=>!this.actionBlackListForNPC.includes(p.action.playType));const s=r.filter(p=>!Number.isNaN(p.action.priorityForNPC)).shuffle().sort((p,k)=>p.action.priorityForNPC-k.action.priorityForNPC);if(s.length)return s[0];const l=r.filter(p=>p.action.playType==="TriggerEffect");if(l.length)return l.randomPick();if(this.duel.phase!=="main1"&&this.duel.phase!=="main2"){const p=r.filter(k=>k.action.playType==="IgnitionEffect");if(p.length)return p.randomPick()}const o=r.filter(p=>p.action.playType==="Battle").sort((p,k)=>(p.action.entity.atk??0)-(k.action.entity.atk??0));if(o.length)return o.find(p=>this.selectAttackTargetForNPC(p.action.entity,p.action));r=r.filter(p=>p.action.playType!=="Battle");const c=r.length?t.slice(-1)[0]:void 0,d=r.filter(p=>p.action.negatePreviousBlock);if(c&&c.activator!==this&&d)return d.randomPick();if(r=r.filter(p=>!p.action.negatePreviousBlock),!r.length)return;const u=Pi(...this.getOpponentPlayer().getMonstersOnField().filter(p=>p.battlePosition==="Attack").map(p=>p.atk??0),1600),f=fn(...this.getOpponentPlayer().getMonstersOnField().map(p=>p.battlePosition==="Set"?1500:(p.battlePosition==="Attack"?p.atk:p.def)??0),1500),v=this.getMonstersOnField(),_=Pi(...v.filter(p=>p.battlePosition==="Attack").map(p=>p.atk??0),0);let g=r.filter(p=>p.action.playType!=="ChangeBattlePosition").filter(p=>p.action.entity.battlePosition!=="Attack").filter(p=>(p.action.entity.atk??0)>=u||(p.action.entity.atk??0)>f&&(p.action.entity.atk??0)>2300);if(g.length)return g.randomPick();r=r.filter(p=>p.action.playType!=="ChangeBattlePosition").filter(p=>p.action.playType!=="SpellTrapSet").filter(p=>p.action.entity.actions.filter(k=>k.playType!=="NormalSummon"&&k.playType!=="SpecialSummon").flatMap(k=>k.executableCells).every(k=>k!=="Hand")||p.action.playType!=="NormalSummon"&&p.action.playType!=="SpecialSummon");const S=[...r.filter(p=>p.action.playType==="NormalSummon").filter(p=>(p.action.entity.lvl??12)<5),...r.filter(p=>p.action.playType==="SpecialSummon"),...r.filter(p=>p.action.playType==="NormalSummon").filter(p=>(p.action.entity.atk??0)>2600||(p.action.entity.atk??0)>2300&&(p.action.entity.lvl??12)<7).filter(p=>(p.action.entity.atk??0)>=_),...r.filter(p=>p.action.entity.face==="FaceUp").filter(p=>p.action.entity.isOnFieldStrictly)];if(S.length)return S.randomPick();if(r=r.filter(p=>p.action.playType!=="NormalSummon").filter(p=>p.action.playType!=="SpecialSummon"),this.duel.phase==="main2"){if(g=e.filter(p=>p.action.playType==="ChangeBattlePosition").filter(p=>p.action.entity.battlePosition==="Attack").filter(p=>(p.action.entity.atk??0)<u||(p.action.entity.atk??0)>f&&(p.action.entity.atk??0)>2300),g.length)return g.randomPick();if(this.getAvailableSpellTrapZones.length>1)return e.filter(p=>p.action.playType==="SpellTrapSet").filter(p=>p.action.entity.kind!=="Spell"||p.action.entity.status.spellCategory==="QuickPlay").randomPick()}if(Math.random()<r.length/4)return r.randomPick()});this.duel=e,this.seat=t,this.profile=i,this.duelistType=r,this.deckInfo=s,this.initHand=l,this.lifeLog=[],this.infoOrigin={maxRuleNormalSummonCount:1,ruleNormalSummonCount:0,ruleNormalSummonCountQty:0,effectNormalSummonCount:0,effectNormalSummonCountQty:0,specialSummonCount:0,specialSummonCountQty:0},this.info={...this.infoOrigin},this.statusOrigin={maxSpecialSummonCount:Number.MAX_VALUE,canDrawByEffect:!0,canSearchFromDeck:!0,canDiscardAsCost:!0,canDiscardAsEffect:!0},this.status={...this.statusOrigin},this._lp=8e3;const o=[];this.duelistType==="NPC"&&(this.profile.npcLvl<1&&o.push("CardActivation","IgnitionEffect","TriggerEffect","QuickEffect"),this.profile.npcLvl<101&&o.push("Battle")),this.actionBlackListForNPC=o}get entity(){const e=this.getHandCell().entities.find(t=>t.entityType==="Duelist");return e||ne.createPlayerEntity(this)}get lp(){return this._lp}get isTurnPlayer(){return this.duel.getTurnPlayer()===this}get canDraw(){return!0}get canAddToHandFromDeck(){return!0}};a(Bi,"summonMany",async(e,t,i,r,s,l,o,c,d,u,f="特殊召喚するモンスターを選択。")=>{const v=s.map(g=>g.summoner).getDistinct(),_=[];for(const g of v){const S=await g.prepareToSummonMany(e,t,i,r,s.filter(p=>p.summoner===g),l,o,c,d,u,f);_.push(...S)}if(_.length)return _.forEach(g=>g.monster.info.materials.reset(...l)),await Ge.moveToXyzOwner(_[0].dest,l.map(g=>g.material).filter(g=>g.kind==="XyzMaterial"),["XyzMaterial","Rule"],_[0].monster,e),await ne.summonMany(_,t,i,r.entity,e),_.map(g=>g.monster)});let Fi=Bi;const Ml=["NormalSummon","SpecialSummon","FlipSummon"],qn=["IgnitionEffect","TriggerEffect","QuickEffect","CardActivation"],ql=["ChangeBattlePosition","Battle","SpellTrapSet","LingeringEffect"],xl=n=>n==="CardActivation"?"CardActivation":qn.some(e=>e===n)?"EffectActivation":"NonActivate",nr=["NormalSummon","AdvanceSummon","SpecialSummon","SpecialSummonFromDeck","SendToGraveyardFromDeck","Draw","SearchFromDeck","BanishFromDeck","BanishFromGraveyard","AddToHandFromGraveyard","ReturnToDeckFromGraveyard","SpecialSummonFromGraveyard","SpecialSummonFromBanished","ReturnToHandFromGraveyard","ReturnToHandFromField","BanishFromField","BanishFromHand","Destroy","DestroyMultiple","DestroyOnField","DestroyMultipleOnField","DestroyOnOpponentField","DestroyMultipleOnOpponentField","DestroyMonsterOnField","DestroyMonstersOnField","DestroySpellTrapOnField","DestroySpellTrapsOnField","SpecialSummonFromHand","SpecialSummonFromExtraDeck","IfNormarlSummonSucceed","IfSpecialSummonSucceed","DamageToOpponent","DamageToSelf","PayLifePoint","DiscordAsCost","DiscordAsEffect","RollDice","BounceToHand","NegateCardEffect","NegateCardActivation","NegateNormalSummon","NegateSpecialSummon"],Mt=class Mt extends Ai{constructor(t,i,r,s){super(t,i,r);a(this,"toString",()=>this.isWithChainBlock&&this.playType!=="CardActivation"?`${this.entity.toString()}の«${this.title}»`:`${this.entity.toString()}の${this.title}`);a(this,"addhocMaterialLimitation");a(this,"getClone",t=>new Mt(this.seq,this.entity,this.definition,t));a(this,"getEnableMaterialPatterns",t=>{var i,r;return((r=(i=this.definition).getEnableMaterialPatterns)==null?void 0:r.call(i,t).filter(this.addhocMaterialLimitation))??[]});a(this,"validateCount",(t,i)=>{const r=i.filter(l=>this.isSameGroup(l.action)).length;if(this.isOnlyNTimesPerDuel>0&&this.entity.field.duel.chainBlockLog.records.filter(l=>!l.chainBlockInfo.isNegatedActivationBy).filter(l=>this.isSameGroup(l.chainBlockInfo.action)).filter(l=>l.chainBlockInfo.activator===t).length+r>=this.isOnlyNTimesPerDuel||this.isOnlyNTimesPerTurn>0&&this.entity.field.duel.chainBlockLog.records.filter(l=>!l.chainBlockInfo.isNegatedActivationBy).filter(l=>this.isSameGroup(l.chainBlockInfo.action)).filter(l=>l.clock.turn===this.entity.field.duel.clock.turn).filter(l=>l.chainBlockInfo.activator===t).length+r>=this.isOnlyNTimesPerTurn||this.isOnlyNTimesPerChain>0&&r>=this.isOnlyNTimesPerChain)return!1;const s=r+this.entity.counterHolder.getActionCount(this);return!(this.isOnlyNTimesPerTurnIfFaceup>0&&s>=this.isOnlyNTimesPerTurnIfFaceup||this.isOnlyNTimesIfFaceup>0&&s>=this.isOnlyNTimesIfFaceup)});a(this,"validate",(t,i,r)=>{if(this.playType==="CardActivation"&&this.entity.isOnFieldStrictly&&this.entity.face==="FaceUp"||this.isWithChainBlock&&!this.entity.status.canActivateEffect||r&&this.needsToPayCost||!this.validateCount(t,i))return;const s=Pi(0,...i.map(c=>c.chainNumber??-1)),l={index:i.length,chainNumber:this.isWithChainBlock?s+1:void 0,action:this,activator:t,targetChainBlock:i.slice(-1)[0],isActivatedIn:this.entity.fieldCell,isActivatedAt:this.duel.clock.getClone(),costInfo:{},state:"unloaded",dest:void 0,ignoreCost:!1};if(this.definition.canPayCosts&&!r&&!this.definition.canPayCosts(l,this.playType==="AfterChainBlock"?[]:i))return;const o=this.definition.validate(l,this.playType==="AfterChainBlock"?[]:i);if(o)return{action:this,dests:o,originSeq:this.seq}});a(this,"prepare",async(t,i,r,s,l,o)=>{var g,S;let c=l;this.isLikeContinuousSpell&&(this.entity.info.isPending=!0);const d=this.isWithChainBlock?Pi(0,...s.map(p=>p.chainNumber??-1))+1:void 0;let u="";if(d!==void 0&&(u+=`チェーン${d}: `),this.playType==="CardActivation"||this.playType==="SpellTrapSet")if(this.entity.fieldCell.cellType==="Hand"){let p=i?[i]:this.entity.status.spellCategory==="Field"?[t.getFieldZone()]:t.getAvailableSpellTrapZones();if(this.entity.status.spellCategory==="Field"){const w=t.getFieldZone().cardEntities;if(w.length){const b=w[0];await Ge.sendManyToGraveyardForTheSameReason(t.getFieldZone().cardEntities,["Rule"],this.entity,t),t.writeInfoLog(`フィールド魔法の上書きにより、${b.toString()}は墓地に送られた。`),c=!1}}(g=this.entity.status.monsterCategories)!=null&&g.includes("Pendulum")&&(p=p.filter(w=>w.isAvailableForPendulum));let k=p[0];if(p.length>1){k=p.randomPick();const w=this.playType==="SpellTrapSet"?"セット":"カードの発動",b=await this.duel.view.waitSelectDestination(t,this.entity,p,"カードを移動先へドラッグ",w,c);if(!b)return;k=b}u+="手札から",this.playType==="SpellTrapSet"?u+="魔法・罠カードをセット。":u+=`${this.entity.toString()}を発動。`,t.writeInfoLog(u),(S=this.entity.status.monsterCategories)!=null&&S.includes("Pendulum")?await this.entity.activateAsPendulumScale(k,["CardActivation"],this.entity,t):this.playType==="CardActivation"?await this.entity.activateSpellTrapFromHand(k,this.entity.kind,["CardActivation"],this.entity,t):await this.entity.setAsSpellTrap(k,this.entity.kind,["SpellTrapSet"],this.entity,t),c=!1}else this.entity.isOnField&&this.entity.face==="FaceDown"&&(u+=`セットされていた${this.entity.toString()}を発動。`,t.writeInfoLog(u),await this.entity.setNonFieldMonsterPosition(this.entity.origin.kind,"FaceUp",["Rule"]),c=!1);else d!==void 0&&(u+=`${this.toString()}を発動。`,t.writeInfoLog(u));const f={index:s.length,chainNumber:d,action:this,activator:t,targetChainBlock:r,isActivatedIn:this.entity.fieldCell,isActivatedAt:this.duel.clock.getClone(),costInfo:{},state:"ready",dest:i,ignoreCost:!1};if(console.log(this.definition.payCosts,o),this.definition.payCosts&&!o){const p=await this.definition.payCosts(f,s,c);if(!p)return;f.costInfo=p}const v=await this.definition.prepare(f,s,c);if(v===void 0)return;const _={...v};if(Ml.some(p=>p===this.playType)){const p=v.nextChainBlockFilter??(()=>!0);_.nextChainBlockFilter=(k,w)=>w.negateSummon&&p(k,w)}return{...f,..._}});a(this,"execute",async(t,i)=>{if(t.action.isLikeContinuousSpell&&!t.action.entity.isOnField)return this.entity.info.isPending=!1,!1;const r=await this.definition.execute(t,i);return this.entity.determine(),r});a(this,"settle",(t,i)=>(this.isOnlyNTimesPerTurnIfFaceup>0?this.entity.counterHolder.incrementActionCountPerTurn(this):this.isOnlyNTimesIfFaceup>0&&this.entity.counterHolder.incrementActionCount(this),this.definition.settle(t,i)));a(this,"directExecute",async(t,i,r)=>{const s=await this.prepare(t,void 0,i,[],!1,r);if(!s)throw new le("想定されない状態",this,t,r);const l=await this.execute(s,[]);return await this.settle(s,[]),l});a(this,"isSame",t=>this.entity.origin.name===t.entity.origin.name&&this.title===t.title);a(this,"isSameGroup",t=>this.actionGroupName?this.entity.origin.name===t.entity.origin.name&&this.actionGroupName===t.actionGroupName:this.isSame(t));a(this,"calcChainBlockTagsForDestroy",t=>{if(!nr.length)return[];const i=["Destroy"];nr.length>1&&i.push("DestroyMultiple");const r=t.filter(c=>c.isOnFieldStrictly);r.length&&(i.push("DestroyOnField"),r.length>1&&i.push("DestroyMultipleOnField"));const s=r.filter(c=>c.kind==="Monster");s.length&&(i.push("DestroyMonsterOnField"),s.length>1&&i.push("DestroyMonstersOnField")),r.filter(c=>c.kind!=="Monster").length&&(i.push("DestroySpellTrapOnField"),s.length>1&&i.push("DestroySpellTrapsOnField"));const o=r.filter(c=>c.controller!==this.entity.controller);return o.length&&(i.push("DestroyOnOpponentField"),o.length>1&&i.push("DestroyMultipleOnOpponentField")),i});this.addhocMaterialLimitation=s??(()=>!0)}get definition(){return super.definition}get playType(){return this.definition.playType}get spellSpeed(){return this.definition.spellSpeed}get needsToPayCost(){return this.definition.needsToPayCost??!1}get hasToTargetCards(){return this.definition.hasToTargetCards??!1}get isWithChainBlock(){return qn.some(t=>t===this.playType)}get isLikeContinuousSpell(){return this.definition.isLikeContinuousSpell||this.entity.isLikeContinuousSpell&&this.playType==="CardActivation"}get negatePreviousBlock(){return this.definition.negatePreviousBlock??!1}get negateSummon(){return this.definition.negateSummon??!1}get priorityForNPC(){return this.definition.priorityForNPC??Number.NaN}};a(Mt,"createNew",(t,i)=>new Mt("AutoSeq",t,i)),a(Mt,"createDummyAction",(t,i,r,s,l)=>({action:Mt.createNew(t,{title:i,isMandatory:!1,executableCells:[],executablePeriods:[],executableDuelistTypes:[],playType:"Dammy",spellSpeed:"Dammy",validate:()=>r,prepare:async()=>{},execute:async()=>!1,settle:async()=>!1}),dests:r,battlePosition:s,originSeq:(l==null?void 0:l.seq)??-1}));let Vt=Mt;function*Bl(){const n={...Object.assign({"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_ContinuousSpell.ts":zr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_ContinuousTrap.ts":Vr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_CounterTrap.ts":Zr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_EquipSpell.ts":jr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_EquipSpell_Preset.ts":Hr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_FieldSpell_Preset.ts":Ur,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_LinkMonster.ts":$r,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster.ts":Ir,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster_Preset_DirectAttacker.ts":Rr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster_Preset_Recruiter.ts":Lr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell.ts":Nr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell_General_Draw.ts":Or,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell_Preset.ts":Br,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalTrap.ts":xr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalTrap_UponAttackDeclaration.ts":qr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_QuickPlaySpell.ts":Mr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_SyncroMonster.ts":Fr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_TestMonster.ts":Ar,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_XyzMonster.ts":Pr}),...Object.assign({"/src/ygo_entity_proc/card_proc_definitions/character_yusei/CardProcDefinitions_Yusei_SyncroTunerMonster.ts":Tr,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_BambooSword_EquipSpell.ts":Dr,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_BambooSword_NormalSpell.ts":Er,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_Blackwing_Monster.ts":br,"/src/ygo_entity_proc/card_proc_definitions/tag_c/CardProcDefinitions_Crystron_LinkMonster.ts":kr,"/src/ygo_entity_proc/card_proc_definitions/tag_e/CardProcDefinitions_Exodia_Monster.ts":Cr,"/src/ygo_entity_proc/card_proc_definitions/tag_f/CardProcDefinitions_Firewall_LinkMonster.ts":wr,"/src/ygo_entity_proc/card_proc_definitions/tag_i/CardProcDefinitions_Igknight_Monster.ts":Sr,"/src/ygo_entity_proc/card_proc_definitions/tag_j/CardProcDefinitions_Junk_Monster.ts":yr,"/src/ygo_entity_proc/card_proc_definitions/tag_r/CardProcDefinitions_Resonator_Monster.ts":mr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_SpellCounter_Monster.ts":gr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Stardust_Monster.ts":_r,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Synchron_SyncroMonster.ts":pr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Syncron_NormalSpell.ts":vr,"/src/ygo_entity_proc/card_proc_definitions/tag_w/CardProcDefinitions_WorldChalice_Monster.ts":hr,"/src/ygo_entity_proc/card_proc_definitions/type_Cyberse/CardProcDefinitions_Earth_Cyberse_lvl1_Monster.ts":fr,"/src/ygo_entity_proc/card_proc_definitions/type_Fairy/CardProcDefinitions_Light_Fairy_lvl8_SyncroMonster.ts":ur,"/src/ygo_entity_proc/card_proc_definitions/type_Fiend/CardProcDefinitions_Dark_Fiend_lvl4_Monster.ts":dr,"/src/ygo_entity_proc/card_proc_definitions/type_Spellcaster/CardProcDefinitions_Wind_Spellcaster_lvl3_Monster.ts":cr})};for(const e of Object.keys(n))n[e].default&&(yield*n[e].default())}function*Ol(...n){const e={...Object.assign({"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_ContinuousSpell.ts":zr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_ContinuousTrap.ts":Vr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_CounterTrap.ts":Zr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_EquipSpell.ts":jr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_EquipSpell_Preset.ts":Hr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_FieldSpell_Preset.ts":Ur,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_LinkMonster.ts":$r,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster.ts":Ir,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster_Preset_DirectAttacker.ts":Rr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_Monster_Preset_Recruiter.ts":Lr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell.ts":Nr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell_General_Draw.ts":Or,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalSpell_Preset.ts":Br,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalTrap.ts":xr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_NormalTrap_UponAttackDeclaration.ts":qr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_QuickPlaySpell.ts":Mr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_SyncroMonster.ts":Fr,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_TestMonster.ts":Ar,"/src/ygo_entity_proc/card_proc_definitions/CardProcDefinitions_XyzMonster.ts":Pr}),...Object.assign({"/src/ygo_entity_proc/card_proc_definitions/character_yusei/CardProcDefinitions_Yusei_SyncroTunerMonster.ts":Tr,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_BambooSword_EquipSpell.ts":Dr,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_BambooSword_NormalSpell.ts":Er,"/src/ygo_entity_proc/card_proc_definitions/tag_b/CardProcDefinitions_Blackwing_Monster.ts":br,"/src/ygo_entity_proc/card_proc_definitions/tag_c/CardProcDefinitions_Crystron_LinkMonster.ts":kr,"/src/ygo_entity_proc/card_proc_definitions/tag_e/CardProcDefinitions_Exodia_Monster.ts":Cr,"/src/ygo_entity_proc/card_proc_definitions/tag_f/CardProcDefinitions_Firewall_LinkMonster.ts":wr,"/src/ygo_entity_proc/card_proc_definitions/tag_i/CardProcDefinitions_Igknight_Monster.ts":Sr,"/src/ygo_entity_proc/card_proc_definitions/tag_j/CardProcDefinitions_Junk_Monster.ts":yr,"/src/ygo_entity_proc/card_proc_definitions/tag_r/CardProcDefinitions_Resonator_Monster.ts":mr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_SpellCounter_Monster.ts":gr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Stardust_Monster.ts":_r,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Synchron_SyncroMonster.ts":pr,"/src/ygo_entity_proc/card_proc_definitions/tag_s/CardProcDefinitions_Syncron_NormalSpell.ts":vr,"/src/ygo_entity_proc/card_proc_definitions/tag_w/CardProcDefinitions_WorldChalice_Monster.ts":hr,"/src/ygo_entity_proc/card_proc_definitions/type_Cyberse/CardProcDefinitions_Earth_Cyberse_lvl1_Monster.ts":fr,"/src/ygo_entity_proc/card_proc_definitions/type_Fairy/CardProcDefinitions_Light_Fairy_lvl8_SyncroMonster.ts":ur,"/src/ygo_entity_proc/card_proc_definitions/type_Fiend/CardProcDefinitions_Dark_Fiend_lvl4_Monster.ts":dr,"/src/ygo_entity_proc/card_proc_definitions/type_Spellcaster/CardProcDefinitions_Wind_Spellcaster_lvl3_Monster.ts":cr})},t=[];for(const i of Object.values(e))if(i.default){for(const r of i.default())if(n.includes(r.name)){const s=rt[r.name];let l=r.summonFilter;s.kind==="Monster"&&s.monsterCategories&&!r.summonFilter&&s.monsterCategories.union(Fs).length&&(l=ro),yield{...r,summonFilter:l,staticInfo:s},t.push(r.name)}}if(yield*n.filter(i=>!t.includes(i)).map(i=>rt[i]).filter(i=>i).filter(i=>i.kind==="Monster").filter(i=>{var r;return(r=i.monsterCategories)==null?void 0:r.includes("Normal")}).filter(i=>{var r;return!((r=i.monsterCategories)!=null&&r.includes("Pendulum"))}).map(i=>(t.push(i.name),{name:i.name,actions:no,staticInfo:i})),t.length!==n.length)throw console.log(n.filter(i=>!t.includes(i))),new le("カード定義が取得できなかった",n.filter(i=>!t.includes(i)))}const Nl=n=>({...io(n),staticInfo:{name:n.profile.name,kind:"Monster",wikiEncodedName:"%A5%D7%A5%EC%A5%A4%A5%E4%A1%BC"}}),Ll=new Set,gn=so;for(const n of Bl()){if(Ll.has(n.name))throw new Error(`カード定義重複${n.name}`);gn[n.name]&&(gn[n.name].isImplemented=!0)}const rt=Object.values(gn).reduce((n,e)=>{var t;return(t=e.monsterCategories)!=null&&t.includes("Normal")&&!e.monsterCategories.includes("Pendulum")&&(e.isImplemented=!0),n[e.name]=e,n},{}),Ys=[{id:-1,name:"サンプルデッキ１",description:"",cardNames:["アンノウン・シンクロン","六武衆のご隠居","ジャンク・フォアード","ジャンク・フォアード","ジャンク・フォアード","チューン・ウォリアー","チューン・ウォリアー","ガード・オブ・フレムベル","ガード・オブ・フレムベル","守護竜ユスティア","守護竜ユスティア","エンジェル・トランペッター","エンジェル・トランペッター","ジェムナイト・サフィア","ジェムナイト・サフィア","魂虎","魂虎","暗黒界の番兵 レンジ","暗黒界の番兵 レンジ","バトルフットボーラー","バトルフットボーラー","球騎士の三人娘","球騎士の三人娘","エンジェル・トランペッター","エンジェル・トランペッター","Ｇ戦隊 シャインブラック","Ｇ戦隊 シャインブラック","しゃりの軍貫","しゃりの軍貫","ジョングルグールの幻術師","ジョングルグールの幻術師","ゾンビーノ","ゾンビーノ","メガロスマッシャーＸ","メガロスマッシャーＸ","ライドロン","ライドロン","機界騎士アヴラム","機界騎士アヴラム","幻のグリフォン","幻のグリフォン","幻殻竜","幻殻竜","アレキサンドライドラゴン","アレキサンドライドラゴン","ジェネティック・ワーウルフ","ジェネティック・ワーウルフ","サイバー・ドラゴン","フロストザウルス","フロストザウルス","フロストザウルス","青眼の白龍","マジカル・アンドロイド","マジカル・アンドロイド","マジカル・アンドロイド","大地の騎士ガイアナイト","大地の騎士ガイアナイト","大地の騎士ガイアナイト","スクラップ・デスデーモン","スクラップ・デスデーモン","スクラップ・デスデーモン","スターダスト・ドラゴン","スターダスト・ドラゴン","スターダスト・ドラゴン","ナチュル・ガオドレイク","ナチュル・ガオドレイク","ナチュル・ガオドレイク"]},{id:-2,name:"サンプルデッキ２",description:"",cardNames:["アンノウン・シンクロン","六武衆のご隠居","ジャンク・フォアード","グローアップ・バルブ","ガード・オブ・フレムベル","伝説の白石","伝説の白石","伝説の白石","守護竜ユスティア","ギャラクシーサーペント","ジェネクス・コントローラー","Ｅ・ＨＥＲＯ フェザーマン","Ｅ・ＨＥＲＯ バーストレディ","チューン・ウォリアー","Ｅ・ＨＥＲＯ クレイマン","Ｅ・ＨＥＲＯ スパークマン","しゃりの軍貫","ジョングルグールの幻術師","ゾンビーノ","ジェネティック・ワーウルフ","ライトロード・ビースト ウォルフ","サイバー・ドラゴン","サイバー・ドラゴン","サイバー・ドラゴン","ラブラドライドラゴン","Ｄ－ＨＥＲＯ ディアボリックガイ","Ｄ－ＨＥＲＯ ディアボリックガイ","Ｄ－ＨＥＲＯ ディアボリックガイ","フロストザウルス","Ｅ・ＨＥＲＯ ネオス","青眼の白龍","青眼の白龍","青眼の白龍","Ｅ－エマージェンシーコール","おろかな埋葬","トレード・イン","トレード・イン","トレード・イン","闇の量産工場","強欲な壺","強欲な壺","強欲な壺","死者蘇生","死者蘇生","死者蘇生","召喚師のスキル","召喚師のスキル","召喚師のスキル","成金ゴブリン","成金ゴブリン","成金ゴブリン","戦士の生還","増援","調和の宝札","調和の宝札","調和の宝札","天使の施し","天使の施し","天使の施し","貪欲な壺","貪欲な壺","貪欲な壺","マジカル・アンドロイド","マジカル・アンドロイド","マジカル・アンドロイド","大地の騎士ガイアナイト","大地の騎士ガイアナイト","大地の騎士ガイアナイト","スクラップ・デスデーモン","スクラップ・デスデーモン","スクラップ・デスデーモン","スターダスト・ドラゴン","スターダスト・ドラゴン","スターダスト・ドラゴン","ナチュル・ガオドレイク","ナチュル・ガオドレイク","ナチュル・ガオドレイク"]}],Q=class Q{constructor(e,t){a(this,"id");a(this,"name");a(this,"description");a(this,"lastUsedAt");a(this,"cardNames");a(this,"getIllegalCardNames",()=>Array.from(new Set(this.cardNames.filter(e=>!Object.keys(rt).includes(e)))));a(this,"getDisableCardNames",()=>Array.from(new Set(this.cardNames.filter(e=>!Object.keys(rt).includes(e)))));a(this,"createCardInfos",()=>{const e=this.getIllegalCardNames();if(e.length>0)throw new Error(`存在しないカード名からデッキを生成しようとした。${e}`);return this.cardNames.map(t=>rt==null?void 0:rt[t]).filter(t=>t)});a(this,"copy",async()=>Q.createNewDeck(this.name,this.description,this.cardNames));a(this,"updateTimestamp",async()=>{await Q.tblHeader.update(this.id,e=>({...e,lastUsedAt:new Date}))});a(this,"saveDeckInfo",async e=>{const t=e??this;await Q.tblHeader.update(this.id,s=>({...s,name:t.name,description:t.description,lastUsedAt:new Date}));const i=(await Q.tblDetail.getAll()).filter(s=>s.deckId===this.id);await Q.tblDetail.delete(i.map(s=>s.id));const r=await Q.tblDetail.insertMany(t.cardNames.map((s,l)=>({deckId:this.id,seq:l,name:s,description:""})));return new Q(await Q.tblHeader.get(this.id),r)});a(this,"delete",async()=>{await Q.tblHeader.delete([this.id]);const e=(await Q.tblDetail.getAll()).filter(t=>t.deckId===this.id);await Q.tblDetail.delete(e.map(t=>t.id))});this.id=e.id,this.name=e.name,this.description=e.description,this.lastUsedAt=e.lastUsedAt,this.cardNames=t.filter(i=>i.deckId===this.id).map(i=>i.name)}};a(Q,"toJson",e=>{const t=e.map(i=>{const{id:r,name:s,description:l,lastUsedAt:o,cardNames:c}=i;return{id:r,name:s,description:l,lastUsedAt:o,cardNames:c}});return t.forEach(i=>{i.cardNames=i.cardNames.map(r=>rt[r]).sort(Is).map(r=>r.name)}),JSON.stringify(t,null,2)}),a(Q,"convertToObjectURL",e=>{const t=Q.toJson(e),i=new Blob([t],{type:"text/plain"});return window.URL.createObjectURL(i)}),a(Q,"idb"),a(Q,"tblHeader"),a(Q,"tblDetail"),a(Q,"getAllDeckInfo",async e=>{if(e&&(Q.idb=e),!Q.idb)throw new Error("illegal argument: idb is undefined.");Q.tblHeader||(Q.tblHeader=new Rl(Q.idb)),Q.tblDetail||(Q.tblDetail=new Il(Q.idb));const t=await Q.tblHeader.getAll(),i=await Q.tblDetail.getAll();return t.length?t.map(r=>new Q(r,i)):[await Q.prepareSampleDeck()]}),a(Q,"createNewDeck",async(e,t,i)=>{const r=await Q.tblHeader.insert({name:e,description:t,lastUsedAt:new Date}),s=await Q.tblDetail.insertMany(i.map((l,o)=>({deckId:r.id,seq:o,name:l,description:""})));return new Q(r,s)}),a(Q,"prepareSampleDeck",async()=>{const e=Ys.slice(-1)[0];return await Q.createNewDeck(e.name,e.description,e.cardNames)});let rr=Q;class Rl extends An{constructor(t){super(t,"TblDeckHeader");a(this,"_prepareInitialRecords",()=>[])}}class Il extends An{constructor(t){super(t,"TblDeckDetail");a(this,"_prepareInitialRecords",()=>[])}}const su=Ys.map(n=>({...n,lastUsedAt:new Date})).filter(n=>n.id<0),$l=n=>n;function Ul(n){const e=n-1;return e*e*e+1}function ou(n,{delay:e=0,duration:t=400,easing:i=$l}={}){const r=+getComputedStyle(n).opacity;return{delay:e,duration:t,easing:i,css:s=>`opacity: ${s*r}`}}function sr(n,e){for(const t in e)n[t]=e[t];return n}function Hl({fallback:n,...e}){const t=new Map,i=new Map;function r(l,o,c){const{delay:d=0,duration:u=Z=>Math.sqrt(Z)*30,easing:f=Ul}=sr(sr({},e),c),v=l.getBoundingClientRect(),_=o.getBoundingClientRect(),g=v.left-_.left,S=v.top-_.top,p=v.width/_.width,k=v.height/_.height,w=Math.sqrt(g*g+S*S),b=getComputedStyle(o),P=b.transform==="none"?"":b.transform,q=+b.opacity;return{delay:d,duration:typeof u=="function"?u(w):u,easing:f,css:(Z,ee)=>`
			   opacity: ${Z*q};
			   transform-origin: top left;
			   transform: ${P} translate(${ee*g}px,${ee*S}px) scale(${Z+(1-Z)*p}, ${Z+(1-Z)*k});
		   `}}function s(l,o,c){return(d,u)=>(l.set(u.key,d),()=>{if(o.has(u.key)){const f=o.get(u.key);return o.delete(u.key),r(f,d,u)}return l.delete(u.key),n&&n(d,u,c)})}return[s(i,t,!1),s(t,i,!0)]}var jl=T("<div></div>"),Zl=T('<div class="duel_card_row svelte-14cfp8z"><div> </div> <div> </div></div>'),Vl=T('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"> </div></div>'),zl=T('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"> </div></div>'),Gl=T('<div class="duel_card_row svelte-14cfp8z"><div> </div> <div> </div></div>'),Wl=T('<div class="duel_card_row svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z">ペンデュラム</div></div>'),Kl=T('<div class="duel_card_row duel_card_detail svelte-14cfp8z"><div class="svelte-14cfp8z"> </div></div> <div class="duel_card_row duel_card_detail svelte-14cfp8z"><div class="svelte-14cfp8z"></div> <div class="svelte-14cfp8z"><span> </span> / <span> </span></div></div>',1),Xl=T('<button><div class="duel_card_body svelte-14cfp8z"><div class="duel_card_row svelte-14cfp8z" style="position:relative"><div class="svelte-14cfp8z"> </div> <div class="svelte-14cfp8z"></div> <!></div> <!> <!> <!> <!></div></button>'),Ql=T('<button><div class="svelte-14cfp8z">裏守備</div></button>'),Yl=T('<div class="duel_card duel_card_face_down svelte-14cfp8z"><div class="svelte-14cfp8z">セット</div></div>');function ft(n,e){Je(e,!1);let t=me(e,"entity",8),i=me(e,"state",8,"Disabled"),r=me(e,"selectedList",28,()=>[]),s=me(e,"isVisibleForcibly",8,!1),l=me(e,"isWideMode",8,!1),o=me(e,"dummyActionInfos",24,()=>[]),c=me(e,"cardActionResolve",8),d=me(e,"entitySelectResolve",8,()=>{}),u,f=De(!1),v=()=>{},_=me(e,"qty",12,void 0);const g=$=>{var O;u=$.activator,M(f,!1),_((O=$.entitiesChoices)==null?void 0:O.qty),v=$.resolve};t().field.duel.view.onWaitStart.append(g);let S=De(!1);const p=()=>{if(i()!=="Disabled"&&i()==="Selectable"&&_()===1){if(r().some($=>$.seq!==t().seq)){r([t()]);return}_()===1&&d()&&d()([t()])}},k=$=>{(t().face==="FaceUp"||t().owner===t().field.duel.duelists.Below&&(t().isUnderControl||s()))&&t().field.duel.view.showCardInfo(t(),$??"Normal")},w=()=>{if(k(),console.log(t().toString(),i(),o().length,c()),i()==="Disabled")return;if(i()==="Selectable"){M(f,!h(f)),_()===1&&(r().splice(0),t().duel.view.requireUpdate()),r(h(f)?[...r(),t()]:r().filter(O=>O!==t()));return}if(o().length===0)return;if(o().length===1){const O=o()[0];if(c()){c()(O);return}console.log(t().toString(),i(),o().length,v),v({actionInfo:O});return}if(!u)return;t().field.duel.view.modalController.actionSelector.show({title:"行動を選択。",activator:u,dummyActionInfos:o(),cancelable:!0}).then(O=>{O&&v({actionInfo:O})})},b=$=>{var O;window.getSelection&&((O=window.getSelection())==null||O.removeAllRanges()),console.info("drag start",$,o()),t().field.duel.view.setDraggingActions(o()),M(S,!0)},P=$=>{console.info("drag end",$,o()),t().field.duel.view.removeDraggingActions(),$.dataTransfer&&M(S,!1)},q=()=>(k("Debug"),!1);ct();var Z=ye(),ee=G(Z);{var N=$=>{var O=Xl(),Pe=m(O),Be=m(Pe),W=m(Be),V=m(W),ie=C(W,4);de(ie,1,()=>t().attr,ce,(L,R)=>{var E=jl();x(()=>_e(E,`monster_attr ${h(R)??""} svelte-14cfp8z`)),y(L,E)});var he=C(Be,2);{var we=L=>{var R=Zl(),E=m(R),D=m(E),U=C(E,2),j=m(U);x((K,J)=>{_e(E,Lt(t().lvl!==t().origin.level?"different_from_its_origin":""),"svelte-14cfp8z"),F(D,K),_e(U,Lt(t().rank!==t().origin.rank?"different_from_its_origin":""),"svelte-14cfp8z"),F(j,J)},[()=>"★".repeat(t().lvl||0),()=>"☆".repeat(t().rank||0)],ue),y(L,R)},xe=L=>{var R=ye(),E=G(R);{var D=j=>{var K=Vl(),J=C(m(K),2),ge=m(J);x(()=>F(ge,`${xs[t().status.spellCategory]??""}魔法`)),y(j,K)},U=j=>{var K=ye(),J=G(K);{var ge=re=>{var X=zl(),te=C(m(X),2),z=m(te);x(()=>F(z,`${Bs[t().status.trapCategory]??""}罠`)),y(re,X)};B(J,re=>{t().kind==="Trap"&&t().status.trapCategory&&re(ge)},!0)}y(j,K)};B(E,j=>{t().kind==="Spell"&&t().status.spellCategory?j(D):j(U,!1)},!0)}y(L,R)};B(he,L=>{t().kind==="Monster"?L(we):L(xe,!1)})}var $e=C(he,2);{var qe=L=>{var R=Gl(),E=m(R),D=m(E),U=C(E,2),j=m(U);x(()=>{_e(E,Lt(t().psL!==t().origin.pendulumScaleL?"different_from_its_origin":""),"svelte-14cfp8z"),F(D,`◀ ${t().psL??""}`),_e(U,Lt(t().psR!==t().origin.pendulumScaleR?"different_from_its_origin":""),"svelte-14cfp8z"),F(j,`${t().psR??""} ▶`)}),y(L,R)};B($e,L=>{var R;(R=t().status.monsterCategories)!=null&&R.includes("Pendulum")&&L(qe)})}var A=C($e,2);{var I=L=>{var R=Wl();y(L,R)};B(A,L=>{t().kind==="Spell"&&t().isPendulumScale&&L(I)})}var Y=C(A,2);{var Se=L=>{var R=Kl(),E=G(R),D=m(E),U=m(D),j=C(E,2),K=C(m(j),2),J=m(K),ge=m(J),re=C(J,2),X=m(re);x((te,z)=>{F(U,`${te??""}
            ${z??""}`),_e(J,Lt(t().atk!==t().origin.attack?"different_from_its_origin":""),"svelte-14cfp8z"),F(ge,t().atk??"?"),_e(re,Lt(t().def!==t().origin.defense?"different_from_its_origin":""),"svelte-14cfp8z"),F(X,t().def??"?")},[()=>t().types.map(te=>Ls[te]+(l()?Ns[te]:"")).join(),()=>{var te;return(te=t().status.monsterCategories)==null?void 0:te.map(z=>qs[z]+(l()?Ms[z]:"")).join()}],ue),y(L,R)};B(Y,L=>{t().kind==="Monster"&&L(Se)})}x(L=>{_e(O,`duel_card button_style_reset ${t().origin.kind??""} ${L??""} ${(h(f)?"duel_card_selected":"")??""} ${i()??""} duel_card_${t().orientation??""} ${(h(S)?"isDragging":"")??""} ${(l()?"duel_card_wide":"")??""} duel_card_${t().face??""} ${(t().isOnField?"duel_card_is_on_field":"")??""} svelte-14cfp8z`),ai(O,"draggable",i()==="Draggable"),ai(O,"title",t().nm),F(V,t().nm)},[()=>{var L;return((L=t().status.monsterCategories)==null?void 0:L.join(" "))||""}],ue),je("dragstart",O,b),je("dragend",O,P),je("click",O,w),je("dblclick",O,p),je("mouseenter",O,()=>k()),je("contextmenu",O,q),y($,O)},H=$=>{var O=ye(),Pe=G(O);{var Be=V=>{var ie=Ql();x(()=>_e(ie,`duel_card duel_card_face_down duel_card_face_down_defense ${i()??""}  ${(h(f)?"duel_card_selected":"")??""} svelte-14cfp8z`)),je("click",ie,w),je("dblclick",ie,p),y(V,ie)},W=V=>{var ie=Yl();y(V,ie)};B(Pe,V=>{t().battlePosition==="Set"?V(Be):V(W,!1)},!0)}y($,O)};B(ee,$=>{t().face==="FaceUp"||s()||t().controller.duelistType==="Player"&&t().isUnderControl?$(N):$(H,!1)})}y(n,Z),et()}var Jl=T('<div class="phase_display svelte-1mv96a1"><span class="svelte-1mv96a1"> </span> </div>'),ec=T('<div class="lifepoint_display svelte-1mv96a1"><div class="svelte-1mv96a1"> </div> <div class="svelte-1mv96a1"> </div></div>'),tc=(n,e,t)=>e(h(t)),ic=T('<div class="svelte-1mv96a1"><button class="phase_button svelte-1mv96a1"> </button></div>'),nc=T("<div><!></div>"),rc=T('<div class="svelte-1mv96a1"><!></div>'),sc=T("<div><!></div>"),oc=T("<!> <!> <!>",1),ac=T('<div style="position: absolute;" class="card_animation_receiver svelte-1mv96a1"><!></div>'),lc=T('<div style="position: absolute; top:0rem" class="svelte-1mv96a1">｛効果対象｝</div>'),cc=T('<!> <div style="position: absolute; display:flex;justify-content: center;" class="svelte-1mv96a1"><!></div>',1),dc=T(" <!> 】",1),uc=T('<div style="position: absolute; bottom:0rem" class="svelte-1mv96a1"> <!></div>'),fc=T("<!> <!>",1),hc=T('<div class="badge svelte-1mv96a1"> </div>'),vc=T('<div class="card_animation_receiver svelte-1mv96a1"><!></div>'),pc=T("<!> <!> <!> <!>",1),_c=T('<td><div role="listitem"><!></div></td>');function gc(n,e){Je(e,!1);let t=me(e,"view",8),i=me(e,"row",8),r=me(e,"column",8),s=me(e,"selectedEntities",28,()=>[]),l=me(e,"selectedCells",28,()=>[]),o=De(t().getCell(i(),r()));const c=()=>{M(o,t().getCell(i(),r()))};h(o).onUpdate.append(c),t().onDuelUpdate.append(c),t().modalController.onUpdate.append(c);let d,u=De([]),f=()=>{},v,_=De([]),g=De(!1),S=De(!1),p=!1;const k=A=>{var I,Y;M(H,[]),s().reset(),d=A.activator,f=A.resolve,M(u,A.dummyActionInfos),M(_,A.chainBlockInfos.flatMap(Se=>Se.selectedEntities).getDistinct()),v=A.entitiesChoices,M(g,!1),M(S,((I=A.cellsChoices)==null?void 0:I.selectables.includes(h(o)))??!1),p=h(S)&&((Y=A.cellsChoices)==null?void 0:Y.qty)===1};t().onWaitStart.append(k);const w=()=>{d=void 0,M(u,[]),f=()=>{},v=void 0,M(_,[]),M(g,!1),M(S,!1),p=!1};t().onWaitEnd.append(w);let b=De(!1),P=[];const q=A=>{P=A.filter(I=>I.dests.includes(h(o))),M(b,P.length>0),c()},Z=()=>{P=[],M(b,!1),c()};t().onDragStart.append(q),t().onDragEnd.append(Z);const[ee,N]=Cd;let H=De([]);const $=A=>{if(d=void 0,h(o)===A.to||h(o).entities.includes(A.entity)){M(H,[...h(H),A]);const I=A.resolve;M(o,h(o)),setTimeout(()=>{M(H,h(H).filter(Y=>Y!==A)),A.count++,A.count>1&&I()},600)}};t().onAnimation.append($);const O=A=>{f({phaseChange:A})},Pe=()=>h(o).isStackCell&&h(o).entities.flatMap(A=>A.actions).filter(A=>h(u).map(I=>I.action.seq).some(I=>I===A.seq)).length>0,Be=()=>{if(ei(o,h(o).field.duel.view.infoBoardState="Log"),p)f({selectedCells:[h(o)]});else if(h(S))M(g,!h(g)),l(h(g)?[...l(),h(o)]:l().filter(A=>A!==h(o)));else if(h(o).isStackCell){ei(o,h(o).field.duel.view.infoBoardState="CellInfo"),ei(o,h(o).field.duel.view.infoBoardCell=h(o)),h(o).field.duel.view.requireUpdate();const A=h(o).entities.flatMap(Y=>Y.actions).map(Y=>Y.seq),I=h(u).filter(Y=>A.includes(Y.action.seq));if(I.length){if(!d)return;h(o).field.duel.view.modalController.actionSelector.show({title:"カードを選択。",activator:d,dummyActionInfos:I,cancelable:!0}).then(Se=>{Se&&f({actionInfo:Se})});return}}h(o).field.duel.view.requireUpdate(),console.info(h(o))},W=A=>{A.preventDefault(),A.dataTransfer&&(A.dataTransfer.dropEffect="move")},V=A=>{A.preventDefault(),console.info("drop",A,h(b),P),A.dataTransfer&&(A.dataTransfer.dropEffect="move");try{if(h(b)&&P){if(P.length===1){const I=P[0];f({actionInfo:{...I,dest:h(o)}})}else if(P.length>1){if(!d)throw new le("想定されない状態");h(o).field.duel.view.modalController.terminateAll(),h(o).field.duel.view.modalController.actionSelector.show({title:"選択",activator:d,dummyActionInfos:P.map(I=>({...I,dest:h(o)})),cancelable:!1}).then(I=>{f({actionInfo:I})})}}}finally{t().removeDraggingActions()}},ie=(...A)=>{if(t().waitMode==="Animation")return"Disabled";if(v&&v.selectables.find(Y=>A.find(Se=>Y===Se)))return"Selectable";if(!h(u)||h(u).length===0||t().waitMode!=="Free"||Object.values(t().modalController.modals).some(Y=>Y.state==="Shown"))return"Disabled";const I=h(u).filter(Y=>A.includes(Y.action.entity));return I.length===0?"Disabled":h(o).isStackCell||I[0].action.entity!==A[0]?"Clickable":I.some(Y=>Y.dests.length)?"Draggable":"Clickable"};ct();var he=_c(),we=m(he);we.__click=Be;var xe=m(we);{var $e=A=>{var I=ye(),Y=G(I);{var Se=L=>{var R=ye(),E=G(R);{var D=j=>{var K=Jl(),J=m(K),ge=m(J),re=C(J,1,!0);x((X,te)=>{F(ge,X),F(re,te)},[()=>String(h(o).field.duel.clock.turn).padStart(2,"0"),()=>h(o).field.duel.phase.toUpperCase()],ue),y(j,K)},U=j=>{var K=ye(),J=G(K);{var ge=X=>{var te=ec(),z=m(te),be=m(z),Ae=C(z,2),Ne=m(Ae);x(()=>{F(be,h(o).field.duel.duelists.Above.lp),F(Ne,h(o).field.duel.duelists.Below.lp)}),y(X,te)},re=X=>{var te=ye(),z=G(te);{var be=Ae=>{var Ne=ye(),mt=G(Ne);{var Ze=Me=>{var Ue=ye(),yt=G(Ue);{var At=He=>{var se=ye(),oe=G(se);de(oe,1,()=>t().duel.nextPhaseList,ce,(pe,Ce)=>{var Ee=ic(),tt=m(Ee);tt.__click=[tc,O,Ce];var Ve=m(tt);x(dt=>F(Ve,dt),[()=>h(Ce).toUpperCase()],ue),y(pe,Ee)}),y(He,se)};B(yt,He=>{t().duel.isEnded||He(At)})}y(Me,Ue)};B(mt,Me=>{t().waitMode==="Free"&&Me(Ze)})}y(Ae,Ne)};B(z,Ae=>{h(o).column===5&&Ae(be)},!0)}y(X,te)};B(J,X=>{h(o).column===3?X(ge):X(re,!1)},!0)}y(j,K)};B(E,j=>{h(o).column===1?j(D):j(U,!1)})}y(L,R)};B(Y,L=>{h(o).row===3&&L(Se)})}y(A,I)},qe=A=>{var I=ye(),Y=G(I);{var Se=R=>{var E=oc();const D=ue(()=>h(H).find(re=>re.to===h(o)));var U=G(E);{var j=re=>{var X=nc(),te=m(X);ft(te,{get entity(){return h(D).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),x(()=>_e(X,`card_animation_receiver ${h(o).cellType??""} svelte-1mv96a1`)),Rt(1,X,()=>N,()=>({key:h(D).entity.seq})),y(re,X)};B(U,re=>{h(D)&&h(D).index==="Top"&&re(j)})}var K=C(U,2);de(K,1,()=>h(o).visibleEntities,ce,(re,X)=>{var te=ye(),z=G(te);{var be=Ae=>{var Ne=rc(),mt=m(Ne);const Ze=ue(()=>ie(h(X))),Me=ue(()=>h(u).filter(Ue=>Ue.action.entity===h(X)));ft(mt,{get entity(){return h(X)},get state(){return h(Ze)},get dummyActionInfos(){return h(Me)},cardActionResolve:void 0,get selectedList(){return s()},set selectedList(Ue){s(Ue)},$$legacy:!0}),Rt(2,Ne,()=>ee,()=>({key:h(X).seq})),y(Ae,Ne)};B(z,Ae=>{h(H).every(Ne=>Ne.entity.seq!==h(X).seq)&&Ae(be)})}y(re,te)});var J=C(K,2);{var ge=re=>{var X=sc(),te=m(X);ft(te,{get entity(){return h(D).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),x(()=>_e(X,`card_animation_receiver ${h(o).cellType??""} svelte-1mv96a1`)),Rt(1,X,()=>N,()=>({key:h(D).entity.seq})),y(re,X)};B(J,re=>{h(D)&&h(D).index!=="Top"&&re(ge)})}y(R,E)},L=R=>{var E=pc();const D=ue(()=>h(H).find(z=>z.to===h(o)));var U=G(E);{var j=z=>{var be=ac(),Ae=m(be);ft(Ae,{get entity(){return h(D).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),Rt(1,be,()=>N,()=>({key:h(D).entity.seq})),y(z,be)};B(U,z=>{h(D)&&h(D).index!=="Top"&&z(j)})}var K=C(U,2);{var J=z=>{var be=fc(),Ae=G(be);de(Ae,1,()=>h(o).visibleEntities.map((Ze,Me)=>({index:Me,entity:Ze})).toReversed(),ce,(Ze,Me)=>{var Ue=ye(),yt=G(Ue);{var At=He=>{var se=cc(),oe=G(se);{var pe=dt=>{var Js=lc();y(dt,Js)};B(oe,dt=>{h(_).includes(h(Me).entity)&&dt(pe)})}var Ce=C(oe,2),Ee=m(Ce);const tt=ue(()=>!h(o).isStackCell&&h(Me).index===0?ie(...h(o).visibleEntities):void 0),Ve=ue(()=>h(Me).index===0?h(u).filter(dt=>h(o).visibleEntities.includes(dt.action.entity)):void 0);ft(Ee,{get entity(){return h(Me).entity},get state(){return h(tt)},get dummyActionInfos(){return h(Ve)},cardActionResolve:void 0,get selectedList(){return s()},set selectedList(dt){s(dt)},$$legacy:!0}),Rt(2,Ce,()=>ee,()=>({key:h(Me).entity.seq})),y(He,se)};B(yt,He=>{h(H).every(se=>se.entity.seq!==h(Me).entity.seq)&&He(At)})}y(Ze,Ue)});var Ne=C(Ae,2);{var mt=Ze=>{var Me=uc(),Ue=m(Me),yt=C(Ue);de(yt,1,()=>Object.keys(h(o).visibleEntities[0].status.maxCounterQty),ce,(At,He)=>{var se=dc(),oe=G(se),pe=C(oe);{var Ce=Ee=>{var tt=va();x(()=>F(tt,`/${h(o).visibleEntities[0].status.maxCounterQty[h(He)]??""}`)),y(Ee,tt)};B(pe,Ee=>{(h(o).visibleEntities[0].status.maxCounterQty[h(He)]??!1)&&Ee(Ce)})}x(Ee=>F(oe,`【
              ${sl[h(He)]??""}${Ee??""} `),[()=>h(o).visibleEntities[0].counterHolder.getQty(h(He))],ue),y(At,se)}),x(()=>F(Ue,`【${h(o).visibleEntities[0].battlePositionName??""}】 `)),y(Ze,Me)};B(Ne,Ze=>{h(o).visibleEntities[0].battlePosition&&Ze(mt)})}y(z,be)};B(K,z=>{h(o).visibleEntities.length>0&&z(J)})}var ge=C(K,2);{var re=z=>{var be=hc(),Ae=m(be);x(()=>F(Ae,h(o).visibleEntities.length)),y(z,be)};B(ge,z=>{h(o).isStackCell&&z(re)})}var X=C(ge,2);{var te=z=>{var be=vc(),Ae=m(be);ft(Ae,{get entity(){return h(D).entity},state:"Disabled",dummyActionInfos:[],cardActionResolve:void 0}),Rt(1,be,()=>N,()=>({key:h(D).entity.seq})),y(z,be)};B(X,z=>{h(D)&&h(D).index==="Top"&&z(te)})}y(R,E)};B(Y,R=>{h(o).cellType==="Hand"?R(Se):R(L,!1)},!0)}y(A,I)};B(xe,A=>{h(o).isDisabledCell?A($e):A(qe,!1)})}x(A=>{_e(he,`${`duel_field_cell duel_field_cell_${h(o).cellType} ${h(o).linkArrowSources.length===0?"":"duel_field_cell_linked"}`??""} svelte-1mv96a1`),ai(he,"colspan",h(o).cellType==="Hand"?7:1),_e(we,`${A??""} svelte-1mv96a1`)},[()=>`duel_card_wrapper ${h(o).cellType} ${h(b)?"can_accept_drop":""} ${Pe()?"can_action":""} ${h(g)?"is_selected":h(S)?"is_selectable":""} `],ue),je("dragover",we,W),je("drop",we,V),y(n,he),et()}Yt(["click"]);var mc=T('<div class="title svelte-1sjjr5s"> </div>'),yc=T('<div class="title svelte-1sjjr5s"> </div>'),Sc=T('<div class="duel_log_record svelte-1sjjr5s"> </div>'),wc=T('<div><div style=" white-space: nowrap;text-align: center;"> </div> <!></div>'),Cc=T("<div><!> <!></div>"),kc=T("<div><!> <!></div>"),bc=T('<div class="duel_log svelte-1sjjr5s"><div class="duel_log_header svelte-1sjjr5s"></div> <div class="duel_log_body svelte-1sjjr5s"></div> <div class="duel_log_footer svelte-1sjjr5s"></div></div>');function Ec(n,e){Je(e,!1);let t=De(void 0),i=me(e,"log",8),r,s=De([]);const l=()=>{const u=((r==null?void 0:r.seq)??-1)+1;i().records.slice(u).forEach(f=>{if(!r){M(s,[[[[f]]]]),r=f;return}if(!h(s)[f.clock.turn]){ei(s,h(s)[f.clock.turn]=[[[f]]]),r=f;return}if(!h(s)[f.clock.turn][f.clock.phaseSeq]){ei(s,h(s)[f.clock.turn][f.clock.phaseSeq]=[[f]]),r=f;return}if(r.clock.chainSeq===f.clock.chainSeq&&r.clock.chainBlockSeq===f.clock.chainBlockSeq&&r.duelist===f.duelist){h(s)[f.clock.turn][f.clock.phaseSeq].slice(-1)[0].push(f),r=f;return}h(s)[f.clock.turn][f.clock.phaseSeq].push([f]),r=f}),M(s,h(s)),sa().then(()=>h(t)&&h(t).scroll(0,h(t).clientHeight*990))};i().onUpdate.append(l),i().duel.view.onDuelUpdate.append(l),ct();var o=ye(),c=G(o);{var d=u=>{var f=bc(),v=C(m(f),2);de(v,5,()=>h(s),ce,(_,g)=>{var S=kc(),p=m(S);{var k=b=>{var P=mc(),q=m(P);x(()=>F(q,`ターン：${h(g)[0][0][0].clock.turn??""}`)),y(b,P)};B(p,b=>{h(g)[0][0][0].clock.turn>0&&b(k)})}var w=C(p,2);de(w,1,()=>h(g),ce,(b,P)=>{var q=Cc(),Z=m(q);{var ee=H=>{var $=yc(),O=m($);x(()=>F(O,h(P)[0][0].clock.period.name)),y(H,$)};B(Z,H=>{h(P)[0][0].clock.turn>0&&H(ee)})}var N=C(Z,2);de(N,1,()=>h(P),ce,(H,$)=>{var O=wc(),Pe=m(O),Be=m(Pe),W=C(Pe,2);de(W,1,()=>h($),ce,(V,ie)=>{var he=Sc(),we=m(he);x(()=>F(we,h(ie).text)),y(V,he)}),x(()=>{var V,ie,he;_e(O,`duel_log_block_duelist duel_log_block_duelist_${((V=h($)[0].duelist)==null?void 0:V.seat)??"system"} svelte-1sjjr5s`),_e(Pe,`duelist ${((ie=h($)[0].duelist)==null?void 0:ie.seat)??""} svelte-1sjjr5s`),F(Be,((he=h($)[0].duelist)==null?void 0:he.profile.name)||"SYSTEM")}),y(H,O)}),x(()=>_e(q,`duel_log_block_phase duel_log_block_phase_${h(P)[0][0].clock.period.key??""} svelte-1sjjr5s`)),y(b,q)}),x(()=>_e(S,`duel_log_block_turn duel_log_block_turn_${h(g)[0][0][0].clock.turn??""} svelte-1sjjr5s`)),y(_,S)}),Ma(v,_=>M(t,_),()=>h(t)),y(u,f)};B(c,u=>{i().duel.view.infoBoardState==="Log"&&u(d)})}y(n,o),et()}var Dc=T('<div><div class="duelist_name svelte-1u7codf"> </div> <div> </div></div>');function or(n,e){Je(e,!1);let t=me(e,"duelist",12),i=De(0),r=De();const s=async()=>{const v=t().lp-h(i);if(!h(r)||Math.abs(v)<10){M(i,t().lp),h(r)&&(h(r)(),M(r,void 0));return}M(i,h(i)+Math.floor(Math.random()*v)),await Sl(100),s()},l=()=>{t(t()),!h(r)&&t().lp!==h(i)&&new Promise(v=>{M(r,v),Math.abs(t().lp-h(i)),s()})};t().duel.log.onUpdate.append(l),s(),ct();var o=Dc(),c=m(o),d=m(c),u=C(c,2),f=m(u);x(()=>{_e(o,`duelist ${t().seat??""} svelte-1u7codf`),F(d,t().profile.name),_e(u,`duelist_lp ${(h(r)?"vibration":"")??""} svelte-1u7codf`),F(f,h(i))}),y(n,o),et()}const Tc=(n,e,t)=>{e.resolve(h(t))};var Pc=T("<div><!></div>"),Ac=T("<div></div>"),Fc=(n,e)=>e.resolve(void 0),Mc=T('<button class="svelte-ynkuoo">Cancel</button>'),qc=T('<div class="modal_window svelte-ynkuoo"><div> </div> <!> <div><button class="svelte-ynkuoo">OK</button> <!></div></div>');function xc(n,e){Je(e,!0);let t=$o(Ct([])),i=e.args.chainBlockInfos.flatMap(o=>o.selectedEntities).getDistinct();var r=ye(),s=G(r);{var l=o=>{var c=qc(),d=m(c),u=m(d),f=C(d,2);de(f,17,()=>e.args.entitiesChoices.selectables.map(p=>p.controller.seat).getDistinct(),ce,(p,k)=>{var w=Ac();de(w,21,()=>e.args.entitiesChoices.selectables.filter(b=>b.controller.seat===h(k)).toSorted(Ws),ce,(b,P)=>{var q=Pc(),Z=m(q);ft(Z,{get entity(){return h(P)},isVisibleForcibly:!0,state:"Selectable",entitySelectResolve:ee=>e.resolve(ee),get qty(){return e.args.entitiesChoices.qty},cardActionResolve:void 0,get selectedList(){return h(t)},set selectedList(ee){M(t,Ct(ee))}}),x(ee=>_e(q,`entities_list_item ${ee??""} svelte-ynkuoo`),[()=>i.includes(h(P))?"effect_target":""]),y(b,q)}),x(()=>_e(w,`entities_list ${h(k)??""} svelte-ynkuoo`)),y(p,w)});var v=C(f,2),_=m(v);_.__click=[Tc,e,t];var g=C(_,2);{var S=p=>{var k=Mc();k.__click=[Fc,e],y(p,k)};B(g,p=>{e.args.entitiesChoices.cancelable&&p(S)})}x(p=>{F(u,e.args.title),_.disabled=p},[()=>!e.args.entitiesChoices.validator(h(t))]),y(o,c)};B(s,o=>{o(l)})}y(n,r),et()}Yt(["click"]);var Bc=T('<div class="duel_card_wrapper svelte-1k3dhp1"><!> <div> </div></div>'),Oc=(n,e)=>e()(),Nc=T('<div><button class="cancel_button svelte-1k3dhp1">Cancel</button></div>'),Lc=T('<div class="modal_window svelte-1k3dhp1"><div> </div> <div class="flex svelte-1k3dhp1" style="display: flex;"></div> <!></div>');function Rc(n,e){Je(e,!1);let t=me(e,"view",8),i=me(e,"args",8),r=me(e,"resolve",8),s=qa(!1);const l=()=>s.set(!0),o=()=>s.set(!1);t().onDragStart.append(l),t().onDragEnd.append(o),ct();var c=ye(),d=G(c);{var u=f=>{var v=Lc(),_=m(v),g=m(_),S=C(_,2);de(S,5,()=>i().dummyActionInfos,ce,(w,b)=>{var P=Bc(),q=m(P);const Z=ue(()=>h(b).dests.length?"Draggable":"Clickable"),ee=ue(()=>i().dragAndDropOnly?[]:[h(b)]);ft(q,{get entity(){return h(b).action.entity},isVisibleForcibly:!0,get state(){return h(Z)},get dummyActionInfos(){return h(ee)},get cardActionResolve(){return r()}});var N=C(q,2),H=m(N);x(()=>F(H,`«${h(b).action.title??""}»`)),y(w,P)});var p=C(S,2);{var k=w=>{var b=Nc(),P=m(b);P.__click=[Oc,r],y(w,b)};B(p,w=>{i().cancelable&&w(k)})}x(()=>F(g,i().title)),y(f,v)};B(d,f=>{f(u)})}y(n,c),et()}Yt(["click"]);var Ic=(n,e,t)=>e()(t()),$c=T('<li><button class="svelte-1w70c2f"> </button></li>'),Uc=(n,e)=>e()(void 0),Hc=T('<button class="svelte-1w70c2f">Cancel</button>'),jc=T('<div class="modal_window svelte-1w70c2f"><div class="svelte-1w70c2f"> </div> <ui class="text_list svelte-1w70c2f"></ui> <!></div>');function Zc(n,e){Je(e,!1);let t=me(e,"arg",8),i=me(e,"resolve",8);ct();var r=ye(),s=G(r);{var l=o=>{var c=jc(),d=m(c),u=m(d),f=C(d,2);de(f,5,()=>t().choises,ce,(g,S)=>{let p=()=>h(S).seq,k=()=>h(S).text;var w=$c(),b=m(w);b.__click=[Ic,i,p];var P=m(b);x(()=>{_e(w,`text_item ${p()??""} svelte-1w70c2f`),F(P,k())}),y(g,w)});var v=C(f,2);{var _=g=>{var S=Hc();S.__click=[Uc,i],y(g,S)};B(v,g=>{t().cancelable&&g(_)})}x(()=>F(u,t().title)),y(o,c)};B(s,o=>{o(l)})}y(n,r),et()}Yt(["click"]);const Vc=(n,e)=>{e().modals.forEach(t=>t.cancel())};var zc=T('<button class="overlay svelte-5wiqd8">☆</button> <!> <!> <!>',1),Gc=T('<div class="base svelte-5wiqd8"><!></div>');function Wc(n,e){var o,c;Je(e,!1);let t=me(e,"modalController",12);const i=()=>{t(t())};(c=(o=t())==null?void 0:o.onUpdate)==null||c.append(i),ct();var r=Gc(),s=m(r);{var l=d=>{var u=zc(),f=G(u);f.__click=[Vc,t];var v=C(f,2);{var _=w=>{xc(w,{get args(){return t().entitySelector.args},get resolve(){return t().entitySelector.resolve}})};B(v,w=>{t().entitySelector.state==="Shown"&&w(_)})}var g=C(v,2);{var S=w=>{Rc(w,{get view(){return t().view},get args(){return t().actionSelector.args},get resolve(){return t().actionSelector.resolve}})};B(g,w=>{t().actionSelector.state==="Shown"&&w(S)})}var p=C(g,2);{var k=w=>{Zc(w,{get arg(){return t().textSelector.args},get resolve(){return t().textSelector.resolve}})};B(p,w=>{t().textSelector.state==="Shown"&&w(k)})}y(d,u)};B(s,d=>{t().modals.some(u=>u.state==="Shown")&&d(l)})}y(n,r),et()}Yt(["click"]);const Kc=(n,e)=>(e(e()==="Normal"?"Debug":"Normal"),!0);var Xc=T('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><pre class="description svelte-1qknre5"> </pre></div></div> <div class="duel_card_info_row svelte-1qknre5" style=" justify-content: space-between;"><div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div></div>',1),Qc=T('<div></div> <div class="svelte-1qknre5"> </div>',1),Yc=T("<div> </div>"),Jc=T("<div> </div>"),ed=T('<div class="duel_card_info_row svelte-1qknre5"><!> <!></div> <div class="duel_card_info_row svelte-1qknre5"></div>',1),td=T('<div class="duel_card_row svelte-1qknre5"><div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div></div>'),id=T('<div class="duel_card_row svelte-1qknre5"><div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div></div>'),nd=T("<!> <!>",1),rd=T('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><pre class="description svelte-1qknre5"> </pre></div></div>'),sd=T('<div class="svelte-1qknre5"> </div>'),od=T('<div class="svelte-1qknre5"> </div>'),ad=T('<div class="svelte-1qknre5"> </div>'),ld=T('<div class="svelte-1qknre5"> </div>'),cd=T('<div class="svelte-1qknre5"> </div>'),dd=T('<div class="svelte-1qknre5"> </div>'),ud=T('<div class="svelte-1qknre5"> </div>'),fd=T('<div class="svelte-1qknre5"> </div>'),hd=T('<div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"><div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <!> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"></div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"></div></div></div>'),vd=T('<div class="svelte-1qknre5">※テスト用カードです</div>'),pd=T('<div class="duel_card_info_links svelte-1qknre5"><a target="_blank" rel="noopener noreferrer" title="遊戯王カードWiki" class="svelte-1qknre5">⇒遊戯王カードWiki</a> <a target="_blank" rel="noopener noreferrer" title="コナミカードデータベース" class="svelte-1qknre5"> </a></div>'),_d=T('<div role="contentinfo"><div class="duel_card_info_header svelte-1qknre5"><div class="duel_card_info_row svelte-1qknre5"><div class="svelte-1qknre5"> </div></div> <div class="duel_card_info_row svelte-1qknre5" style="position:sticky; top:0;"><div class="svelte-1qknre5"> </div> <div class="svelte-1qknre5"> </div></div> <!></div> <div class="duel_card_info_body svelte-1qknre5"><!></div> <div class="duel_card_info_footer svelte-1qknre5"><!></div></div>');function gd(n,e){Je(e,!1);let t=me(e,"entity",8,void 0);const i=()=>t()?rt[t().origin.name]:void 0,r=()=>{var d;return t()&&(t().origin.cardId??!1)?`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=2&cid=${t().origin.cardId}`:`https://www.db.yugioh-card.com/yugiohdb/card_search.action?ope=1&sess=1&rp=10&mode=&sort=1&keyword=${(d=i())==null?void 0:d.name}&stype=1&ctype=&othercon=2&starfr=&starto=&pscalefr=&pscaleto=&linkmarkerfr=&linkmarkerto=&link_m=2&atkfr=&atkto=&deffr=&defto=&releaseDStart=1&releaseMStart=1&releaseYStart=1999&releaseDEnd=&releaseMEnd=&releaseYEnd=`};let s=me(e,"mode",12,"Normal");ct();var l=ye(),o=G(l);{var c=d=>{var u=_d();u.__contextmenu=[Kc,s];var f=m(u),v=m(f),_=m(v),g=m(_),S=C(v,2),p=m(S),k=m(p),w=C(p,2),b=m(w),P=C(S,2);{var q=W=>{var V=nd(),ie=G(V);{var he=qe=>{var A=Xc(),I=G(A),Y=m(I),Se=m(Y),L=m(Se),R=C(I,2),E=m(R),D=m(E),U=C(E,2),j=m(U);x(()=>{F(L,rt[t().origin.name].pendulumDescription),F(D,`◀ ${t().psL??""}`),F(j,`${t().psR??""} ▶`)}),y(qe,A)};B(ie,qe=>{var A;(A=t().status.monsterCategories)!=null&&A.includes("Pendulum")&&qe(he)})}var we=C(ie,2);{var xe=qe=>{var A=ed(),I=G(A),Y=m(I);de(Y,1,()=>t().attr,ce,(R,E)=>{var D=Qc(),U=G(D),j=C(U,2),K=m(j);x(()=>{_e(U,`monster_attr ${h(E)??""} svelte-1qknre5`),F(K,`${Ra[h(E)]??""}属性`)}),y(R,D)});var Se=C(Y,2);de(Se,1,()=>t().types,ce,(R,E)=>{var D=Yc(),U=m(D);x(()=>{_e(D,`monster_cat ${h(E)??""} svelte-1qknre5`),F(U,`${Ls[h(E)]??""}${Ns[h(E)]??""}族`)}),y(R,D)});var L=C(I,2);de(L,5,()=>t().status.monsterCategories??[],ce,(R,E)=>{var D=Jc(),U=m(D);x(()=>{_e(D,`monster_cat ${h(E)??""} svelte-1qknre5`),F(U,`${qs[h(E)]??""}${Ms[h(E)]??""}`)}),y(R,D)}),y(qe,A)},$e=qe=>{var A=ye(),I=G(A);{var Y=L=>{var R=td(),E=C(m(R),2),D=m(E);x(()=>F(D,`${xs[t().status.spellCategory]??""}魔法`)),y(L,R)},Se=L=>{var R=ye(),E=G(R);{var D=U=>{var j=id(),K=C(m(j),2),J=m(K);x(()=>F(J,`${Bs[t().status.trapCategory]??""}罠`)),y(U,j)};B(E,U=>{t().kind==="Trap"&&t().status.trapCategory&&U(D)},!0)}y(L,R)};B(I,L=>{t().kind==="Spell"&&t().status.spellCategory?L(Y):L(Se,!1)},!0)}y(qe,A)};B(we,qe=>{t().kind==="Monster"?qe(xe):qe($e,!1)})}y(W,V)};B(P,W=>{s()==="Normal"&&W(q)})}var Z=C(f,2),ee=m(Z);{var N=W=>{var V=rd(),ie=m(V),he=m(ie),we=m(he);x(xe=>F(we,xe),[()=>{var xe;return(xe=i())==null?void 0:xe.description}],ue),y(W,V)},H=W=>{var V=hd(),ie=m(V),he=m(ie);he.textContent='"info" :{';var we=C(he,2);de(we,1,()=>Object.entries(t().info),ce,(se,oe)=>{let pe=()=>h(oe)[0],Ce=()=>h(oe)[1];var Ee=sd(),tt=m(Ee);x(Ve=>F(tt,`"${pe()??""}" :${Ve??""},`),[()=>{var Ve;return(Ve=Ce())==null?void 0:Ve.toString()}],ue),y(se,Ee)});var xe=C(we,2);xe.textContent="},";var $e=C(xe,2);$e.textContent='"status" :{';var qe=C($e,2);de(qe,1,()=>Object.entries(t().status),ce,(se,oe)=>{let pe=()=>h(oe)[0],Ce=()=>h(oe)[1];var Ee=od(),tt=m(Ee);x(Ve=>F(tt,`"${pe()??""}" :${Ve??""},`),[()=>{var Ve;return(Ve=Ce())==null?void 0:Ve.toString()}],ue),y(se,Ee)});var A=C(qe,2);A.textContent="},";var I=C(A,2);I.textContent='"actions" :[';var Y=C(I,2);de(Y,1,()=>t().actions,ce,(se,oe)=>{var pe=ad(),Ce=m(pe);x(()=>F(Ce,`"${h(oe).playType??""} ${h(oe).title??""}",`)),y(se,pe)});var Se=C(Y,2);Se.textContent="],";var L=C(Se,2);L.textContent='"substituteEffects" :[';var R=C(L,2);de(R,1,()=>t().substituteEffects,ce,(se,oe)=>{var pe=ld(),Ce=m(pe);x(()=>F(Ce,`"${h(oe).title??""}",`)),y(se,pe)});var E=C(R,2);E.textContent="],";var D=C(E,2);D.textContent='"continuousEffects" :[';var U=C(D,2);de(U,1,()=>t().continuousEffects,ce,(se,oe)=>{var pe=cd(),Ce=m(pe);x(()=>F(Ce,`"${h(oe).isStarted??""}",`)),y(se,pe)});var j=C(U,2);j.textContent="],";var K=C(j,2);K.textContent='"procFilters" :[';var J=C(K,2);de(J,1,()=>t().procFilterBundle.operators,ce,(se,oe)=>{var pe=dd(),Ce=m(pe);x(Ee=>F(Ce,`"${Ee??""} ${h(oe).title??""}",`),[()=>h(oe).isSpawnedBy.toString()],ue),y(se,pe)});var ge=C(J,2);ge.textContent="],";var re=C(ge,2);re.textContent='"numericStateOperators" :[';var X=C(re,2);de(X,1,()=>t().numericOprsBundle.operators,ce,(se,oe)=>{var pe=ud(),Ce=m(pe);x(Ee=>F(Ce,`"${Ee??""} ${h(oe).title??""}",`),[()=>h(oe).isSpawnedBy.toString()],ue),y(se,pe)});var te=C(X,2);te.textContent="],";var z=C(te,2);z.textContent='"stateOperators" :[';var be=C(z,2);de(be,1,()=>t().statusOperatorBundle.operators,ce,(se,oe)=>{var pe=fd(),Ce=m(pe);x(Ee=>F(Ce,`"${Ee??""} ${h(oe).title??""}",`),[()=>h(oe).isSpawnedBy.toString()],ue),y(se,pe)});var Ae=C(be,2);Ae.textContent="],";var Ne=C(Ae,2);Ne.textContent='"lastMoveLogRecord" :{';var mt=C(Ne,2),Ze=m(mt),Me=C(mt,2),Ue=m(Me),yt=C(Me,2),At=m(yt),He=C(yt,2);He.textContent="},",x((se,oe)=>{F(Ze,`"movedBy":"${se??""}",`),F(Ue,`"movedAs":"${oe??""}",`),F(At,`"movedAt":"${t().moveLog.latestRecord.movedAt.totalProcSeq??""}",`)},[()=>{var se;return(se=t().moveLog.latestRecord.movedBy)==null?void 0:se.toString()},()=>t().moveLog.latestRecord.movedAs.join(" ")],ue),y(W,V)};B(ee,W=>{s()==="Normal"?W(N):W(H,!1)})}var $=C(Z,2),O=m($);{var Pe=W=>{var V=vd();y(W,V)},Be=W=>{var V=pd(),ie=m(V),he=C(ie,2),we=m(he);x(xe=>{var $e;ai(ie,"href",`https://yugioh-wiki.net/index.php?${t().origin.wikiEncodedName}`),ai(he,"href",xe),F(we,`⇒${(($e=t())!=null&&$e.origin.cardId?"公式カードページ":"公式で検索")??""}`)},[r],ue),y(W,V)};B(O,W=>{var V;(V=t())!=null&&V.origin.isForTest?W(Pe):W(Be,!1)})}x((W,V,ie)=>{_e(u,`duel_card duel_card_info ${t().origin.kind??""} ${W??""} svelte-1qknre5`),F(g,t().nm),F(k,V),F(b,ie)},[()=>{var W;return(W=t().origin.monsterCategories)==null?void 0:W.join(" ")},()=>"★".repeat(t().lvl||0),()=>"☆".repeat(t().rank||0)],ue),y(d,u)};B(o,d=>{t()&&d(c)})}y(n,l),et()}Yt(["contextmenu"]);var md=T('<div class="duel_field_cell_info_item svelte-1xj7qf1"><!></div>'),yd=T('<div class="duel_field_cell_info_box svelte-1xj7qf1"><div class="duel_field_cell_info_label svelte-1xj7qf1"> </div> <!></div>'),Sd=T('<div class="duel_field_cell_info svelte-1xj7qf1"><div class="duel_field_cell_info_header item_btn svelte-1xj7qf1"><div class="svelte-1xj7qf1"> </div> <div class="svelte-1xj7qf1"> </div></div> <div class="duel_field_cell_info_body svelte-1xj7qf1"></div></div>');function wd(n,e){Je(e,!1);let t=me(e,"cell",12);const i=()=>{t(t())},r=c=>t().cardEntities.filter(d=>d.face===c);t().field.duel.view.onDuelUpdate.append(i),ct();var s=ye(),l=G(s);{var o=c=>{var d=Sd(),u=m(d),f=m(u),v=m(f),_=C(f,2),g=m(_),S=C(u,2);de(S,4,()=>["FaceUp","FaceDown"],ce,(p,k)=>{var w=ye(),b=G(w);{var P=q=>{var Z=yd(),ee=m(Z),N=m(ee),H=C(ee,2);de(H,1,()=>r(k).toSorted(Ws),ce,($,O)=>{var Pe=md(),Be=m(Pe);const W=ue(()=>t().owner===t().field.duel.duelists.Below);ft(Be,{get entity(){return h(O)},get isVisibleForcibly(){return h(W)},isWideMode:!0,cardActionResolve:void 0}),y($,Pe)}),x(()=>F(N,k==="FaceUp"?"表向き":"裏向き")),y(q,Z)};B(b,q=>{r(k).length&&q(P)})}y(p,w)}),x(()=>{var p;F(v,(p=t().owner)==null?void 0:p.profile.name),F(g,t().cellType)}),y(c,d)};B(l,c=>{t().field.duel.view.infoBoardState==="CellInfo"&&c(o)})}y(n,s),et()}const Cd=Hl({duration:400});var kd=T('<div class="duel_field_header_message svelte-accyye"> </div> <div class="duel_field_header_buttons svelte-accyye"><button class="svelte-accyye">サレンダー</button></div>',1),bd=T("<tr></tr>"),Ed=T('<table class="duel_field svelte-accyye"><tbody class="svelte-accyye"></tbody></table>'),Dd=T('<button class="svelte-accyye">cancel</button>'),Td=T('<button class="svelte-accyye">OK</button> <!>',1),Pd=T('<button class="svelte-accyye"> </button>'),Ad=T('<div class="flex duel_desk svelte-accyye"><div class="duel_desk_left v_flex svelte-accyye"><!> <!> <!></div> <div class=" duel_desk_center v_flex svelte-accyye"><div class="duel_field_header svelte-accyye"><!></div> <div class="svelte-accyye"><!></div> <div class="duel_field_footer svelte-accyye"><!></div></div> <div class=" duel_desk_right svelte-accyye" style="text-align: left;"><!> <!></div></div> <div style="position:absolute;left:0;bottom:0"> </div> <!>',1);function au(n,e){Je(e,!1);let t=me(e,"duel",12),i=De([]),r=De([]),s=()=>{},l=De([]),o=De(),c=De(),d=De(()=>!1),u=De(!1);const f=E=>{s=E.resolve,M(l,E.dummyActionInfos.filter(D=>D.action.entity.entityType==="Duelist").filter(D=>D.action.entity.controller.seat==="Below")),M(o,void 0),M(c,void 0),M(r,[]),M(i,[]),M(u,!1),E.entitiesChoices&&(M(o,E.entitiesChoices),M(d,()=>{var D;return((D=E.entitiesChoices)==null?void 0:D.validator(h(i)))??!1}),M(u,E.entitiesChoices.cancelable),h(o).selectables.every(D=>D.fieldCell.isPlayFieldCell&&D.getIndexInCell()===0||D.fieldCell.cellType==="Hand"&&D.controller.duelistType==="Player"||D.entityType==="Duelist")||t().view.modalController.entitySelector.show({title:t().view.message,entitiesChoices:E.entitiesChoices,chainBlockInfos:E.chainBlockInfos,cancelable:E.entitiesChoices.cancelable}).then(D=>{s({selectedEntities:D})})),E.cellsChoices&&(M(c,E.cellsChoices),M(d,()=>{var D;return((D=E.cellsChoices)==null?void 0:D.validator(h(r)))??!1}),M(u,E.cellsChoices.cancelable))};t().view.onWaitStart.append(f);const v=()=>{s=()=>{},M(c,void 0),M(o,void 0),M(r,[]),M(i,[]),M(d,()=>!1),M(u,!1)};t().view.onWaitEnd.append(v);let _=De(void 0),g=De("Normal");const S=({card:E,mode:D})=>{M(_,E),M(g,D)};t().view.onShowCardEntity.append(S);const p=()=>{t(t())};t().view.onDuelUpdate.append(p),t().log.onUpdate.append(p);const k=()=>{h(o)&&h(o).validator(h(i))&&s({selectedEntities:h(i)}),h(c)&&h(c).validator(h(r))&&s({selectedCells:h(r)})},w=()=>{s({})},b=E=>{s({actionInfo:E})},P=()=>{s({surrender:!0})};t().main(),ct();var q=Ad(),Z=G(q),ee=m(Z),N=m(ee);or(N,{get duelist(){return t().duelists.Above}});var H=C(N,2);gd(H,{get entity(){return h(_)},get mode(){return h(g)}});var $=C(H,2);or($,{get duelist(){return t().duelists.Below}});var O=C(ee,2),Pe=m(O),Be=m(Pe);{var W=E=>{var D=kd(),U=G(D),j=m(U),K=C(U,2),J=m(K);x(()=>F(j,`[TURN:${t().clock.turn}][PHASE:${t().phase}] ${t().view.message}`)),je("click",J,P),y(E,D)};B(Be,E=>{t().isEnded||E(W)})}var V=C(Pe,2),ie=m(V);{var he=E=>{var D=Ed(),U=m(D);de(U,5,()=>t().field.cells,ce,(j,K,J)=>{var ge=bd();_e(ge,`${`duel_desk_row_${J}`??""} svelte-accyye`),de(ge,5,()=>h(K),ce,(re,X,te)=>{gc(re,{get view(){return t().view},row:J,column:te,get selectedEntities(){return h(i)},set selectedEntities(z){M(i,z)},get selectedCells(){return h(r)},set selectedCells(z){M(r,z)},$$legacy:!0})}),y(j,ge)}),y(E,D)};B(ie,E=>{t().clock.turn>0&&E(he)})}var we=C(V,2),xe=m(we);{var $e=E=>{var D=Td(),U=G(D),j=C(U,2);{var K=J=>{var ge=Dd();je("click",ge,w),y(J,ge)};B(j,J=>{h(u)&&J(K)})}x(J=>U.disabled=J,[()=>!h(d)()],ue),je("click",U,k),y(E,D)},qe=E=>{var D=ye(),U=G(D);{var j=K=>{var J=ye(),ge=G(J);de(ge,1,()=>h(l),ce,(re,X)=>{var te=Pd(),z=m(te);x(()=>F(z,h(X).action.title)),je("click",te,()=>b(h(X))),y(re,te)}),y(K,J)};B(U,K=>{h(l)&&h(l).length&&K(j)},!0)}y(E,D)};B(xe,E=>{h(o)&&h(o).selectables.length||h(c)&&h(c).selectables?E($e):E(qe,!1)})}var A=C(O,2),I=m(A);Ec(I,{get log(){return t().log}});var Y=C(I,2);wd(Y,{get cell(){return t().view.infoBoardCell}});var Se=C(Z,2),L=m(Se),R=C(Se,2);Wc(R,{get modalController(){return t().view.modalController}}),x(E=>F(L,E),[()=>t().clock.toString()],ue),y(n,q),et()}export{Ra as $,x as A,_e as B,y as C,Ge as D,va as E,F,Ls as G,qs as H,er as I,ue as J,je as K,jd as L,Hd as M,Kn as N,xs as O,Gn as P,Bs as Q,G as R,le as S,Ud as T,et as U,Ti as V,ye as W,rt as X,Ms as Y,Xd as Z,ai as _,Xa as a,Ns as a0,Oa as a1,De as a2,Wd as a3,Gd as a4,zd as a5,Vd as a6,Zd as a7,rr as a8,Ld as a9,ei as aa,Od as ab,Nd as ac,Rd as ad,M as ae,xd as af,Id as ag,$d as ah,tr as ai,au as aj,Rt as ak,ou as al,en as am,ir as an,nu as ao,za as ap,su as aq,ru as ar,Bd as as,zs as b,Jd as c,Yi as d,eu as e,Kd as f,tu as g,cl as h,Qa as i,Yd as j,ne as k,Tt as l,js as m,hl as n,me as o,Je as p,ct as q,de as r,Zs as s,T as t,C as u,m as v,h as w,ce as x,Is as y,B as z};
